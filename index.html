<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Commerciale</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="/db.js"></script>
  <script type="module" src="/api-call.js"></script>
  <style>
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(40px); }
    }
    @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes countPulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @keyframes kpiPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes clientPulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    @keyframes drawerOpen {
      from { max-height: 0; opacity: 0; }
      to { max-height: 1000px; opacity: 1; }
    }
    @keyframes drawerClose {
      from { max-height: 1000px; opacity: 1; }
      to { max-height: 0; opacity: 0; }
    }
    .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
    .animate-pulse { animation: pulse 2s infinite ease-in-out; }
    .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
    .animate-kpi-pop { animation: kpiPop 0.5s ease-out forwards; }
    .top-client-updated { animation: clientPulse 0.6s ease-in-out; }
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    .drawer-open { animation: drawerOpen 0.3s ease-out forwards; }
    .drawer-close { animation: drawerClose 0.3s ease-out forwards; }
    #clientsSection { animation-delay: 0.2s; }
    #fournisseursSection { animation-delay: 0.4s; }
    #productsSection { animation-delay: 0.6s; }
    #utilisateursSection { animation-delay: 0.8s; }
    footer { animation-delay: 1.2s; }
    #scannerPreview { width: 100%; max-width: 300px; height: 200px; border: 2px solid #e5e7eb; margin-bottom: 1rem; display: none; background: #000; }
    .user-anim { animation: pulse 1.5s infinite ease-in-out; }
    .count-anim { animation: countPulse 1.5s infinite ease-in-out; }
    .small-email { font-size: 0.75rem; line-height: 1rem; }
    .kpi-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .kpi-card:hover { transform: scale(1.03); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
    .kpi-section { transition: opacity 0.5s ease; }
    .kpi-updated { animation: pulse 0.5s ease-in-out; }
    .dynamic-icon { transition: color 0.3s ease; }
    .chart-container { animation-delay: 1s; }
    #kpiSection {
      border-bottom: 2px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    #kpiSection:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .kpi-card {
      border-left: 4px solid #4F46E5;
      transition: all 0.3s ease;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
    }
    .fixed-buttons {
      position: sticky;
      top: 64px;
      z-index: 9;
      background: #f3f4f6;
      padding: 1rem 0;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .table-container {
      max-height: 350px;
      overflow-y: auto;
      position: relative;
    }
    .table-container table {
      width: 100%;
    }
    .table-container thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }
    .hidden-id {
      display: none;
    }
    .action-button {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    .section-content {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
    }
    .section-content.open {
      max-height: 1000px;
      opacity: 1;
    }
    .opacity-50 {
      opacity: 0.5;
    }
    .cursor-not-allowed {
      cursor: not-allowed;
    }
    /* Cache les actions pour les employés */
    body.employe-mode .action-buttons {
      display: none !important;
    }
    /* Style pour boutons désactivés */
    button:disabled {
      opacity: 0.5 !important;
      cursor: not-allowed !important;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Formulaire de connexion -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 hidden">
    <form id="loginForm" class="bg-white rounded-lg p-6 w-full max-w-md">
      <h2 class="text-xl font-semibold mb-4">Connexion</h2>
      <p class="text-sm text-red-500 mb-4">⚠️ Le mot de passe ne doit pas être celui de votre email.</p>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Adresse Email*</label>
        <input type="email" id="userEmail" name="username" autocomplete="username" class="w-full px-3 py-2 border rounded-md" placeholder="Entrez votre email" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe*</label>
        <input type="password" id="userPassword" name="password" autocomplete="current-password" class="w-full px-3 py-2 border rounded-md" placeholder="Entrez votre mot de passe" required>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="submit" onclick="loginWithCredentials(event)" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
          <i class="fas fa-sign-in-alt mr-2"></i>Se connecter
        </button>
      </div>
    </form>
  </div>

  <!-- Menu de navigation -->
  <nav class="bg-indigo-600 text-white p-4 fixed w-full top-0 z-10 shadow-md animate-slide-in">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex flex-col">
        <h1 class="text-2xl font-bold flex items-center">
          <i class="fas fa-fire mr-2 text-amber-400 animate-pulse"></i> FirePoz
        </h1>
        <span id="userDisplay" class="small-email user-anim hidden"></span>
        <span id="sellerDisplay" class="text-xs text-indigo-200 seller-anim">Vendeur: <span id="currentSellerName">Inconnu</span></span>
      </div>
      <div class="space-x-4 flex items-center">
        <button onclick="window.location.href='HTML.HTML'" class="bg-indigo-700 text-white px-3 py-1 rounded-md hover:bg-indigo-800 transition flex items-center">
          <i class="fas fa-user-edit mr-1"></i>
        </button>
        <a href="page1.html" class="hover:text-indigo-200 transition flex items-center">
          <i class="fas fa-barcode mr-1"></i> Scanner
        </a>
        <button id="loginLogoutButton" onclick="loginLogout()" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition flex items-center">
          <i class="fas fa-sign-out-alt mr-1"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Contenu principal -->
  <div class="container mx-auto px-4 py-16 mt-16">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-indigo-700">KHsphers software</h1>
      <p class="text-gray-600 flex items-center">
        <i class="fas fa-database mr-2 text-indigo-500"></i> Fueled by PostgreSQL
      </p>
    </header>

    <!-- Boutons Vente et Achat fixés -->
    <div class="fixed-buttons flex">
      <a href="vente.html" class="w-1/2 bg-green-600 text-white py-6 flex items-center justify-center hover:bg-green-700 transition-all duration-300 transform hover:scale-105 animate-pulse">
        <i class="fas fa-shopping-cart text-4xl mr-3"></i>
        <span class="text-2xl font-semibold">Vente</span>
      </a>
      <a href="achat.html" class="w-1/2 bg-blue-600 text-white py-6 flex items-center justify-center hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 animate-pulse">
        <i class="fas fa-box-open text-4xl mr-3"></i>
        <span class="text-2xl font-semibold">Achat</span>
      </a>
    </div>

    <!-- Section KPI améliorée -->
    <div id="kpiSection" class="w-full bg-gradient-to-r from-indigo-100 to-white shadow-lg rounded-lg p-4 mb-8 z-10 animate-fade-in">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
          <i class="fas fa-chart-line mr-2 text-indigo-500 animate-pulse"></i> Tableau de Bord
        </h2>
        <select id="kpiPeriod" class="border p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-sm">
          <option value="day">Aujourd'hui</option>
          <option value="week">Cette Semaine</option>
        </select>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
          <h3 class="text-xs font-medium text-gray-600 flex items-center">
            <i id="caIcon" class="fas fa-money-bill-wave mr-1 text-green-500 dynamic-icon"></i> Chiffre d'Affaires
          </h3>
          <p id="totalCA" class="text-lg font-bold text-indigo-600">0.00 DA</p>
        </div>
        <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
          <h3 class="text-xs font-medium text-gray-600 flex items-center">
            <i id="profitIcon" class="fas fa-chart-pie mr-1 text-blue-500 dynamic-icon"></i> Bénéfice Total
          </h3>
          <p id="totalProfit" class="text-lg font-bold text-indigo-600">0.00 DA</p>
        </div>
        <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
          <h3 class="text-xs font-medium text-gray-600 flex items-center">
            <i id="salesIcon" class="fas fa-shopping-cart mr-1 text-yellow-500 dynamic-icon"></i> Ventes
          </h3>
          <p id="salesCount" class="text-lg font-bold text-indigo-600">0</p>
        </div>
        <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
          <h3 class="text-xs font-medium text-gray-600 flex items-center">
            <i id="stockIcon" class="fas fa-exclamation-triangle mr-1 text-red-500 dynamic-icon"></i> Ruptures
          </h3>
          <p id="lowStockItems" class="text-lg font-bold text-indigo-600">0</p>
        </div>
        <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24 col-span-2 sm:col-span-1 lg:col-span-2">
          <h3 class="text-xs font-medium text-gray-600 flex items-center">
            <i id="clientIcon" class="fas fa-user-check mr-1 text-purple-500 dynamic-icon"></i> Top Client
          </h3>
          <p id="topClient" class="text-sm font-bold text-indigo-600 overflow-hidden text-ellipsis whitespace-nowrap" title="N/A">N/A</p>
          <p id="topClientCA" class="text-xs text-gray-500">0.00 DA</p>
        </div>
      </div>
    </div>

    <!-- Graphique en dessous -->
    <div class="w-full bg-white p-4 rounded-lg shadow-md animate-fade-in chart-container mt-4">
      <h3 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
        <i class="fas fa-chart-area mr-2 text-indigo-500"></i> Évolution du Chiffre d'Affaires
      </h3>
      <canvas id="caChart" height="100"></canvas>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Gestion Clients -->
      <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="clientsSection">
        <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('clientsSection')">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-users mr-2 text-indigo-500"></i> Gestion Clients
            <span id="clientCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim">0</span>
          </h2>
          <button class="text-gray-600 hover:text-gray-800 transition">
            <i class="fas fa-chevron-down" id="clientsChevron"></i>
          </button>
        </div>
        <div class="section-content" id="clientsContent">
          <div class="p-6">
            <div class="mb-4">
              <div class="relative">
                <input type="text" id="searchClient" placeholder="Rechercher des clients..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
              <div class="flex justify-end mt-2">
                <button onclick="toggleClientForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-plus mr-2"></i>Ajouter
                </button>
              </div>
            </div>

            <div id="clientForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
              <h3 class="font-medium mb-3" id="clientFormTitle">Nouveau Client</h3>
              <input type="hidden" id="clientId">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                  <input type="text" id="clientNom" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                  <input type="text" id="clientContact" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                  <input type="text" id="clientAdresse" class="w-full px-3 py-2 border rounded-md">
                </div>
              </div>
              <div class="flex justify-end space-x-3 mt-4">
                <button onclick="resetClientForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-times mr-2"></i>Annuler
                </button>
                <button onclick="saveClient()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
              </div>
            </div>

            <div class="table-container">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="hidden-id">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Solde</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="clientsList" class="bg-white divide-y divide-gray-200">
                  <tr>
                    <td colspan="7" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Gestion Fournisseurs -->
      <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="fournisseursSection">
        <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('fournisseursSection')">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-truck mr-2 text-indigo-500"></i> Gestion Fournisseurs
            <span id="fournisseurCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim">0</span>
          </h2>
          <button class="text-gray-600 hover:text-gray-800 transition">
            <i class="fas fa-chevron-down" id="fournisseursChevron"></i>
          </button>
        </div>
        <div class="section-content" id="fournisseursContent">
          <div class="p-6">
            <div class="mb-4">
              <div class="relative">
                <input type="text" id="searchFournisseur" placeholder="Rechercher des fournisseurs..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
              <div class="flex justify-end mt-2">
                <button onclick="toggleFournisseurForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-plus mr-2"></i>Ajouter
                </button>
              </div>
            </div>

            <div id="fournisseurForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
              <h3 class="font-medium mb-3" id="fournisseurFormTitle">Nouveau Fournisseur</h3>
              <input type="hidden" id="fournisseurId">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                  <input type="text" id="fournisseurNom" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                  <input type="text" id="fournisseurContact" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                  <input type="text" id="fournisseurAdresse" class="w-full px-3 py-2 border rounded-md">
                </div>
              </div>
              <div class="flex justify-end space-x-3 mt-4">
                <button onclick="resetFournisseurForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-times mr-2"></i>Annuler
                </button>
                <button onclick="saveFournisseur()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
              </div>
            </div>

            <div class="table-container">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="hidden-id">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Solde</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="fournisseursList" class="bg-white divide-y divide-gray-200">
                  <tr>
                    <td colspan="7" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Gestion Produits -->
      <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="productsSection">
        <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('productsSection')">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-box mr-2 text-indigo-500"></i> Gestion Produits
            <span id="productCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim">0</span>
          </h2>
          <button class="text-gray-600 hover:text-gray-800 transition">
            <i class="fas fa-chevron-down" id="productsChevron"></i>
          </button>
        </div>
        <div class="section-content" id="productsContent">
          <div class="p-6">
            <div class="mb-4">
              <div class="relative">
                <input type="text" id="searchProduct" placeholder="Rechercher des produits..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
              <div class="flex justify-end mt-2">
                <button onclick="toggleProductForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-plus mr-2"></i>Ajouter
                </button>
              </div>
            </div>

            <div id="productForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
              <h3 class="font-medium mb-3" id="productFormTitle">Nouveau Produit</h3>
              <input type="hidden" id="productId">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Désignation*</label>
                  <input type="text" id="productDesignation" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Code Barre</label>
                  <input type="text" id="productBar" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Référence</label>
                  <input type="text" id="productRef" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Prix*</label>
                  <input type="text" id="productPrix" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Prix Achat</label>
                  <input type="text" id="productPrixBA" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Quantité*</label>
                  <input type="number" id="productQte" class="w-full px-3 py-2 border rounded-md" required>
                </div>
              </div>
              <div class="flex justify-end space-x-3 mt-4">
                <button onclick="resetProductForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-times mr-2"></i>Annuler
                </button>
                <button onclick="saveProduct()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
              </div>
            </div>

            <div class="table-container">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="hidden-id">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Désignation</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code Barre</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="productsList" class="bg-white divide-y divide-gray-200">
                  <tr>
                    <td colspan="7" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Gestion Utilisateurs -->
      <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="utilisateursSection">
        <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('utilisateursSection')">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-user mr-2 text-indigo-500"></i> Gestion Utilisateurs
            <span id="utilisateurCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim">0</span>
          </h2>
          <button class="text-gray-600 hover:text-gray-800 transition">
            <i class="fas fa-chevron-down" id="utilisateursChevron"></i>
          </button>
        </div>
        <div class="section-content" id="utilisateursContent">
          <div class="p-6">
            <div class="mb-4">
              <div class="relative">
                <input type="text" id="searchUtilisateur" placeholder="Rechercher des utilisateurs..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
              </div>
              <div class="flex justify-end mt-2">
                <button onclick="toggleUtilisateurForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-plus mr-2"></i>Ajouter
                </button>
              </div>
            </div>

            <div id="utilisateurForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
              <h3 class="font-medium mb-3" id="utilisateurFormTitle">Nouvel Utilisateur</h3>
              <input type="hidden" id="utilisateurId">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                  <input type="text" id="utilisateurNom" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                  <input type="password" id="utilisateurPassword" class="w-full px-3 py-2 border rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Statut*</label>
                  <select id="utilisateurStatut" class="w-full px-3 py-2 border rounded-md" required>
                    <option value="admin">Admin</option>
                    <option value="employe">Employé</option>
                  </select>
                </div>
              </div>
              <div class="flex justify-end space-x-3 mt-4">
                <button onclick="resetUtilisateurForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-times mr-2"></i>Annuler
                </button>
                <button onclick="saveUtilisateur()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                  <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
              </div>
            </div>

            <div class="table-container">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="hidden-id">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="utilisateursList" class="bg-white divide-y divide-gray-200">
                  <tr>
                    <td colspan="4" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script principal -->
  <script>
    // Définir API_BASE_URL depuis localStorage
    const API_BASE_URL = localStorage.getItem('apiBaseUrl') || '';

    // Import apiCall
    import { apiCall } from '/api-call.js';

    // Gestion du mode employé
    function setEmployeMode(isEmploye) {
      document.body.classList.toggle('employe-mode', isEmploye);
      const actionButtons = document.querySelectorAll('.action-buttons button');
      actionButtons.forEach(button => {
        button.disabled = isEmploye;
      });
    }

    // Connexion
    async function loginWithCredentials(event) {
      event.preventDefault();
      const email = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;
      try {
        const response = await apiCall('/liste_utilisateurs', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (response.ok && data.utilisateurs) {
          const user = data.utilisateurs.find(u => u.nom === email && u.password2 === password);
          if (user) {
            localStorage.setItem('userId', user.numero_util);
            localStorage.setItem('userStatut', user.statue);
            document.getElementById('userDisplay').textContent = email;
            document.getElementById('userDisplay').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i> Déconnexion';
            setEmployeMode(user.statue === 'employe');
            loadDashboard();
            loadClients();
            loadFournisseurs();
            loadProduits();
            loadUtilisateurs();
          } else {
            alert('Email ou mot de passe incorrect.');
          }
        } else {
          console.error('Erreur lors de la connexion:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur réseau:', error);
      }
    }

    // Déconnexion
    function loginLogout() {
      if (localStorage.getItem('userId')) {
        localStorage.removeItem('userId');
        localStorage.removeItem('userStatut');
        document.getElementById('userDisplay').classList.add('hidden');
        document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-in-alt mr-1"></i> Connexion';
        document.getElementById('loginModal').classList.remove('hidden');
        setEmployeMode(false);
      } else {
        document.getElementById('loginModal').classList.remove('hidden');
      }
    }

    // Charger le tableau de bord
    async function loadDashboard(period = 'day') {
      try {
        const response = await apiCall(`/dashboard?period=${period}`, {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          document.getElementById('totalCA').textContent = `${(data.totalCA || 0).toFixed(2)} DA`;
          document.getElementById('totalProfit').textContent = `${(data.totalProfit || 0).toFixed(2)} DA`;
          document.getElementById('salesCount').textContent = data.salesCount || 0;
          document.getElementById('lowStockItems').textContent = data.lowStockItems || 0;
          document.getElementById('topClient').textContent = data.topClient?.nom || 'N/A';
          document.getElementById('topClient').title = data.topClient?.nom || 'N/A';
          document.getElementById('topClientCA').textContent = `${(data.topClient?.ca || 0).toFixed(2)} DA`;
          updateChart(data.caData || []);
        } else {
          console.error('Erreur dashboard:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement du dashboard:', error);
      }
    }

    // Mettre à jour le graphique
    function updateChart(caData) {
      const ctx = document.getElementById('caChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: caData.map(d => d.date),
          datasets: [{
            label: 'Chiffre d\'Affaires (DA)',
            data: caData.map(d => d.montant),
            borderColor: '#4F46E5',
            backgroundColor: 'rgba(79, 70, 229, 0.2)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Gestion des sections
    function toggleSection(sectionId) {
      const content = document.getElementById(`${sectionId}Content`);
      const chevron = document.getElementById(`${sectionId}Chevron`);
      content.classList.toggle('open');
      chevron.classList.toggle('fa-chevron-down');
      chevron.classList.toggle('fa-chevron-up');
    }

    // Clients
    function toggleClientForm() {
      const form = document.getElementById('clientForm');
      form.classList.toggle('hidden');
      resetClientForm();
    }

    function resetClientForm() {
      document.getElementById('clientForm').classList.add('hidden');
      document.getElementById('clientId').value = '';
      document.getElementById('clientNom').value = '';
      document.getElementById('clientContact').value = '';
      document.getElementById('clientAdresse').value = '';
      document.getElementById('clientFormTitle').textContent = 'Nouveau Client';
    }

    async function loadClients() {
      try {
        const response = await apiCall('/liste_clients', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const clientsList = document.getElementById('clientsList');
          clientsList.innerHTML = '';
          data.clients.forEach(client => {
            clientsList.innerHTML += `
              <tr>
                <td class="hidden-id">${client.numero_clt}</td>
                <td class="px-6 py-4">${client.nom}</td>
                <td class="px-6 py-4">${(client.solde || 0).toFixed(2)}</td>
                <td class="px-6 py-4">${client.reference || ''}</td>
                <td class="px-6 py-4">${client.contact || ''}</td>
                <td class="px-6 py-4">${client.adresse || ''}</td>
                <td class="px-6 py-4 action-buttons">
                  <button onclick="editClient(${client.numero_clt})" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                  <button onclick="deleteClient(${client.numero_clt})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            `;
          });
          document.getElementById('clientCount').textContent = data.clients.length;
        } else {
          console.error('Erreur clients:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des clients:', error);
      }
    }

    async function saveClient() {
      const id = document.getElementById('clientId').value;
      const client = {
        nom: document.getElementById('clientNom').value,
        contact: document.getElementById('clientContact').value,
        adresse: document.getElementById('clientAdresse').value
      };
      if (!client.nom) {
        alert('Le nom est requis.');
        return;
      }
      try {
        const endpoint = id ? `/modifier_client/${id}` : '/ajouter_client';
        const method = id ? 'PUT' : 'POST';
        const response = await apiCall(endpoint, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': localStorage.getItem('userId')
          },
          body: JSON.stringify(client)
        });
        const data = await response.json();
        if (response.ok) {
          resetClientForm();
          loadClients();
          loadDashboard(document.getElementById('kpiPeriod').value);
        } else {
          console.error('Erreur sauvegarde client:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la sauvegarde du client:', error);
      }
    }

    async function editClient(id) {
      try {
        const response = await apiCall('/liste_clients', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const client = data.clients.find(c => c.numero_clt === id);
          if (client) {
            document.getElementById('clientId').value = client.numero_clt;
            document.getElementById('clientNom').value = client.nom;
            document.getElementById('clientContact').value = client.contact || '';
            document.getElementById('clientAdresse').value = client.adresse || '';
            document.getElementById('clientFormTitle').textContent = 'Modifier Client';
            document.getElementById('clientForm').classList.remove('hidden');
          }
        } else {
          console.error('Erreur chargement client:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement du client:', error);
      }
    }

    async function deleteClient(id) {
      if (!confirm('Voulez-vous vraiment supprimer ce client ?')) return;
      try {
        const response = await apiCall(`/supprimer_client/${id}`, {
          method: 'DELETE',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          loadClients();
          loadDashboard(document.getElementById('kpiPeriod').value);
        } else {
          console.error('Erreur suppression client:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression du client:', error);
      }
    }

    // Fournisseurs
    function toggleFournisseurForm() {
      const form = document.getElementById('fournisseurForm');
      form.classList.toggle('hidden');
      resetFournisseurForm();
    }

    function resetFournisseurForm() {
      document.getElementById('fournisseurForm').classList.add('hidden');
      document.getElementById('fournisseurId').value = '';
      document.getElementById('fournisseurNom').value = '';
      document.getElementById('fournisseurContact').value = '';
      document.getElementById('fournisseurAdresse').value = '';
      document.getElementById('fournisseurFormTitle').textContent = 'Nouveau Fournisseur';
    }

    async function loadFournisseurs() {
      try {
        const response = await apiCall('/liste_fournisseurs', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const fournisseursList = document.getElementById('fournisseursList');
          fournisseursList.innerHTML = '';
          data.fournisseurs.forEach(fournisseur => {
            fournisseursList.innerHTML += `
              <tr>
                <td class="hidden-id">${fournisseur.numero_fou}</td>
                <td class="px-6 py-4">${fournisseur.nom}</td>
                <td class="px-6 py-4">${(fournisseur.solde || 0).toFixed(2)}</td>
                <td class="px-6 py-4">${fournisseur.reference || ''}</td>
                <td class="px-6 py-4">${fournisseur.contact || ''}</td>
                <td class="px-6 py-4">${fournisseur.adresse || ''}</td>
                <td class="px-6 py-4 action-buttons">
                  <button onclick="editFournisseur(${fournisseur.numero_fou})" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                  <button onclick="deleteFournisseur(${fournisseur.numero_fou})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            `;
          });
          document.getElementById('fournisseurCount').textContent = data.fournisseurs.length;
        } else {
          console.error('Erreur fournisseurs:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des fournisseurs:', error);
      }
    }

    async function saveFournisseur() {
      const id = document.getElementById('fournisseurId').value;
      const fournisseur = {
        nom: document.getElementById('fournisseurNom').value,
        contact: document.getElementById('fournisseurContact').value,
        adresse: document.getElementById('fournisseurAdresse').value
      };
      if (!fournisseur.nom) {
        alert('Le nom est requis.');
        return;
      }
      try {
        const endpoint = id ? `/modifier_fournisseur/${id}` : '/ajouter_fournisseur';
        const method = id ? 'PUT' : 'POST';
        const response = await apiCall(endpoint, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': localStorage.getItem('userId')
          },
          body: JSON.stringify(fournisseur)
        });
        const data = await response.json();
        if (response.ok) {
          resetFournisseurForm();
          loadFournisseurs();
        } else {
          console.error('Erreur sauvegarde fournisseur:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la sauvegarde du fournisseur:', error);
      }
    }

    async function editFournisseur(id) {
      try {
        const response = await apiCall('/liste_fournisseurs', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const fournisseur = data.fournisseurs.find(f => f.numero_fou === id);
          if (fournisseur) {
            document.getElementById('fournisseurId').value = fournisseur.numero_fou;
            document.getElementById('fournisseurNom').value = fournisseur.nom;
            document.getElementById('fournisseurContact').value = fournisseur.contact || '';
            document.getElementById('fournisseurAdresse').value = fournisseur.adresse || '';
            document.getElementById('fournisseurFormTitle').textContent = 'Modifier Fournisseur';
            document.getElementById('fournisseurForm').classList.remove('hidden');
          }
        } else {
          console.error('Erreur chargement fournisseur:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement du fournisseur:', error);
      }
    }

    async function deleteFournisseur(id) {
      if (!confirm('Voulez-vous vraiment supprimer ce fournisseur ?')) return;
      try {
        const response = await apiCall(`/supprimer_fournisseur/${id}`, {
          method: 'DELETE',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          loadFournisseurs();
        } else {
          console.error('Erreur suppression fournisseur:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression du fournisseur:', error);
      }
    }

    // Produits
    function toggleProductForm() {
      const form = document.getElementById('productForm');
      form.classList.toggle('hidden');
      resetProductForm();
    }

    function resetProductForm() {
      document.getElementById('productForm').classList.add('hidden');
      document.getElementById('productId').value = '';
      document.getElementById('productDesignation').value = '';
      document.getElementById('productBar').value = '';
      document.getElementById('productRef').value = '';
      document.getElementById('productPrix').value = '';
      document.getElementById('productPrixBA').value = '';
      document.getElementById('productQte').value = '';
      document.getElementById('productFormTitle').textContent = 'Nouveau Produit';
    }

    async function loadProduits() {
      try {
        const response = await apiCall('/liste_produits', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const productsList = document.getElementById('productsList');
          productsList.innerHTML = '';
          data.produits.forEach(produit => {
            productsList.innerHTML += `
              <tr>
                <td class="hidden-id">${produit.numero_item}</td>
                <td class="px-6 py-4">${produit.designation}</td>
                <td class="px-6 py-4">${produit.bar || ''}</td>
                <td class="px-6 py-4">${produit.ref || ''}</td>
                <td class="px-6 py-4">${produit.prix}</td>
                <td class="px-6 py-4">${produit.qte}</td>
                <td class="px-6 py-4 action-buttons">
                  <button onclick="editProduit(${produit.numero_item})" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                  <button onclick="deleteProduit(${produit.numero_item})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            `;
          });
          document.getElementById('productCount').textContent = data.produits.length;
        } else {
          console.error('Erreur produits:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des produits:', error);
      }
    }

    async function saveProduit() {
      const id = document.getElementById('productId').value;
      const produit = {
        designation: document.getElementById('productDesignation').value,
        bar: document.getElementById('productBar').value,
        ref: document.getElementById('productRef').value,
        prix: document.getElementById('productPrix').value,
        prixba: document.getElementById('productPrixBA').value,
        qte: parseInt(document.getElementById('productQte').value)
      };
      if (!produit.designation || !produit.prix || !produit.qte) {
        alert('Désignation, prix et quantité sont requis.');
        return;
      }
      try {
        const endpoint = id ? `/modifier_item/${id}` : '/ajouter_item';
        const method = id ? 'PUT' : 'POST';
        const response = await apiCall(endpoint, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': localStorage.getItem('userId')
          },
          body: JSON.stringify(produit)
        });
        const data = await response.json();
        if (response.ok) {
          resetProductForm();
          loadProduits();
          loadDashboard(document.getElementById('kpiPeriod').value);
        } else {
          console.error('Erreur sauvegarde produit:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la sauvegarde du produit:', error);
      }
    }

    async function editProduit(id) {
      try {
        const response = await apiCall('/liste_produits', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const produit = data.produits.find(p => p.numero_item === id);
          if (produit) {
            document.getElementById('productId').value = produit.numero_item;
            document.getElementById('productDesignation').value = produit.designation;
            document.getElementById('productBar').value = produit.bar || '';
            document.getElementById('productRef').value = produit.ref || '';
            document.getElementById('productPrix').value = produit.prix;
            document.getElementById('productPrixBA').value = produit.prixba || '';
            document.getElementById('productQte').value = produit.qte;
            document.getElementById('productFormTitle').textContent = 'Modifier Produit';
            document.getElementById('productForm').classList.remove('hidden');
          }
        } else {
          console.error('Erreur chargement produit:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement du produit:', error);
      }
    }

    async function deleteProduit(id) {
      if (!confirm('Voulez-vous vraiment supprimer ce produit ?')) return;
      try {
        const response = await apiCall(`/supprimer_item/${id}`, {
          method: 'DELETE',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          loadProduits();
          loadDashboard(document.getElementById('kpiPeriod').value);
        } else {
          console.error('Erreur suppression produit:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression du produit:', error);
      }
    }

    // Utilisateurs
    function toggleUtilisateurForm() {
      const form = document.getElementById('utilisateurForm');
      form.classList.toggle('hidden');
      resetUtilisateurForm();
    }

    function resetUtilisateurForm() {
      document.getElementById('utilisateurForm').classList.add('hidden');
      document.getElementById('utilisateurId').value = '';
      document.getElementById('utilisateurNom').value = '';
      document.getElementById('utilisateurPassword').value = '';
      document.getElementById('utilisateurStatut').value = 'admin';
      document.getElementById('utilisateurFormTitle').textContent = 'Nouvel Utilisateur';
    }

    async function loadUtilisateurs() {
      try {
        const response = await apiCall('/liste_utilisateurs', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const utilisateursList = document.getElementById('utilisateursList');
          utilisateursList.innerHTML = '';
          data.utilisateurs.forEach(utilisateur => {
            utilisateursList.innerHTML += `
              <tr>
                <td class="hidden-id">${utilisateur.numero_util}</td>
                <td class="px-6 py-4">${utilisateur.nom}</td>
                <td class="px-6 py-4">${utilisateur.statue}</td>
                <td class="px-6 py-4 action-buttons">
                  <button onclick="editUtilisateur(${utilisateur.numero_util})" class="text-indigo-600 hover:text-indigo-800"><i class="fas fa-edit"></i></button>
                  <button onclick="deleteUtilisateur(${utilisateur.numero_util})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
              </tr>
            `;
          });
          document.getElementById('utilisateurCount').textContent = data.utilisateurs.length;
        } else {
          console.error('Erreur utilisateurs:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des utilisateurs:', error);
      }
    }

    async function saveUtilisateur() {
      const id = document.getElementById('utilisateurId').value;
      const utilisateur = {
        nom: document.getElementById('utilisateurNom').value,
        password2: document.getElementById('utilisateurPassword').value,
        statue: document.getElementById('utilisateurStatut').value
      };
      if (!utilisateur.nom || !utilisateur.statue) {
        alert('Nom et statut sont requis.');
        return;
      }
      try {
        const endpoint = id ? `/modifier_utilisateur/${id}` : '/ajouter_utilisateur';
        const method = id ? 'PUT' : 'POST';
        const response = await apiCall(endpoint, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-User-ID': localStorage.getItem('userId')
          },
          body: JSON.stringify(utilisateur)
        });
        const data = await response.json();
        if (response.ok) {
          resetUtilisateurForm();
          loadUtilisateurs();
        } else {
          console.error('Erreur sauvegarde utilisateur:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la sauvegarde de l\'utilisateur:', error);
      }
    }

    async function editUtilisateur(id) {
      try {
        const response = await apiCall('/liste_utilisateurs', {
          method: 'GET',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          const utilisateur = data.utilisateurs.find(u => u.numero_util === id);
          if (utilisateur) {
            document.getElementById('utilisateurId').value = utilisateur.numero_util;
            document.getElementById('utilisateurNom').value = utilisateur.nom;
            document.getElementById('utilisateurPassword').value = '';
            document.getElementById('utilisateurStatut').value = utilisateur.statue;
            document.getElementById('utilisateurFormTitle').textContent = 'Modifier Utilisateur';
            document.getElementById('utilisateurForm').classList.remove('hidden');
          }
        } else {
          console.error('Erreur chargement utilisateur:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors du chargement de l\'utilisateur:', error);
      }
    }

    async function deleteUtilisateur(id) {
      if (!confirm('Voulez-vous vraiment supprimer cet utilisateur ?')) return;
      try {
        const response = await apiCall(`/supprimer_utilisateur/${id}`, {
          method: 'DELETE',
          headers: { 'X-User-ID': localStorage.getItem('userId') }
        });
        const data = await response.json();
        if (response.ok) {
          loadUtilisateurs();
        } else {
          console.error('Erreur suppression utilisateur:', data.erreur);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression de l\'utilisateur:', error);
      }
    }

    // Recherche
    function searchClients() {
      const searchValue = document.getElementById('searchClient').value.toLowerCase();
      const rows = document.querySelectorAll('#clientsList tr');
      rows.forEach(row => {
        const nom = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        row.style.display = nom.includes(searchValue) ? '' : 'none';
      });
    }

    function searchFournisseurs() {
      const searchValue = document.getElementById('searchFournisseur').value.toLowerCase();
      const rows = document.querySelectorAll('#fournisseursList tr');
      rows.forEach(row => {
        const nom = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        row.style.display = nom.includes(searchValue) ? '' : 'none';
      });
    }

    function searchProduits() {
      const searchValue = document.getElementById('searchProduct').value.toLowerCase();
      const rows = document.querySelectorAll('#productsList tr');
      rows.forEach(row => {
        const designation = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        row.style.display = designation.includes(searchValue) ? '' : 'none';
      });
    }

    function searchUtilisateurs() {
      const searchValue = document.getElementById('searchUtilisateur').value.toLowerCase();
      const rows = document.querySelectorAll('#utilisateursList tr');
      rows.forEach(row => {
        const nom = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        row.style.display = nom.includes(searchValue) ? '' : 'none';
      });
    }

    // Écouteurs d'événements
    document.getElementById('searchClient').addEventListener('input', searchClients);
    document.getElementById('searchFournisseur').addEventListener('input', searchFournisseurs);
    document.getElementById('searchProduct').addEventListener('input', searchProduits);
    document.getElementById('searchUtilisateur').addEventListener('input', searchUtilisateurs);
    document.getElementById('kpiPeriod').addEventListener('change', () => {
      loadDashboard(document.getElementById('kpiPeriod').value);
    });

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('userId')) {
        document.getElementById('userDisplay').textContent = localStorage.getItem('userEmail') || 'Utilisateur';
        document.getElementById('userDisplay').classList.remove('hidden');
        document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i> Déconnexion';
        setEmployeMode(localStorage.getItem('userStatut') === 'employe');
        loadDashboard();
        loadClients();
        loadFournisseurs();
        loadProduits();
        loadUtilisateurs();
      } else {
        document.getElementById('loginModal').classList.remove('hidden');
      }
    });
  </script>
</body>
</html>