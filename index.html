<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Commerciale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Styles optimisés */
        .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
        @keyframes slideIn { 
            from { transform: translateY(-100%); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }

        #scannerPreview {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-container {
            max-height: 65vh;
            overflow-y: auto;
        }

        .dynamic-form {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
        }

        .dynamic-form.active {
            max-height: 1000px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Formulaire de connexion -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <form id="loginForm" class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-indigo-600">Connexion</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Adresse Email</label>
                    <input type="email" id="userEmail" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="userPassword" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <button type="submit" 
                    class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-transform duration-300 hover:scale-[1.02]">
                    Se connecter
                </button>
            </div>
        </form>
    </div>

    <!-- Navigation principale -->
    <nav class="bg-indigo-600 text-white p-4 fixed w-full top-0 z-40 shadow-xl animate-slide-in">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-fire text-2xl text-amber-400"></i>
                <span class="text-xl font-bold">FirePoz</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userDisplay" class="text-sm bg-indigo-700 px-3 py-1 rounded-full hidden"></span>
                <button id="loginLogoutButton" 
                    class="bg-white/10 px-4 py-2 rounded-lg hover:bg-white/20 transition-colors duration-200">
                    Connexion
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-24 pb-12">
        <!-- En-tête -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-indigo-700 mb-2">KHsphers Software</h1>
            <p class="text-gray-600">
                <i class="fas fa-database mr-2 text-indigo-500"></i>
                Propulsé par PostgreSQL
            </p>
        </header>

        <!-- Section principale -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Modules principaux -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Actions rapides</h2>
                <div class="grid grid-cols-2 gap-4">
                    <a href="vente.html" class="action-card bg-green-100 hover:bg-green-200 text-green-700">
                        <i class="fas fa-cash-register"></i>
                        Vente
                    </a>
                    <a href="achat.html" class="action-card bg-blue-100 hover:bg-blue-200 text-blue-700">
                        <i class="fas fa-pallet"></i>
                        Achat
                    </a>
                </div>
            </div>

            <!-- Formulaire dynamique -->
            <div class="col-span-2">
                <div id="dynamicFormContainer" class="dynamic-form bg-white rounded-xl shadow-lg">
                    <!-- Le contenu du formulaire sera injecté ici via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Sections de gestion -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <!-- Clients -->
            <section class="management-section">
                <div class="section-header" data-target="clients">
                    <h3><i class="fas fa-users"></i> Clients</h3>
                    <button class="section-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="section-content hidden" id="clientsContent">
                    <!-- Contenu chargé dynamiquement -->
                </div>
            </section>

            <!-- Fournisseurs -->
            <section class="management-section">
                <div class="section-header" data-target="fournisseurs">
                    <h3><i class="fas fa-truck"></i> Fournisseurs</h3>
                    <button class="section-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="section-content hidden" id="fournisseursContent">
                    <!-- Contenu chargé dynamiquement -->
                </div>
            </section>

            <!-- Produits -->
            <section class="management-section">
                <div class="section-header" data-target="produits">
                    <h3><i class="fas fa-boxes"></i> Produits</h3>
                    <button class="section-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="section-content hidden" id="productsContent">
                    <!-- Contenu chargé dynamiquement -->
                </div>
            </section>

            <!-- Utilisateurs -->
            <section class="management-section">
                <div class="section-header" data-target="utilisateurs">
                    <h3><i class="fas fa-users-cog"></i> Utilisateurs</h3>
                    <button class="section-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="section-content hidden" id="usersContent">
                    <!-- Contenu chargé dynamiquement -->
                </div>
            </section>
        </div>
    </main>

    <!-- Scanner overlay -->
    <div id="scannerOverlay" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50">
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl">
            <div id="scannerPreview" class="bg-black rounded-xl overflow-hidden"></div>
            <button id="closeScanner" class="absolute top-4 right-4 text-white text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast" class="fixed bottom-4 right-4 hidden p-4 rounded-lg shadow-xl text-white max-w-xs"></div>

    <script type="module">
       // config.js
const API_BASE_URL = 'https://web-production-3b9e.up.railway.app';
const ENTITIES = ['clients', 'fournisseurs', 'produits', 'utilisateurs'];
const TOAST_DURATION = 3000;

// auth.js
class AuthService {
  static get userId() {
    return localStorage.getItem('userId');
  }

  static get userEmail() {
    return localStorage.getItem('userEmail');
  }

  static async login(email, password) {
    try {
      // Simulation de requête API
      const response = await fetch(`${API_BASE_URL}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      if (!response.ok) throw new Error('Identifiants invalides');

      localStorage.setItem('userId', btoa(`${email}:${password}`));
      localStorage.setItem('userEmail', email);
      return true;
    } catch (error) {
      throw error;
    }
  }

  static logout() {
    localStorage.removeItem('userId');
    localStorage.removeItem('userEmail');
  }
}

// api.js
class ApiService {
  static async request(endpoint, method = 'GET', data = null) {
    const config = {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-User-ID': AuthService.userId
      }
    };

    if (data) config.body = JSON.stringify(data);

    try {
      const response = await fetch(`${API_BASE_URL}/${endpoint}`, config);
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Erreur serveur');
      }
      return await response.json();
    } catch (error) {
      throw new Error(`API Error: ${error.message}`);
    }
  }

  static async loadData(entity) {
    return this.request(entity);
  }

  static async saveData(entity, data, id = null) {
    return id 
      ? this.request(`${entity}/${id}`, 'PUT', data)
      : this.request(entity, 'POST', data);
  }

  static async deleteData(entity, id) {
    return this.request(`${entity}/${id}`, 'DELETE');
  }
}

// ui.js
class UI {
  static showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white max-w-xs ${
      isError ? 'bg-red-500' : 'bg-green-500'
    }`;
    toast.textContent = message;
    toast.classList.remove('hidden');
    
    setTimeout(() => toast.classList.add('hidden'), TOAST_DURATION);
  }

  static toggleSection(sectionId) {
    const section = document.getElementById(`${sectionId}Content`);
    section.classList.toggle('hidden');
    document.querySelector(`[data-target="${sectionId}"] .fa-chevron-down`)
      .classList.toggle('rotate-180');
  }

  static async loadForm(entity, data = null) {
    const formContainer = document.getElementById('dynamicFormContainer');
    formContainer.innerHTML = await this.getFormTemplate(entity, data);
    formContainer.classList.add('active');
  }

  static async getFormTemplate(entity, data) {
    // Templates simplifiés - À compléter selon vos besoins
    const templates = {
      clients: /*html*/`
        <form class="entity-form" data-entity="clients">
          <input type="hidden" name="id" value="${data?.id || ''}">
          <div class="form-group">
            <label>Nom</label>
            <input type="text" name="nom" value="${data?.nom || ''}" required>
          </div>
          <button type="submit">${data ? 'Modifier' : 'Créer'}</button>
        </form>
      `,
      // Ajouter les autres templates...
    };
    return templates[entity];
  }
}

// scanner.js
class BarcodeScanner {
  static async startScan() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
      
      const video = document.createElement('video');
      video.srcObject = stream;
      await video.play();
      
      document.getElementById('scannerPreview').appendChild(video);
      document.getElementById('scannerOverlay').classList.remove('hidden');
      
      return new Promise((resolve) => {
        const detector = new BarcodeDetector({ formats: ['ean_13'] });
        const detect = async () => {
          const barcodes = await detector.detect(video);
          if (barcodes.length > 0) {
            this.stopScan(stream);
            resolve(barcodes[0].rawValue);
          }
          requestAnimationFrame(detect);
        };
        detect();
      });
    } catch (error) {
      UI.showToast('Erreur du scanner: ' + error.message, true);
    }
  }

  static stopScan(stream) {
    stream.getTracks().forEach(track => track.stop());
    document.getElementById('scannerOverlay').classList.add('hidden');
  }
}

// app.js
class App {
  static init() {
    this.bindEvents();
    this.checkAuth();
  }

  static checkAuth() {
    if (AuthService.userId) {
      this.loadDashboard();
      document.getElementById('userDisplay').textContent = AuthService.userEmail;
    } else {
      document.getElementById('loginModal').classList.remove('hidden');
    }
  }

  static async loadDashboard() {
    try {
      ENTITIES.forEach(async (entity) => {
        const data = await ApiService.loadData(entity);
        this.renderTable(entity, data);
      });
      // Charger les KPI...
    } catch (error) {
      UI.showToast(error.message, true);
    }
  }

  static renderTable(entity, data) {
    const container = document.getElementById(`${entity}Content`);
    container.innerHTML = /*html*/`
      <table>
        <thead>...</thead>
        <tbody>
          ${data.map(item => /*html*/`
            <tr>
              <td>${item.nom}</td>
              <td>
                <button class="edit-btn" data-id="${item.id}">✏️</button>
                <button class="delete-btn" data-id="${item.id}">🗑️</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  static bindEvents() {
    // Événements généraux
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;
      
      try {
        await AuthService.login(email, password);
        window.location.reload();
      } catch (error) {
        UI.showToast(error.message, true);
      }
    });

    // Gestion des formulaires
    document.addEventListener('submit', async (e) => {
      if (e.target.matches('.entity-form')) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const entity = e.target.dataset.entity;
        
        try {
          await ApiService.saveData(entity, Object.fromEntries(formData), formData.get('id'));
          UI.showToast('Enregistrement réussi !');
          this.loadDashboard();
        } catch (error) {
          UI.showToast(error.message, true);
        }
      }
    });

    // Scanner
    document.getElementById('scanBarcode').addEventListener('click', async () => {
      try {
        const barcode = await BarcodeScanner.startScan();
        document.getElementById('productCode').value = barcode;
      } catch (error) {
        UI.showToast(error.message, true);
      }
    });
  }
}

// Initialisation
document.addEventListener('DOMContentLoaded', () => App.init());
        // Il doit inclure la gestion des formulaires, 
        // les appels API et les interactions utilisateur
    </script>
</body>
</html>
