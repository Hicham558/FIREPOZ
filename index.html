<!DOCTYPE html>
<html>
<head>
    <title>Liste des Produits - Solution Définitive</title>
    <style>
        #products { margin-top: 20px; }
        .product { 
            padding: 15px; 
            border-bottom: 1px solid #eee;
            display: flex;
        }
        .error { 
            color: red; 
            padding: 10px;
            background: #ffeeee;
            border: 1px solid red;
        }
    </style>
</head>
<body>
    <h1>Produits</h1>
    <div id="status">Chargement...</div>
    <div id="products"></div>

    <script>
        const API_URL = 'https://web-production-3b9e.up.railway.app/liste_produits';
        const MAX_RETRIES = 3;
        let retryCount = 0;

        async function fetchWithRetry(url, options = {}, retries = MAX_RETRIES) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        ...(options.headers || {})
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();

            } catch (error) {
                if (retries > 0) {
                    console.warn(`Tentative ${MAX_RETRIES - retries + 1}/${MAX_RETRIES}...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchWithRetry(url, options, retries - 1);
                }
                throw error;
            }
        }

        async function loadProducts() {
            try {
                document.getElementById('status').textContent = 'Chargement...';
                
                // Essai direct
                let data = await fetchWithRetry(API_URL)
                    .catch(() => {
                        console.log('Tentative avec proxy CORS...');
                        return fetchWithRetry(`https://corsproxy.io/?${encodeURIComponent(API_URL)}`);
                    });

                displayProducts(data);
                document.getElementById('status').textContent = '';

            } catch (error) {
                document.getElementById('status').innerHTML = 
                    `<div class="error">
                        <p>Échec du chargement : ${error.message}</p>
                        <button onclick="loadProducts()">Réessayer</button>
                    </div>`;
                console.error('Erreur finale :', error);
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('products');
            container.innerHTML = products.map(p => `
                <div class="product">
                    <div style="flex:1"><strong>${p.DESIGNATION}</strong></div>
                    <div style="flex:1">${p.PRIX} €</div>
                    <div style="flex:1">${p.BAR}</div>
                </div>
            `).join('');
        }

        // Démarrer
        loadProducts();
    </script>
</body>
</html>