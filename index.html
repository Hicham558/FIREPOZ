<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Clients et Fournisseurs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f5f5f5;
    }
    .table-container {
      margin-bottom: 40px;
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-container {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .error {
      color: #721c24;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: none;
    }
    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: none;
    }
    .table {
      font-size: 14px;
    }
    th, td {
      vertical-align: middle;
    }
    @media (max-width: 576px) {
      .table {
        font-size: 12px;
      }
      .btn {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="my-4 text-center">Gestion des Clients et Fournisseurs</h1>

    <!-- Boutons Debug et Sauvegarde -->
    <div class="form-container">
      <div class="d-flex justify-content-between mb-3">
        <button id="btnListerTables" class="btn btn-primary">Lister les tables</button>
        <button id="btnSauvegarder" class="btn btn-secondary">üíæ Sauvegarder gestion.db</button>
      </div>
      <div id="tablesList" class="success"></div>
      <div id="tablesError" class="error"></div>
    </div>

    <!-- Formulaires Clients -->
    <div class="form-container">
      <h2>Gestion des Clients</h2>

      <!-- Ajouter -->
      <form id="formAjouter" class="mb-3">
        <h5>Ajouter un client</h5>
        <div class="mb-2">
          <input type="text" name="nom" placeholder="Nom" class="form-control" required>
        </div>
        <div class="mb-2">
          <input type="text" name="contact" placeholder="Contact (facultatif)" class="form-control">
        </div>
        <div class="mb-2">
          <input type="text" name="adresse" placeholder="Adresse (facultatif)" class="form-control">
        </div>
        <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
        <div id="ajouterResult" class="success"></div>
        <div id="ajouterError" class="error"></div>
      </form>

      <!-- Modifier -->
      <form id="formModifier" class="mb-3">
        <h5>Modifier un client</h5>
        <div class="mb-2">
          <input type="number" name="numero_clt" placeholder="Num√©ro client" class="form-control" required>
        </div>
        <div class="mb-2">
          <input type="text" name="nom" placeholder="Nom" class="form-control" required>
        </div>
        <div class="mb-2">
          <input type="text" name="contact" placeholder="Contact (facultatif)" class="form-control">
        </div>
        <div class="mb-2">
          <input type="text" name="adresse" placeholder="Adresse (facultatif)" class="form-control">
        </div>
        <button type="submit" class="btn btn-warning">‚úèÔ∏è Modifier</button>
        <div id="modifierResult" class="success"></div>
        <div id="modifierError" class="error"></div>
      </form>

      <!-- Supprimer -->
      <form id="formSupprimer">
        <h5>Supprimer un client</h5>
        <div class="mb-2">
          <input type="number" name="numero_clt" placeholder="Num√©ro client" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-danger">üóë Supprimer</button>
        <div id="supprimerResult" class="success"></div>
        <div id="supprimerError" class="error"></div>
      </form>
    </div>

    <!-- Table Clients -->
    <div class="table-container">
      <h2>Clients</h2>
      <div id="clientsError" class="error"></div>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Num√©ro</th>
            <th>Nom</th>
            <th>Solde (‚Ç¨)</th>
            <th>R√©f√©rence</th>
            <th>Contact</th>
            <th>Adresse</th>
          </tr>
        </thead>
        <tbody id="clientsBody"></tbody>
      </table>
    </div>

    <!-- Table Fournisseurs -->
    <div class="table-container">
      <h2>Fournisseurs</h2>
      <div id="fournisseursError" class="error"></div>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Num√©ro</th>
            <th>Nom</th>
            <th>Solde (‚Ç¨)</th>
            <th>R√©f√©rence</th>
            <th>Contact</th>
            <th>Adresse</th>
          </tr>
        </thead>
        <tbody id="fournisseursBody"></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  <script type="module">
    import { fetchApi } from './fetchApi.js';
    import { getDb } from './db.js';

    // Formatage du solde (1234.56 ‚Üí 1 234,56)
    function formatSolde(solde) {
      try {
        const num = parseFloat(solde.replace(',', '.'));
        return isNaN(num) ? '0,00' : num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      } catch {
        return solde || '0,00';
      }
    }

    // Sauvegarder la base dans IndexedDB
    async function saveDbToIndexedDB(db) {
      try {
        console.log("Sauvegarde dans IndexedDB...");
        const dbBinary = db.export();
        const request = indexedDB.open('GestionDB', 1);
        request.onupgradeneeded = event => {
          event.target.result.createObjectStore('databases', { keyPath: 'name' });
        };
        return new Promise((resolve, reject) => {
          request.onsuccess = event => {
            const idb = event.target.result;
            const transaction = idb.transaction(['databases'], 'readwrite');
            const store = transaction.objectStore('databases');
            store.put({ name: 'gestion.db', data: dbBinary });
            transaction.oncomplete = () => {
              console.log("Sauvegarde IndexedDB r√©ussie");
              resolve();
            };
            transaction.onerror = () => reject(new Error('Erreur IndexedDB'));
          };
          request.onerror = () => reject(new Error('Erreur ouverture IndexedDB'));
        });
      } catch (error) {
        console.error("Erreur saveDbToIndexedDB :", error);
        throw error;
      }
    }

    // Charger les clients
    async function loadClients() {
      const clientsError = document.getElementById('clientsError');
      const clientsBody = document.getElementById('clientsBody');
      try {
        console.log("Chargement des clients...");
        const response = await fetchApi('/liste_clients');
        if (!response.ok) throw new Error('Erreur lors du chargement des clients');
        const clients = await response.json();
        console.log("Clients re√ßus :", clients);
        clientsBody.innerHTML = clients.length > 0 ? clients.map(client => `
          <tr>
            <td>${client.numero_clt || '-'}</td>
            <td>${client.nom || '-'}</td>
            <td>${formatSolde(client.solde)}</td>
            <td>${client.reference || '-'}</td>
            <td>${client.contact || '-'}</td>
            <td>${client.adresse || '-'}</td>
          </tr>
        `).join('') : '<tr><td colspan="6" class="text-center">Aucun client trouv√©</td></tr>';
        clientsError.style.display = 'none';
      } catch (error) {
        console.error("Erreur loadClients :", error);
        clientsError.textContent = `Erreur : ${error.message}`;
        clientsError.style.display = 'block';
        clientsBody.innerHTML = '<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>';
      }
    }

    // Charger les fournisseurs
    async function loadFournisseurs() {
      const fournisseursError = document.getElementById('fournisseursError');
      const fournisseursBody = document.getElementById('fournisseursBody');
      try {
        console.log("Chargement des fournisseurs...");
        const response = await fetchApi('/liste_fournisseurs');
        if (!response.ok) throw new Error('Erreur lors du chargement des fournisseurs');
        const fournisseurs = await response.json();
        console.log("Fournisseurs re√ßus :", fournisseurs);
        fournisseursBody.innerHTML = fournisseurs.length > 0 ? fournisseurs.map(fournisseur => `
          <tr>
            <td>${fournisseur.numero_fou || '-'}</td>
            <td>${fournisseur.nom || '-'}</td>
            <td>${formatSolde(fournisseur.solde)}</td>
            <td>${fournisseur.reference || '-'}</td>
            <td>${fournisseur.contact || '-'}</td>
            <td>${fournisseur.adresse || '-'}</td>
          </tr>
        `).join('') : '<tr><td colspan="6" class="text-center">Aucun fournisseur trouv√©</td></tr>';
        fournisseursError.style.display = 'none';
      } catch (error) {
        console.error("Erreur loadFournisseurs :", error);
        fournisseursError.textContent = `Erreur : ${error.message}`;
        fournisseursError.style.display = 'block';
        fournisseursBody.innerHTML = '<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>';
      }
    }

    // Lister les tables
    async function listerTables() {
      const tablesList = document.getElementById('tablesList');
      const tablesError = document.getElementById('tablesError');
      try {
        console.log("Chargement des tables...");
        const response = await fetchApi('/tables');
        if (!response.ok) throw new Error('Erreur lors du chargement des tables');
        const tables = await response.json();
        console.log("Tables re√ßues :", tables);
        tablesList.innerHTML = `<strong>Tables trouv√©es :</strong> ${tables.length > 0 ? tables.join(', ') : 'Aucune table'}`;
        tablesList.style.display = 'block';
        tablesError.style.display = 'none';
      } catch (error) {
        console.error("Erreur listerTables :", error);
        tablesError.textContent = `Erreur : ${error.message}`;
        tablesError.style.display = 'block';
        tablesList.style.display = 'none';
      }
    }

    // Ajouter un client
    document.getElementById('formAjouter').addEventListener('submit', async e => {
      e.preventDefault();
      const ajouterResult = document.getElementById('ajouterResult');
      const ajouterError = document.getElementById('ajouterError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      if (!data.nom.trim()) {
        ajouterError.textContent = 'Erreur : Le nom est obligatoire';
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
        return;
      }
      try {
        console.log("Ajout client :", data);
        const response = await fetchApi('/ajouter_client', { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse ajout :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de l\'ajout');
        ajouterResult.textContent = `${result.statut} (ID: ${result.id}, R√©f√©rence: ${result.reference})`;
        ajouterResult.style.display = 'block';
        ajouterError.style.display = 'none';
        const db = await getDb();
        await saveDbToIndexedDB(db);
        await loadClients();
        e.target.reset();
      } catch (error) {
        console.error("Erreur ajouterClient :", error);
        ajouterError.textContent = `Erreur : ${error.message}`;
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
      }
    });

    // Modifier un client
    document.getElementById('formModifier').addEventListener('submit', async e => {
      e.preventDefault();
      const modifierResult = document.getElementById('modifierResult');
      const modifierError = document.getElementById('modifierError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      const numero = data.numero_clt;
      if (!numero || !data.nom.trim()) {
        modifierError.textContent = 'Erreur : Le num√©ro client et le nom sont obligatoires';
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
        return;
      }
      delete data.numero_clt;
      try {
        console.log("Modification client :", numero, data);
        const response = await fetchApi(`/modifier_client/${numero}`, { method: 'PUT', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse modification :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la modification');
        modifierResult.textContent = result.statut;
        modifierResult.style.display = 'block';
        modifierError.style.display = 'none';
        const db = await getDb();
        await saveDbToIndexedDB(db);
        await loadClients();
        e.target.reset();
      } catch (error) {
        console.error("Erreur modifierClient :", error);
        modifierError.textContent = `Erreur : ${error.message}`;
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
      }
    });

    // Supprimer un client
    document.getElementById('formSupprimer').addEventListener('submit', async e => {
      e.preventDefault();
      const supprimerResult = document.getElementById('supprimerResult');
      const supprimerError = document.getElementById('supprimerError');
      const numero = new FormData(e.target).get('numero_clt');
      if (!numero) {
        supprimerError.textContent = 'Erreur : Le num√©ro client est obligatoire';
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
        return;
      }
      try {
        console.log("Suppression client :", numero);
        const response = await fetchApi(`/supprimer_client/${numero}`, { method: 'DELETE' });
        const result = await response.json();
        console.log("R√©ponse suppression :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la suppression');
        supprimerResult.textContent = result.statut;
        supprimerResult.style.display = 'block';
        supprimerError.style.display = 'none';
        const db = await getDb();
        await saveDbToIndexedDB(db);
        await loadClients();
        e.target.reset();
      } catch (error) {
        console.error("Erreur supprimerClient :", error);
        supprimerError.textContent = `Erreur : ${error.message}`;
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
      }
    });

    // Sauvegarder la base
    document.getElementById('btnSauvegarder').addEventListener('click', async () => {
      try {
        console.log("Sauvegarde de la base...");
        const db = await getDb();
        const dbBinary = db.export();
        const blob = new Blob([dbBinary], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gestion.db';
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('tablesList').textContent = 'Base sauvegard√©e avec succ√®s';
        document.getElementById('tablesList').style.display = 'block';
        document.getElementById('tablesError').style.display = 'none';
      } catch (error) {
        console.error("Erreur sauvegarde :", error);
        document.getElementById('tablesError').textContent = `Erreur lors de la sauvegarde : ${error.message}`;
        document.getElementById('tablesError').style.display = 'block';
        document.getElementById('tablesList').style.display = 'none';
      }
    });

    // Lister les tables
    document.getElementById('btnListerTables').addEventListener('click', listerTables);

    // Charger au d√©marrage
    loadClients();
    loadFournisseurs();
  </script>
</body>
</html>
