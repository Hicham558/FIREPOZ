<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Clients, Fournisseurs, Utilisateurs et Produits</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f5f5f5;
    }
    .table-container {
      margin-bottom: 40px;
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-container {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 40px;
    }
    .error {
      color: #721c24;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: none;
    }
    .success {
      color: #155724;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      display: none;
    }
    .table {
      font-size: 14px;
    }
    th, td {
      vertical-align: middle;
    }
    .section-divider {
      border-top: 2px solid #dee2e6;
      margin: 40px 0;
    }
    @media (max-width: 576px) {
      .table {
        font-size: 12px;
      }
      .btn {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="my-4 text-center">Gestion des Clients, Fournisseurs, Utilisateurs et Produits</h1>

    <!-- Boutons Debug et Sauvegarde -->
    <div class="form-container">
      <div class="d-flex justify-content-between mb-3">
        <button id="btnTest" class="btn btn-info">Tester la connexion</button>
        <button id="btnListerTables" class="btn btn-primary">Lister les tables</button>
        <button id="btnSauvegarder" class="btn btn-secondary">üíæ Sauvegarder gestion.db</button>
      </div>
      <div id="tablesList" class="success"></div>
      <div id="tablesError" class="error"></div>
    </div>

    <!-- Clients -->
    <div id="clients">
      <div class="form-container">
        <h2>Gestion des Clients</h2>

        <!-- Ajouter -->
        <form id="formAjouterClient" class="mb-3">
          <h5>Ajouter un client</h5>
          <div class="mb-2">
            <input type="text" name="nom" placeholder="Nom" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="contact" placeholder="Contact (facultatif)" class="form-control">
          </div>
          <div class="mb-2">
            <input type="text" name="adresse" placeholder="Adresse (facultatif)" class="form-control">
          </div>
          <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
          <div id="ajouterClientResult" class="success"></div>
          <div id="ajouterClientError" class="error"></div>
        </form>

        <!-- Modifier -->
        <form id="formModifierClient" class="mb-3">
          <h5>Modifier un client</h5>
          <div class="mb-2">
            <input type="number" name="numero_clt" placeholder="Num√©ro client" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="nom" placeholder="Nom" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="contact" placeholder="Contact (facultatif)" class="form-control">
          </div>
          <div class="mb-2">
            <input type="text" name="adresse" placeholder="Adresse (facultatif)" class="form-control">
          </div>
          <button type="submit" class="btn btn-warning">‚úèÔ∏è Modifier</button>
          <div id="modifierClientResult" class="success"></div>
          <div id="modifierClientError" class="error"></div>
        </form>

        <!-- Supprimer -->
        <form id="formSupprimerClient">
          <h5>Supprimer un client</h5>
          <div class="mb-2">
            <input type="number" name="numero_clt" placeholder="Num√©ro client" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-danger">üóë Supprimer</button>
          <div id="supprimerClientResult" class="success"></div>
          <div id="supprimerClientError" class="error"></div>
        </form>
      </div>

      <!-- Table Clients -->
      <div class="table-container">
        <h2>Clients</h2>
        <div id="clientsError" class="error"></div>
        <table class="table table-striped table-bordered" id="clientsTable">
          <thead>
            <tr>
              <th>Num√©ro</th>
              <th>Nom</th>
              <th>Solde (‚Ç¨)</th>
              <th>R√©f√©rence</th>
              <th>Contact</th>
              <th>Adresse</th>
            </tr>
          </thead>
          <tbody id="clientsBody"></tbody>
        </table>
      </div>
    </div>

    <hr class="section-divider">

    <!-- Fournisseurs -->
    <div id="fournisseurs">
      <div class="form-container">
        <h2>Gestion des Fournisseurs</h2>

        <!-- Ajouter -->
        <form id="formAjouterFournisseur" class="mb-3">
          <h5>Ajouter un fournisseur</h5>
          <div class="mb-2">
            <input type="text" name="nom" placeholder="Nom" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="contact" placeholder="Contact (facultatif)" class="form-control">
          </div>
          <div class="mb-2">
            <input type="text" name="adresse" placeholder="Adresse (facultatif)" class="form-control">
          </div>
          <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
          <div id="ajouterFournisseurResult" class="success"></div>
          <div id="ajouterFournisseurError" class="error"></div>
        </form>

        <!-- Modifier -->
        <form id="formModifierFournisseur" class="mb-3">
          <h5>Modifier un fournisseur</h5>
          <div class="mb-2">
            <input type="number" name="numero_fou" placeholder="Num√©ro fournisseur" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="nom" placeholder="Nom" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="contact" placeholder="Contact (facultatif)" class="form-control">
          </div>
          <div class="mb-2">
            <input type="text" name="adresse" placeholder="Adresse (facultatif)" class="form-control">
          </div>
          <button type="submit" class="btn btn-warning">‚úèÔ∏è Modifier</button>
          <div id="modifierFournisseurResult" class="success"></div>
          <div id="modifierFournisseurError" class="error"></div>
        </form>

        <!-- Supprimer -->
        <form id="formSupprimerFournisseur">
          <h5>Supprimer un fournisseur</h5>
          <div class="mb-2">
            <input type="number" name="numero_fou" placeholder="Num√©ro fournisseur" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-danger">üóë Supprimer</button>
          <div id="supprimerFournisseurResult" class="success"></div>
          <div id="supprimerFournisseurError" class="error"></div>
        </form>
      </div>

      <!-- Table Fournisseurs -->
      <div class="table-container">
        <h2>Fournisseurs</h2>
        <div id="fournisseursError" class="error"></div>
        <table class="table table-striped table-bordered" id="fournisseursTable">
          <thead>
            <tr>
              <th>Num√©ro</th>
              <th>Nom</th>
              <th>Solde (‚Ç¨)</th>
              <th>R√©f√©rence</th>
              <th>Contact</th>
              <th>Adresse</th>
            </tr>
          </thead>
          <tbody id="fournisseursBody"></tbody>
        </table>
      </div>
    </div>

    <hr class="section-divider">

    <!-- Utilisateurs -->
    <div id="utilisateurs">
      <div class="form-container">
        <h2>Gestion des Utilisateurs</h2>

        <!-- Ajouter -->
        <form id="formAjouterUtilisateur" class="mb-3">
          <h5>Ajouter un utilisateur</h5>
          <div class="mb-2">
            <input type="text" name="nom" placeholder="Nom" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="password" name="password2" placeholder="Mot de passe" class="form-control" required>
          </div>
          <div class="mb-2">
            <select name="statue" class="form-control" required>
              <option value="" disabled selected>S√©lectionner un statut</option>
              <option value="admin">Admin</option>
              <option value="emplo">Employ√©</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
          <div id="ajouterUtilisateurResult" class="success"></div>
          <div id="ajouterUtilisateurError" class="error"></div>
        </form>

        <!-- Modifier -->
        <form id="formModifierUtilisateur" class="mb-3">
          <h5>Modifier un utilisateur</h5>
          <div class="mb-2">
            <input type="number" name="numero_util" placeholder="Num√©ro utilisateur" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="nom" placeholder="Nom" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="password" name="password2" placeholder="Mot de passe (facultatif)" class="form-control">
          </div>
          <div class="mb-2">
            <select name="statue" class="form-control" required>
              <option value="" disabled selected>S√©lectionner un statut</option>
              <option value="admin">Admin</option>
              <option value="emplo">Employ√©</option>
            </select>
          </div>
          <button type="submit" class="btn btn-warning">‚úèÔ∏è Modifier</button>
          <div id="modifierUtilisateurResult" class="success"></div>
          <div id="modifierUtilisateurError" class="error"></div>
        </form>

        <!-- Supprimer -->
        <form id="formSupprimerUtilisateur">
          <h5>Supprimer un utilisateur</h5>
          <div class="mb-2">
            <input type="number" name="numero_util" placeholder="Num√©ro utilisateur" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-danger">üóë Supprimer</button>
          <div id="supprimerUtilisateurResult" class="success"></div>
          <div id="supprimerUtilisateurError" class="error"></div>
        </form>
      </div>

      <!-- Table Utilisateurs -->
      <div class="table-container">
        <h2>Utilisateurs</h2>
        <div id="utilisateursError" class="error"></div>
        <table class="table table-striped table-bordered" id="utilisateursTable">
          <thead>
            <tr>
              <th>Num√©ro</th>
              <th>Nom</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody id="utilisateursBody"></tbody>
        </table>
      </div>
    </div>

    <hr class="section-divider">

    <!-- Produits -->
    <div id="produits">
      <div class="form-container">
        <h2>Gestion des Produits</h2>

        <!-- Ajouter -->
        <form id="formAjouterItem" class="mb-3">
          <h5>Ajouter un produit</h5>
          <div class="mb-2">
            <input type="text" name="designation" placeholder="D√©signation" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="bar" placeholder="Code-barres (facultatif)" class="form-control">
          </div>
          <div class="mb-2">
            <input type="number" name="qte" placeholder="Quantit√©" class="form-control" required min="0">
          </div>
          <div class="mb-2">
            <input type="text" name="prix" placeholder="Prix (ex: 10,00)" class="form-control" required pattern="\d+,\d{2}">
          </div>
          <div class="mb-2">
            <input type="text" name="prixba" placeholder="Prix de base (facultatif, ex: 8,00)" class="form-control" pattern="\d+,\d{2}|^$">
          </div>
          <div class="mb-2">
            <input type="text" name="ref" placeholder="R√©f√©rence (facultatif)" class="form-control">
          </div>
          <button type="submit" class="btn btn-success">‚ûï Ajouter</button>
          <div id="ajouterItemResult" class="success"></div>
          <div id="ajouterItemError" class="error"></div>
        </form>

        <!-- Modifier -->
        <form id="formModifierItem" class="mb-3">
          <h5>Modifier un produit</h5>
          <div class="mb-2">
            <input type="number" name="numero_item" placeholder="Num√©ro produit" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="designation" placeholder="D√©signation" class="form-control" required>
          </div>
          <div class="mb-2">
            <input type="text" name="bar" placeholder="Code-barres (facultatif)" class="form-control">
          </div>
          <div class="mb-2">
            <input type="number" name="qte" placeholder="Quantit√©" class="form-control" required min="0">
          </div>
          <div class="mb-2">
            <input type="text" name="prix" placeholder="Prix (ex: 10,00)" class="form-control" required pattern="\d+,\d{2}">
          </div>
          <div class="mb-2">
            <input type="text" name="prixba" placeholder="Prix de base (facultatif, ex: 8,00)" class="form-control" pattern="\d+,\d{2}|^$">
          </div>
          <div class="mb-2">
            <input type="text" name="ref" placeholder="R√©f√©rence (facultatif)" class="form-control">
          </div>
          <button type="submit" class="btn btn-warning">‚úèÔ∏è Modifier</button>
          <div id="modifierItemResult" class="success"></div>
          <div id="modifierItemError" class="error"></div>
        </form>

        <!-- Supprimer -->
        <form id="formSupprimerItem">
          <h5>Supprimer un produit</h5>
          <div class="mb-2">
            <input type="number" name="numero_item" placeholder="Num√©ro produit" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-danger">üóë Supprimer</button>
          <div id="supprimerItemResult" class="success"></div>
          <div id="supprimerItemError" class="error"></div>
        </form>
      </div>

      <!-- Table Produits -->
      <div class="table-container">
        <h2>Produits</h2>
        <div id="produitsError" class="error"></div>
        <table class="table table-striped table-bordered" id="produitsTable">
          <thead>
            <tr>
              <th>Num√©ro</th>
              <th>D√©signation</th>
              <th>Code-barres</th>
              <th>Quantit√©</th>
              <th>Prix (‚Ç¨)</th>
              <th>Prix de base (‚Ç¨)</th>
              <th>R√©f√©rence</th>
            </tr>
          </thead>
          <tbody id="produitsBody"></tbody>
        </table>
      </div>
    </div>

    <hr class="section-divider">

    <!-- Dashboard -->
    <div id="dashboard">
      <div class="form-container">
        <h2 class="text-xl font-semibold mb-4">Dashboard</h2>
        <div class="mb-4">
          <label for="dashboardPeriod" class="mr-2">P√©riode :</label>
          <select id="dashboardPeriod" onchange="loadDashboard()" class="form-control">
            <option value="day">Jour</option>
            <option value="week">Semaine</option>
          </select>
        </div>
        <div id="dashboardError" class="error mb-4"></div>
        <div id="dashboardKpis" class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-gray-200 p-4 rounded">
            <h3 class="font-semibold">CA Total</h3>
            <p id="totalCa">0,00</p>
          </div>
          <div class="bg-gray-200 p-4 rounded">
            <h3 class="font-semibold">Profit Total</h3>
            <p id="totalProfit">0,00</p>
          </div>
          <div class="bg-gray-200 p-4 rounded">
            <h3 class="font-semibold">Nombre de Ventes</h3>
            <p id="salesCount">0</p>
          </div>
          <div class="bg-gray-200 p-4 rounded">
            <h3 class="font-semibold">Articles en Stock Bas</h3>
            <p id="lowStockItems">0</p>
          </div>
          <div class="bg-gray-200 p-4 rounded">
            <h3 class="font-semibold">Top Client</h3>
            <p id="topClient">N/A (0,00)</p>
          </div>
        </div>
        <canvas id="salesChart" class="w-full h-64"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  <script type="module">
    console.log("Chargement des modules...");
    import { fetchApi } from './fetchapi.js';
    import { getDb } from './db.js';
    import { 
      listeTables, 
      listeClients, 
      listeFournisseurs, 
      listeUtilisateurs, 
      listeProduits, 
      ajouterClient, 
      ajouterFournisseur, 
      ajouterUtilisateur, 
      ajouterItem, 
      modifierClient, 
      modifierFournisseur, 
      modifierUtilisateur, 
      modifierItem, 
      supprimerClient, 
      supprimerFournisseur, 
      supprimerUtilisateur, 
      supprimerItem, 
      dashboard 
    } from './apiRoutes.js';

    // Formatage du solde et prix (1234.56 ‚Üí 1 234,56)
    function formatSolde(solde) {
      try {
        const num = parseFloat(solde.replace(',', '.'));
        return isNaN(num) ? '0,00' : num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      } catch {
        return solde || '0,00';
      }
    }

    // Charger les clients
    async function loadClients() {
      const clientsError = document.getElementById('clientsError');
      const clientsBody = document.getElementById('clientsBody');
      try {
        console.log("Chargement des clients...");
        const response = await fetchApi('/liste_clients');
        if (!response.ok) throw new Error('Erreur lors du chargement des clients');
        const clients = await response.json();
        console.log("Clients re√ßus :", clients);
        clientsBody.innerHTML = clients.length > 0 ? clients.map(client => `
          <tr>
            <td>${client.numero_clt || '-'}</td>
            <td>${client.nom || '-'}</td>
            <td>${formatSolde(client.solde)}</td>
            <td>${client.reference || '-'}</td>
            <td>${client.contact || '-'}</td>
            <td>${client.adresse || '-'}</td>
          </tr>
        `).join('') : '<tr><td colspan="6" class="text-center">Aucun client trouv√©</td></tr>';
        clientsError.style.display = 'none';
      } catch (error) {
        console.error("Erreur loadClients :", error);
        clientsError.textContent = `Erreur : ${error.message}`;
        clientsError.style.display = 'block';
        clientsBody.innerHTML = '<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>';
      }
    }

    // Charger les fournisseurs
    async function loadFournisseurs() {
      const fournisseursError = document.getElementById('fournisseursError');
      const fournisseursBody = document.getElementById('fournisseursBody');
      try {
        console.log("Chargement des fournisseurs...");
        const response = await fetchApi('/liste_fournisseurs');
        if (!response.ok) throw new Error('Erreur lors du chargement des fournisseurs');
        const fournisseurs = await response.json();
        console.log("Fournisseurs re√ßus :", fournisseurs);
        fournisseursBody.innerHTML = fournisseurs.length > 0 ? fournisseurs.map(fournisseur => `
          <tr>
            <td>${fournisseur.numero_fou || '-'}</td>
            <td>${fournisseur.nom || '-'}</td>
            <td>${formatSolde(fournisseur.solde)}</td>
            <td>${fournisseur.reference || '-'}</td>
            <td>${fournisseur.contact || '-'}</td>
            <td>${fournisseur.adresse || '-'}</td>
          </tr>
        `).join('') : '<tr><td colspan="6" class="text-center">Aucun fournisseur trouv√©</td></tr>';
        fournisseursError.style.display = 'none';
      } catch (error) {
        console.error("Erreur loadFournisseurs :", error);
        fournisseursError.textContent = `Erreur : ${error.message}`;
        fournisseursError.style.display = 'block';
        fournisseursBody.innerHTML = '<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>';
      }
    }

    // Charger les utilisateurs
    async function loadUtilisateurs() {
      const utilisateursError = document.getElementById('utilisateursError');
      const utilisateursBody = document.getElementById('utilisateursBody');
      try {
        console.log("Chargement des utilisateurs...");
        const response = await fetchApi('/liste_utilisateurs');
        if (!response.ok) throw new Error('Erreur lors du chargement des utilisateurs');
        const utilisateurs = await response.json();
        console.log("Utilisateurs re√ßus :", utilisateurs);
        utilisateursBody.innerHTML = utilisateurs.length > 0 ? utilisateurs.map(utilisateur => `
          <tr>
            <td>${utilisateur.numero || '-'}</td>
            <td>${utilisateur.nom || '-'}</td>
            <td>${utilisateur.statut || '-'}</td>
          </tr>
        `).join('') : '<tr><td colspan="3" class="text-center">Aucun utilisateur trouv√©</td></tr>';
        utilisateursError.style.display = 'none';
      } catch (error) {
        console.error("Erreur loadUtilisateurs :", error);
        utilisateursError.textContent = `Erreur : ${error.message}`;
        utilisateursError.style.display = 'block';
        utilisateursBody.innerHTML = '<tr><td colspan="3" class="text-center">Erreur de chargement</td></tr>';
      }
    }

    // Charger les produits
    async function loadProduits() {
      const produitsError = document.getElementById('produitsError');
      const produitsBody = document.getElementById('produitsBody');
      try {
        console.log("Chargement des produits...");
        const response = await fetchApi('/liste_produits');
        if (!response.ok) throw new Error('Erreur lors du chargement des produits');
        const produits = await response.json();
        console.log("Produits re√ßus :", produits);
        produitsBody.innerHTML = produits.length > 0 ? produits.map(produit => `
          <tr>
            <td>${produit.numero_item || '-'}</td>
            <td>${produit.designation || '-'}</td>
            <td>${produit.bar || '-'}</td>
            <td>${produit.qte || 0}</td>
            <td>${formatSolde(produit.prix)}</td>
            <td>${formatSolde(produit.prixba)}</td>
            <td>${produit.ref || '-'}</td>
          </tr>
        `).join('') : '<tr><td colspan="7" class="text-center">Aucun produit trouv√©</td></tr>';
        produitsError.style.display = 'none';
      } catch (error) {
        console.error("Erreur loadProduits :", error);
        produitsError.textContent = `Erreur : ${error.message}`;
        produitsError.style.display = 'block';
        produitsBody.innerHTML = '<tr><td colspan="7" class="text-center">Erreur de chargement</td></tr>';
      }
    }

    // Charger le dashboard
    let salesChart = null;
    async function loadDashboard() {
      const dashboardError = document.getElementById('dashboardError');
      try {
        const period = document.getElementById('dashboardPeriod').value;
        console.log("Chargement du dashboard avec period:", period);
        const response = await fetchApi(`/dashboard?period=${period}`);
        const result = await response.json();
        if (result.erreur) throw new Error(result.erreur);
        console.log("Donn√©es dashboard re√ßues:", result);

        document.getElementById('totalCa').textContent = formatSolde(result.data.total_ca.toString());
        document.getElementById('totalProfit').textContent = formatSolde(result.data.total_profit.toString());
        document.getElementById('salesCount').textContent = result.data.sales_count;
        document.getElementById('lowStockItems').textContent = result.data.low_stock_items;
        document.getElementById('topClient').textContent = `${result.data.top_client.name} (${formatSolde(result.data.top_client.ca.toString())})`;

        const ctx = document.getElementById('salesChart').getContext('2d');
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: result.data.chart_data.labels,
            datasets: [{
              label: 'CA Quotidien',
              data: result.data.chart_data.values,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true }
            }
          }
        });

        dashboardError.style.display = 'none';
      } catch (error) {
        console.error("Erreur loadDashboard:", error);
        dashboardError.textContent = `Erreur : ${error.message}`;
        dashboardError.style.display = 'block';
      }
    }

    // Lister les tables
    async function listerTables() {
      const tablesList = document.getElementById('tablesList');
      const tablesError = document.getElementById('tablesError');
      try {
        console.log("Chargement des tables...");
        const response = await fetchApi('/tables');
        if (!response.ok) throw new Error('Erreur lors du chargement des tables');
        const tables = await response.json();
        console.log("Tables re√ßues :", tables);
        tablesList.innerHTML = `<strong>Tables trouv√©es :</strong> ${tables.length > 0 ? tables.join(', ') : 'Aucune table'}`;
        tablesList.style.display = 'block';
        tablesError.style.display = 'none';
      } catch (error) {
        console.error("Erreur listerTables :", error);
        tablesError.textContent = `Erreur : ${error.message}`;
        tablesError.style.display = 'block';
        tablesList.style.display = 'none';
      }
    }

    // Test de connexion
    document.getElementById('btnTest').addEventListener('click', async () => {
      const tablesList = document.getElementById('tablesList');
      const tablesError = document.getElementById('tablesError');
      try {
        console.log("Test de connexion...");
        const response = await fetchApi('/test');
        const data = await response.json();
        console.log("R√©sultat test :", data);
        tablesList.textContent = data.message;
        tablesList.style.display = 'block';
        tablesError.style.display = 'none';
      } catch (error) {
        console.error("Erreur test :", error);
        tablesError.textContent = `Erreur : ${error.message}`;
        tablesError.style.display = 'block';
        tablesList.style.display = 'none';
      }
    });

    // Ajouter un client
    document.getElementById('formAjouterClient').addEventListener('submit', async e => {
      e.preventDefault();
      const ajouterResult = document.getElementById('ajouterClientResult');
      const ajouterError = document.getElementById('ajouterClientError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      if (!data.nom.trim()) {
        ajouterError.textContent = 'Erreur : Le nom est obligatoire';
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
        return;
      }
      try {
        console.log("Ajout client :", data);
        const response = await fetchApi('/ajouter_client', { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse ajout client :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de l\'ajout');
        ajouterResult.textContent = `${result.statut} (ID: ${result.id}, R√©f√©rence: ${result.reference})`;
        ajouterResult.style.display = 'block';
        ajouterError.style.display = 'none';
        await loadClients();
        e.target.reset();
      } catch (error) {
        console.error("Erreur ajouterClient :", error);
        ajouterError.textContent = `Erreur : ${error.message}`;
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
      }
    });

    // Modifier un client
    document.getElementById('formModifierClient').addEventListener('submit', async e => {
      e.preventDefault();
      const modifierResult = document.getElementById('modifierClientResult');
      const modifierError = document.getElementById('modifierClientError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      const numero = data.numero_clt;
      if (!numero || !data.nom.trim()) {
        modifierError.textContent = 'Erreur : Le num√©ro client et le nom sont obligatoires';
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
        return;
      }
      delete data.numero_clt;
      try {
        console.log("Modification client :", numero, data);
        const response = await fetchApi(`/modifier_client/${numero}`, { method: 'PUT', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse modification client :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la modification');
        modifierResult.textContent = result.statut;
        modifierResult.style.display = 'block';
        modifierError.style.display = 'none';
        await loadClients();
        e.target.reset();
      } catch (error) {
        console.error("Erreur modifierClient :", error);
        modifierError.textContent = `Erreur : ${error.message}`;
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
      }
    });

    // Supprimer un client
    document.getElementById('formSupprimerClient').addEventListener('submit', async e => {
      e.preventDefault();
      const supprimerResult = document.getElementById('supprimerClientResult');
      const supprimerError = document.getElementById('supprimerClientError');
      const numero = new FormData(e.target).get('numero_clt');
      if (!numero) {
        supprimerError.textContent = 'Erreur : Le num√©ro client est obligatoire';
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
        return;
      }
      try {
        console.log("Suppression client :", numero);
        const response = await fetchApi(`/supprimer_client/${numero}`, { method: 'DELETE' });
        const result = await response.json();
        console.log("R√©ponse suppression client :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la suppression');
        supprimerResult.textContent = result.statut;
        supprimerResult.style.display = 'block';
        supprimerError.style.display = 'none';
        await loadClients();
        e.target.reset();
      } catch (error) {
        console.error("Erreur supprimerClient :", error);
        supprimerError.textContent = `Erreur : ${error.message}`;
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
      }
    });

    // Ajouter un fournisseur
    document.getElementById('formAjouterFournisseur').addEventListener('submit', async e => {
      e.preventDefault();
      const ajouterResult = document.getElementById('ajouterFournisseurResult');
      const ajouterError = document.getElementById('ajouterFournisseurError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      if (!data.nom.trim()) {
        ajouterError.textContent = 'Erreur : Le nom est obligatoire';
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
        return;
      }
      try {
        console.log("Ajout fournisseur :", data);
        const response = await fetchApi('/ajouter_fournisseur', { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse ajout fournisseur :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de l\'ajout');
        ajouterResult.textContent = `${result.statut} (ID: ${result.id}, R√©f√©rence: ${result.reference})`;
        ajouterResult.style.display = 'block';
        ajouterError.style.display = 'none';
        await loadFournisseurs();
        e.target.reset();
      } catch (error) {
        console.error("Erreur ajouterFournisseur :", error);
        ajouterError.textContent = `Erreur : ${error.message}`;
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
      }
    });

    // Modifier un fournisseur
    document.getElementById('formModifierFournisseur').addEventListener('submit', async e => {
      e.preventDefault();
      const modifierResult = document.getElementById('modifierFournisseurResult');
      const modifierError = document.getElementById('modifierFournisseurError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      const numero = data.numero_fou;
      if (!numero || !data.nom.trim()) {
        modifierError.textContent = 'Erreur : Le num√©ro fournisseur et le nom sont obligatoires';
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
        return;
      }
      delete data.numero_fou;
      try {
        console.log("Modification fournisseur :", numero, data);
        const response = await fetchApi(`/modifier_fournisseur/${numero}`, { method: 'PUT', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse modification fournisseur :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la modification');
        modifierResult.textContent = result.statut;
        modifierResult.style.display = 'block';
        modifierError.style.display = 'none';
        await loadFournisseurs();
        e.target.reset();
      } catch (error) {
        console.error("Erreur modifierFournisseur :", error);
        modifierError.textContent = `Erreur : ${error.message}`;
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
      }
    });

    // Supprimer un fournisseur
    document.getElementById('formSupprimerFournisseur').addEventListener('submit', async e => {
      e.preventDefault();
      const supprimerResult = document.getElementById('supprimerFournisseurResult');
      const supprimerError = document.getElementById('supprimerFournisseurError');
      const numero = new FormData(e.target).get('numero_fou');
      if (!numero) {
        supprimerError.textContent = 'Erreur : Le num√©ro fournisseur est obligatoire';
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
        return;
      }
      try {
        console.log("Suppression fournisseur :", numero);
        const response = await fetchApi(`/supprimer_fournisseur/${numero}`, { method: 'DELETE' });
        const result = await response.json();
        console.log("R√©ponse suppression fournisseur :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la suppression');
        supprimerResult.textContent = result.statut;
        supprimerResult.style.display = 'block';
        supprimerError.style.display = 'none';
        await loadFournisseurs();
        e.target.reset();
      } catch (error) {
        console.error("Erreur supprimerFournisseur :", error);
        supprimerError.textContent = `Erreur : ${error.message}`;
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
      }
    });

    // Ajouter un utilisateur
    document.getElementById('formAjouterUtilisateur').addEventListener('submit', async e => {
      e.preventDefault();
      const ajouterResult = document.getElementById('ajouterUtilisateurResult');
      const ajouterError = document.getElementById('ajouterUtilisateurError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      if (!data.nom.trim() || !data.password2 || !data.statue) {
        ajouterError.textContent = 'Erreur : Le nom, le mot de passe et le statut sont obligatoires';
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
        return;
      }
      try {
        console.log("Ajout utilisateur :", data);
        const response = await fetchApi('/ajouter_utilisateur', { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse ajout utilisateur :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de l\'ajout');
        ajouterResult.textContent = `${result.statut} (ID: ${result.id})`;
        ajouterResult.style.display = 'block';
        ajouterError.style.display = 'none';
        await loadUtilisateurs();
        e.target.reset();
      } catch (error) {
        console.error("Erreur ajouterUtilisateur :", error);
        ajouterError.textContent = `Erreur : ${error.message}`;
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
      }
    });

    // Modifier un utilisateur
    document.getElementById('formModifierUtilisateur').addEventListener('submit', async e => {
      e.preventDefault();
      const modifierResult = document.getElementById('modifierUtilisateurResult');
      const modifierError = document.getElementById('modifierUtilisateurError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      const numero = data.numero_util;
      if (!numero || !data.nom.trim() || !data.statue) {
        modifierError.textContent = 'Erreur : Le num√©ro utilisateur, le nom et le statut sont obligatoires';
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
        return;
      }
      delete data.numero_util;
      try {
        console.log("Modification utilisateur :", numero, data);
        const response = await fetchApi(`/modifier_utilisateur/${numero}`, { method: 'PUT', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse modification utilisateur :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la modification');
        modifierResult.textContent = result.statut;
        modifierResult.style.display = 'block';
        modifierError.style.display = 'none';
        await loadUtilisateurs();
        e.target.reset();
      } catch (error) {
        console.error("Erreur modifierUtilisateur :", error);
        modifierError.textContent = `Erreur : ${error.message}`;
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
      }
    });

    // Supprimer un utilisateur
    document.getElementById('formSupprimerUtilisateur').addEventListener('submit', async e => {
      e.preventDefault();
      const supprimerResult = document.getElementById('supprimerUtilisateurResult');
      const supprimerError = document.getElementById('supprimerUtilisateurError');
      const numero = new FormData(e.target).get('numero_util');
      if (!numero) {
        supprimerError.textContent = 'Erreur : Le num√©ro utilisateur est obligatoire';
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
        return;
      }
      try {
        console.log("Suppression utilisateur :", numero);
        const response = await fetchApi(`/supprimer_utilisateur/${numero}`, { method: 'DELETE' });
        const result = await response.json();
        console.log("R√©ponse suppression utilisateur :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la suppression');
        supprimerResult.textContent = result.statut;
        supprimerResult.style.display = 'block';
        supprimerError.style.display = 'none';
        await loadUtilisateurs();
        e.target.reset();
      } catch (error) {
        console.error("Erreur supprimerUtilisateur :", error);
        supprimerError.textContent = `Erreur : ${error.message}`;
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
      }
    });

    // Ajouter un produit
    document.getElementById('formAjouterItem').addEventListener('submit', async e => {
      e.preventDefault();
      const ajouterResult = document.getElementById('ajouterItemResult');
      const ajouterError = document.getElementById('ajouterItemError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      if (!data.designation.trim() || !data.qte || !data.prix || !/^\d+,\d{2}$/.test(data.prix)) {
        ajouterError.textContent = 'Erreur : La d√©signation, la quantit√© et un prix valide (ex: 10,00) sont obligatoires';
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
        return;
      }
      if (data.prixba && !/^\d+,\d{2}$/.test(data.prixba)) {
        ajouterError.textContent = 'Erreur : Le prix de base doit √™tre valide (ex: 8,00) ou vide';
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
        return;
      }
      try {
        console.log("Ajout produit :", data);
        const response = await fetchApi('/ajouter_item', { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse ajout produit :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de l\'ajout');
        ajouterResult.textContent = `${result.statut} (ID: ${result.id}, Code-barres: ${result.bar})`;
        ajouterResult.style.display = 'block';
        ajouterError.style.display = 'none';
        await loadProduits();
        e.target.reset();
      } catch (error) {
        console.error("Erreur ajouterItem :", error);
        ajouterError.textContent = `Erreur : ${error.message}`;
        ajouterError.style.display = 'block';
        ajouterResult.style.display = 'none';
      }
    });

    // Modifier un produit
    document.getElementById('formModifierItem').addEventListener('submit', async e => {
      e.preventDefault();
      const modifierResult = document.getElementById('modifierItemResult');
      const modifierError = document.getElementById('modifierItemError');
      const data = Object.fromEntries(new FormData(e.target).entries());
      const numero = data.numero_item;
      if (!numero || !data.designation.trim() || !data.qte || !data.prix || !/^\d+,\d{2}$/.test(data.prix)) {
        modifierError.textContent = 'Erreur : Le num√©ro produit, la d√©signation, la quantit√© et un prix valide (ex: 10,00) sont obligatoires';
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
        return;
      }
      if (data.prixba && !/^\d+,\d{2}$/.test(data.prixba)) {
        modifierError.textContent = 'Erreur : Le prix de base doit √™tre valide (ex: 8,00) ou vide';
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
        return;
      }
      delete data.numero_item;
      try {
        console.log("Modification produit :", numero, data);
        const response = await fetchApi(`/modifier_item/${numero}`, { method: 'PUT', body: JSON.stringify(data) });
        const result = await response.json();
        console.log("R√©ponse modification produit :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la modification');
        modifierResult.textContent = result.statut;
        modifierResult.style.display = 'block';
        modifierError.style.display = 'none';
        await loadProduits();
        e.target.reset();
      } catch (error) {
        console.error("Erreur modifierItem :", error);
        modifierError.textContent = `Erreur : ${error.message}`;
        modifierError.style.display = 'block';
        modifierResult.style.display = 'none';
      }
    });

    // Supprimer un produit
    document.getElementById('formSupprimerItem').addEventListener('submit', async e => {
      e.preventDefault();
      const supprimerResult = document.getElementById('supprimerItemResult');
      const supprimerError = document.getElementById('supprimerItemError');
      const numero = new FormData(e.target).get('numero_item');
      if (!numero) {
        supprimerError.textContent = 'Erreur : Le num√©ro produit est obligatoire';
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
        return;
      }
      try {
        console.log("Suppression produit :", numero);
        const response = await fetchApi(`/supprimer_item/${numero}`, { method: 'DELETE' });
        const result = await response.json();
        console.log("R√©ponse suppression produit :", result);
        if (!response.ok) throw new Error(result.erreur || 'Erreur lors de la suppression');
        supprimerResult.textContent = result.statut;
        supprimerResult.style.display = 'block';
        supprimerError.style.display = 'none';
        await loadProduits();
        e.target.reset();
      } catch (error) {
        console.error("Erreur supprimerItem :", error);
        supprimerError.textContent = `Erreur : ${error.message}`;
        supprimerError.style.display = 'block';
        supprimerResult.style.display = 'none';
      }
    });

    // Sauvegarder la base
    document.getElementById('btnSauvegarder').addEventListener('click', async () => {
      try {
        console.log("Sauvegarde de la base...");
        const db = await getDb();
        const dbBinary = db.export();
        const blob = new Blob([dbBinary], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gestion.db';
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('tablesList').textContent = 'Base sauvegard√©e avec succ√®s';
        document.getElementById('tablesList').style.display = 'block';
        document.getElementById('tablesError').style.display = 'none';
      } catch (error) {
        console.error("Erreur sauvegarde :", error);
        document.getElementById('tablesError').textContent = `Erreur lors de la sauvegarde : ${error.message}`;
        document.getElementById('tablesError').style.display = 'block';
        document.getElementById('tablesList').style.display = 'none';
      }
    });

    // Lister les tables
    document.getElementById('btnListerTables').addEventListener('click', listerTables);

    // G√©rer les param√®tres URL
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const nom = urlParams.get('nom');
      const contact = urlParams.get('contact');
      const adresse = urlParams.get('adresse');
      if (nom || contact || adresse) {
        const form = document.getElementById('formAjouterClient');
        form.querySelector('input[name="nom"]').value = nom || '';
        form.querySelector('input[name="contact"]').value = contact || '';
        form.querySelector('input[name="adresse"]').value = adresse || '';
      }
    });

    // Initialisation
    console.log("Initialisation de l'application...");
    Promise.all([
      loadClients(),
      loadFournisseurs(),
      loadUtilisateurs(),
      loadProduits(),
      loadDashboard()
    ]).catch(error => {
      console.error("Erreur lors de l'initialisation :", error);
      document.getElementById('tablesError').textContent = `Erreur d'initialisation : ${error.message}`;
      document.getElementById('tablesError').style.display = 'block';
    });
  </script>
</body>
</html>
