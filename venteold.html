<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FirePoz - Gestion des Catégories</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f6f9;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .sidebar {
            background-color: #2c3e50;
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
        }
        .sidebar a {
            color: #ecf0f1;
            padding: 15px 20px;
            display: block;
            text-decoration: none;
            transition: background 0.3s;
        }
        .sidebar a:hover {
            background-color: #34495e;
        }
        .sidebar a.active {
            background-color: #3498db;
        }
        .content {
            margin-left: 250px;
            padding: 20px;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover {
            background-color: #f9fafb;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-secondary {
            background-color: #7f8c8d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #6d7676;
        }
        select, input[type="text"] {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h2 class="text-white text-2xl font-bold px-6 mb-6">FirePoz</h2>
        <a href="#" class="active"><i class="fas fa-folder mr-2"></i>Catégories</a>
        <a href="#"><i class="fas fa-box mr-2"></i>Produits</a>
        <a href="#"><i class="fas fa-users mr-2"></i>Clients</a>
        <a href="#"><i class="fas fa-truck mr-2"></i>Fournisseurs</a>
        <a href="#"><i class="fas fa-shopping-cart mr-2"></i>Ventes</a>
        <a href="#"><i class="fas fa-user mr-2"></i>Utilisateurs</a>
    </div>

    <!-- Main Content -->
    <div class="content">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Gestion des Catégories</h1>

        <!-- Bouton Ajouter Catégorie -->
        <button class="btn btn-primary mb-4" onclick="openAddCategoryModal()">
            <i class="fas fa-plus mr-2"></i>Ajouter une catégorie
        </button>

        <!-- Tableau des Catégories -->
        <div class="table-container">
            <table id="categoriesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesBody"></tbody>
            </table>
        </div>

        <!-- Section Assignation et Affichage des Produits -->
        <h2 class="text-2xl font-bold my-6 text-gray-800">Assigner des Produits et Afficher par Catégorie</h2>
        <div class="mb-4">
            <label for="categorySelect" class="block text-gray-700 mb-2">Sélectionner une catégorie :</label>
            <select id="categorySelect" onchange="fetchProductsByCategory()" class="mb-4">
                <option value="">Sans catégorie</option>
            </select>
        </div>
        <button class="btn btn-primary mb-4" onclick="openAssignProductModal()">
            <i class="fas fa-link mr-2"></i>Assigner un produit
        </button>

        <!-- Tableau des Produits par Catégorie -->
        <div class="table-container">
            <table id="productsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Désignation</th>
                        <th>Catégorie</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Ajouter/Modifier Catégorie -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('categoryModal')">&times;</span>
            <h2 id="categoryModalTitle" class="text-xl font-bold mb-4"></h2>
            <form id="categoryForm">
                <div class="mb-4">
                    <label for="description" class="block text-gray-700">Description</label>
                    <input type="text" id="description" name="description_c" required class="mt-1">
                </div>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-secondary ml-2" onclick="closeModal('categoryModal')">Annuler</button>
            </form>
        </div>
    </div>

    <!-- Modal Assignation Produit -->
    <div id="assignProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignProductModal')">&times;</span>
            <h2 class="text-xl font-bold mb-4">Assigner un produit à une catégorie</h2>
            <form id="assignProductForm">
                <div class="mb-4">
                    <label for="productSelect" class="block text-gray-700">Produit</label>
                    <select id="productSelect" name="numero_item" required class="mt-1"></select>
                </div>
                <div class="mb-4">
                    <label for="categoryAssignSelect" class="block text-gray-700">Catégorie</label>
                    <select id="categoryAssignSelect" name="numero_categorie" class="mt-1">
                        <option value="">Sans catégorie</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Assigner</button>
                <button type="button" class="btn btn-secondary ml-2" onclick="closeModal('assignProductModal')">Annuler</button>
            </form>
        </div>
    </div>

    <script>
        const apiBaseUrl = 'https://your-api-url'; // Remplacez par l'URL de votre API
        const userId = 'your-user-id'; // Remplacez par l'ID utilisateur réel
        let currentCategoryId = null;

        // Ouvre un modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Ferme un modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'categoryModal') {
                document.getElementById('categoryForm').reset();
                currentCategoryId = null;
            }
            if (modalId === 'assignProductModal') {
                document.getElementById('assignProductForm').reset();
            }
        }

        // Récupère les catégories
        async function fetchCategories() {
            try {
                const response = await fetch(`${apiBaseUrl}/liste_categories`, {
                    headers: { 'X-User-ID': userId }
                });
                const categories = await response.json();
                const tbody = document.getElementById('categoriesBody');
                tbody.innerHTML = '';

                // Mettre à jour le select des catégories
                const categorySelect = document.getElementById('categorySelect');
                const categoryAssignSelect = document.getElementById('categoryAssignSelect');
                categorySelect.innerHTML = '<option value="">Sans catégorie</option>';
                categoryAssignSelect.innerHTML = '<option value="">Sans catégorie</option>';

                categories.forEach(category => {
                    // Tableau des catégories
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${category.numer_categorie}</td>
                        <td>${category.description_c}</td>
                        <td>
                            <button class="btn btn-primary mr-2" onclick="openEditCategoryModal(${category.numer_categorie}, '${category.description_c}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteCategory(${category.numer_categorie})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Options pour les selects
                    const option = document.createElement('option');
                    option.value = category.numer_categorie;
                    option.textContent = category.description_c;
                    categorySelect.appendChild(option.cloneNode(true));
                    categoryAssignSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des catégories');
            }
        }

        // Récupère les produits pour assignation
        async function fetchProductsForAssignation() {
            try {
                const response = await fetch(`${apiBaseUrl}/liste_produits`, {
                    headers: { 'X-User-ID': userId }
                });
                const products = await response.json();
                const productSelect = document.getElementById('productSelect');
                productSelect.innerHTML = '';

                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.NUMERO_ITEM;
                    option.textContent = product.DESIGNATION;
                    productSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des produits');
            }
        }

        // Ouvre le modal pour ajouter une catégorie
        function openAddCategoryModal() {
            document.getElementById('categoryModalTitle').textContent = 'Ajouter une catégorie';
            openModal('categoryModal');
            document.getElementById('categoryForm').onsubmit = addCategory;
        }

        // Ouvre le modal pour modifier une catégorie
        function openEditCategoryModal(id, description) {
            currentCategoryId = id;
            document.getElementById('categoryModalTitle').textContent = 'Modifier la catégorie';
            document.getElementById('description').value = description;
            openModal('categoryModal');
            document.getElementById('categoryForm').onsubmit = editCategory;
        }

        // Ajoute une catégorie
        async function addCategory(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('categoryForm'));
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${apiBaseUrl}/ajouter_categorie`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Catégorie ajoutée avec succès');
                    closeModal('categoryModal');
                    fetchCategories();
                } else {
                    alert(result.erreur || 'Erreur lors de l\'ajout');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout de la catégorie');
            }
        }

        // Modifie une catégorie
        async function editCategory(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('categoryForm'));
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch(`${apiBaseUrl}/modifier_categorie/${currentCategoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Catégorie modifiée avec succès');
                    closeModal('categoryModal');
                    fetchCategories();
                } else {
                    alert(result.erreur || 'Erreur lors de la modification');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la modification de la catégorie');
            }
        }

        // Supprime une catégorie
        async function deleteCategory(id) {
            if (!confirm('Voulez-vous vraiment supprimer cette catégorie ?')) return;

            try {
                const response = await fetch(`${apiBaseUrl}/supprimer_categorie/${id}`, {
                    method: 'DELETE',
                    headers: { 'X-User-ID': userId }
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Catégorie supprimée avec succès');
                    fetchCategories();
                } else {
                    alert(result.erreur || 'Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression de la catégorie');
            }
        }

        // Ouvre le modal pour assigner un produit
        function openAssignProductModal() {
            fetchProductsForAssignation();
            openModal('assignProductModal');
            document.getElementById('assignProductForm').onsubmit = assignProduct;
        }

        // Assigne un produit à une catégorie
        async function assignProduct(event) {
            event.preventDefault();
            const formData = new FormData(document.getElementById('assignProductForm'));
            const data = Object.fromEntries(formData);
            if (!data.numero_categorie) data.numero_categorie = null;

            try {
                const response = await fetch(`${apiBaseUrl}/assigner_categorie`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Produit assigné avec succès');
                    closeModal('assignProductModal');
                    fetchProductsByCategory();
                } else {
                    alert(result.erreur || 'Erreur lors de l\'assignation');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'assignation du produit');
            }
        }

        // Récupère les produits par catégorie
        async function fetchProductsByCategory() {
            const categoryId = document.getElementById('categorySelect').value;
            try {
                const response = await fetch(`${apiBaseUrl}/liste_produits_par_categorie${categoryId ? `?numero_categorie=${categoryId}` : ''}`, {
                    headers: { 'X-User-ID': userId }
                });
                const result = await response.json();
                const tbody = document.getElementById('productsBody');
                tbody.innerHTML = '';

                let products = [];
                if (categoryId) {
                    result.categories.forEach(category => {
                        category.produits.forEach(product => {
                            products.push({
                                ...product,
                                categoryDescription: category.description_c
                            });
                        });
                    });
                } else {
                    products = result.produits;
                }

                products.forEach(product => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${product.numero_item}</td>
                        <td>${product.designation}</td>
                        <td>${product.categoryDescription || 'Sans catégorie'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="openAssignProductModalForProduct(${product.numero_item})">
                                <i class="fas fa-link"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des produits');
            }
        }

        // Ouvre le modal d'assignation avec le produit présélectionné
        function openAssignProductModalForProduct(productId) {
            fetchProductsForAssignation().then(() => {
                document.getElementById('productSelect').value = productId;
                openModal('assignProductModal');
                document.getElementById('assignProductForm').onsubmit = assignProduct;
            });
        }

        // Initialisation
        window.onload = () => {
            fetchCategories();
            fetchProductsByCategory();
        };
    </script>
</body>
</html>