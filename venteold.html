<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Catégories et Produits</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        .category-grid-header, .category-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            padding: 0.5rem;
            align-items: center;
        }
        .category-grid-header {
            font-weight: bold;
            background-color: #f3f4f6;
        }
        .stock-rupture {
            color: red;
        }
        .stock-faible {
            color: orange;
        }
        .btn-disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            z-index: 100;
            display: none;
        }
        .toast-success {
            background-color: #10b981;
        }
        .toast-error {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Gestion des Catégories et Produits</h1>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

        <!-- Category Management -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-2">Catégories</h2>
            <button onclick="openAddCategoryModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition mb-4">
                <i class="fas fa-plus"></i> Ajouter une catégorie
            </button>
            <div id="categoryList" class="bg-white rounded-lg shadow p-4"></div>
        </div>

        <!-- Product Management -->
        <div>
            <h2 class="text-xl font-semibold mb-2">Produits</h2>
            <div class="flex space-x-4 mb-4">
                <input id="searchProduct" type="text" placeholder="Rechercher un produit..." class="border p-2 rounded w-full" oninput="filterProducts()">
                <select id="categoryFilter" onchange="filterProducts()" class="border p-2 rounded w-48">
                    <option value="all">Toutes les catégories</option>
                    <option value="none">Non assignés</option>
                </select>
                <span id="productCount" class="hidden text-gray-500"></span>
            </div>
            <table class="w-full bg-white rounded-lg shadow">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Action</th>
                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Désignation</th>
                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Stock</th>
                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Catégorie</th>
                        <th class="px-6 py-3 text-left text-sm font-medium text-gray-500">Prix</th>
                    </tr>
                </thead>
                <tbody id="productsList"></tbody>
            </table>
        </div>

        <!-- Add Category Modal -->
        <div id="addCategoryModal" class="modal">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-4">Ajouter une catégorie</h2>
                <form onsubmit="addCategory(event)">
                    <div class="mb-4">
                        <label for="newCategoryDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <input id="newCategoryDescription" type="text" class="border p-2 rounded w-full" required>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeAddCategoryModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Annuler</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Ajouter</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Category Modal -->
        <div id="editCategoryModal" class="modal">
            <div class="modal-content">
                <h2 class="text-lg font-semibold mb-4">Modifier la catégorie</h2>
                <form onsubmit="saveEditedCategory(event)">
                    <input id="editCategoryId" type="hidden">
                    <div class="mb-4">
                        <label for="editCategoryDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <input id="editCategoryDescription" type="text" class="border p-2 rounded w-full" required>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeEditCategoryModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Annuler</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://hicham03041979.onrender.com';
        let categoriesCache = [];
        let produitsCache = [];

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        async function loadCategoryList() {
            const [categoriesResponse, productsResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/liste_categories`, { headers: { 'X-User-ID': userId } }),
                fetch(`${API_BASE_URL}/liste_produits`, { headers: { 'X-User-ID': userId } })
            ]);
            if (!categoriesResponse.ok || !productsResponse.ok) {
                throw new Error(`Erreur: ${await (categoriesResponse.ok ? productsResponse : categoriesResponse).text()}`);
            }
            const categories = await categoriesResponse.json();
            console.log('Réponse API /liste_categories:', categories);
            const normalizedCategories = categories.map(category => ({
                numero_categorie: category.numer_categorie || null,
                description_c: category.description_c || 'N/A'
            }));
            console.log('Catégories normalisées:', normalizedCategories);
            const products = await productsResponse.json();
            const normalizedProducts = products.map(p => ({
                ...p,
                numero_categorie: p.numero_categorie || p.NUMERO_CATEGORIE || null,
                numero_item: parseInt(p.numero_item || p.NUMERO_ITEM),
                designation: p.designation || p.DESIGNATION || 'N/A',
                qte: parseFloat(p.qte || p.QTE || 0),
                prix: parseFloat(p.prix || p.PRIX || 0),
                prixba: parseFloat(p.prixba || p.PRIXBA || 0)
            }));
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            const unassignedProducts = normalizedProducts.filter(p => p.numero_categorie === null);
            const unassignedDiv = document.createElement('div');
            unassignedDiv.className = 'mb-4';
            unassignedDiv.innerHTML = `
                <h3 class="font-semibold mb-2">Produits non assignés</h3>
                <div class="pl-4">
                    ${unassignedProducts.length ? unassignedProducts.map(product => `
                        <div class="flex justify-between items-center mb-1">
                            <span>${product.designation}</span>
                            <select onchange="assignCategory(${product.numero_item}, this.value)" class="border p-1 rounded w-40">
                                <option value="">Assigner à...</option>
                                ${normalizedCategories.map(cat => `<option value="${cat.numero_categorie}">${cat.description_c}</option>`).join('')}
                            </select>
                        </div>
                    `).join('') : '<p class="text-gray-500">Aucun produit non assigné</p>'}
                </div>
            `;
            categoryList.appendChild(unassignedDiv);

            const headerDiv = document.createElement('div');
            headerDiv.className = 'category-grid-header';
            headerDiv.innerHTML = `
                <div>Nom de la catégorie</div>
                <div>Nombre d'articles</div>
                <div>Actions</div>
            `;
            categoryList.appendChild(headerDiv);

           ascribe
            normalizedCategories.forEach(category => {
                if (!category.numero_categorie) {
                    console.error('Catégorie sans numero_categorie:', category);
                    return;
                }
                const productCount = normalizedProducts.filter(p => p.numero_categorie === category.numero_categorie).length;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-grid';
                categoryDiv.innerHTML = `
                    <div>${category.description_c}</div>
                    <div>${productCount}</div>
                    <div class="flex space-x-2">
                        <button onclick="editCategory(${category.numero_categorie}, '${category.description_c.replace(/'/g, "\\'")}')" class="bg-blue-600 text-white px-2 py-1 rounded-md hover:bg-blue-700 transition">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory(${category.numero_categorie})" class="bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                categoryList.appendChild(categoryDiv);

                const assignedProducts = normalizedProducts.filter(p => p.numero_categorie === category.numero_categorie);
                const productsDiv = document.createElement('div');
                productsDiv.className = 'pl-4 mt-2 mb-4';
                productsDiv.innerHTML = `
                    <h4 class="text-sm font-medium mb-2">Produits assignés</h4>
                    ${assignedProducts.length ? assignedProducts.map(product => `
                        <div class="flex justify-between items-center mb-1">
                            <span>${product.designation}</span>
                            <button onclick="unassignProduct(${product.numero_item})" class="bg-gray-600 text-white px-2 py-1 rounded-md hover:bg-gray-700 transition">
                                <i class="fas fa-times"></i> Retirer
                            </button>
                        </div>
                    `).join('') : '<p class="text-gray-500">Aucun produit assigné</p>'}
                `;
                categoryList.appendChild(productsDiv);
            });
            produitsCache = normalizedProducts;
            await chargerCategories();
            filterProducts();
        } catch (error) {
            showToast(`Erreur chargement catégories: ${error.message}`, true);
        }
    }

    async function chargerCategories() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Veuillez vous connecter pour voir les catégories', true);
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/liste_categories`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
            const categories = await response.json();
            console.log('Réponse API /liste_categories:', categories);
            categoriesCache = categories.map(category => ({
                numero_categorie: category.numer_categorie || null,
                description_c: category.description_c || 'N/A'
            }));
            console.log('categoriesCache mis à jour:', categoriesCache);
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="all">Toutes les catégories</option><option value="none">Non assignés</option>';
            categoriesCache.forEach(category => {
                if (!category.numero_categorie) {
                    console.error('Catégorie sans numero_categorie:', category);
                    return;
                }
                const option = document.createElement('option');
                option.value = category.numero_categorie;
                option.textContent = category.description_c;
                categoryFilter.appendChild(option);
            });
        } catch (error) {
            showToast('Erreur chargement catégories: ' + error.message, true);
        }
    }

    async function chargerProduits() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Veuillez vous connecter pour voir les produits', true);
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/liste_produits`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
            const products = await response.json();
            produitsCache = products.map(p => ({
                ...p,
                numero_categorie: p.numero_categorie || p.NUMERO_CATEGORIE || null,
                numero_item: parseInt(p.numero_item || p.NUMERO_ITEM),
                designation: p.designation || p.DESIGNATION || 'N/A',
                qte: parseFloat(p.qte || p.QTE || 0),
                prix: parseFloat(p.prix || p.PRIX || 0),
                prixba: parseFloat(p.prixba || p.PRIXBA || 0)
            }));
            filterProducts();
        } catch (error) {
            showToast('Erreur chargement produits: ' + error.message, true);
        }
    }

    function openAddCategoryModal() {
        document.getElementById('addCategoryModal').style.display = 'flex';
    }

    function closeAddCategoryModal() {
        document.getElementById('addCategoryModal').style.display = 'none';
        document.getElementById('newCategoryDescription').value = '';
    }

    async function addCategory(event) {
        event.preventDefault();
        const userId = localStorageഗ
            showToast('Veuillez vous connecter', true);
            return;
        }
        const description = document.getElementById('newCategoryDescription').value.trim();
        if (!description) {
            showToast('Description requise', true);
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/ajouter_categorie`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify({ description_c: description })
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
            closeAddCategoryModal();
            await loadCategoryList();
            showToast('Catégorie ajoutée avec succès');
        } catch (error) {
            showToast(`Erreur ajout catégorie: ${error.message}`, true);
        }
    }

    function editCategory(numeroCategorie, description) {
        console.log('Modification catégorie:', numeroCategorie, description);
        if (!numeroCategorie || isNaN(numeroCategorie)) {
            showToast('ID de catégorie invalide', true);
            return;
        }
        document.getElementById('editCategoryId').value = numeroCategorie;
        document.getElementById('editCategoryDescription').value = description;
        document.getElementById('editCategoryModal').style.display = 'flex';
    }

    function closeEditCategoryModal() {
        document.getElementById('editCategoryModal').style.display = 'none';
        document.getElementById('editCategoryDescription').value = '';
    }

    async function saveEditedCategory(event) {
        event.preventDefault();
        const userId = localStorage.getItem('userId');
        const numeroCategorie = document.getElementById('editCategoryId').value;
        const description = document.getElementById('editCategoryDescription').value.trim();
        if (!userId) {
            showToast('Veuillez vous connecter', true);
            return;
        }
        if (!numeroCategorie || isNaN(numeroCategorie)) {
            showToast('ID de catégorie invalide', true);
            return;
        }
        if (!description) {
            showToast('Description requise', true);
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/modifier_categorie/${numeroCategorie}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify({ description_c: description })
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
            closeEditCategoryModal();
            await loadCategoryList();
            showToast('Catégorie modifiée avec succès');
        } catch (error) {
            showToast(`Erreur modification catégorie: ${error.message}`, true);
        }
    }

    async function deleteCategory(numeroCategorie) {
        console.log('Suppression catégorie:', numeroCategorie);
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Veuillez vous connecter', true);
            return;
        }
        if (!numeroCategorie || isNaN(numeroCategorie)) {
            showToast('ID de catégorie invalide', true);
            return;
        }
        if (!confirm('Voulez-vous vraiment supprimer cette catégorie ? Les produits assignés seront désassignés.')) {
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/supprimer_categorie/${numeroCategorie}`, {
                method: 'DELETE',
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erreur ${response.status}: ${errorText}`);
            }
            await chargerCategories();
            await loadCategoryList();
            showToast('Catégorie supprimée avec succès');
        } catch (error) {
            console.error('Erreur suppression:', error);
            showToast(`Erreur suppression catégorie: ${error.message}`, true);
        }
    }

    async function assignCategory(numeroItem, numeroCategorie) {
        console.log('Assignation:', numeroItem, numeroCategorie);
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Veuillez vous connecter', true);
            return;
        }
        if (!numeroCategorie || isNaN(numeroCategorie)) {
            showToast('Veuillez sélectionner une catégorie valide', true);
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/assigner_categorie`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify({
                    numero_item: parseInt(numeroItem),
                    numero_categorie: parseInt(numeroCategorie)
                })
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
            await chargerProduits();
            await loadCategoryList();
            showToast('Produit assigné à la catégorie');
        } catch (error) {
            showToast(`Erreur assignation catégorie: ${error.message}`, true);
        }
    }

    async function unassignProduct(numeroItem) {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Veuillez vous connecter', true);
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/assigner_categorie`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify({
                    numero_item: parseInt(numeroItem),
                    numero_categorie: null
                })
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
            await chargerProduits();
            await loadCategoryList();
            showToast('Produit désassigné avec succès');
        } catch (error) {
            showToast(`Erreur désassignation: ${error.message}`, true);
        }
    }

    function filterProducts() {
        const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const tbody = document.getElementById('productsList');
        const countElement = document.getElementById('productCount');
        let filteredProducts = produitsCache.filter(p =>
            p.designation.toLowerCase().includes(searchTerm)
        );
        if (categoryFilter !== 'all') {
            filteredProducts = filteredProducts.filter(p =>
                categoryFilter === 'none' ? p.numero_categorie === null : p.numero_categorie === parseInt(categoryFilter)
            );
        }
        if (filteredProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Aucun produit trouvé</td></tr>';
            countElement.textContent = '0';
            countElement.classList.remove('hidden');
            return;
        }
        tbody.innerHTML = '';
        filteredProducts.forEach(produit => {
            const stockStatus = produit.qte <= 0 ? 'Rupture' : produit.qte <= 5 ? 'Stock faible' : produit.qte.toFixed(2);
            const stockClass = produit.qte <= 0 ? 'stock-rupture' : produit.qte <= 5 ? 'stock-faible' : '';
            const buttonDisabled = produit.qte <= 0 ? 'btn-disabled' : '';
            const buttonAttrs = produit.qte <= 0 ? 'disabled' : '';
            const category = categoriesCache.find(c => c.numero_categorie === produit.numero_categorie)?.description_c || 'Non assigné';
            const tr = document.createElement('tr');
            tr.className = `hover:bg-gray-50 ${stockClass}`;
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <button onclick="selectProduct(${produit.numero_item}, ${produit.prix}, ${produit.prixba}, ${produit.qte}, '${produit.designation.replace(/'/g, "\\'")}')" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition duration-300 ${buttonDisabled}" ${buttonAttrs}>
                        <i class="fas fa-plus"></i>
                    </button>
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">${produit.designation}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stockStatus}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${category}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.prix.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
        countElement.textContent = filteredProducts.length;
        countElement.classList.remove('hidden');
    }

    function selectProduct(numeroItem, prix, prixba, qte, designation) {
        // Fonction à implémenter selon vos besoins
        console.log(`Produit sélectionné: ${designation} (ID: ${numeroItem}, Prix: ${prix}, Prix BA: ${prixba}, Qté: ${qte})`);
        showToast(`Produit ${designation} sélectionné`);
    }

    // Initialisation
    window.onload = async () => {
        await chargerCategories();
        await chargerProduits();
        await loadCategoryList();
    };
    </script>
</body>
</html>