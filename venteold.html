<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Commerciale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes user { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes countPulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes kpiPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes clientPulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
        .animate-pulse { animation: pulse 2s infinite ease-in-out; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .animate-kpi-pop { animation: kpiPop 0.5s ease-out forwards; }
        .top-client-updated { animation: clientPulse 0.6s ease-in-out; }
        #clientsSection { animation-delay: 0.2s; }
        #fournisseursSection { animation-delay: 0.4s; }
        #productsSection { animation-delay: 0.6s; }
        #utilisateursSection { animation-delay: 0.8s; }
        footer { animation-delay: 1.2s; }
        #scannerPreview { width: 100%; max-width: 300px; height: 200px; border: 2px solid #e5e7eb; margin-bottom: 1rem; display: none; background: #000; }
        .user-anim { animation: userPulse 1.5s infinite ease-in-out; }
        .count-anim { animation: countPulse 1.5s infinite ease-in-out; }
        .small-email { font-size: 0.75rem; line-height: 1rem; }
        .kpi-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .kpi-card:hover { transform: scale(1.03); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .kpi-section { transition: opacity 0.5s ease; }
        .kpi-updated { animation: pulse 0.5s ease-in-out; }
        .dynamic-icon { transition: color 0.3s ease; }
        .chart-container { animation-delay: 1s; }
        #kpiSection {
            border-bottom: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        #kpiSection:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .kpi-card {
            border-left: 4px solid #4F46E5;
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
        }
        .fixed-buttons {
            position: sticky;
            top: 64px;
            z-index: 9;
            background: #f3f4f6;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .table-container {
            max-height: 350px;
            overflow-y: auto;
            position: relative;
        }
        .table-container table {
            width: 100%;
        }
        .table-container thead {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Formulaire de connexion -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 hidden">
        <form id="loginForm" class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Connexion</h2>
            <p class="text-sm text-red-500 mb-4">⚠️ Le mot de passe ne doit pas être celui de votre email.</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Adresse Email*</label>
                <input type="email" id="userEmail" name="username" autocomplete="username" class="w-full px-3 py-2 border rounded-md" placeholder="Entrez votre email" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe*</label>
                <input type="password" id="userPassword" name="password" autocomplete="current-password" class="w-full px-3 py-2 border rounded-md" placeholder="Entrez votre mot de passe" required>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="submit" onclick="loginWithCredentials(event)" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Se connecter
                </button>
            </div>
        </form>
    </div>

    <!-- Menu de navigation -->
    <nav class="bg-indigo-600 text-white p-4 fixed w-full top-0 z-10 shadow-md animate-slide-in">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-fire mr-2 text-amber-400 animate-pulse"></i> FirePoz
                </h1>
                <span id="userDisplay" class="small-email user-anim hidden"></span>
            </div>
            <div class="space-x-4 flex items-center">
                <a href="page1.html" class="hover:text-indigo-200 transition flex items-center">
                    <i class="fas fa-barcode mr-1"></i> Scanner Produit
                </a>
                <button id="loginLogoutButton" onclick="loginLogout()" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition flex items-center">
                    <i class="fas fa-sign-out-alt mr-1"></i>Déconnexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="container mx-auto px-4 py-16 mt-16">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-indigo-700">KHsphers software</h1>
            <p class="text-gray-600 flex items-center">
                <i class="fas fa-database mr-2 text-indigo-500"></i> Fueled by PostgreSQL
            </p>
        </header>

        <!-- Boutons Vente et Achat fixés -->
        <div class="fixed-buttons flex">
            <a href="vente.html" class="w-1/2 bg-green-600 text-white py-6 flex items-center justify-center hover:bg-green-700 transition-all duration-300 transform hover:scale-105 animate-pulse">
                <i class="fas fa-shopping-cart text-4xl mr-3"></i>
                <span class="text-2xl font-semibold">Vente</span>
            </a>
            <a href="achat.html" class="w-1/2 bg-blue-600 text-white py-6 flex items-center justify-center hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 animate-pulse">
                <i class="fas fa-box-open text-4xl mr-3"></i>
                <span class="text-2xl font-semibold">Achat</span>
            </a>
        </div>

        <!-- Section KPI améliorée -->
        <div id="kpiSection" class="w-full bg-gradient-to-r from-indigo-100 to-white shadow-lg rounded-lg p-4 mb-8 z-10 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-indigo-500 animate-pulse"></i> Tableau de Bord
                </h2>
                <select id="kpiPeriod" class="border p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-sm">
                    <option value="day">Aujourd'hui</option>
                    <option value="week">Cette Semaine</option>
                </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="caIcon" class="fas fa-money-bill-wave mr-1 text-green-500 dynamic-icon"></i> Chiffre d'Affaires
                    </h3>
                    <p id="totalCA" class="text-lg font-bold text-indigo-600">0.00 DA</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="profitIcon" class="fas fa-chart-pie mr-1 text-blue-500 dynamic-icon"></i> Bénéfice Total
                    </h3>
                    <p id="totalProfit" class="text-lg font-bold text-indigo-600">0.00 DA</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="salesIcon" class="fas fa-shopping-cart mr-1 text-yellow-500 dynamic-icon"></i> Ventes
                    </h3>
                    <p id="salesCount" class="text-lg font-bold text-indigo-600">0</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="stockIcon" class="fas fa-exclamation-triangle mr-1 text-red-500 dynamic-icon"></i> Ruptures
                    </h3>
                    <p id="lowStockItems" class="text-lg font-bold text-indigo-600">0</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24 col-span-2 sm:col-span-1 lg:col-span-2">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="clientIcon" class="fas fa-user-check mr-1 text-purple-500 dynamic-icon"></i> Top Client
                    </h3>
                    <p id="topClient" class="text-sm font-bold text-indigo-600 overflow-hidden text-ellipsis whitespace-nowrap" title="N/A">N/A</p>
                    <p id="topClientCA" class="text-xs text-gray-500">0.00 DA</p>
                </div>
            </div>
        </div>

        <!-- Graphique en dessous -->
        <div class="w-full bg-white p-4 rounded-lg shadow-md animate-fade-in chart-container mt-4">
            <h3 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
                <i class="fas fa-chart-area mr-2 text-indigo-500"></i> Évolution du Chiffre d'Affaires
            </h3>
            <canvas id="caChart" height="100"></canvas>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Gestion Clients -->
            <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="clientsSection">
                <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('clientsSection')">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-users mr-2 text-indigo-500"></i> Gestion Clients
                        <span id="clientCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim hidden">0</span>
                    </h2>
                    <button class="text-gray-600 hover:text-gray-800 transition">
                        <i class="fas fa-chevron-down" id="clientsChevron"></i>
                    </button>
                </div>
                <div class="p-6 hidden" id="clientsContent">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="searchClient" placeholder="Rechercher des clients..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleClientForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Ajouter
                            </button>
                        </div>
                    </div>

                    <div id="clientForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium mb-3">Nouveau Client</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                                <input type="text" id="clientNom" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                                <input type="text" id="clientContact" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                                <input type="text" id="clientAdresse" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Solde*</label>
                                <input type="number" id="clientSolde" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="resetClientForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-times mr-2"></i>Annuler
                            </button>
                            <button onclick="saveClient()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Solde</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gestion Fournisseurs -->
            <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="fournisseursSection">
                <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('fournisseursSection')">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-truck mr-2 text-indigo-500"></i> Gestion Fournisseurs
                        <span id="fournisseurCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim hidden">0</span>
                    </h2>
                    <button class="text-gray-600 hover:text-gray-800 transition">
                        <i class="fas fa-chevron-down" id="fournisseursChevron"></i>
                    </button>
                </div>
                <div class="p-6 hidden" id="fournisseursContent">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="searchFournisseur" placeholder="Rechercher des fournisseurs..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleFournisseurForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Ajouter
                            </button>
                        </div>
                    </div>

                    <div id="fournisseurForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium mb-3">Nouveau Fournisseur</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                                <input type="text" id="fournisseurNom" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                                <input type="text" id="fournisseurContact" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                                <input type="text" id="fournisseurAdresse" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Solde*</.Concurrent

System: Voici le HTML modifié selon vos spécifications, sans le script, avec les colonnes ID invisibles, les actions "Modifier" et "Supprimer" ajoutées pour les grilles Clients, Fournisseurs et Produits, et les formulaires pour Clients et Fournisseurs limités aux champs demandés (Nom, Contact, Adresse, Solde), avec la Référence gérée côté Flask :

```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Commerciale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes user { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes countPulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes kpiPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes clientPulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
        .animate-pulse { animation: pulse 2s infinite ease-in-out; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .animate-kpi-pop { animation: kpiPop 0.5s ease-out forwards; }
        .top-client-updated { animation: clientPulse 0.6s ease-in-out; }
        #clientsSection { animation-delay: 0.2s; }
        #fournisseursSection { animation-delay: 0.4s; }
        #productsSection { animation-delay: 0.6s; }
        #utilisateursSection { animation-delay: 0.8s; }
        footer { animation-delay: 1.2s; }
        #scannerPreview { width: 100%; max-width: 300px; height: 200px; border: 2px solid #e5e7eb; margin-bottom: 1rem; display: none; background: #000; }
        .user-anim { animation: userPulse 1.5s infinite ease-in-out; }
        .count-anim { animation: countPulse 1.5s infinite ease-in-out; }
        .small-email { font-size: 0.75rem; line-height: 1rem; }
        .kpi-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .kpi-card:hover { transform: scale(1.03); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .kpi-section { transition: opacity 0.5s ease; }
        .kpi-updated { animation: pulse 0.5s ease-in-out; }
        .dynamic-icon { transition: color 0.3s ease; }
        .chart-container { animation-delay: 1s; }
        #kpiSection {
            border-bottom: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        #kpiSection:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .kpi-card {
            border-left: 4px solid #4F46E5;
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
        }
        .fixed-buttons {
            position: sticky;
            top: 64px;
            z-index: 9;
            background: #f3f4f6;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .table-container {
            max-height: 350px;
            overflow-y: auto;
            position: relative;
        }
        .table-container table {
            width: 100%;
        }
        .table-container thead {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 1;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Formulaire de connexion -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 hidden">
        <form id="loginForm" class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Connexion</h2>
            <p class="text-sm text-red-500 mb-4">⚠️ Le mot de passe ne doit pas être celui de votre email.</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Adresse Email*</label>
                <input type="email" id="userEmail" name="username" autocomplete="username" class="w-full px-3 py-2 border rounded-md" placeholder="Entrez votre email" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe*</label>
                <input type="password" id="userPassword" name="password" autocomplete="current-password" class="w-full px-3 py-2 border rounded-md" placeholder="Entrez votre mot de passe" required>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="submit" onclick="loginWithCredentials(event)" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Se connecter
                </button>
            </div>
        </form>
    </div>

    <!-- Menu de navigation -->
    <nav class="bg-indigo-600 text-white p-4 fixed w-full top-0 z-10 shadow-md animate-slide-in">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-fire mr-2 text-amber-400 animate-pulse"></i> FirePoz
                </h1>
                <span id="userDisplay" class="small-email user-anim hidden"></span>
            </div>
            <div class="space-x-4 flex items-center">
                <a href="page1.html" class="hover:text-indigo-200 transition flex items-center">
                    <i class="fas fa-barcode mr-1"></i> Scanner Produit
                </a>
                <button id="loginLogoutButton" onclick="loginLogout()" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition flex items-center">
                    <i class="fas fa-sign-out-alt mr-1"></i>Déconnexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="container mx-auto px-4 py-16 mt-16">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-indigo-700">KHsphers software</h1>
            <p class="text-gray-600 flex items-center">
                <i class="fas fa-database mr-2 text-indigo-500"></i> Fueled by PostgreSQL
            </p>
        </header>

        <!-- Boutons Vente et Achat fixés -->
        <div class="fixed-buttons flex">
            <a href="vente.html" class="w-1/2 bg-green-600 text-white py-6 flex items-center justify-center hover:bg-green-700 transition-all duration-300 transform hover:scale-105 animate-pulse">
                <i class="fas fa-shopping-cart text-4xl mr-3"></i>
                <span class="text-2xl font-semibold">Vente</span>
            </a>
            <a href="achat.html" class="w-1/2 bg-blue-600 text-white py-6 flex items-center justify-center hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 animate-pulse">
                <i class="fas fa-box-open text-4xl mr-3"></i>
                <span class="text-2xl font-semibold">Achat</span>
            </a>
        </div>

        <!-- Section KPI améliorée -->
        <div id="kpiSection" class="w-full bg-gradient-to-r from-indigo-100 to-white shadow-lg rounded-lg p-4 mb-8 z-10 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-indigo-500 animate-pulse"></i> Tableau de Bord
                </h2>
                <select id="kpiPeriod" class="border p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white text-sm">
                    <option value="day">Aujourd'hui</option>
                    <option value="week">Cette Semaine</option>
                </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="caIcon" class="fas fa-money-bill-wave mr-1 text-green-500 dynamic-icon"></i> Chiffre d'Affaires
                    </h3>
                    <p id="totalCA" class="text-lg font-bold text-indigo-600">0.00 DA</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="profitIcon" class="fas fa-chart-pie mr-1 text-blue-500 dynamic-icon"></i> Bénéfice Total
                    </h3>
                    <p id="totalProfit" class="text-lg font-bold text-indigo-600">0.00 DA</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="salesIcon" class="fas fa-shopping-cart mr-1 text-yellow-500 dynamic-icon"></i> Ventes
                    </h3>
                    <p id="salesCount" class="text-lg font-bold text-indigo-600">0</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="stockIcon" class="fas fa-exclamation-triangle mr-1 text-red-500 dynamic-icon"></i> Ruptures
                    </h3>
                    <p id="lowStockItems" class="text-lg font-bold text-indigo-600">0</p>
                </div>
                <div class="kpi-card bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 flex flex-col items-center justify-center text-center h-24 col-span-2 sm:col-span-1 lg:col-span-2">
                    <h3 class="text-xs font-medium text-gray-600 flex items-center">
                        <i id="clientIcon" class="fas fa-user-check mr-1 text-purple-500 dynamic-icon"></i> Top Client
                    </h3>
                    <p id="topClient" class="text-sm font-bold text-indigo-600 overflow-hidden text-ellipsis whitespace-nowrap" title="N/A">N/A</p>
                    <p id="topClientCA" class="text-xs text-gray-500">0.00 DA</p>
                </div>
            </div>
        </div>

        <!-- Graphique en dessous -->
        <div class="w-full bg-white p-4 rounded-lg shadow-md animate-fade-in chart-container mt-4">
            <h3 class="text-lg font-medium text-gray-700 mb-4 flex items-center">
                <i class="fas fa-chart-area mr-2 text-indigo-500"></i> Évolution du Chiffre d'Affaires
            </h3>
            <canvas id="caChart" height="100"></canvas>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Gestion Clients -->
            <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="clientsSection">
                <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('clientsSection')">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-users mr-2 text-indigo-500"></i> Gestion Clients
                        <span id="clientCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim hidden">0</span>
                    </h2>
                    <button class="text-gray-600 hover:text-gray-800 transition">
                        <i class="fas fa-chevron-down" id="clientsChevron"></i>
                    </button>
                </div>
                <div class="p-6 hidden" id="clientsContent">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="searchClient" placeholder="Rechercher des clients..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleClientForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Ajouter
                            </button>
                        </div>
                    </div>

                    <div id="clientForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium mb-3">Client</h3>
                        <input type="hidden" id="clientId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                                <input type="text" id="clientNom" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                                <input type="text" id="clientContact" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                                <input type="text" id="clientAdresse" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Solde*</label>
                                <input type="number" id="clientSolde" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="resetClientForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-times mr-2"></i>Annuler
                            </button>
                            <button onclick="saveClient()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Solde</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gestion Fournisseurs -->
            <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="fournisseursSection">
                <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('fournisseursSection')">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-truck mr-2 text-indigo-500"></i> Gestion Fournisseurs
                        <span id="fournisseurCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim hidden">0</span>
                    </h2>
                    <button class="text-gray-600 hover:text-gray-800 transition">
                        <i class="fas fa-chevron-down" id="fournisseursChevron"></i>
                    </button>
                </div>
                <div class="p-6 hidden" id="fournisseursContent">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="searchFournisseur" placeholder="Rechercher des fournisseurs..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleFournisseurForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Ajouter
                            </button>
                        </div>
                    </div>

                    <div id="fournisseurForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium mb-3">Fournisseur</h3>
                        <input type="hidden" id="fournisseurId">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                                <input type="text" id="fournisseurNom" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Contact</label>
                                <input type="text" id="fournisseurContact" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Adresse</label>
                                <input type="text" id="fournisseurAdresse" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Solde*</label>
                                <input type="number" id="fournisseurSolde" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="resetFournisseurForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-times mr-2"></i>Annuler
                            </button>
                            <button onclick="saveFournisseur()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Solde</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fournisseursList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Liste des Produits -->
            <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="productsSection">
                <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('productsSection')">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-boxes mr-2 text-indigo-500"></i> Liste des Produits
                        <span id="productCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim hidden">0</span>
                    </h2>
                    <button class="text-gray-600 hover:text-gray-800 transition">
                        <i class="fas fa-chevron-down" id="productsChevron"></i>
                    </button>
                </div>
                <div class="p-6 hidden" id="productsContent">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="searchProduct" placeholder="Rechercher des produits..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleProductForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Ajouter
                            </button>
                        </div>
                    </div>

                    <div id="productForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium mb-3">Produit</h3>
                        <input type="hidden" id="productId">
                        <div id="scannerPreview"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Désignation*</label>
                                <input type="text" id="productDesignation" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Code Barre*</label>
                                <input type="text" id="productBar" class="w-full px-3 py-2 border rounded-md" required>
                                <button id="scanButton" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white px-2 py-1 rounded-md hover:bg-indigo-700 transition duration-300" onclick="startScanner()">
                                    <i class="fas fa-camera"></i> Scanner
                                </button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prix Vente*</label>
                                <input type="number" id="productPrix" step="0.01" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prix Achat</label>
                                <input type="number" id="productPrixba" step="0.01" class="w-full px-3 py-2 border rounded-md" placeholder="Ex: 300.00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Quantité*</label>
                                <input type="number" id="productQte" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="stopScanner()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-stop mr-2"></i>Arrêter
                            </button>
                            <button onclick="resetProductForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-times mr-2"></i>Annuler
                            </button>
                            <button onclick="saveProduit()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden">Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Désignation</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix Vente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix Achat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gestion Utilisateurs -->
            <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="utilisateursSection">
                <div class="p-6 flex justify-between items-center cursor-pointer" onclick="toggleSection('utilisateursSection')">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-user-tie mr-2 text-indigo-500"></i> Gestion Utilisateurs
                        <span id="utilisateurCount" class="ml-2 text-sm bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full count-anim hidden">0</span>
                    </h2>
                    <button class="text-gray-600 hover:text-gray-800 transition">
                        <i class="fas fa-chevron-down" id="utilisateursChevron"></i>
                    </button>
                </div>
                <div class="p-6 hidden" id="utilisateursContent">
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="searchUtilisateur" placeholder="Rechercher des utilisateurs..." class="w-full pl-10 pr-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <div class="flex justify-end mt-2">
                            <button onclick="toggleUtilisateurForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Ajouter
                            </button>
                        </div>
                    </div>

                    <div id="utilisateurForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium mb-3">Nouvel Utilisateur</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nom*</label>
                                <input type="text" id="utilisateurNom" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe*</label>
                                <input type="password" id="utilisateurPassword" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Statut*</label>
                                <select id="utilisateurStatut" class="w-full px-3 py-2 border rounded-md">
                                    <option value="admin">Admin</option>
                                    <option value="emplo">Employé</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="resetUtilisateurForm()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-times mr-2"></i>Annuler
                            </button>
                            <button onclick="ajouterUtilisateur()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                                <i class="fas fa-save mr-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="utilisateursList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-gray-500">Chargement en cours...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Panneau Actions Rapides -->
            <div class="bg-white rounded-lg shadow-md transition-all duration-300 overflow-hidden animate-fade-in" id="actionsSection">
                <div class="p-6">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center mb-4">
                        <i class="fas fa-bolt mr-2 text-indigo-500"></i> Actions Rapides
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <a href="page2.html" class="bg-indigo-600 text-white p-4 rounded-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105 flex items-center justify-center">
                            <i class="fas fa-chart-bar mr-2 text-xl"></i>
                            <span class="font-medium">Statistiques</span>
                        </a>
                        <a href="HISTO.html" class="bg-blue-600 text-white p-4 rounded-md hover:bg-blue-700 transition duration-300 transform hover:scale-105 flex items-center justify-center">
                            <i class="fas fa-money-check-alt mr-2 text-xl"></i>
                            <span class="font-medium">Versement</span>
                        </a>
                        <a href="PARAM.html" class="bg-gray-600 text-white p-4 rounded-md hover:bg-gray-700 transition duration-300 transform hover:scale-105 flex items-center justify-center">
                            <i class="fas fa-cog mr-2 text-xl"></i>
                            <span class="font-medium">Réglage</span>
                        </a>
                        <a href="HELP.html" class="bg-green-600 text-white p-4 rounded-md hover:bg-green-700 transition duration-300 transform hover:scale-105 flex items-center justify-center">
                            <i class="fas fa-question-circle mr-2 text-xl"></i>
                            <span class="font-medium">Aide</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-700 text-white text-center py-4 mt-8 animate-fade-in">
        <p>Développé par Khelladi Hicham</p>
        <p>Tel: <a href="tel:00213553700900" class="underline hover:text-indigo-300 transition duration-300">00213553700900</a></p>
        <p>Email: <a href="mailto:Hicham.khelladi@gmail.com" class="underline hover:text-indigo-300 transition duration-300">Hicham.khelladi@gmail.com</a></p>
    </footer>

    <!-- Bouton flottant pour remonter en haut -->
    <button id="scrollTopButton" class="hidden fixed bottom-4 right-4 bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition transform hover:scale-110 animate-fade-in z-30" title="Remonter en haut">
        <i class="fas fa-arrow-up"></i>
    </button>

    <div id="toast" class="fixed bottom-4 right-4 hidden">
        <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
            <i id="toastIcon" class="mr-2"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <link rel="manifest" href="manifest.json">

    <div id="update-notification" style="display:none; position:fixed; bottom:10px; right:10px; background:#333; color:#fff; padding:10px; border-radius:5px; z-index:9999;">
        Nouvelle version disponible.
        <button onclick="window.location.reload()" style="margin-left:10px;">Mettre à jour</button>
    </div>
    <script>
    const API_BASE_URL = 'https://web-production-3b9e.up.railway.app';
    let caChartInstance = null;
    let stream = null;
    let barcodeDetector = null;
    let isScanning = false;

    // Générer un user_id basé sur l'email et le mot de passe
    function generateUniqueUserId(email, password) {
        const combined = `${email.toLowerCase()}:${password}`;
        return btoa(combined);
    }

    // Afficher un toast de notification
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        toastMessage.textContent = message;
        toastIcon.className = `fas ${isError ? 'fa-exclamation-circle text-red-500' : 'fa-check-circle text-green-500'} mr-2`;
        toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg ${isError ? 'bg-red-100' : 'bg-green-100'}`;
        toast.classList.remove('hidden');
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Basculer l'affichage des sections
    function toggleSection(sectionId) {
        const content = document.getElementById(`${sectionId}Content`);
        const chevron = document.getElementById(`${sectionId}Chevron`);
        content.classList.toggle('hidden');
        chevron.classList.toggle('fa-chevron-down');
        chevron.classList.toggle('fa-chevron-up');
    }

    // Vérifier si l'utilisateur est connecté au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
        const userId = localStorage.getItem('userId');
        const userEmail = localStorage.getItem('userEmail');
        if (userId && userEmail) {
            document.getElementById('userDisplay').textContent = userEmail.toLowerCase();
            document.getElementById('userDisplay').classList.remove('hidden');
            document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i>Déconnexion';
            document.getElementById('loginModal').classList.add('hidden');
            chargerClients();
            chargerFournisseurs();
            chargerProduits();
            chargerUtilisateurs();
            chargerKPI();
        } else {
            document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-in-alt mr-1"></i>Connexion';
            document.getElementById('loginModal').classList.remove('hidden');
        }

        // Vérification de la connexion API
        fetch(`${API_BASE_URL}/`)
            .then(response => response.text())
            .then(text => console.log('Statut API:', text))
            .catch(err => {
                console.error('API non disponible:', err);
                showToast('Erreur de connexion à l\'API', true);
            });

        // Écouteur pour le sélecteur de période KPI
        document.getElementById('kpiPeriod').addEventListener('change', () => {
            document.getElementById('kpiSection').style.opacity = '0.5';
            setTimeout(chargerKPI, 300);
        });

        // Bouton remonter en haut
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                document.getElementById('scrollTopButton').classList.remove('hidden');
            } else {
                document.getElementById('scrollTopButton').classList.add('hidden');
            }
        });

        document.getElementById('scrollTopButton').addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Écouteurs pour la recherche
        document.getElementById('searchClient').addEventListener('input', () => filterTable('searchClient', 'clientsList'));
        document.getElementById('searchFournisseur').addEventListener('input', () => filterTable('searchFournisseur', 'fournisseursList'));
        document.getElementById('searchProduct').addEventListener('input', () => filterTable('searchProduct', 'productsList'));
        document.getElementById('searchUtilisateur').addEventListener('input', () => filterTable('searchUtilisateur', 'utilisateursList'));
    });

    // Filtrer les tables
    function filterTable(searchInputId, tableBodyId) {
        const searchValue = document.getElementById(searchInputId).value.toLowerCase();
        const rows = document.getElementById(tableBodyId).getElementsByTagName('tr');
        for (let row of rows) {
            const cells = row.getElementsByTagName('td');
            let found = false;
            for (let i = 1; i < cells.length - 1; i++) { // Ignorer ID et Actions
                if (cells[i].textContent.toLowerCase().includes(searchValue)) {
                    found = true;
                    break;
                }
            }
            row.style.display = found || searchValue === '' ? '' : 'none';
        }
    }

    // Connexion avec email et mot de passe
    function loginWithCredentials(event) {
        event.preventDefault();
        const email = document.getElementById('userEmail').value.trim();
        const password = document.getElementById('userPassword').value.trim();
        if (!email || !password) {
            showToast('Veuillez entrer un email et un mot de passe valides', true);
            return;
        }

        const emailLowerCase = email.toLowerCase();
        const userId = generateUniqueUserId(emailLowerCase, password);

        localStorage.setItem('userId', userId);
        localStorage.setItem('userEmail', emailLowerCase);
        document.getElementById('userDisplay').textContent = emailLowerCase;
        document.getElementById('userDisplay').classList.remove('hidden');
        document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i>Déconnexion';
        document.getElementById('loginModal').classList.add('hidden');
        chargerClients();
        chargerFournisseurs();
        chargerProduits();
        chargerUtilisateurs();
        chargerKPI();
        showToast('Connexion réussie');
    }

    // Déconnexion
    function loginLogout() {
        const userId = localStorage.getItem('userId');
        if (userId) {
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            document.getElementById('userDisplay').textContent = '';
            document.getElementById('userDisplay').classList.add('hidden');
            document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-in-alt mr-1"></i>Connexion';
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('clientsList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            document.getElementById('fournisseursList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            document.getElementById('productsList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            document.getElementById('utilisateursList').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            document.getElementById('clientCount').classList.add('hidden');
            document.getElementById('fournisseurCount').classList.add('hidden');
            document.getElementById('productCount').classList.add('hidden');
            document.getElementById('utilisateurCount').classList.add('hidden');
            document.getElementById('totalCA').textContent = '0.00 DA';
            document.getElementById('totalProfit').textContent = '0.00 DA';
            document.getElementById('salesCount').textContent = '0';
            document.getElementById('lowStockItems').textContent = '0';
            document.getElementById('topClient').textContent = 'N/A';
            document.getElementById('topClientCA').textContent = '0.00 DA';
            if (caChartInstance) {
                caChartInstance.destroy();
                caChartInstance = null;
            }
            showToast('Déconnexion réussie');
        }
    }

    // Charger les clients
    async function chargerClients() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            document.getElementById('clientsList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/clients`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const clients = await response.json();
            const clientsList = document.getElementById('clientsList');
            clientsList.innerHTML = clients.length === 0
                ? '<tr><td colspan="6" class="text-center py-4 text-gray-500">Aucun client trouvé</td></tr>'
                : clients.map(client => `
                    <tr>
                        <td class="px-6 py-4 hidden">${client.numero_clt}</td>
                        <td class="px-6 py-4">${client.nom}</td>
                        <td class="px-6 py-4">${client.contact || ''}</td>
                        <td class="px-6 py-4">${client.adresse || ''}</td>
                        <td class="px-6 py-4">${client.solde.toFixed(2)} DA</td>
                        <td class="px-6 py-4">
                            <button onclick="editClient('${client.numero_clt}')" class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteClient('${client.numero_clt}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `).join('');
            document.getElementById('clientCount').textContent = clients.length;
            document.getElementById('clientCount').classList.remove('hidden');
        } catch (error) {
            showToast(`Erreur de chargement des clients: ${error.message}`, true);
            document.getElementById('clientsList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Erreur de chargement</td></tr>';
        }
    }

    // Basculer le formulaire client
    function toggleClientForm() {
        const form = document.getElementById('clientForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            document.getElementById('clientNom').focus();
        }
    }

    // Réinitialiser le formulaire client
    function resetClientForm() {
        document.getElementById('clientForm').classList.add('hidden');
        document.getElementById('clientId').value = '';
        document.getElementById('clientNom').value = '';
        document.getElementById('clientContact').value = '';
        document.getElementById('clientAdresse').value = '';
        document.getElementById('clientSolde').value = '';
    }

    // Enregistrer un client
    async function saveClient() {
        const userId = localStorage.getItem('userId');
        const id = document.getElementById('clientId').value;
        const nom = document.getElementById('clientNom').value.trim();
        const contact = document.getElementById('clientContact').value.trim();
        const adresse = document.getElementById('clientAdresse').value.trim();
        const solde = parseFloat(document.getElementById('clientSolde').value) || 0;

        if (!nom || isNaN(solde)) {
            showToast('Nom et solde sont requis', true);
            return;
        }

        const clientData = { nom, contact, adresse, solde };
        const url = id ? `${API_BASE_URL}/clients/${id}` : `${API_BASE_URL}/clients`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify(clientData)
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast(id ? 'Client modifié avec succès' : 'Client ajouté avec succès');
            resetClientForm();
            chargerClients();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Modifier un client
    async function editClient(numero_clt) {
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch(`${API_BASE_URL}/clients/${numero_clt}`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const client = await response.json();
            document.getElementById('clientId').value = client.numero_clt;
            document.getElementById('clientNom').value = client.nom;
            document.getElementById('clientContact').value = client.contact || '';
            document.getElementById('clientAdresse').value = client.adresse || '';
            document.getElementById('clientSolde').value = client.solde;
            document.getElementById('clientForm').classList.remove('hidden');
            document.getElementById('clientNom').focus();
        } catch (error) {
            showToast(`Erreur de chargement du client: ${error.message}`, true);
        }
    }

    // Supprimer un client
    async function deleteClient(numero_clt) {
        if (!confirm('Voulez-vous vraiment supprimer ce client ?')) return;
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch(`${API_BASE_URL}/clients/${numero_clt}`, {
                method: 'DELETE',
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast('Client supprimé avec succès');
            chargerClients();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Charger les fournisseurs
    async function chargerFournisseurs() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            document.getElementById('fournisseursList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/fournisseurs`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const fournisseurs = await response.json();
            const fournisseursList = document.getElementById('fournisseursList');
            fournisseursList.innerHTML = fournisseurs.length === 0
                ? '<tr><td colspan="6" class="text-center py-4 text-gray-500">Aucun fournisseur trouvé</td></tr>'
                : fournisseurs.map(fournisseur => `
                    <tr>
                        <td class="px-6 py-4 hidden">${fournisseur.numero_fou}</td>
                        <td class="px-6 py-4">${fournisseur.nom}</td>
                        <td class="px-6 py-4">${fournisseur.contact || ''}</td>
                        <td class="px-6 py-4">${fournisseur.adresse || ''}</td>
                        <td class="px-6 py-4">${fournisseur.solde.toFixed(2)} DA</td>
                        <td class="px-6 py-4">
                            <button onclick="editFournisseur('${fournisseur.numero_fou}')" class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteFournisseur('${fournisseur.numero_fou}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `).join('');
            document.getElementById('fournisseurCount').textContent = fournisseurs.length;
            document.getElementById('fournisseurCount').classList.remove('hidden');
        } catch (error) {
            showToast(`Erreur de chargement des fournisseurs: ${error.message}`, true);
            document.getElementById('fournisseursList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Erreur de chargement</td></tr>';
        }
    }

    // Basculer le formulaire fournisseur
    function toggleFournisseurForm() {
        const form = document.getElementById('fournisseurForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            document.getElementById('fournisseurNom').focus();
        }
    }

    // Réinitialiser le formulaire fournisseur
    function resetFournisseurForm() {
        document.getElementById('fournisseurForm').classList.add('hidden');
        document.getElementById('fournisseurId').value = '';
        document.getElementById('fournisseurNom').value = '';
        document.getElementById('fournisseurContact').value = '';
        document.getElementById('fournisseurAdresse').value = '';
        document.getElementById('fournisseurSolde').value = '';
    }

    // Enregistrer un fournisseur
    async function saveFournisseur() {
        const userId = localStorage.getItem('userId');
        const id = document.getElementById('fournisseurId').value;
        const nom = document.getElementById('fournisseurNom').value.trim();
        const contact = document.getElementById('fournisseurContact').value.trim();
        const adresse = document.getElementById('fournisseurAdresse').value.trim();
        const solde = parseFloat(document.getElementById('fournisseurSolde').value) || 0;

        if (!nom || isNaN(solde)) {
            showToast('Nom et solde sont requis', true);
            return;
        }

        const fournisseurData = { nom, contact, adresse, solde };
        const url = id ? `${API_BASE_URL}/fournisseurs/${id}` : `${API_BASE_URL}/fournisseurs`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify(fournisseurData)
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast(id ? 'Fournisseur modifié avec succès' : 'Fournisseur ajouté avec succès');
            resetFournisseurForm();
            chargerFournisseurs();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Modifier un fournisseur
    async function editFournisseur(numero_fou) {
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch(`${API_BASE_URL}/fournisseurs/${numero_fou}`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const fournisseur = await response.json();
            document.getElementById('fournisseurId').value = fournisseur.numero_fou;
            document.getElementById('fournisseurNom').value = fournisseur.nom;
            document.getElementById('fournisseurContact').value = fournisseur.contact || '';
            document.getElementById('fournisseurAdresse').value = fournisseur.adresse || '';
            document.getElementById('fournisseurSolde').value = fournisseur.solde;
            document.getElementById('fournisseurForm').classList.remove('hidden');
            document.getElementById('fournisseurNom').focus();
        } catch (error) {
            showToast(`Erreur de chargement du fournisseur: ${error.message}`, true);
        }
    }

    // Supprimer un fournisseur
    async function deleteFournisseur(numero_fou) {
        if (!confirm('Voulez-vous vraiment supprimer ce fournisseur ?')) return;
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch(`${API_BASE_URL}/fournisseurs/${numero_fou}`, {
                method: 'DELETE',
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast('Fournisseur supprimé avec succès');
            chargerFournisseurs();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Charger les produits
    async function chargerProduits() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            document.getElementById('productsList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/produits`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const produits = await response.json();
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = produits.length === 0
                ? '<tr><td colspan="6" class="text-center py-4 text-gray-500">Aucun produit trouvé</td></tr>'
                : produits.map(produit => `
                    <tr>
                        <td class="px-6 py-4 hidden">${produit.BAR}</td>
                        <td class="px-6 py-4">${produit.designation}</td>
                        <td class="px-6 py-4">${produit.prix.toFixed(2)} DA</td>
                        <td class="px-6 py-4">${produit.prixba ? produit.prixba.toFixed(2) : '0.00'} DA</td>
                        <td class="px-6 py-4">${produit.qte}</td>
                        <td class="px-6 py-4">
                            <button onclick="editProduit('${produit.BAR}')" class="text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteProduit('${produit.BAR}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `).join('');
            document.getElementById('productCount').textContent = produits.length;
            document.getElementById('productCount').classList.remove('hidden');
        } catch (error) {
            showToast(`Erreur de chargement des produits: ${error.message}`, true);
            document.getElementById('productsList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Erreur de chargement</td></tr>';
        }
    }

    // Basculer le formulaire produit
    function toggleProductForm() {
        const form = document.getElementById('productForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            document.getElementById('productDesignation').focus();
        }
    }

    // Réinitialiser le formulaire produit
    function resetProductForm() {
        document.getElementById('productForm').classList.add('hidden');
        document.getElementById('productId').value = '';
        document.getElementById('productDesignation').value = '';
        document.getElementById('productBar').value = '';
        document.getElementById('productPrix').value = '';
        document.getElementById('productPrixba').value = '';
        document.getElementById('productQte').value = '';
        stopScanner();
    }

    // Enregistrer un produit
    async function saveProduit() {
        const userId = localStorage.getItem('userId');
        const id = document.getElementById('productId').value;
        const designation = document.getElementById('productDesignation').value.trim();
        const BAR = document.getElementById('productBar').value.trim();
        const prix = parseFloat(document.getElementById('productPrix').value) || 0;
        const prixba = parseFloat(document.getElementById('productPrixba').value) || 0;
        const qte = parseInt(document.getElementById('productQte').value) || 0;

        if (!designation || !BAR || isNaN(prix) || isNaN(qte)) {
            showToast('Désignation, code barre, prix de vente et quantité sont requis', true);
            return;
        }

        const produitData = { designation, BAR, prix, prixba, qte };
        const url = id ? `${API_BASE_URL}/produits/${id}` : `${API_BASE_URL}/produits`;
        const method = id ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify(produitData)
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast(id ? 'Produit modifié avec succès' : 'Produit ajouté avec succès');
            resetProductForm();
            chargerProduits();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Modifier un produit
    async function editProduit(BAR) {
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch(`${API_BASE_URL}/produits/${BAR}`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const produit = await response.json();
            document.getElementById('productId').value = produit.BAR;
            document.getElementById('productDesignation').value = produit.designation;
            document.getElementById('productBar').value = produit.BAR;
            document.getElementById('productPrix').value = produit.prix;
            document.getElementById('productPrixba').value = produit.prixba || '';
            document.getElementById('productQte').value = produit.qte;
            document.getElementById('productForm').classList.remove('hidden');
            document.getElementById('productDesignation').focus();
        } catch (error) {
            showToast(`Erreur de chargement du produit: ${error.message}`, true);
        }
    }

    // Supprimer un produit
    async function deleteProduit(BAR) {
        if (!confirm('Voulez-vous vraiment supprimer ce produit ?')) return;
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch(`${API_BASE_URL}/produits/${BAR}`, {
                method: 'DELETE',
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast('Produit supprimé avec succès');
            chargerProduits();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Charger les utilisateurs
    async function chargerUtilisateurs() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            document.getElementById('utilisateursList').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/utilisateurs`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const utilisateurs = await response.json();
            const utilisateursList = document.getElementById('utilisateursList');
            utilisateursList.innerHTML = utilisateurs.length === 0
                ? '<tr><td colspan="4" class="text-center py-4 text-gray-500">Aucun utilisateur trouvé</td></tr>'
                : utilisateurs.map(user => `
                    <tr>
                        <td class="px-6 py-4">${user.id}</td>
                        <td class="px-6 py-4">${user.nom}</td>
                        <td class="px-6 py-4">${user.statut}</td>
                        <td class="px-6 py-4">
                            <button onclick="deleteUtilisateur('${user.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `).join('');
            document.getElementById('utilisateurCount').textContent = utilisateurs.length;
            document.getElementById('utilisateurCount').classList.remove('hidden');
        } catch (error) {
            showToast(`Erreur de chargement des utilisateurs: ${error.message}`, true);
            document.getElementById('utilisateursList').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Erreur de chargement</td></tr>';
        }
    }

    // Basculer le formulaire utilisateur
    function toggleUtilisateurForm() {
        const form = document.getElementById('utilisateurForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            document.getElementById('utilisateurNom').focus();
        }
    }

    // Réinitialiser le formulaire utilisateur
    function resetUtilisateurForm() {
        document.getElementById('utilisateurForm').classList.add('hidden');
        document.getElementById('utilisateurNom').value = '';
        document.getElementById('utilisateurPassword').value = '';
        document.getElementById('utilisateurStatut').value = 'admin';
    }

    // Ajouter un utilisateur
    async function ajouterUtilisateur() {
        const userId = localStorage.getItem('userId');
        const nom = document.getElementById('utilisateurNom').value.trim();
        const password = document.getElementById('utilisateurPassword').value.trim();
        const statut = document.getElementById('utilisateurStatut').value;

        if (!nom || !password) {
            showToast('Nom et mot de passe sont requis', true);
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/utilisateurs`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify({ nom, password, statut })
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast('Utilisateur ajouté avec succès');
            resetUtilisateurForm();
            chargerUtilisateurs();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Supprimer un utilisateur
    async function deleteUtilisateur(id) {
        if (!confirm('Voulez-vous vraiment supprimer cet utilisateur ?')) return;
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch(`${API_BASE_URL}/utilisateurs/${id}`, {
                method: 'DELETE',
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            showToast('Utilisateur supprimé avec succès');
            chargerUtilisateurs();
        } catch (error) {
            showToast(`Erreur: ${error.message}`, true);
        }
    }

    // Charger les KPI
    async function chargerKPI() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            showToast('Veuillez vous connecter pour voir les KPI', true);
            return;
        }

        const period = document.getElementById('kpiPeriod').value;
        try {
            const response = await fetch(`${API_BASE_URL}/dashboard?period=${period}`, {
                headers: { 'X-User-ID': userId }
            });
            if (!response.ok) throw new Error(`Erreur ${response.status}`);
            const kpi = await response.json();

            document.getElementById('totalCA').textContent = `${kpi.total_ca.toFixed(2)} DA`;
            document.getElementById('totalProfit').textContent = `${kpi.total_profit.toFixed(2)} DA`;
            document.getElementById('salesCount').textContent = kpi.sales_count;
            document.getElementById('lowStockItems').textContent = kpi.low_stock_items;
            document.getElementById('topClient').textContent = kpi.top_client.name || 'N/A';
            document.getElementById('topClient').title = kpi.top_client.name || 'N/A';
            document.getElementById('topClientCA').textContent = `${kpi.top_client.ca.toFixed(2)} DA`;

            const kpiCards = document.querySelectorAll('.kpi-card');
            kpiCards.forEach(card => {
                card.classList.add('kpi-updated');
                setTimeout(() => card.classList.remove('kpi-updated'), 500);
            });

            const topClientCard = document.getElementById('topClient').parentElement;
            topClientCard.classList.add('top-client-updated');
            setTimeout(() => topClientCard.classList.remove('top-client-updated'), 600);

            document.getElementById('caIcon').className = `fas fa-money-bill-wave mr-1 dynamic-icon ${kpi.total_ca > 0 ? 'text-green-500 animate-pulse' : 'text-gray-400'}`;
            document.getElementById('profitIcon').className = `fas fa-chart-pie mr-1 dynamic-icon ${kpi.total_profit > 0 ? 'text-blue-500 animate-pulse' : 'text-gray-400'}`;
            document.getElementById('salesIcon').className = `fas fa-shopping-cart mr-1 dynamic-icon ${kpi.sales_count > 0 ? 'text-yellow-500 animate-pulse' : 'text-gray-400'}`;
            document.getElementById('stockIcon').className = `fas fa-exclamation-triangle mr-1 dynamic-icon ${kpi.low_stock_items > 0 ? 'text-red-500 animate-pulse' : 'text-gray-400'}`;
            document.getElementById('clientIcon').className = `fas fa-user-check mr-1 dynamic-icon ${kpi.top_client.ca > 0 ? 'text-purple-500 animate-pulse' : 'text-gray-400'}`;

            updateChart(kpi.chart_data.labels, kpi.chart_data.values);
            document.getElementById('kpiSection').style.opacity = '1';
        } catch (error) {
            showToast(`Erreur de chargement des KPI: ${error.message}`, true);
            document.getElementById('kpiSection').style.opacity = '1';
        }
    }

    // Mettre à jour le graphique
    function updateChart(labels, values) {
        const ctx = document.getElementById('caChart').getContext('2d');
        if (caChartInstance) {
            caChartInstance.destroy();
        }
        caChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Chiffre d\'Affaires (DA)',
                    data: values,
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'CA (DA)' }, beginAtZero: true }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: context => `${context.parsed.y.toFixed(2)} DA`
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
    }

    // Démarrer le scanner
    async function startScanner() {
        if (!('BarcodeDetector' in window)) {
            showToast('Le scanner de code-barres n\'est pas pris en charge par ce navigateur', true);
            return;
        }

        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsinline = true;

            const scannerPreview = document.getElementById('scannerPreview');
            scannerPreview.innerHTML = '';
            scannerPreview.appendChild(video);
            scannerPreview.style.display = 'block';

            barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'code_128', 'upc_a', 'upc_e'] });

            isScanning = true;
            scanBarcode(video);
        } catch (error) {
            showToast(`Erreur de démarrage du scanner: ${error.message}`, true);
        }
    }

    // Scanner le code-barres
    function scanBarcode(video) {
        if (!isScanning) return;

        barcodeDetector.detect(video)
            .then(barcodes => {
                if (barcodes.length > 0) {
                    document.getElementById('productBar').value = barcodes[0].rawValue;
                    stopScanner();
                    showToast('Code-barres scanné avec succès');
                } else {
                    setTimeout(() => scanBarcode(video), 100);
                }
            })
            .catch(error => {
                showToast(`Erreur de lecture du code-barres: ${error.message}`, true);
                stopScanner();
            });
    }

    // Arrêter le scanner
    function stopScanner() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        isScanning = false;
        const scannerPreview = document.getElementById('scannerPreview');
        scannerPreview.innerHTML = '';
        scannerPreview.style.display = 'none';
    }
</script>
    
</body>
</html>