<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Commerciale</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .kpi-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .kpi-updated {
            animation: pulse 0.5s ease;
        }
        .top-client-updated {
            animation: glow 0.6s ease;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes glow {
            0% { box-shadow: 0 0 0 rgba(0, 0, 0, 0.1); }
            50% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
            100% { box-shadow: 0 0 0 rgba(0, 0, 0, 0.1); }
        }
        .dynamic-icon {
            transition: color 0.3s ease, transform 0.3s ease;
        }
        /* Masquer les colonnes ID */
        .hidden-id {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-6">
        <!-- En-tête -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Tableau de Bord Commercial</h1>
            <div class="flex items-center space-x-4">
                <span id="userDisplay" class="hidden text-sm font-medium text-gray-700"></span>
                <button id="loginLogoutButton" onclick="loginLogout()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-sign-in-alt mr-1"></i>Connexion
                </button>
            </div>
        </header>

        <!-- Modal de connexion -->
        <div id="loginModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                <h2 class="text-xl font-semibold mb-4">Connexion</h2>
                <form onsubmit="loginWithCredentials(event)">
                    <div class="mb-4">
                        <label for="userEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input id="userEmail" type="email" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="userPassword" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                        <input id="userPassword" type="password" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                        <i class="fas fa-sign-in-alt mr-1"></i>Se connecter
                    </button>
                </form>
            </div>
        </div>

        <!-- Section KPI -->
        <section id="kpiSection" class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Indicateurs Clés</h2>
                <select id="kpiPeriod" class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="daily">Journalier</option>
                    <option value="weekly">Hebdomadaire</option>
                    <option value="monthly">Mensuel</option>
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="kpi-card bg-gray-50 p-4 rounded-md text-center">
                    <i id="caIcon" class="fas fa-money-bill-wave mr-1 dynamic-icon text-gray-400"></i>
                    <h3 class="text-sm font-medium text-gray-600">Chiffre d'Affaires</h3>
                    <p id="totalCA" class="text-lg font-semibold text-gray-800">0.00 DA</p>
                </div>
                <div class="kpi-card bg-gray-50 p-4 rounded-md text-center">
                    <i id="profitIcon" class="fas fa-chart-pie mr-1 dynamic-icon text-gray-400"></i>
                    <h3 class="text-sm font-medium text-gray-600">Profit Total</h3>
                    <p id="totalProfit" class="text-lg font-semibold text-gray-800">0.00 DA</p>
                </div>
                <div class="kpi-card bg-gray-50 p-4 rounded-md text-center">
                    <i id="salesIcon" class="fas fa-shopping-cart mr-1 dynamic-icon text-gray-400"></i>
                    <h3 class="text-sm font-medium text-gray-600">Nombre de Ventes</h3>
                    <p id="salesCount" class="text-lg font-semibold text-gray-800">0</p>
                </div>
                <div class="kpi-card bg-gray-50 p-4 rounded-md text-center">
                    <i id="stockIcon" class="fas fa-exclamation-triangle mr-1 dynamic-icon text-gray-400"></i>
                    <h3 class="text-sm font-medium text-gray-600">Articles en Stock Faible</h3>
                    <p id="lowStockItems" class="text-lg font-semibold text-gray-800">0</p>
                </div>
                <div class="kpi-card bg-gray-50 p-4 rounded-md text-center">
                    <i id="clientIcon" class="fas fa-user-check mr-1 dynamic-icon text-gray-400"></i>
                    <h3 class="text-sm font-medium text-gray-600">Top Client (CA)</h3>
                    <p id="topClient" class="text-lg font-semibold text-gray-800 truncate" title="N/A">N/A</p>
                    <p id="topClientCA" class="text-sm text-gray-600">0.00 DA</p>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-md">
                <canvas id="caChart" height="100"></canvas>
            </div>
        </section>

        <!-- Clients Section -->
        <section id="clientsSection" class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Clients <span id="clientCount" class="hidden ml-2 text-sm text-gray-500"></span></h2>
                <button onclick="toggleSection('clientsSection')" class="text-gray-600 hover:text-gray-800">
                    <i id="clientsChevron" class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div id="clientsContent">
                <div class="mb-4">
                    <input id="searchClient" type="text" placeholder="Rechercher un client..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="toggleClientForm()" class="mb-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-plus mr-1"></i> Ajouter un client
                </button>
                <!-- Formulaire d'ajout de client -->
                <div id="clientForm" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="clientNom" class="block text-sm font-medium text-gray-700">Nom</label>
                            <input id="clientNom" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="clientReference" class="block text-sm font-medium text-gray-700">Référence</label>
                            <input id="clientReference" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="clientContact" class="block text-sm font-medium text-gray-700">Contact</label>
                            <input id="clientContact" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="clientAdresse" class="block text-sm font-medium text-gray-700">Adresse</label>
                            <input id="clientAdresse" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="resetClientForm()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Annuler</button>
                        <button onclick="ajouterClient()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Ajouter</button>
                    </div>
                </div>
                <!-- Formulaire de modification de client -->
                <div id="editClientForm" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                    <input id="editClientId" type="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editClientNom" class="block text-sm font-medium text-gray-700">Nom</label>
                            <input id="editClientNom" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editClientReference" class="block text-sm font-medium text-gray-700">Référence</label>
                            <input id="editClientReference" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editClientContact" class="block text-sm font-medium text-gray-700">Contact</label>
                            <input id="editClientContact" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editClientAdresse" class="block text-sm font-medium text-gray-700">Adresse</label>
                            <input id="editClientAdresse" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="resetEditClientForm()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Annuler</button>
                        <button onclick="modifierClient()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Modifier</button>
                    </div>
                </div>
                <!-- Tableau des clients -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden-id">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsList" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="text-center py-4 text-gray-500">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Fournisseurs Section -->
        <section id="fournisseursSection" class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Fournisseurs <span id="fournisseurCount" class="hidden ml-2 text-sm text-gray-500"></span></h2>
                <button onclick="toggleSection('fournisseursSection')" class="text-gray-600 hover:text-gray-800">
                    <i id="fournisseursChevron" class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div id="fournisseursContent">
                <div class="mb-4">
                    <input id="searchFournisseur" type="text" placeholder="Rechercher un fournisseur..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="toggleFournisseurForm()" class="mb-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-plus mr-1"></i> Ajouter un fournisseur
                </button>
                <!-- Formulaire d'ajout de fournisseur -->
                <div id="fournisseurForm" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="fournisseurNom" class="block text-sm font-medium text-gray-700">Nom</label>
                            <input id="fournisseurNom" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="fournisseurReference" class="block text-sm font-medium text-gray-700">Référence</label>
                            <input id="fournisseurReference" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="fournisseurContact" class="block text-sm font-medium text-gray-700">Contact</label>
                            <input id="fournisseurContact" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="fournisseurAdresse" class="block text-sm font-medium text-gray-700">Adresse</label>
                            <input id="fournisseurAdresse" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="resetFournisseurForm()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Annuler</button>
                        <button onclick="ajouterFournisseur()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Ajouter</button>
                    </div>
                </div>
                <!-- Formulaire de modification de fournisseur -->
                <div id="editFournisseurForm" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                    <input id="editFournisseurId" type="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editFournisseurNom" class="block text-sm font-medium text-gray-700">Nom</label>
                            <input id="editFournisseurNom" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editFournisseurReference" class="block text-sm font-medium text-gray-700">Référence</label>
                            <input id="editFournisseurReference" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editFournisseurContact" class="block text-sm font-medium text-gray-700">Contact</label>
                            <input id="editFournisseurContact" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editFournisseurAdresse" class="block text-sm font-medium text-gray-700">Adresse</label>
                            <input id="editFournisseurAdresse" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="resetEditFournisseurForm()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Annuler</button>
                        <button onclick="modifierFournisseur()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Modifier</button>
                    </div>
                </div>
                <!-- Tableau des fournisseurs -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden-id">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fournisseursList" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="text-center py-4 text-gray-500">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Produits Section -->
        <section id="productsSection" class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Produits <span id="productCount" class="hidden ml-2 text-sm text-gray-500"></span></h2>
                <button onclick="toggleSection('productsSection')" class="text-gray-600 hover:text-gray-800">
                    <i id="productsChevron" class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div id="productsContent">
                <div class="mb-4">
                    <input id="searchProduct" type="text" placeholder="Rechercher un produit..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="toggleProductForm()" class="mb-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-plus mr-1"></i> Ajouter un produit
                </button>
                <!-- Formulaire d'ajout de produit -->
                <div id="productForm" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="productDesignation" class="block text-sm font-medium text-gray-700">Désignation</label>
                            <input id="productDesignation" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="productBar" class="block text-sm font-medium text-gray-700">Code-barres</label>
                            <div class="flex">
                                <input id="productBar" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <button onclick="startScanner()" class="ml-2 mt-1 px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                                    <i class="fas fa-barcode"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="productRef" class="block text-sm font-medium text-gray-700">Référence</label>
                            <input id="productRef" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="productPrix" class="block text-sm font-medium text-gray-700">Prix de vente (DA)</label>
                            <input id="productPrix" type="number" step="0.01" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="productPrixba" class="block text-sm font-medium text-gray-700">Prix d'achat (DA)</label>
                            <input id="productPrixba" type="number" step="0.01" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="productQte" class="block text-sm font-medium text-gray-700">Quantité</label>
                            <input id="productQte" type="number" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div id="scannerPreview" class="mt-4 hidden"></div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="resetProductForm()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Annuler</button>
                        <button onclick="ajouterProduit()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Ajouter</button>
                    </div>
                </div>
                <!-- Formulaire de modification de produit -->
                <div id="editProductForm" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                    <input id="editProductBar" type="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editProductBarDisplay" class="block text-sm font-medium text-gray-700">Code-barres</label>
                            <input id="editProductBarDisplay" type="text" disabled class="mt-1 w-full px-3 py-2 border rounded-md bg-gray-100">
                        </div>
                        <div>
                            <label for="editProductDesignation" class="block text-sm font-medium text-gray-700">Désignation</label>
                            <input id="editProductDesignation" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editProductRef" class="block text-sm font-medium text-gray-700">Référence</label>
                            <input id="editProductRef" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editProductPrix" class="block text-sm font-medium text-gray-700">Prix de vente (DA)</label>
                            <input id="editProductPrix" type="number" step="0.01" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editProductPrixba" class="block text-sm font-medium text-gray-700">Prix d'achat (DA)</label>
                            <input id="editProductPrixba" type="number" step="0.01" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="editProductQte" class="block text-sm font-medium text-gray-700">Quantité</label>
                            <input id="editProductQte" type="number" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="resetEditProductForm()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Annuler</button>
                        <button onclick="modifierProduit()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Modifier</button>
                    </div>
                </div>
                <!-- Tableau des produits -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden-id">Code-barres</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Désignation</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix (DA)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix d'achat (DA)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsList" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="7" class="text-center py-4 text-gray-500">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Utilisateurs Section -->
        <section id="utilisateursSection" class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Utilisateurs <span id="utilisateurCount" class="hidden ml-2 text-sm text-gray-500"></span></h2>
                <button onclick="toggleSection('utilisateursSection')" class="text-gray-600 hover:text-gray-800">
                    <i id="utilisateursChevron" class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div id="utilisateursContent">
                <div class="mb-4">
                    <input id="searchUtilisateur" type="text" placeholder="Rechercher un utilisateur..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="toggleUtilisateurForm()" class="mb-4 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-plus mr-1"></i> Ajouter un utilisateur
                </button>
                <!-- Formulaire d'ajout d'utilisateur -->
                <div id="utilisateurForm" class="hidden mb-4 p-4 bg-gray-50 rounded-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="utilisateurNom" class="block text-sm font-medium text-gray-700">Nom</label>
                            <input id="utilisateurNom" type="text" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="utilisateurPassword" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                            <input id="utilisateurPassword" type="password" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="utilisateurStatut" class="block text-sm font-medium text-gray-700">Statut</label>
                            <select id="utilisateurStatut" class="mt-1 w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="admin">Admin</option>
                                <option value="user">Utilisateur</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="resetUtilisateurForm()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Annuler</button>
                        <button onclick="ajouterUtilisateur()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Ajouter</button>
                    </div>
                </div>
                <!-- Tableau des utilisateurs -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden-id">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="utilisateursList" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Bouton remonter en haut -->
        <button id="scrollTopButton" class="hidden fixed bottom-6 right-6 p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition">
            <i class="fas fa-arrow-up"></i>
        </button>

        <!-- Toast Notification -->
        <div id="toast" class="hidden fixed bottom-4 right-4 flex items-center bg-green-500 text-white px-6 py-3 rounded-md shadow-lg">
            <i id="toastIcon" class="fas fa-check-circle mr-2"></i>
            <span id="toastMessage"></span>
        </div>

        <script>
            const API_BASE_URL = 'https://web-production-3b9e.up.railway.app';
            let caChartInstance = null;
            let stream = null;
            let barcodeDetector = null;
            let isScanning = false;

            // Générer un user_id basé sur l'email et le mot de passe
            function generateUniqueUserId(email, password) {
                const combined = `${email.toLowerCase()}:${password}`;
                return btoa(combined);
            }

            // Vérifier si l'utilisateur est connecté au chargement de la page
            document.addEventListener('DOMContentLoaded', () => {
                const userId = localStorage.getItem('userId');
                const userEmail = localStorage.getItem('userEmail');
                if (userId && userEmail) {
                    document.getElementById('userDisplay').textContent = userEmail.toLowerCase();
                    document.getElementById('userDisplay').classList.remove('hidden');
                    document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i>Déconnexion';
                    document.getElementById('loginModal').classList.add('hidden');
                    chargerClients();
                    chargerFournisseurs();
                    chargerProduits();
                    chargerUtilisateurs();
                    chargerKPI();
                } else {
                    document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-in-alt mr-1"></i>Connexion';
                    document.getElementById('loginModal').classList.remove('hidden');
                }

                // Vérification de la connexion API
                fetch(`${API_BASE_URL}/`)
                    .then(response => response.text())
                    .then(text => console.log('Statut API:', text))
                    .catch(err => {
                        console.error('API non disponible:', err);
                        showToast('Erreur de connexion à l\'API', true);
                    });

                // Écouteur pour le sélecteur de période KPI
                document.getElementById('kpiPeriod').addEventListener('change', () => {
                    document.getElementById('kpiSection').style.opacity = '0.5';
                    setTimeout(chargerKPI, 300);
                });

                // Bouton remonter en haut
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 300) {
                        document.getElementById('scrollTopButton').classList.remove('hidden');
                    } else {
                        document.getElementById('scrollTopButton').classList.add('hidden');
                    }
                });

                document.getElementById('scrollTopButton').addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });

            // Fonction pour charger les KPI
            async function chargerKPI() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour voir les KPI', true);
                    return;
                }

                const period = document.getElementById('kpiPeriod').value;
                try {
                    const response = await fetch(`${API_BASE_URL}/dashboard?period=${period}`, {
                        headers: {
                            'X-User-ID': userId
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                    }
                    const kpi = await response.json();

                    // Mettre à jour les KPI
                    document.getElementById('totalCA').textContent = `${kpi.total_ca.toFixed(2)} DA`;
                    document.getElementById('totalProfit').textContent = `${kpi.total_profit.toFixed(2)} DA`;
                    document.getElementById('salesCount').textContent = kpi.sales_count;
                    document.getElementById('lowStockItems').textContent = kpi.low_stock_items;
                    document.getElementById('topClient').textContent = kpi.top_client.name || 'N/A';
                    document.getElementById('topClient').title = kpi.top_client.name || 'N/A';
                    document.getElementById('topClientCA').textContent = `${kpi.top_client.ca.toFixed(2)} DA`;

                    // Animation de mise à jour
                    const kpiCards = document.querySelectorAll('.kpi-card');
                    kpiCards.forEach(card => {
                        card.classList.add('kpi-updated');
                        setTimeout(() => card.classList.remove('kpi-updated'), 500);
                    });

                    // Animation spécifique pour Top Client
                    const topClientCard = document.getElementById('topClient').parentElement;
                    topClientCard.classList.add('top-client-updated');
                    setTimeout(() => topClientCard.classList.remove('top-client-updated'), 600);

                    // Mettre à jour les icônes dynamiques
                    document.getElementById('caIcon').className = `fas fa-money-bill-wave mr-1 dynamic-icon ${kpi.total_ca > 0 ? 'text-green-500 animate-pulse' : 'text-gray-400'}`;
                    document.getElementById('profitIcon').className = `fas fa-chart-pie mr-1 dynamic-icon ${kpi.total_profit > 0 ? 'text-blue-500 animate-pulse' : 'text-gray-400'}`;
                    document.getElementById('salesIcon').className = `fas fa-shopping-cart mr-1 dynamic-icon ${kpi.sales_count > 0 ? 'text-yellow-500 animate-pulse' : 'text-gray-400'}`;
                    document.getElementById('stockIcon').className = `fas fa-exclamation-triangle mr-1 dynamic-icon ${kpi.low_stock_items > 0 ? 'text-red-500 animate-pulse' : 'text-gray-400'}`;
                    document.getElementById('clientIcon').className = `fas fa-user-check mr-1 dynamic-icon ${kpi.top_client.ca > 0 ? 'text-purple-500 animate-pulse' : 'text-gray-400'}`;

                    // Mettre à jour le graphique
                    updateChart(kpi.chart_data.labels, kpi.chart_data.values);

                    // Réactiver l'opacité
                    document.getElementById('kpiSection').style.opacity = '1';
                } catch (error) {
                    showToast(`Erreur de chargement des KPI: ${error.message}`, true);
                    console.error('Erreur KPI:', error);
                    document.getElementById('kpiSection').style.opacity = '1';
                }
            }

            // Fonction pour mettre à jour le graphique
            function updateChart(labels, values) {
                const ctx = document.getElementById('caChart').getContext('2d');
                if (caChartInstance) {
                    caChartInstance.destroy();
                }
                caChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Chiffre d\'Affaires (DA)',
                            data: values,
                            borderColor: '#4F46E5',
                            backgroundColor: 'rgba(79, 70, 229, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: { display: true, text: 'Date' }
                            },
                            y: {
                                title: { display: true, text: 'CA (DA)' },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: context => `${context.parsed.y.toFixed(2)} DA`
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }

            // Connexion avec email et mot de passe
            function loginWithCredentials(event) {
                event.preventDefault();
                const email = document.getElementById('userEmail').value.trim();
                const password = document.getElementById('userPassword').value.trim();
                if (!email || !password) {
                    showToast('Veuillez entrer un email et un mot de passe valides', true);
                    return;
                }

                const emailLowerCase = email.toLowerCase();
                const storedUserId = localStorage.getItem('userId');
                const storedEmail = localStorage.getItem('userEmail');

                const userId = generateUniqueUserId(emailLowerCase, password);

                if (storedUserId && storedEmail === emailLowerCase && storedUserId === userId) {
                    document.getElementById('userDisplay').textContent = emailLowerCase;
                    document.getElementById('userDisplay').classList.remove('hidden');
                    document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i>Déconnexion';
                    document.getElementById('loginModal').classList.add('hidden');
                    chargerClients();
                    chargerFournisseurs();
                    chargerProduits();
                    chargerUtilisateurs();
                    chargerKPI();
                } else {
                    localStorage.setItem('userId', userId);
                    localStorage.setItem('userEmail', emailLowerCase);
                    document.getElementById('userDisplay').textContent = emailLowerCase;
                    document.getElementById('userDisplay').classList.remove('hidden');
                    document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-out-alt mr-1"></i>Déconnexion';
                    document.getElementById('loginModal').classList.add('hidden');
                    chargerClients();
                    chargerFournisseurs();
                    chargerProduits();
                    chargerUtilisateurs();
                    chargerKPI();
                    showToast('Nouveau compte créé avec succès');
                }
            }

            // Fonction de déconnexion
            function loginLogout() {
                const userId = localStorage.getItem('userId');
                if (userId) {
                    localStorage.removeItem('userId');
                    localStorage.removeItem('userEmail');
                    document.getElementById('userDisplay').textContent = '';
                    document.getElementById('userDisplay').classList.add('hidden');
                    document.getElementById('loginLogoutButton').innerHTML = '<i class="fas fa-sign-in-alt mr-1"></i>Connexion';
                    document.getElementById('loginModal').classList.remove('hidden');
                    document.getElementById('clientsList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
                    document.getElementById('fournisseursList').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
                    document.getElementById('productsList').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
                    document.getElementById('utilisateursList').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>';
                    document.getElementById('clientCount').classList.add('hidden');
                    document.getElementById('fournisseurCount').classList.add('hidden');
                    document.getElementById('productCount').classList.add('hidden');
                    document.getElementById('utilisateurCount').classList.add('hidden');
                    document.getElementById('totalCA').textContent = '0.00 DA';
                    document.getElementById('totalProfit').textContent = '0.00 DA';
                    document.getElementById('salesCount').textContent = '0';
                    document.getElementById('lowStockItems').textContent = '0';
                    document.getElementById('topClient').textContent = 'N/A';
                    document.getElementById('topClientCA').textContent = '0.00 DA';
                    if (caChartInstance) {
                        caChartInstance.destroy();
                        caChartInstance = null;
                    }
                }
            }

            // Fonction pour afficher les notifications
            function showToast(message, isError = false) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                const toastIcon = document.getElementById('toastIcon');

                toast.className = isError
                    ? 'fixed bottom-4 right-4 flex items-center bg-red-500 text-white px-6 py-3 rounded-md shadow-lg'
                    : 'fixed bottom-4 right-4 flex items-center bg-green-500 text-white px-6 py-3 rounded-md shadow-lg';

                toastIcon.className = isError
                    ? 'fas fa-exclamation-circle mr-2'
                    : 'fas fa-check-circle mr-2';

                toastMessage.textContent = message;
                toast.classList.remove('hidden');

                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }

            // Fonction pour gérer l'animation développer/envelopper
            function toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const content = document.getElementById(`${sectionId.replace('Section', 'Content')}`);
                const chevron = document.getElementById(`${sectionId.replace('Section', 'Chevron')}`);

                content.classList.toggle('hidden');
                chevron.classList.toggle('fa-chevron-down');
                chevron.classList.toggle('fa-chevron-up');
            }

            // --- Gestion des clients ---
            async function chargerClients() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour voir les clients', true);
                    document.getElementById('clientsList').innerHTML = `
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>`;
                    return;
                }

                try {
                    console.log('Chargement des clients avec userId:', userId); // Débogage
                    const response = await fetch(`${API_BASE_URL}/liste_clients`, {
                        headers: {
                            'X-User-ID': userId,
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('Statut de la réponse:', response.status); // Débogage
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText || response.statusText}`);
                    }
                    const clients = await response.json();
                    console.log('Clients reçus:', clients); // Débogage
                    const tbody = document.getElementById('clientsList');
                    const countElement = document.getElementById('clientCount');

                    if (!Array.isArray(clients) || clients.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Aucun client trouvé</td></tr>';
                        countElement.textContent = '0';
                        countElement.classList.remove('hidden');
                        return;
                    }

                    tbody.innerHTML = '';
                    clients.forEach(client => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden-id">${client.numero_clt || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${client.nom || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.reference || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.contact || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${client.adresse || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button onclick="editClient('${client.numero_clt}', '${client.nom}', '${client.reference || ''}', '${client.contact || ''}', '${client.adresse || ''}')" class="text-blue-600 hover:text-blue-800 transition mr-2">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button onclick="supprimerClient('${client.numero_clt}')" class="text-red-600 hover:text-red-800 transition">
                                    <i class="fas fa-trash-alt"></i> Supprimer
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    countElement.textContent = clients.length;
                    countElement.classList.remove('hidden');
                } catch (error) {
                    console.error('Erreur lors du chargement des clients:', error);
                    document.getElementById('clientsList').innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-red-500">
                                Erreur de chargement: ${error.message}
                            </td>
                        </tr>`;
                    showToast(`Erreur de chargement des clients: ${error.message}`, true);
                }
            }

            async function ajouterClient() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour ajouter un client', true);
                    return;
                }

                const nom = document.getElementById('clientNom').value.trim();
                const reference = document.getElementById('clientReference').value.trim();
                const contact = document.getElementById('clientContact').value.trim();
                const adresse = document.getElementById('clientAdresse').value.trim();

                if (!nom) {
                    showToast('Veuillez remplir le champ Nom', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/ajouter_client`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': userId
                        },
                        body: JSON.stringify({
                            nom,
                            reference: reference || null,
                            contact,
                            adresse
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.erreur || 'Erreur lors de l\'ajout');
                    }

                    showToast('Client ajouté avec succès');
                    resetClientForm();
                    chargerClients();
                } catch (error) {
                    showToast(error.message, true);
                    console.error('Erreur ajout client:', error);
                }
            }

            function editClient(numero_clt, nom, reference, contact, adresse) {
                document.getElementById('editClientId').value = numero_clt;
                document.getElementById('editClientNom').value = nom;
                document.getElementById('editClientReference').value = reference;
                document.getElementById('editClientContact').value = contact;
                document.getElementById('editClientAdresse').value = adresse;
                document.getElementById('clientForm').classList.add('hidden');
                document.getElementById('editClientForm').classList.remove('hidden');
            }

            async function modifierClient() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour modifier un client', true);
                    return;
                }

                const numero_clt = document.getElementById('editClientId').value;
                const nom = document.getElementById('editClientNom').value.trim();
                const reference = document.getElementById('editClientReference').value.trim();
                const contact = document.getElementById('editClientContact').value.trim();
                const adresse = document.getElementById('editClientAdresse').value.trim();

                if (!nom) {
                    showToast('Veuillez remplir le champ Nom', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/modifier_client/${numero_clt}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': userId
                        },
                        body: JSON.stringify({
                            nom,
                            reference: reference || null,
                            contact,
                            adresse
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.erreur || 'Erreur lors de la modification');
                    }

                    showToast('Client modifié avec succès');
                    resetEditClientForm();
                    chargerClients();
                } catch (error) {
                    showToast(error.message, true);
                    console.error('Erreur modification client:', error);
                }
            }

            async function supprimerClient(numero_clt) {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour supprimer un client', true);
                    return;
                }

                if (!confirm('Voulez-vous vraiment supprimer ce client ?')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/supprimer_client/${numero_clt}`, {
                        method: 'DELETE',
                        headers: {
                            'X-User-ID': userId
                        }
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.erreur || 'Erreur lors de la suppression');
                    }

                    showToast('Client supprimé avec succès');
                    chargerClients();
                } catch (error) {
                    showToast(error.message, true);
                    console.error('Erreur suppression client:', error);
                }
            }

            function resetClientForm() {
                document.getElementById('clientNom').value = '';
                document.getElementById('clientReference').value = '';
                document.getElementById('clientContact').value = '';
                document.getElementById('clientAdresse').value = '';
                document.getElementById('clientForm').classList.add('hidden');
            }

            function resetEditClientForm() {
                document.getElementById('editClientId').value = '';
                document.getElementById('editClientNom').value = '';
                document.getElementById('editClientReference').value = '';
                document.getElementById('editClientContact').value = '';
                document.getElementById('editClientAdresse').value = '';
                document.getElementById('editClientForm').classList.add('hidden');
            }

            function toggleClientForm() {
                document.getElementById('clientForm').classList.toggle('hidden');
                document.getElementById('editClientForm').classList.add('hidden');
            }

            document.getElementById('searchClient').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#clientsList tr');

                rows.forEach(row => {
                    const nom = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
                    const reference = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase();
                    const contact = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase();
                    const adresse = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase();
                    if (nom?.includes(searchTerm) || reference?.includes(searchTerm) || contact?.includes(searchTerm) || adresse?.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

            // --- Gestion des fournisseurs ---
            async function chargerFournisseurs() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour voir les fournisseurs', true);
                    document.getElementById('fournisseursList').innerHTML = `
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>`;
                    return;
                }

                try {
                    console.log('Chargement des fournisseurs avec userId:', userId); // Débogage
                    const response = await fetch(`${API_BASE_URL}/liste_fournisseurs`, {
                        headers: {
                            'X-User-ID': userId,
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('Statut de la réponse:', response.status); // Débogage
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText || response.statusText}`);
                    }
                    const fournisseurs = await response.json();
                    console.log('Fournisseurs reçus:', fournisseurs); // Débogage
                    const tbody = document.getElementById('fournisseursList');
                    const countElement = document.getElementById('fournisseurCount');

                    if (!Array.isArray(fournisseurs) || fournisseurs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Aucun fournisseur trouvé</td></tr>';
                        countElement.textContent = '0';
                        countElement.classList.remove('hidden');
                        return;
                    }

                    tbody.innerHTML = '';
                    fournisseurs.forEach(fournisseur => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden-id">${fournisseur.numero_fou || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fournisseur.nom || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fournisseur.reference || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fournisseur.contact || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fournisseur.adresse || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button onclick="editFournisseur('${fournisseur.numero_fou}', '${fournisseur.nom}', '${fournisseur.reference || ''}', '${fournisseur.contact || ''}', '${fournisseur.adresse || ''}')" class="text-blue-600 hover:text-blue-800 transition mr-2">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button onclick="supprimerFournisseur('${fournisseur.numero_fou}')" class="text-red-600 hover:text-red-800 transition">
                                    <i class="fas fa-trash-alt"></i> Supprimer
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    countElement.textContent = fournisseurs.length;
                    countElement.classList.remove('hidden');
                } catch (error) {
                    console.error('Erreur lors du chargement des fournisseurs:', error);
                    document.getElementById('fournisseursList').innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-red-500">
                                Erreur de chargement: ${error.message}
                            </td>
                        </tr>`;
                    showToast(`Erreur de chargement des fournisseurs: ${error.message}`, true);
                }
            }

            async function ajouterFournisseur() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour ajouter un fournisseur', true);
                    return;
                }

                const nom = document.getElementById('fournisseurNom').value.trim();
                const reference = document.getElementById('fournisseurReference').value.trim();
                const contact = document.getElementById('fournisseurContact').value.trim();
                const adresse = document.getElementById('fournisseurAdresse').value.trim();

                if (!nom) {
                    showToast('Veuillez remplir le champ Nom', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/ajouter_fournisseur`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': userId
                        },
                        body: JSON.stringify({
                            nom,
                            reference: reference || null,
                            contact,
                            adresse
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.erreur || 'Erreur lors de l\'ajout');
                    }

                    showToast('Fournisseur ajouté avec succès');
                    resetFournisseurForm();
                    chargerFournisseurs();
                } catch (error) {
                    showToast(error.message, true);
                    console.error('Erreur ajout fournisseur:', error);
                }
            }

            function editFournisseur(numero_fou, nom, reference, contact, adresse) {
                document.getElementById('editFournisseurId').value = numero_fou;
                document.getElementById('editFournisseurNom').value = nom;
                document.getElementById('editFournisseurReference').value = reference;
                document.getElementById('editFournisseurContact').value = contact;
                document.getElementById('editFournisseurAdresse').value = adresse;
                document.getElementById('fournisseurForm').classList.add('hidden');
                document.getElementById('editFournisseurForm').classList.remove('hidden');
            }

            async function modifierFournisseur() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour modifier un fournisseur', true);
                    return;
                }

                const numero_fou = document.getElementById('editFournisseurId').value;
                const nom = document.getElementById('editFournisseurNom').value.trim();
                const reference = document.getElementById('editFournisseurReference').value.trim();
                const contact = document.getElementById('editFournisseurContact').value.trim();
                const adresse = document.getElementById('editFournisseurAdresse').value.trim();

                if (!nom) {
                    showToast('Veuillez remplir le champ Nom', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/modifier_fournisseur/${numero_fou}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-ID': userId
                        },
                        body: JSON.stringify({
                            nom,
                            reference: reference || null,
                            contact,
                            adresse
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.erreur || 'Erreur lors de la modification');
                    }

                    showToast('Fournisseur modifié avec succès');
                    resetEditFournisseurForm();
                    chargerFournisseurs();
                } catch (error) {
                    showToast(error.message, true);
                    console.error('Erreur modification fournisseur:', error);
                }
            }

            async function supprimerFournisseur(numero_fou) {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour supprimer un fournisseur', true);
                    return;
                }

                if (!confirm('Voulez-vous vraiment supprimer ce fournisseur ?')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/supprimer_fournisseur/${numero_fou}`, {
                        method: 'DELETE',
                        headers: {
                            'X-User-ID': userId
                        }
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.erreur || 'Erreur lors de la suppression');
                    }

                    showToast('Fournisseur supprimé avec succès');
                    chargerFournisseurs();
                } catch (error) {
                    showToast(error.message, true);
                    console.error('Erreur suppression fournisseur:', error);
                }
            }

            function resetFournisseurForm() {
                document.getElementById('fournisseurNom').value = '';
                document.getElementById('fournisseurReference').value = '';
                document.getElementById('fournisseurContact').value = '';
                document.getElementById('fournisseurAdresse').value = '';
                document.getElementById('fournisseurForm').classList.add('hidden');
            }

            function resetEditFournisseurForm() {
                document.getElementById('editFournisseurId').value = '';
                document.getElementById('editFournisseurNom').value = '';
                document.getElementById('editFournisseurReference').value = '';
                document.getElementById('editFournisseurContact').value = '';
                document.getElementById('editFournisseurAdresse').value = '';
                document.getElementById('editFournisseurForm').classList.add('hidden');
            }

            function toggleFournisseurForm() {
                document.getElementById('fournisseurForm').classList.toggle('hidden');
                document.getElementById('editFournisseurForm').classList.add('hidden');
            }

            document.getElementById('searchFournisseur').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#fournisseursList tr');

                rows.forEach(row => {
                    const nom = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
                    const reference = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase();
                    const contact = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase();
                    const adresse = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase();
                    if (nom?.includes(searchTerm) || reference?.includes(searchTerm) || contact?.includes(searchTerm) || adresse?.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

            // --- Gestion des produits ---
            async function chargerProduits() {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showToast('Veuillez vous connecter pour voir les produits', true);
                    document.getElementById('productsList').innerHTML = `
                        <tr><td colspan="7" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>`;
                    return;
                }

                try {
                    console.log('Chargement des produits avec userId:', userId); // Débogage
                    const response = await fetch(`${API_BASE_URL}/liste_produits`, {
                        headers: {
                            'X-User-ID': userId,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('Statut de la réponse:', response.status); // Débogage
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur ${response.status}: ${errorText || response.statusText}`);
                    }

                    const produits = await response.json();
                    console.log('Produits reçus:', produits); // Débogage
                    const tbody = document.getElementById('productsList');
                    const countElement = document.getElementById('productCount');

                    if (!Array.isArray(produits) || produits.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Aucun produit trouvé</td></tr>';
                        countElement.textContent = '0';
                        countElement.classList.remove('hidden');
                        return;
                    }

                    tbody.innerHTML = '';
                    produits.forEach(produit => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden-id">${produit.bar || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${produit.designation || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.ref || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.prix ? produit.prix.toFixed(2) : 'N/A'} DA</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.prixba ? produit.prixba.toFixed(2) : 'N/A'} DA</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.qte || '0'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button onclick="editProduit('${produit.bar}', '${produit.designation}', '${produit.ref || ''}', ${produit.prix || 0}, ${produit.prixba || 0}, ${produit.qte || 0})" class="text-blue-600 hover:text-blue-800 transition mr-2">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button onclick="supprimerProduit('${produit.bar}')" class="text-red-600 hover:text-red-800 transition">
                                    <i class="fas fa-trash-alt"></i> Supprimer
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    countElement.textContent = produits.length;
                    countElement.classList.remove('hidden');
                } catch (error) {
                    console.error('Erreur lors du chargement des produits:', error);
       <!-- Suite de la fonction chargerProduits à partir de document.getElementById('productsList').innerHTML = -->
document.getElementById('productsList').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Aucun produit trouvé</td></tr>';
countElement.textContent = '0';
countElement.classList.remove('hidden');
return;
}

tbody.innerHTML = '';
produits.forEach(produit => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50';
    tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden-id">${produit.bar || 'N/A'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${produit.designation || 'N/A'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.ref || 'N/A'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.prix ? produit.prix.toFixed(2) : 'N/A'} DA</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.prixba ? produit.prixba.toFixed(2) : 'N/A'} DA</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${produit.qte || '0'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <button onclick="editProduit('${produit.bar}', '${produit.designation}', '${produit.ref || ''}', ${produit.prix || 0}, ${produit.prixba || 0}, ${produit.qte || 0})" class="text-blue-600 hover:text-blue-800 transition mr-2">
                <i class="fas fa-edit"></i> Modifier
            </button>
            <button onclick="supprimerProduit('${produit.bar}')" class="text-red-600 hover:text-red-800 transition">
                <i class="fas fa-trash-alt"></i> Supprimer
            </button>
        </td>
    `;
    tbody.appendChild(tr);
});
countElement.textContent = produits.length;
countElement.classList.remove('hidden');
} catch (error) {
console.error('Erreur lors du chargement des produits:', error);
document.getElementById('productsList').innerHTML = `
    <tr>
        <td colspan="7" class="text-center py-4 text-red-500">
            Erreur de chargement: ${error.message}
        </td>
    </tr>`;
showToast(`Erreur de chargement des produits: ${error.message}`, true);
}
}

async function ajouterProduit() {
const userId = localStorage.getItem('userId');
if (!userId) {
    showToast('Veuillez vous connecter pour ajouter un produit', true);
    return;
}

const designation = document.getElementById('productDesignation').value.trim();
const bar = document.getElementById('productBar').value.trim();
const ref = document.getElementById('productRef').value.trim();
const prix = parseFloat(document.getElementById('productPrix').value);
const prixba = parseFloat(document.getElementById('productPrixba').value);
const qte = parseInt(document.getElementById('productQte').value);

if (!designation || !bar || isNaN(prix) || isNaN(prixba) || isNaN(qte)) {
    showToast('Veuillez remplir tous les champs correctement', true);
    return;
}

try {
    const response = await fetch(`${API_BASE_URL}/ajouter_produit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-User-ID': userId
        },
        body: JSON.stringify({
            bar,
            designation,
            ref: ref || null,
            prix,
            prixba,
            qte
        })
    });

    const result = await response.json();
    if (!response.ok) {
        throw new Error(result.erreur || 'Erreur lors de l\'ajout');
    }

    showToast('Produit ajouté avec succès');
    resetProductForm();
    chargerProduits();
} catch (error) {
    showToast(error.message, true);
    console.error('Erreur ajout produit:', error);
}
}

function editProduit(bar, designation, ref, prix, prixba, qte) {
document.getElementById('editProductBar').value = bar;
document.getElementById('editProductBarDisplay').value = bar;
document.getElementById('editProductDesignation').value = designation;
document.getElementById('editProductRef').value = ref;
document.getElementById('editProductPrix').value = prix;
document.getElementById('editProductPrixba').value = prixba;
document.getElementById('editProductQte').value = qte;
document.getElementById('productForm').classList.add('hidden');
document.getElementById('editProductForm').classList.remove('hidden');
}

async function modifierProduit() {
const userId = localStorage.getItem('userId');
if (!userId) {
    showToast('Veuillez vous connecter pour modifier un produit', true);
    return;
}

const bar = document.getElementById('editProductBar').value;
const designation = document.getElementById('editProductDesignation').value.trim();
const ref = document.getElementById('editProductRef').value.trim();
const prix = parseFloat(document.getElementById('editProductPrix').value);
const prixba = parseFloat(document.getElementById('editProductPrixba').value);
const qte = parseInt(document.getElementById('editProductQte').value);

if (!designation || isNaN(prix) || isNaN(prixba) || isNaN(qte)) {
    showToast('Veuillez remplir tous les champs correctement', true);
    return;
}

try {
    const response = await fetch(`${API_BASE_URL}/modifier_produit/${bar}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-User-ID': userId
        },
        body: JSON.stringify({
            designation,
            ref: ref || null,
            prix,
            prixba,
            qte
        })
    });

    const result = await response.json();
    if (!response.ok) {
        throw new Error(result.erreur || 'Erreur lors de la modification');
    }

    showToast('Produit modifié avec succès');
    resetEditProductForm();
    chargerProduits();
} catch (error) {
    showToast(error.message, true);
    console.error('Erreur modification produit:', error);
}
}

async function supprimerProduit(bar) {
const userId = localStorage.getItem('userId');
if (!userId) {
    showToast('Veuillez vous connecter pour supprimer un produit', true);
    return;
}

if (!confirm('Voulez-vous vraiment supprimer ce produit ?')) {
    return;
}

try {
    const response = await fetch(`${API_BASE_URL}/supprimer_produit/${bar}`, {
        method: 'DELETE',
        headers: {
            'X-User-ID': userId
        }
    });

    const result = await response.json();
    if (!response.ok) {
        throw new Error(result.erreur || 'Erreur lors de la suppression');
    }

    showToast('Produit supprimé avec succès');
    chargerProduits();
} catch (error) {
    showToast(error.message, true);
    console.error('Erreur suppression produit:', error);
}
}

function resetProductForm() {
document.getElementById('productDesignation').value = '';
document.getElementById('productBar').value = '';
document.getElementById('productRef').value = '';
document.getElementById('productPrix').value = '';
document.getElementById('productPrixba').value = '';
document.getElementById('productQte').value = '';
document.getElementById('productForm').classList.add('hidden');
stopScanner();
}

function resetEditProductForm() {
document.getElementById('editProductBar').value = '';
document.getElementById('editProductBarDisplay').value = '';
document.getElementById('editProductDesignation').value = '';
document.getElementById('editProductRef').value = '';
document.getElementById('editProductPrix').value = '';
document.getElementById('editProductPrixba').value = '';
document.getElementById('editProductQte').value = '';
document.getElementById('editProductForm').classList.add('hidden');
}

function toggleProductForm() {
document.getElementById('productForm').classList.toggle('hidden');
document.getElementById('editProductForm').classList.add('hidden');
stopScanner();
}

document.getElementById('searchProduct').addEventListener('input', function(e) {
const searchTerm = e.target.value.toLowerCase();
const rows = document.querySelectorAll('#productsList tr');

rows.forEach(row => {
    const designation = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
    const ref = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase();
    if (designation?.includes(searchTerm) || ref?.includes(searchTerm)) {
        row.style.display = '';
    } else {
        row.style.display = 'none';
    }
});
});

// --- Gestion du scanner de code-barres ---
async function startScanner() {
if (!('BarcodeDetector' in window)) {
    showToast('Le scanner de code-barres n\'est pas supporté par ce navigateur', true);
    return;
}

try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    const video = document.createElement('video');
    video.setAttribute('playsinline', '');
    video.setAttribute('autoplay', '');
    video.setAttribute('muted', '');
    video.srcObject = stream;
    video.style.width = '100%';
    video.style.maxHeight = '300px';

    const scannerPreview = document.getElementById('scannerPreview');
    scannerPreview.innerHTML = '';
    scannerPreview.appendChild(video);
    scannerPreview.classList.remove('hidden');

    barcodeDetector = new BarcodeDetector({ formats: ['ean_13', 'code_128', 'upc_a'] });
    isScanning = true;

    async function scan() {
        if (!isScanning || !video.readyState === video.HAVE_ENOUGH_DATA) {
            return;
        }
        try {
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length > 0) {
                document.getElementById('productBar').value = barcodes[0].rawValue;
                stopScanner();
                showToast('Code-barres scanné avec succès');
                return;
            }
        } catch (error) {
            console.error('Erreur de scan:', error);
        }
        requestAnimationFrame(scan);
    }
    video.play();
    scan();
} catch (error) {
    showToast('Erreur d\'accès à la caméra', true);
    console.error('Erreur scanner:', error);
}
}

function stopScanner() {
if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
}
const scannerPreview = document.getElementById('scannerPreview');
scannerPreview.innerHTML = '';
scannerPreview.classList.add('hidden');
isScanning = false;
}

// --- Gestion des utilisateurs ---
async function chargerUtilisateurs() {
const userId = localStorage.getItem('userId');
if (!userId) {
    showToast('Veuillez vous connecter pour voir les utilisateurs', true);
    document.getElementById('utilisateursList').innerHTML = `
        <tr><td colspan="4" class="text-center py-4 text-gray-500">Veuillez vous connecter</td></tr>`;
    return;
}

try {
    console.log('Chargement des utilisateurs avec userId:', userId); // Débogage
    const response = await fetch(`${API_BASE_URL}/liste_utilisateurs`, {
        headers: {
            'X-User-ID': userId,
            'Content-Type': 'application/json'
        }
    });
    console.log('Statut de la réponse:', response.status); // Débogage
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Erreur ${response.status}: ${errorText || response.statusText}`);
    }
    const utilisateurs = await response.json();
    console.log('Utilisateurs reçus:', utilisateurs); // Débogage
    const tbody = document.getElementById('utilisateursList');
    const countElement = document.getElementById('utilisateurCount');

    if (!Array.isArray(utilisateurs) || utilisateurs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Aucun utilisateur trouvé</td></tr>';
        countElement.textContent = '0';
        countElement.classList.remove('hidden');
        return;
    }

    tbody.innerHTML = '';
    utilisateurs.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden-id">${user.numero_ut || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.nom || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.statut || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button onclick="supprimerUtilisateur('${user.numero_ut}')" class="text-red-600 hover:text-red-800 transition">
                    <i class="fas fa-trash-alt"></i> Supprimer
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    countElement.textContent = utilisateurs.length;
    countElement.classList.remove('hidden');
} catch (error) {
    console.error('Erreur lors du chargement des utilisateurs:', error);
    document.getElementById('utilisateursList').innerHTML = `
        <tr>
            <td colspan="4" class="text-center py-4 text-red-500">
                Erreur de chargement: ${error.message}
            </td>
        </tr>`;
    showToast(`Erreur de chargement des utilisateurs: ${error.message}`, true);
}
}

async function ajouterUtilisateur() {
const userId = localStorage.getItem('userId');
if (!userId) {
    showToast('Veuillez vous connecter pour ajouter un utilisateur', true);
    return;
}

const nom = document.getElementById('utilisateurNom').value.trim();
const password = document.getElementById('utilisateurPassword').value.trim();
const statut = document.getElementById('utilisateurStatut').value;

if (!nom || !password) {
    showToast('Veuillez remplir les champs Nom et Mot de passe', true);
    return;
}

// Générer un numero_ut basé sur le nom et le mot de passe
const numero_ut = generateUniqueUserId(nom, password);

try {
    const response = await fetch(`${API_BASE_URL}/ajouter_utilisateur`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-User-ID': userId
        },
        body: JSON.stringify({
            numero_ut,
            nom,
            password,
            statut
        })
    });

    const result = await response.json();
    if (!response.ok) {
        throw new Error(result.erreur || 'Erreur lors de l\'ajout');
    }

    showToast('Utilisateur ajouté avec succès');
    resetUtilisateurForm();
    chargerUtilisateurs();
} catch (error) {
    showToast(error.message, true);
    console.error('Erreur ajout utilisateur:', error);
}
}

async function supprimerUtilisateur(numero_ut) {
const userId = localStorage.getItem('userId');
if (!userId) {
    showToast('Veuillez vous connecter pour supprimer un utilisateur', true);
    return;
}

if (!confirm('Voulez-vous vraiment supprimer cet utilisateur ?')) {
    return;
}

try {
    const response = await fetch(`${API_BASE_URL}/supprimer_utilisateur/${numero_ut}`, {
        method: 'DELETE',
        headers: {
            'X-User-ID': userId
        }
    });

    const result = await response.json();
    if (!response.ok) {
        throw new Error(result.erreur || 'Erreur lors de la suppression');
    }

    showToast('Utilisateur supprimé avec succès');
    chargerUtilisateurs();
} catch (error) {
    showToast(error.message, true);
    console.error('Erreur suppression utilisateur:', error);
}
}

function resetUtilisateurForm() {
document.getElementById('utilisateurNom').value = '';
document.getElementById('utilisateurPassword').value = '';
document.getElementById('utilisateurStatut').value = 'admin';
document.getElementById('utilisateurForm').classList.add('hidden');
}

function toggleUtilisateurForm() {
document.getElementById('utilisateurForm').classList.toggle('hidden');
}

document.getElementById('searchUtilisateur').addEventListener('input', function(e) {
const searchTerm = e.target.value.toLowerCase();
const rows = document.querySelectorAll('#utilisateursList tr');

rows.forEach(row => {
    const nom = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
    const statut = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase();
    if (nom?.includes(searchTerm) || statut?.includes(searchTerm)) {
        row.style.display = '';
    } else {
        row.style.display = 'none';
    }
});
});

</script>
</div>
</body>
</html>             