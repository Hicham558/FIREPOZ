<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Ventes - Menu Restaurant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/4e3d6b2e8c.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 bg-white p-4 rounded shadow">
            <h1 class="text-2xl font-bold">Gestion des Ventes - Menu Restaurant</h1>
            <div class="flex items-center space-x-4">
                <select id="sellerSelect" class="border p-2 rounded">
                    <option value="">Sélectionner un vendeur</option>
                </select>
                <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Left: Category and Product Selection -->
            <div class="col-span-2 bg-white p-4 rounded shadow">
                <!-- Category Tabs -->
                <div class="flex space-x-2 mb-4 overflow-x-auto">
                    <button id="allCategoriesBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Toutes</button>
                    <div id="categoryTabs"></div>
                    <button id="manageCategoriesBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        <i class="fas fa-tags"></i> Gérer Catégories
                    </button>
                </div>

                <!-- Product List -->
                <div id="productList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            </div>

            <!-- Right: Cart and Payment -->
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-xl font-bold mb-4">Panier</h2>
                <div id="cartItems" class="mb-4"></div>
                <div class="border-t pt-4">
                    <p class="flex justify-between"><span>Total:</span><span id="cartTotal">0.00 MAD</span></p>
                    <select id="paymentMode" class="w-full border p-2 mt-2 rounded">
                        <option value="espece">Espèces</option>
                        <option value="cheque">Chèque</option>
                        <option value="a_terme">À terme</option>
                    </select>
                    <input id="amountPaid" type="number" step="0.01" min="0" placeholder="Montant versé" class="w-full border p-2 mt-2 rounded">
                    <select id="clientSelect" class="w-full border p-2 mt-2 rounded hidden">
                        <option value="0">Comptoir</option>
                    </select>
                    <button id="validateSaleBtn" class="w-full bg-green-500 text-white px-4 py-2 mt-2 rounded hover:bg-green-600">
                        Valider Vente
                    </button>
                    <button id="printReceiptBtn" class="w-full bg-gray-500 text-white px-4 py-2 mt-2 rounded hover:bg-gray-600 hidden">
                        Imprimer Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Manage Categories Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-lg">
            <h2 class="text-xl font-bold mb-4">Gérer les Catégories</h2>
            <div class="mb-4">
                <input id="categoryDescription" type="text" placeholder="Nouvelle catégorie" class="w-full border p-2 rounded">
                <button id="addCategoryBtn" class="bg-green-500 text-white px-4 py-2 mt-2 rounded hover:bg-green-600 w-full">
                    Ajouter Catégorie
                </button>
            </div>
            <div id="categoryList" class="max-h-64 overflow-y-auto"></div>
            <button id="closeCategoryModalBtn" class="bg-gray-500 text-white px-4 py-2 mt-4 rounded hover:bg-gray-600 w-full">
                Fermer
            </button>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-lg w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Modifier Catégorie</h2>
            <form id="editCategoryForm">
                <input id="editCategoryId" type="hidden">
                <div class="mb-4">
                    <label class="block">Description</label>
                    <input id="editCategoryDescription" type="text" class="w-full border p-2 rounded" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelEditCategoryBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Annuler</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://hicham03041979.onrender.com';
        let cart = [];
        let currentCategory = 'all';
        let userId = localStorage.getItem('userId') || 'test_user';
        let selectedSellerId = null;

        // Fetch Headers
        const getHeaders = () => ({
            'Content-Type': 'application/json',
            'X-User-ID': userId
        });

        // Load Sellers
        async function loadSellers() {
            try {
                const response = await fetch(`${API_URL}/liste_utilisateurs`, { headers: getHeaders() });
                const sellers = await response.json();
                const sellerSelect = document.getElementById('sellerSelect');
                sellerSelect.innerHTML = '<option value="">Sélectionner un vendeur</option>';
                sellers.forEach(seller => {
                    const option = document.createElement('option');
                    option.value = seller.numero;
                    option.textContent = seller.nom;
                    sellerSelect.appendChild(option);
                });
                const savedSeller = localStorage.getItem('selectedSeller');
                if (savedSeller) {
                    sellerSelect.value = savedSeller;
                    selectedSellerId = savedSeller;
                }
            } catch (error) {
                console.error('Erreur chargement vendeurs:', error);
            }
        }

        // Load Categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/liste_categories`, { headers: getHeaders() });
                const categories = await response.json();
                const categoryTabs = document.getElementById('categoryTabs');
                categoryTabs.innerHTML = '';

                categories.forEach(category => {
                    const btn = document.createElement('button');
                    btn.className = `px-4 py-2 rounded hover:bg-blue-600 ${currentCategory === category.numer_categorie ? 'bg-blue-700 text-white' : 'bg-blue-500 text-white'}`;
                    btn.textContent = category.description_c;
                    btn.onclick = () => {
                        currentCategory = category.numer_categorie;
                        loadCategories();
                        loadProducts();
                    };
                    categoryTabs.appendChild(btn);
                });
            } catch (error) {
                console.error('Erreur chargement catégories:', error);
            }
        }

        // Load Products
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/liste_produits`, { headers: getHeaders() });
                const products = await response.json();
                const productList = document.getElementById('productList');
                productList.innerHTML = '';

                const filteredProducts = currentCategory === 'all' 
                    ? products 
                    : products.filter(p => p.NUMERO_CATEGORIE == currentCategory);

                filteredProducts.forEach(product => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-100 p-4 rounded shadow cursor-pointer hover:bg-gray-200';
                    div.innerHTML = `
                        <p class="font-bold">${product.DESIGNATION}</p>
                        <p>Prix: ${product.PRIX.toFixed(2)} MAD</p>
                        <p>Stock: ${product.QTE}</p>
                    `;
                    div.onclick = () => addToCart(product);
                    productList.appendChild(div);
                });
            } catch (error) {
                console.error('Erreur chargement produits:', error);
            }
        }

        // Load Clients
        async function loadClients() {
            try {
                const response = await fetch(`${API_URL}/liste_clients`, { headers: getHeaders() });
                const clients = await response.json();
                const clientSelect = document.getElementById('clientSelect');
                clientSelect.innerHTML = '<option value="0">Comptoir</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.numero_clt;
                    option.textContent = `${client.nom} (${client.solde.toFixed(2)} MAD)`;
                    clientSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement clients:', error);
            }
        }

        // Add to Cart
        function addToCart(product) {
            const existingItem = cart.find(item => item.numero_item === product.NUMERO_ITEM);
            if (existingItem) {
                if (existingItem.quantite < product.QTE) {
                    existingItem.quantite += 1;
                    existingItem.prixt = (existingItem.quantite * product.PRIX).toFixed(2);
                } else {
                    alert('Stock insuffisant!');
                }
            } else {
                if (product.QTE > 0) {
                    cart.push({
                        numero_item: product.NUMERO_ITEM,
                        designation: product.DESIGNATION,
                        quantite: 1,
                        prixt: product.PRIX.toFixed(2),
                        prixbh: product.PRIXBA || '0.00',
                        remarque: ''
                    });
                } else {
                    alert('Produit en rupture de stock!');
                }
            }
            updateCart();
        }

        // Update Cart Display
        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            cartItems.innerHTML = '';
            let total = 0;

            cart.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center mb-2 border-b pb-2';
                div.innerHTML = `
                    <div>
                        <p class="font-bold">${item.designation}</p>
                        <p>${item.quantite} x ${item.prixt / item.quantite} = ${item.prixt} MAD</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="adjustQuantity(${index}, -1)" class="bg-yellow-500 text-white px-2 py-1 rounded">-</button>
                        <span>${item.quantite}</span>
                        <button onclick="adjustQuantity(${index}, 1)" class="bg-yellow-500 text-white px-2 py-1 rounded">+</button>
                        <button onclick="removeFromCart(${index})" class="bg-red-500 text-white px-2 py-1 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                cartItems.appendChild(div);
                total += parseFloat(item.prixt);
            });

            cartTotal.textContent = `${total.toFixed(2)} MAD`;
            togglePrintReceiptButton();
        }

        // Adjust Quantity
        async function adjustQuantity(index, change) {
            const item = cart[index];
            const product = await getProduct(item.numero_item);
            const newQuantity = item.quantite + change;

            if (newQuantity <= 0) {
                removeFromCart(index);
            } else if (newQuantity <= product.QTE) {
                item.quantite = newQuantity;
                item.prixt = (newQuantity * (product.PRIX)).toFixed(2);
                updateCart();
            } else {
                alert('Stock insuffisant!');
            }
        }

        // Remove from Cart
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart();
        }

        // Get Product by ID
        async function getProduct(numero_item) {
            const response = await fetch(`${API_URL}/liste_produits`, { headers: getHeaders() });
            const products = await response.json();
            return products.find(p => p.NUMERO_ITEM === numero_item);
        }

        // Validate Sale
        async function validateSale() {
            if (!cart.length) {
                alert('Le panier est vide!');
                return;
            }
            if (!selectedSellerId) {
                alert('Veuillez sélectionner un vendeur!');
                return;
            }
            const paymentMode = document.getElementById('paymentMode').value;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
            const numeroTable = document.getElementById('clientSelect').value;

            if (paymentMode === 'a_terme' && numeroTable === '0') {
                alert('Veuillez sélectionner un client pour une vente à terme!');
                return;
            }

            const saleData = {
                lignes: cart.map(item => ({
                    numero_item: item.numero_item,
                    quantite: item.quantite,
                    prixt: item.prixt,
                    prixbh: item.prixbh,
                    remarque: item.remarque
                })),
                numero_table: parseInt(numeroTable),
                date_comande: new Date().toISOString(),
                payment_mode: paymentMode,
                amount_paid: amountPaid,
                numero_util: parseInt(selectedSellerId)
            };

            try {
                const response = await fetch(`${API_URL}/valider_vente`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(saleData)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('Vente validée avec succès!');
                    cart = [];
                    updateCart();
                    loadProducts();
                    loadClients();
                    document.getElementById('amountPaid').value = '';
                    document.getElementById('printReceiptBtn').classList.remove('hidden');
                    localStorage.setItem('lastSale', JSON.stringify(saleData));
                    localStorage.setItem('lastSaleId', result.numero_comande);
                } else {
                    alert(`Erreur: ${result.error || 'Échec de la validation'}`);
                }
            } catch (error) {
                console.error('Erreur validation vente:', error);
                alert('Erreur lors de la validation de la vente.');
            }
        }

        // Print Receipt (80mm)
        function printReceipt() {
            const lastSale = JSON.parse(localStorage.getItem('lastSale'));
            if (!lastSale) return;

            const receiptWindow = window.open('', '_blank');
            receiptWindow.document.write(`
                <html>
                <head>
                    <style>
                        body { font-family: monospace; width: 80mm; margin: 0; padding: 10px; font-size: 12px; }
                        .receipt { text-align: center; }
                        .receipt p { margin: 2px 0; }
                        .items { width: 100%; }
                        .items div { display: flex; justify-content: space-between; }
                        .total { border-top: 1px dashed #000; padding-top: 5px; margin-top: 5px; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <p><strong>Restaurant XYZ</strong></p>
                        <p>Date: ${new Date(lastSale.date_comande).toLocaleString()}</p>
                        <p>Vendeur: ${document.getElementById('sellerSelect').selectedOptions[0].text}</p>
                        <p>Client: ${lastSale.numero_table === 0 ? 'Comptoir' : document.getElementById('clientSelect').selectedOptions[0].text}</p>
                        <div class="items">
                            ${lastSale.lignes.map(item => `
                                <div>
                                    <span>${item.quantite}x ${item.designation}</span>
                                    <span>${item.prixt} MAD</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="total">
                            <p><strong>Total: ${lastSale.lignes.reduce((sum, item) => sum + parseFloat(item.prixt), 0).toFixed(2)} MAD</strong></p>
                            <p>Mode: ${lastSale.payment_mode}</p>
                            <p>Montant versé: ${lastSale.amount_paid.toFixed(2)} MAD</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            receiptWindow.document.close();
            receiptWindow.print();
            receiptWindow.close();
        }

        // Toggle Print Receipt Button
        function togglePrintReceiptButton() {
            const printReceiptBtn = document.getElementById('printReceiptBtn');
            if (cart.length === 0 && localStorage.getItem('lastSale')) {
                printReceiptBtn.classList.remove('hidden');
            } else {
                printReceiptBtn.classList.add('hidden');
            }
        }

        // Handle Category Modal
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.remove('hidden');
            loadCategoryList();
        }

        // Load Category List with Products
        async function loadCategoryList() {
            try {
                const [categoriesResponse, productsResponse] = await Promise.all([
                    fetch(`${API_URL}/liste_categories`, { headers: getHeaders() }),
                    fetch(`${API_URL}/liste_produits`, { headers: getHeaders() })
                ]);
                const categories = await categoriesResponse.json();
                const products = await productsResponse.json();
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = '';

                // Add unassigned products section
                const unassignedProducts = products.filter(p => !p.NUMERO_CATEGORIE);
                const unassignedDiv = document.createElement('div');
                unassignedDiv.className = 'mb-4';
                unassignedDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">Non assignés</span>
                    </div>
                    <div class="pl-4">
                        ${unassignedProducts.length ? unassignedProducts.map(product => `
                            <div class="flex justify-between items-center mb-1">
                                <span>${product.DESIGNATION}</span>
                                <select onchange="assignCategory(${product.NUMERO_ITEM}, this.value)" class="border p-1 rounded">
                                    <option value="">Assigner à...</option>
                                    ${categories.map(cat => `<option value="${cat.numer_categorie}">${cat.description_c}</option>`).join('')}
                                </select>
                            </div>
                        `).join('') : '<p>Aucun produit non assigné</p>'}
                    </div>
                `;
                categoryList.appendChild(unassignedDiv);

                // Add categories with their products
                categories.forEach(category => {
                    const categoryProducts = products.filter(p => p.NUMERO_CATEGORIE == category.numer_categorie);
                    const div = document.createElement('div');
                    div.className = 'mb-4';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold">${category.description_c}</span>
                            <div>
                                <button onclick="editCategory(${category.numer_categorie}, '${category.description_c}')" class="bg-yellow-500 text-white px-2 py-1 rounded mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteCategory(${category.numer_categorie})" class="bg-red-500 text-white px-2 py-1 rounded"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="pl-4">
                            ${categoryProducts.length ? categoryProducts.map(product => `
                                <div class="flex justify-between items-center mb-1">
                                    <span>${product.DESIGNATION}</span>
                                    <select onchange="assignCategory(${product.NUMERO_ITEM}, this.value)" class="border p-1 rounded">
                                        <option value="">Retirer de la catégorie</option>
                                        ${categories.map(cat => `
                                            <option value="${cat.numer_categorie}" ${cat.numer_categorie == category.numer_categorie ? 'selected' : ''}>
                                                ${cat.description_c}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            `).join('') : '<p>Aucun produit dans cette catégorie</p>'}
                        </div>
                    `;
                    categoryList.appendChild(div);
                });
            } catch (error) {
                console.error('Erreur chargement liste catégories:', error);
            }
        }

        // Assign Category to Product
      async function assignCategory(numero_item, numero_categorie) {
    console.log('Assigning:', { numero_item, numero_categorie });
    try {
        const response = await fetch(`${API_URL}/assigner_categorie`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({
                numero_item: parseInt(numero_item),
                numero_categorie: numero_categorie ? parseInt(numero_categorie) : null
            })
        });
        const result = await response.json();
        console.log('Response:', result);
        if (response.ok) {
            alert('Catégorie assignée!');
            loadCategoryList();
            loadProducts();
        } else {
            alert(`Erreur: ${result.erreur}`);
        }
    } catch (error) {
        console.error('Erreur assignation catégorie:', error);
        alert('Erreur lors de l’assignation de la catégorie.');
    }
}

        // Add Category
        async function addCategory() {
            const description = document.getElementById('categoryDescription').value;
            if (!description) {
                alert('Description requise!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/ajouter_categorie`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ description_c: description })
                });
                if (response.ok) {
                    alert('Catégorie ajoutée!');
                    document.getElementById('categoryDescription').value = '';
                    loadCategoryList();
                    loadCategories();
                } else {
                    const result = await response.json();
                    alert(`Erreur: ${result.erreur}`);
                }
            } catch (error) {
                console.error('Erreur ajout catégorie:', error);
                alert('Erreur lors de l’ajout de la catégorie.');
            }
        }

        // Edit Category
        function editCategory(id, description) {
            document.getElementById('categoryModal').classList.add('hidden');
            document.getElementById('editCategoryModal').classList.remove('hidden');
            document.getElementById('editCategoryId').value = id;
            document.getElementById('editCategoryDescription').value = description;
        }

        // Save Edited Category
        async function saveEditedCategory(event) {
            event.preventDefault();
            const id = document.getElementById('editCategoryId').value;
            const description = document.getElementById('editCategoryDescription').value;

            try {
                const response = await fetch(`${API_URL}/modifier_categorie/${id}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ description_c: description })
                });
                if (response.ok) {
                    alert('Catégorie modifiée!');
                    document.getElementById('editCategoryModal').classList.add('hidden');
                    openCategoryModal();
                    loadCategories();
                } else {
                    const result = await response.json();
                    alert(`Erreur: ${result.erreur}`);
                }
            } catch (error) {
                console.error('Erreur modification catégorie:', error);
                alert('Erreur lors de la modification de la catégorie.');
            }
        }

        // Delete Category
        async function deleteCategory(id) {
            if (!confirm('Voulez-vous supprimer cette catégorie?')) return;

            try {
                const response = await fetch(`${API_URL}/supprimer_categorie/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                if (response.ok) {
                    alert('Catégorie supprimée!');
                    loadCategoryList();
                    loadCategories();
                } else {
                    const result = await response.json();
                    alert(`Erreur: ${result.erreur}`);
                }
            } catch (error) {
                console.error('Erreur suppression catégorie:', error);
                alert('Erreur lors de la suppression de la catégorie.');
            }
        }

        // Event Listeners
        document.getElementById('sellerSelect').addEventListener('change', (e) => {
            selectedSellerId = e.target.value;
            localStorage.setItem('selectedSeller', selectedSellerId);
        });

        document.getElementById('paymentMode').addEventListener('change', (e) => {
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.classList.toggle('hidden', e.target.value !== 'a_terme');
        });

        document.getElementById('validateSaleBtn').addEventListener('click', validateSale);
        document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);

        document.getElementById('manageCategoriesBtn').addEventListener('click', openCategoryModal);
        document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
        document.getElementById('closeCategoryModalBtn').addEventListener('click', () => {
            document.getElementById('categoryModal').classList.add('hidden');
        });
        document.getElementById('cancelEditCategoryBtn').addEventListener('click', () => {
            document.getElementById('editCategoryModal').classList.add('hidden');
            openCategoryModal();
        });
        document.getElementById('editCategoryForm').addEventListener('submit', saveEditedCategory);

        document.getElementById('allCategoriesBtn').addEventListener('click', () => {
            currentCategory = 'all';
            loadCategories();
            loadProducts();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('userId');
            localStorage.removeItem('selectedSeller');
            localStorage.removeItem('lastSale');
            localStorage.removeItem('lastSaleId');
            window.location.reload();
        });

        // Initialize
        loadSellers();
        loadCategories();
        loadProducts();
        loadClients();
        updateCart();
    </script>
</body>
</html>
