<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Donn√©es - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script type="module" src="db.js"></script>
  <style>
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    @keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
    @keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
    .loading { display: none; }
    .loading.show { display: block; }
    .modal { display: none; }
    .modal.show { display: flex; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- LocalStorage Patch -->
  <script>
    (function(){
      const DB_NAME = "FirePozDB";
      const STORE_NAME = "keyvalue";
      let dbPromise = null;
      let isInitializing = false;

      function initDB() {
        if (dbPromise || isInitializing) return dbPromise;
        isInitializing = true;
        dbPromise = new Promise((resolve, reject) => {
          try {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = (e) => {
              const db = e.target.result;
              if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
              }
            };
            req.onsuccess = (e) => {
              isInitializing = false;
              resolve(e.target.result);
            };
            req.onerror = (e) => {
              isInitializing = false;
              console.warn("‚ö†Ô∏è IndexedDB indisponible:", e.target.error.message);
              resolve(null);
            };
            req.onblocked = (e) => {
              console.warn("‚ö†Ô∏è IndexedDB bloqu√©:", e);
              setTimeout(() => {
                isInitializing = false;
                resolve(null);
              }, 1000);
            };
          } catch (err) {
            isInitializing = false;
            console.warn("‚ö†Ô∏è Erreur init IndexedDB:", err.message);
            resolve(null);
          }
        });
        return dbPromise;
      }

      async function idbGet(key) {
        try {
          const db = await initDB();
          if (!db) return null;
          return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const req = store.get(key);
            req.onsuccess = () => resolve(req.result || null);
            req.onerror = () => resolve(null);
          });
        } catch (e) {
          return null;
        }
      }

      async function idbSet(key, value) {
        try {
          const db = await initDB();
          if (!db) return false;
          return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            store.put(value, key);
            tx.oncomplete = () => resolve(true);
            tx.onerror = () => resolve(false);
          });
        } catch (e) {
          return false;
        }
      }

      async function idbRemove(key) {
        try {
          const db = await initDB();
          if (!db) return false;
          return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            store.delete(key);
            tx.oncomplete = () => resolve(true);
            tx.onerror = () => resolve(false);
          });
        } catch (e) {
          return false;
        }
      }

      const originalLocalStorage = window.localStorage;
      window.localStorage = {
        _cache: {},
        _initialized: false,

        async _init() {
          if (this._initialized) return;
          console.log("üîÑ Chargement cache localStorage...");
          const keys = ["gestion_db", "gestion_db_list", "gestion_db_active", "apiBaseUrl"];
          for (let key of keys) {
            let value = await idbGet(key);
            if (value === null) {
              try {
                value = originalLocalStorage.getItem(key);
                if (value) {
                  await idbSet(key, value);
                  console.log(`üì¶ Migr√© ${key} vers IndexedDB`);
                }
              } catch (e) {
                console.warn(`‚ö†Ô∏è Erreur lecture localStorage natif pour ${key}:`, e.message);
              }
            } else {
              console.log(`üì¶ Charg√© ${key} depuis IndexedDB`);
            }
            if (value !== null) {
              this._cache[key] = value;
            }
          }
          this._initialized = true;
          console.log("‚úÖ Cache localStorage initialis√©");
        },

        getItem(key) {
          return this._cache[key] || null;
        },

        setItem(key, value) {
          this._cache[key] = value;
          idbSet(key, value).catch((e) => {
            console.warn(`‚ö†Ô∏è Erreur sauvegarde ${key} dans IndexedDB:`, e.message);
            try {
              originalLocalStorage.setItem(key, value);
            } catch (fallbackError) {
              console.warn(`‚ö†Ô∏è Erreur sauvegarde ${key} dans localStorage:`, fallbackError.message);
            }
          });
        },

        removeItem(key) {
          delete this._cache[key];
          idbRemove(key).catch((e) => {
            console.warn(`‚ö†Ô∏è Erreur suppression ${key} dans IndexedDB:`, e.message);
            try {
              originalLocalStorage.removeItem(key);
            } catch (fallbackError) {
              console.warn(`‚ö†Ô∏è Erreur suppression ${key} dans localStorage:`, fallbackError.message);
            }
          });
        },

        key(index) {
          const keys = Object.keys(this._cache);
          return keys[index] || null;
        },

        get length() {
          return Object.keys(this._cache).length;
        },

        clear() {
          this._cache = {};
        },
      };

      (async () => {
        try {
          await window.localStorage._init();
        } catch (e) {
          console.error("‚ùå Erreur initialisation storage:", e.message);
        } finally {
          setTimeout(() => {
            window.dispatchEvent(new CustomEvent("storageReady"));
          }, 100);
        }
      })();
    })();
  </script>

  <!-- Loading Indicator -->
  <div id="loading" class="loading show fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg">
      <i class="fas fa-spinner fa-spin mr-2"></i> Chargement des donn√©es...
    </div>
  </div>

  <!-- Modal for Input -->
  <div id="nameModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h3 id="modalTitle" class="text-lg font-semibold mb-4"></h3>
      <input id="modalInput" type="text" class="w-full p-2 border rounded mb-4" placeholder="Nom de la base">
      <div class="flex justify-end space-x-2">
        <button id="modalCancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Annuler</button>
        <button id="modalConfirm" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">
        <i class="fas fa-database mr-2"></i>Gestion Multi-Base de Donn√©es
      </h1>
      <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
        <i class="fas fa-home mr-2"></i>Accueil
      </button>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    <!-- Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6 text-center">
        <i class="fas fa-database text-3xl text-blue-500 mb-2"></i>
        <h3 class="text-xl font-semibold text-gray-800">Base Active</h3>
        <p id="activeDbName" class="text-gray-600">Aucune</p>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 text-center">
        <i class="fas fa-archive text-3xl text-green-500 mb-2"></i>
        <h3 class="text-xl font-semibold text-gray-800">Bases Sauvegard√©es</h3>
        <p id="dbCount" class="text-gray-600">0</p>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 text-center">
        <i class="fas fa-hdd text-3xl text-purple-500 mb-2"></i>
        <h3 class="text-xl font-semibold text-gray-800">Taille Totale</h3>
        <p id="totalSize" class="text-gray-600">0 MB</p>
      </div>
    </div>

    <!-- Gestion Base de Donn√©es -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">
        <i class="fas fa-tools mr-2 text-indigo-500"></i>Outils Base de Donn√©es
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <button onclick="downloadDatabase()" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 transition">
          <i class="fas fa-file-download mr-2"></i>T√©l√©charger Base Active
        </button>
        <button onclick="resetDatabase()" class="w-full bg-red-600 text-white px-4 py-3 rounded-md hover:bg-red-700 transition">
          <i class="fas fa-trash mr-2"></i>R√©initialiser Base Active
        </button>
        <label class="w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 transition text-center cursor-pointer">
          <i class="fas fa-upload mr-2"></i>Importer Fichier DB
          <input type="file" id="uploadDb" accept=".db,.sqlite,.sqlite3" class="hidden" onchange="uploadDatabase(event)">
        </label>
        <button onclick="createNewDatabase()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 transition">
          <i class="fas fa-plus-circle mr-2"></i>Cr√©er Nouvelle Base
        </button>
        <button onclick="updateFromServer()" class="w-full bg-yellow-600 text-white px-4 py-3 rounded-md hover:bg-yellow-700 transition">
          <i class="fas fa-cloud-download-alt mr-2"></i>Synchroniser Serveur
        </button>
        <button onclick="exportAllDatabases()" class="w-full bg-purple-600 text-white px-4 py-3 rounded-md hover:bg-purple-700 transition">
          <i class="fas fa-file-export mr-2"></i>Exporter Toutes
        </button>
      </div>
    </div>

    <!-- Liste des bases sauvegard√©es -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">
          <i class="fas fa-list mr-2 text-indigo-500"></i>Bases Sauvegard√©es
        </h2>
        <button onclick="refreshDbList()" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
          <i class="fas fa-sync-alt mr-1"></i>Actualiser
        </button>
      </div>
      <div id="dbListContainer">
        <ul id="dbList" class="space-y-3"></ul>
        <div id="emptyState" class="text-center py-8 text-gray-500 hidden">
          <i class="fas fa-database text-4xl mb-4"></i>
          <p>Aucune base de donn√©es sauvegard√©e</p>
          <p class="text-sm">Cr√©ez ou importez une base pour commencer</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden z-40">
    <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
      <i id="toastIcon" class="mr-2"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <script type="module">
    import { getDbList, saveDbList, getActiveIndex, setActiveIndex, isDbFile, saveDbToStorage, resetDatabase as resetDb, exportCurrentDb, importDb } from './db.js';

    const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';
    let isInitialized = false;

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      toast.className = isError
        ? 'fixed bottom-4 right-4 flex items-center bg-red-500 text-white px-6 py-3 rounded-md shadow-lg toast-in z-40'
        : 'fixed bottom-4 right-4 flex items-center bg-green-500 text-white px-6 py-3 rounded-md shadow-lg toast-in z-40';
      toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
      toastMessage.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.remove('toast-in');
        toast.classList.add('toast-out');
        setTimeout(() => toast.classList.add('hidden'), 500);
      }, 3000);
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading');
      if (!loading) return;
      if (show) {
        loading.classList.add('show');
        loading.classList.remove('hidden');
      } else {
        loading.classList.remove('show');
        setTimeout(() => loading.classList.add('hidden'), 100);
      }
    }

    function showModal(title, callback) {
      const modal = document.getElementById('nameModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalInput = document.getElementById('modalInput');
      const modalConfirm = document.getElementById('modalConfirm');
      const modalCancel = document.getElementById('modalCancel');
      modalTitle.textContent = title;
      modalInput.value = '';
      modal.classList.add('show');

      const confirmHandler = () => {
        const value = modalInput.value.trim();
        if (value) callback(value);
        modal.classList.remove('show');
        modalConfirm.removeEventListener('click', confirmHandler);
        modalCancel.removeEventListener('click', cancelHandler);
      };

      const cancelHandler = () => {
        modal.classList.remove('show');
        modalConfirm.removeEventListener('click', confirmHandler);
        modalCancel.removeEventListener('click', cancelHandler);
      };

      modalConfirm.addEventListener('click', confirmHandler);
      modalCancel.addEventListener('click', cancelHandler);
    }

    function goHome() {
      window.location.href = "index.html";
    }

    function getActiveDatabaseName() {
      const list = getDbList();
      const activeIndex = getActiveIndex();
      return activeIndex >= 0 && list[activeIndex] ? list[activeIndex].name : "Aucune";
    }

    function calculateTotalSize() {
      const list = getDbList();
      const totalBytes = list.reduce((sum, db) => sum + (db.data ? db.data.length : 0), 0);
      return (totalBytes / 1024 / 1024).toFixed(2);
    }

    async function downloadDatabase() {
      const dbData = localStorage.getItem('gestion_db');
      if (!dbData) {
        showToast("Aucune base active trouv√©e", true);
        return;
      }

      try {
        const bytes = Uint8Array.from(atob(dbData), (c) => c.charCodeAt(0));
        const blob = new Blob([bytes], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const activeName = getActiveDatabaseName();
        a.href = url;
        a.download = activeName !== "Aucune" ? `${activeName}.db` : "gestion.db";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("Base t√©l√©charg√©e avec succ√®s");
      } catch (error) {
        console.error("‚ùå Erreur t√©l√©chargement:", error.message);
        showToast("Erreur lors du t√©l√©chargement", true);
      }
    }

    async function resetDatabase() {
      if (!confirm("‚ö†Ô∏è R√©initialiser la base de production avec gestion.db ?\n\nCette action est irr√©versible.")) return;
      showLoading(true);
      try {
        await resetDb();
        showToast("Base de production r√©initialis√©e");
        updateStats();
      } catch (error) {
        console.error("‚ùå Erreur r√©initialisation:", error.message);
        showToast("Erreur lors de la r√©initialisation", true);
      } finally {
        showLoading(false);
      }
    }

    async function uploadDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!isDbFile(file.name)) {
        showToast("Format non valide. Utilisez .db, .sqlite ou .sqlite3", true);
        return;
      }

      showLoading(true);
      const reader = new FileReader();

      reader.onload = async function (e) {
        try {
          const bytes = new Uint8Array(e.target.result);
          const base64 = btoa(String.fromCharCode(...bytes));
          await importDb(base64);
          const list = await getDbList();
          const newDb = {
            id: Date.now(),
            name: file.name.replace(/\.(db|sqlite|sqlite3)$/i, ''),
            data: base64,
            createdAt: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            size: base64.length,
          };
          list.push(newDb);
          await saveDbList(list);
          await setActiveIndex(list.length - 1);
          showToast(`Base "${newDb.name}" import√©e et activ√©e`);
          renderDbList();
          updateStats();
        } catch (error) {
          console.error("‚ùå Erreur import:", error.message);
          showToast("Erreur lors de l'importation", true);
        } finally {
          showLoading(false);
        }
      };

      reader.onerror = () => {
        showLoading(false);
        showToast("Erreur de lecture du fichier", true);
      };

      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    async function createNewDatabase() {
      showModal("Nom de la nouvelle base", async (name) => {
        if (!name) return;
        showLoading(true);
        try {
          const newDb = await createNewDb();
          const base64 = await exportCurrentDb();
          const list = await getDbList();
          const newDbEntry = {
            id: Date.now(),
            name,
            data: base64,
            createdAt: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            size: base64.length,
          };
          list.push(newDbEntry);
          await saveDbList(list);
          await setActiveDb(base64);
          await setActiveIndex(list.length - 1);
          showToast(`Nouvelle base "${name}" cr√©√©e`);
          renderDbList();
          updateStats();
        } catch (error) {
          console.error("‚ùå Erreur cr√©ation:", error.message);
          showToast("Erreur lors de la cr√©ation", true);
        } finally {
          showLoading(false);
        }
      });
    }

    async function updateFromServer() {
      showLoading(true);
      try {
        const response = await fetch(`${API_BASE_URL}/export`);
        if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
        const data = await response.json();
        const base64Db = data.db;
        await importDb(base64Db);
        const list = await getDbList();
        const newDb = {
          id: Date.now(),
          name: `BaseServeur_${new Date().toLocaleString('fr-FR')}`,
          data: base64Db,
          createdAt: new Date().toISOString(),
          lastModified: new Date().toISOString(),
          size: base64Db.length,
          fromServer: true,
        };
        list.push(newDb);
        await saveDbList(list);
        await setActiveIndex(list.length - 1);
        localStorage.setItem("apiBaseUrl", "/api");
        renderDbList();
        updateStats();
        showToast("Base synchronis√©e depuis le serveur et activ√©e");
      } catch (err) {
        console.error("‚ùå Erreur sync serveur:", err.message);
        showToast(`Erreur serveur: ${err.message}`, true);
      } finally {
        showLoading(false);
      }
    }

    async function exportAllDatabases() {
      const list = await getDbList();
      if (list.length === 0) {
        showToast("Aucune base √† exporter", true);
        return;
      }
      const exportData = {
        exportDate: new Date().toISOString(),
        databases: list.map((db) => ({
          id: db.id,
          name: db.name,
          createdAt: db.createdAt,
          data: db.data,
        })),
      };
      const jsonString = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bases_export_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast(`${list.length} base(s) export√©e(s)`);
    }

    async function saveCurrentBeforeSwitch() {
      const idx = await getActiveIndex();
      if (idx >= 0) {
        const list = await getDbList();
        if (list[idx]) {
          const currentData = localStorage.getItem("gestion_db");
          if (currentData) {
            list[idx].data = currentData;
            list[idx].size = currentData.length;
            list[idx].lastModified = new Date().toISOString();
            await saveDbList(list);
          }
        }
      }
    }

    async function selectDatabase(idx) {
      await saveCurrentBeforeSwitch();
      const list = await getDbList();
      if (list[idx]) {
        await setActiveDb(list[idx].data);
        await setActiveIndex(idx);
        showToast(`"${list[idx].name}" est maintenant la base active`);
        updateStats();
        renderDbList();
      }
    }

    async function renameDatabase(idx) {
      const list = await getDbList();
      if (!list[idx]) return;
      showModal("Renommer la base", async (newName) => {
        if (newName && newName !== list[idx].name) {
          list[idx].name = newName;
          await saveDbList(list);
          renderDbList();
          updateStats();
          showToast("Base renomm√©e");
        }
      });
    }

    async function deleteDatabase(idx) {
      const list = await getDbList();
      if (!list[idx]) return;
      if (!confirm(`‚ö†Ô∏è Supprimer d√©finitivement la base "${list[idx].name}" ?\n\nCette action est irr√©versible.`)) return;
      const wasActive = idx === (await getActiveIndex());
      list.splice(idx, 1);
      await saveDbList(list);
      if (wasActive) {
        localStorage.removeItem("gestion_db");
        await setActiveIndex(-1);
      }
      renderDbList();
      updateStats();
      showToast("Base supprim√©e");
    }

    async function duplicateDatabase(idx) {
      const list = await getDbList();
      if (!list[idx]) return;
      const originalDb = list[idx];
      const newDb = {
        id: Date.now(),
        name: `${originalDb.name}_copie`,
        data: originalDb.data,
        createdAt: new Date().toISOString(),
        size: originalDb.size,
      };
      list.push(newDb);
      await saveDbList(list);
      renderDbList();
      updateStats();
      showToast(`Base "${originalDb.name}" dupliqu√©e`);
    }

    async function refreshDbList() {
      renderDbList();
      updateStats();
      showToast("Liste actualis√©e");
    }

    function formatDate(dateString) {
      if (!dateString) return "Date inconnue";
      return new Date(dateString).toLocaleString('fr-FR');
    }

    function formatSize(bytes) {
      if (!bytes) return "0 KB";
      const kb = bytes / 1024;
      const mb = kb / 1024;
      if (mb >= 1) return `${mb.toFixed(2)} MB`;
      if (kb >= 1) return `${kb.toFixed(1)} KB`;
      return `${bytes} B`;
    }

    async function renderDbList() {
      const list = await getDbList();
      const active = await getActiveIndex();
      const ul = document.getElementById("dbList");
      const emptyState = document.getElementById("emptyState");
      ul.innerHTML = "";
      if (list.length === 0) {
        emptyState.classList.remove("hidden");
        return;
      }
      emptyState.classList.add("hidden");
      list.forEach((db, idx) => {
        const li = document.createElement("li");
        const isActive = idx === active;
        const createdAt = formatDate(db.createdAt);
        const size = formatSize(db.size);
        li.className = `border rounded-lg p-4 ${isActive ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`;
        li.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4 flex-1">
              <input type="radio" name="activeDb" ${isActive ? "checked" : ""} 
                     onchange="selectDatabase(${idx})" 
                     class="w-4 h-4 text-indigo-600">
              <div class="flex-1">
                <div class="flex items-center space-x-2">
                  <span class="font-medium text-lg">${db.name}</span>
                  ${isActive ? '<span class="bg-indigo-500 text-white text-xs px-2 py-1 rounded">ACTIVE</span>' : ''}
                  ${db.fromServer ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded">SERVEUR</span>' : ''}
                </div>
                <div class="text-sm text-gray-600 mt-1">
                  <span><i class="fas fa-calendar mr-1"></i>${createdAt}</span>
                  <span class="ml-4"><i class="fas fa-hdd mr-1"></i>${size}</span>
                </div>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="duplicateDatabase(${idx})" 
                      class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 transition"
                      title="Dupliquer">
                <i class="fas fa-copy"></i>
              </button>
              <button onclick="renameDatabase(${idx})" 
                      class="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 transition"
                      title="Renommer">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteDatabase(${idx})" 
                      class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition"
                      title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
        ul.appendChild(li);
      });
    }

    async function updateStats() {
      const list = await getDbList();
      const activeName = getActiveDatabaseName();
      const totalSize = calculateTotalSize();
      document.getElementById("activeDbName").textContent = activeName;
      document.getElementById("dbCount").textContent = list.length.toString();
      document.getElementById("totalSize").textContent = `${totalSize} MB`;
    }

    async function initializeApp() {
      if (isInitialized) return;
      console.log("üöÄ Initialisation de l'application...");
      isInitialized = true;
      try {
        showLoading(false);
        await updateStats();
        await renderDbList();
        console.log("‚úÖ Application initialis√©e avec succ√®s");
      } catch (error) {
        console.error("‚ùå Erreur lors de l'initialisation:", error.message);
        showLoading(false);
        showToast("Erreur lors de l'initialisation", true);
      }
    }

    window.addEventListener('storageReady', () => {
      console.log("üì° Storage pr√™t - initialisation de l'app");
      initializeApp();
    });

    setTimeout(() => {
      if (!isInitialized) {
        console.warn("‚ö†Ô∏è Timeout storage - initialisation forc√©e");
        initializeApp();
      }
    }, 2000);

    if (document.readyState === 'loading') {
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          if (!isInitialized) {
            console.log("üîÑ Initialisation post-DOM");
            initializeApp();
          }
        }, 100);
      });
    } else {
      setTimeout(() => {
        if (!isInitialized) {
          console.log("üîÑ DOM d√©j√† pr√™t - init imm√©diate");
          initializeApp();
        }
      }, 100);
    }
  </script>
</body>
</html>
