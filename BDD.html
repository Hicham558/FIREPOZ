<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Données - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    @keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
    @keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ⚡ Patch localStorage avec IndexedDB -->
  <script>
    (function(){
      const DB_NAME = "FirePozDB";
      const STORE_NAME = "keyvalue";
      let dbPromise = new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => {
          e.target.result.createObjectStore(STORE_NAME);
        };
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e);
      });

      async function idbGet(key) {
        const db = await dbPromise;
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, "readonly");
          const store = tx.objectStore(STORE_NAME);
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = reject;
        });
      }
      async function idbSet(key, value) {
        const db = await dbPromise;
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, "readwrite");
          const store = tx.objectStore(STORE_NAME);
          store.put(value, key);
          tx.oncomplete = () => resolve(true);
          tx.onerror = reject;
        });
      }
      async function idbRemove(key) {
        const db = await dbPromise;
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, "readwrite");
          const store = tx.objectStore(STORE_NAME);
          store.delete(key);
          tx.oncomplete = () => resolve(true);
          tx.onerror = reject;
        });
      }

      // --- Fake localStorage ---
      const fakeLocalStorage = {
        _cache: {},
        getItem: (k) => fakeLocalStorage._cache[k] || null,
        setItem: (k,v) => { fakeLocalStorage._cache[k] = v; idbSet(k,v); },
        removeItem: (k) => { idbRemove(k); delete fakeLocalStorage._cache[k]; },
        async _init() {
          const keys = ["gestion_db","gestion_db_list","gestion_db_active","apiBaseUrl"];
          for (let k of keys) {
            let val = await idbGet(k);
            if (val !== null) fakeLocalStorage._cache[k] = val;
          }
        }
      };

      // Remplace localStorage natif
      window.localStorage = fakeLocalStorage;

      // Charger données dans le cache
      window.localStorage._init();
    })();
  </script>

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">
        <i class="fas fa-database mr-2"></i>Gestion Base de Données
      </h1>
      <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
        <i class="fas fa-home mr-2"></i>Accueil
      </button>
    </div>
  </nav>

  <!-- Contenu principal -->
  <main class="container mx-auto p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      
      <!-- Actions -->
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4"><i class="fas fa-cogs mr-2"></i>Actions rapides</h2>
        <div class="space-y-3">
          <button onclick="downloadDatabase()" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
            <i class="fas fa-download mr-2"></i>Télécharger la base
          </button>
          <button onclick="resetDatabase()" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
            <i class="fas fa-trash-alt mr-2"></i>Réinitialiser la base
          </button>
          <button onclick="updateFromServer()" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
            <i class="fas fa-sync-alt mr-2"></i>Mettre à jour depuis le serveur
          </button>
        </div>
      </div>

      <!-- Infos DB -->
      <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4"><i class="fas fa-info-circle mr-2"></i>Informations</h2>
        <ul class="space-y-2">
          <li><strong>Taille stockée :</strong> <span id="db-size">0</span> octets</li>
          <li><strong>Base active :</strong> <span id="db-active">gestion.db</span></li>
        </ul>
      </div>

    </div>
  </main>

  <!-- Toast -->
  <div id="toast-container" class="fixed bottom-4 right-4 space-y-2"></div>

  <script>
    function goHome() {
      window.location.href = "index.html";
    }

    function showToast(message, type="info") {
      const container = document.getElementById("toast-container");
      const colors = { info: "bg-blue-500", success: "bg-green-500", error: "bg-red-500" };
      const toast = document.createElement("div");
      toast.className = `${colors[type]} text-white px-4 py-2 rounded shadow toast-in`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => { toast.classList.replace("toast-in","toast-out"); setTimeout(()=>toast.remove(),500); }, 3000);
    }

    function updateInfos() {
      const savedDb = localStorage.getItem("gestion_db");
      document.getElementById("db-size").textContent = savedDb ? savedDb.length : 0;
      document.getElementById("db-active").textContent = "gestion.db";
    }

    async function downloadDatabase() {
      const savedDb = localStorage.getItem("gestion_db");
      if (!savedDb) { showToast("Aucune base trouvée","error"); return; }
      const binaryString = atob(savedDb);
      const bytes = new Uint8Array(binaryString.length);
      for (let i=0; i<binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
      const blob = new Blob([bytes], {type:"application/x-sqlite3"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "gestion.db";
      a.click();
      showToast("Base téléchargée","success");
    }

    function resetDatabase() {
      localStorage.removeItem("gestion_db");
      showToast("Base réinitialisée","success");
      updateInfos();
    }

    async function updateFromServer() {
      try {
        const response = await fetch("./gestion.db");
        if (!response.ok) throw new Error("Serveur inaccessible");
        const arrayBuffer = await response.arrayBuffer();
        const bytes = new Uint8Array(arrayBuffer);
        const binaryString = String.fromCharCode(...bytes);
        const base64String = btoa(binaryString);
        localStorage.setItem("gestion_db", base64String);
        showToast("Base mise à jour depuis le serveur","success");
        updateInfos();
      } catch (e) {
        console.error(e);
        showToast("Erreur mise à jour","error");
      }
    }

    // Init infos
    updateInfos();
  </script>

</body>
</html>
