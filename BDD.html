<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Données - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 p-4">

  <h1 class="text-2xl font-bold mb-4">Gestion Base de Données - FirePoz</h1>

  <!-- Boutons principaux -->
  <div class="flex gap-2 mb-6">
    <button id="homeBtn" class="px-4 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600">
      <i class="fa fa-home"></i> Accueil
    </button>
    <button id="downloadBtn" class="px-4 py-2 bg-green-500 text-white rounded shadow hover:bg-green-600">
      <i class="fa fa-download"></i> Télécharger
    </button>
    <button id="resetBtn" class="px-4 py-2 bg-red-500 text-white rounded shadow hover:bg-red-600">
      <i class="fa fa-rotate-left"></i> Réinitialiser
    </button>
    <button id="newBaseBtn" class="px-4 py-2 bg-purple-500 text-white rounded shadow hover:bg-purple-600">
      <i class="fa fa-plus"></i> Nouvelle Base
    </button>
    <label class="px-4 py-2 bg-yellow-500 text-white rounded shadow hover:bg-yellow-600 cursor-pointer">
      <i class="fa fa-folder-open"></i> Charger depuis fichier
      <input type="file" id="dbFileInput" accept=".db,.sqlite,.sqlite3" class="hidden" />
    </label>
  </div>

  <!-- Liste des bases sauvegardées -->
  <h2 class="text-xl font-semibold mb-2">Bases sauvegardées</h2>
  <ul id="savedBasesList" class="space-y-2"></ul>

  <!-- Zone Toast -->
  <div id="toast" class="hidden fixed bottom-4 right-4 px-4 py-2 bg-gray-800 text-white rounded shadow-lg"></div>

  <script>
    let db = null;
    let savedBases = JSON.parse(localStorage.getItem("gestion_db_list") || "[]");

    // ========== Toast ==========
    function showToast(msg, type="info") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg text-white";
      toast.classList.add(type === "error" ? "bg-red-600" :
                          type === "success" ? "bg-green-600" : "bg-gray-800");
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 2500);
    }

    // ========== Initialisation ==========
    async function initDb() {
      const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}` });
      let u8;
      if (localStorage.getItem("gestion_db")) {
        u8 = Uint8Array.from(atob(localStorage.getItem("gestion_db")), c => c.charCodeAt(0));
      } else {
        const resp = await fetch("gestion.db");
        u8 = new Uint8Array(await resp.arrayBuffer());
        saveDbToStorage(u8, "gestion_db");
      }
      db = new SQL.Database(u8);
      renderSavedBases();
    }

    function saveDbToStorage(u8, key="gestion_db") {
      const base64 = btoa(String.fromCharCode(...u8));
      localStorage.setItem(key, base64);
    }

    function exportDb() {
      return db.export();
    }

    // ========== Boutons ==========
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const blob = new Blob([exportDb()], { type: "application/x-sqlite3" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "gestion.db";
      a.click();
      showToast("Base téléchargée", "success");
    });

    document.getElementById("resetBtn").addEventListener("click", async () => {
      const resp = await fetch("gestion.db");
      const u8 = new Uint8Array(await resp.arrayBuffer());
      saveDbToStorage(u8, "gestion_db");
      db = new (await initSqlJs()).Database(u8);
      showToast("Base de production réinitialisée", "success");
      renderSavedBases();
    });

    document.getElementById("newBaseBtn").addEventListener("click", async () => {
      const resp = await fetch("gestion.db");
      const u8 = new Uint8Array(await resp.arrayBuffer());
      const base64 = btoa(String.fromCharCode(...u8));
      const newName = "NouvelleBase_" + (savedBases.length + 1);
      savedBases.push({ name: newName, data: base64 });
      localStorage.setItem("gestion_db_list", JSON.stringify(savedBases));
      showToast("Nouvelle base ajoutée", "success");
      renderSavedBases();
    });

    document.getElementById("dbFileInput").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      const u8 = new Uint8Array(await file.arrayBuffer());
      const base64 = btoa(String.fromCharCode(...u8));
      savedBases.push({ name: file.name, data: base64 });
      localStorage.setItem("gestion_db_list", JSON.stringify(savedBases));
      showToast("Base importée", "success");
      renderSavedBases();
    });

    // ========== Gestion des bases sauvegardées ==========
    function renderSavedBases() {
      const list = document.getElementById("savedBasesList");
      list.innerHTML = "";
      const current = localStorage.getItem("gestion_db");
      savedBases.forEach((b, i) => {
        const li = document.createElement("li");
        li.className = "flex items-center gap-2 bg-white p-2 rounded shadow";

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "activeBase";
        radio.checked = (b.data === current);
        radio.addEventListener("change", async () => {
          // Sauvegarder l'actuelle dans sa case
          const oldIndex = savedBases.findIndex(x => x.data === current);
          if (oldIndex >= 0) {
            savedBases[oldIndex].data = localStorage.getItem("gestion_db");
          }
          // Charger la nouvelle
          localStorage.setItem("gestion_db", b.data);
          localStorage.setItem("gestion_db_list", JSON.stringify(savedBases));
          showToast(`Base "${b.name}" utilisée en production`, "success");
          renderSavedBases();
        });

        const span = document.createElement("span");
        span.textContent = b.name;

        const renameBtn = document.createElement("button");
        renameBtn.className = "text-blue-600 hover:underline ml-auto";
        renameBtn.textContent = "Renommer";
        renameBtn.onclick = () => {
          const newName = prompt("Nouveau nom :", b.name);
          if (newName) {
            savedBases[i].name = newName;
            localStorage.setItem("gestion_db_list", JSON.stringify(savedBases));
            renderSavedBases();
          }
        };

        const delBtn = document.createElement("button");
        delBtn.className = "text-red-600 hover:underline";
        delBtn.textContent = "Supprimer";
        delBtn.onclick = () => {
          if (confirm("Supprimer cette base ?")) {
            savedBases.splice(i, 1);
            localStorage.setItem("gestion_db_list", JSON.stringify(savedBases));
            renderSavedBases();
          }
        };

        li.appendChild(radio);
        li.appendChild(span);
        li.appendChild(renameBtn);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    initDb();
  </script>
</body>
</html>