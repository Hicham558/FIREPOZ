<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des bases SQLite</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    .btn {
      padding: 8px 12px;
      margin: 4px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #007bff;
      color: white;
    }
    .btn:hover { background: #0056b3; }
    .danger { background: #dc3545; }
    .danger:hover { background: #a71d2a; }
    .db-list {
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
    }
    .db-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 5px 0;
      padding: 6px;
      border-bottom: 1px solid #eee;
    }
    .db-name { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Gestion des bases SQLite</h1>

  <!-- Import fichier -->
  <input type="file" id="dbFileInput" accept=".db,.sqlite,.sqlite3" />
  <button class="btn" onclick="resetProductionDb()">Réinitialiser la base de production</button>

  <div class="db-list">
    <h2>Bases sauvegardées</h2>
    <div id="dbList"></div>
  </div>

  <script>
    // Lire fichier et convertir en base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // Sauvegarder dans l'historique
    function saveDbToHistory(name, dataBase64) {
      let dbList = JSON.parse(localStorage.getItem("gestion_db_list") || "[]");
      dbList.push({
        id: Date.now(),
        name: name || `Base_${dbList.length + 1}`,
        data: dataBase64
      });
      localStorage.setItem("gestion_db_list", JSON.stringify(dbList));
      renderDbList();
    }

    // Charger une base depuis l’historique et la mettre en prod
    function setProductionDb(id) {
      let dbList = JSON.parse(localStorage.getItem("gestion_db_list") || "[]");
      let dbItem = dbList.find(d => d.id === id);
      if (dbItem) {
        localStorage.setItem("gestion_db", dbItem.data); // ⚡ remplace prod
        alert(`La base "${dbItem.name}" est maintenant la base de production.`);
      }
    }

    // Réinitialiser la base de prod
    function resetProductionDb() {
      localStorage.removeItem("gestion_db");
      alert("La base de production a été réinitialisée !");
    }

    // Renommer une base dans l’historique
    function renameDb(id) {
      let newName = prompt("Nouveau nom de la base :");
      if (!newName) return;
      let dbList = JSON.parse(localStorage.getItem("gestion_db_list") || "[]");
      let dbItem = dbList.find(d => d.id === id);
      if (dbItem) {
        dbItem.name = newName;
        localStorage.setItem("gestion_db_list", JSON.stringify(dbList));
        renderDbList();
      }
    }

    // Afficher la liste
    function renderDbList() {
      let dbList = JSON.parse(localStorage.getItem("gestion_db_list") || "[]");
      const container = document.getElementById("dbList");
      container.innerHTML = "";
      dbList.forEach(db => {
        const div = document.createElement("div");
        div.className = "db-item";
        div.innerHTML = `
          <span class="db-name">${db.name}</span>
          <div>
            <button class="btn" onclick="setProductionDb(${db.id})">Utiliser en production</button>
            <button class="btn" onclick="renameDb(${db.id})">Renommer</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Charger fichier sélectionné
    document.getElementById("dbFileInput").addEventListener("change", async function (evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const base64 = await fileToBase64(file);
      localStorage.setItem("gestion_db", base64); // active directement
      saveDbToHistory(file.name, base64);
      alert(`La base "${file.name}" a été importée et activée en production.`);
    });

    // Initialiser liste au chargement
    renderDbList();
  </script>
</body>
</html>