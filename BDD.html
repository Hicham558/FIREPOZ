<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Données - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    @keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
    @keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
    .tab-button { @apply px-6 py-3 font-semibold transition-all; }
    .tab-button.active { @apply bg-white text-indigo-600 border-b-2 border-indigo-600; }
    .tab-button:not(.active) { @apply text-white hover:bg-indigo-700; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg">
      <i class="fas fa-spinner fa-spin mr-2"></i>
      Chargement...
    </div>
  </div>

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold">
        <i class="fas fa-database mr-2"></i>FirePoz Database
      </h1>
      <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
        <i class="fas fa-home mr-2"></i>Accueil
      </button>
    </div>
    
    <!-- Tabs -->
    <div class="container mx-auto px-4 flex space-x-2">
      <button onclick="switchTab('local')" id="tabLocal" class="tab-button active">
        <i class="fas fa-laptop mr-2"></i>Base Locale
      </button>
      <button onclick="switchTab('server')" id="tabServer" class="tab-button">
        <i class="fas fa-cloud mr-2"></i>Synchronisation Serveur
      </button>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    
    <!-- Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Base Active</p>
            <p id="activeDbName" class="text-2xl font-bold text-indigo-600">Chargement...</p>
          </div>
          <i class="fas fa-database text-4xl text-indigo-500"></i>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Taille Base</p>
            <p id="dbSize" class="text-2xl font-bold text-green-600">0 KB</p>
          </div>
          <i class="fas fa-hdd text-4xl text-green-500"></i>
        </div>
      </div>
    </div>

    <!-- Onglet Base Locale -->
    <div id="contentLocal" class="space-y-6">
      
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-tools mr-2 text-indigo-500"></i>
          Gestion Base Locale
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button onclick="downloadDatabase()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition">
            <i class="fas fa-download mr-2"></i>Télécharger Base Active
          </button>
          
          <button onclick="createNewDatabase()" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 transition">
            <i class="fas fa-plus-circle mr-2"></i>Créer Nouvelle Base
          </button>
          
          <label class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition text-center cursor-pointer">
            <i class="fas fa-upload mr-2"></i>Ouvrir Base Existante
            <input type="file" id="uploadDb" accept=".db,.sqlite,.sqlite3" class="hidden" onchange="uploadDatabase(event)">
          </label>
          
          <button onclick="resetToDefault()" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition">
            <i class="fas fa-undo mr-2"></i>Réinitialiser (gestion.db)
          </button>
        </div>
      </div>
      
    </div>

    <!-- Onglet Serveur -->
    <div id="contentServer" class="space-y-6 hidden">
      
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-cloud-download-alt mr-2 text-indigo-500"></i>
          Synchronisation avec le Serveur
        </h2>
        
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
          <p class="text-sm text-gray-700">
            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
            Téléchargez la base de données depuis le serveur et basculez entre la base serveur et la base locale par défaut.
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button onclick="syncFromServer()" class="bg-yellow-600 text-white px-6 py-3 rounded-md hover:bg-yellow-700 transition">
            <i class="fas fa-cloud-download-alt mr-2"></i>Télécharger Base Serveur
          </button>
          
          <button onclick="switchToServer()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition">
            <i class="fas fa-cloud mr-2"></i>Activer Base Serveur
          </button>
          
          <button onclick="switchToDefault()" class="bg-purple-600 text-white px-6 py-3 rounded-md hover:bg-purple-700 transition">
            <i class="fas fa-laptop mr-2"></i>Activer Base Par Défaut
          </button>
        </div>
        
        <div class="mt-6 p-4 bg-gray-50 rounded">
          <h3 class="font-semibold mb-2">État actuel :</h3>
          <p id="serverStatus" class="text-gray-700">Chargement...</p>
        </div>
      </div>
      
    </div>

  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden z-40">
    <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
      <i id="toastIcon" class="mr-2"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <script>
    // ========== IndexedDB Storage Layer ==========
    const DB_NAME = "FirePozDB";
    const STORE_NAME = "databases";
    const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';
    
    let dbConnection = null;

    function openIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
          }
        };
        
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    async function idbGet(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, value) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(value, key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    async function idbRemove(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).delete(key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    // Compatibilité noms localStorage
    window.localStorage = {
      async getItem(key) { return await idbGet(key); },
      async setItem(key, value) { return await idbSet(key, value); },
      async removeItem(key) { return await idbRemove(key); }
    };

    // ========== UI Functions ==========
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg toast-in z-40 ${
        isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
      }`;
      
      toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
      toastMessage.textContent = message;
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('toast-out');
        setTimeout(() => toast.classList.add('hidden'), 500);
      }, 3000);
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading');
      loading.style.display = show ? 'flex' : 'none';
    }

    function switchTab(tab) {
      document.getElementById('tabLocal').classList.toggle('active', tab === 'local');
      document.getElementById('tabServer').classList.toggle('active', tab === 'server');
      document.getElementById('contentLocal').classList.toggle('hidden', tab !== 'local');
      document.getElementById('contentServer').classList.toggle('hidden', tab !== 'server');
      
      if (tab === 'server') updateServerStatus();
    }

    function goHome() {
      window.location.href = "index.html";
    }

    // ========== Database Functions ==========
    async function loadActiveDb() {
      try {
        const activeData = await idbGet('gestion_db');
        if (activeData) {
          const bytes = Uint8Array.from(atob(activeData), c => c.charCodeAt(0));
          const SQL = await initSqlJs({
            locateFile: () => "https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm"
          });
          dbConnection = new SQL.Database(bytes);
          return true;
        }
        return false;
      } catch (e) {
        console.error("Erreur chargement:", e);
        return false;
      }
    }

    async function saveActiveDb() {
      if (!dbConnection) return;
      
      try {
        const binary = dbConnection.export();
        const base64 = btoa(String.fromCharCode(...binary));
        await idbSet('gestion_db', base64);
        await updateStats();
      } catch (e) {
        console.error("Erreur sauvegarde:", e);
      }
    }

    async function downloadDatabase() {
      const dbData = await idbGet('gestion_db');
      if (!dbData) {
        showToast("Aucune base active", true);
        return;
      }

      try {
        const bytes = Uint8Array.from(atob(dbData), c => c.charCodeAt(0));
        const blob = new Blob([bytes], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const name = await idbGet('gestion_db_active') || 'gestion';
        a.href = url;
        a.download = `${name}.db`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast("Base téléchargée");
      } catch (e) {
        console.error("Erreur téléchargement:", e);
        showToast("Erreur téléchargement", true);
      }
    }

    async function createNewDatabase() {
      const name = prompt("Nom de la nouvelle base:");
      if (!name || !name.trim()) return;
      
      showLoading(true);
      try {
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', name.trim());
        
        await loadActiveDb();
        await updateStats();
        
        showToast(`Base "${name}" créée`);
      } catch (e) {
        console.error("Erreur création:", e);
        showToast("Erreur création", true);
      } finally {
        showLoading(false);
      }
    }

    function uploadDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      showLoading(true);
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          const bytes = new Uint8Array(e.target.result);
          const base64 = btoa(String.fromCharCode(...bytes));
          
          const name = file.name.replace(/\.(db|sqlite|sqlite3)$/i, '');
          await idbSet('gestion_db', base64);
          await idbSet('gestion_db_active', name);
          
          await loadActiveDb();
          await updateStats();
          
          showToast(`Base "${name}" chargée`);
        } catch (error) {
          console.error("Erreur import:", error);
          showToast("Erreur import", true);
        } finally {
          showLoading(false);
        }
      };
      
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    async function resetToDefault() {
      if (!confirm("⚠️ Réinitialiser avec gestion.db par défaut ?\n\nCette action est irréversible.")) return;
      
      showLoading(true);
      try {
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', 'gestion');
        await idbRemove('gestion_db_server');
        
        await loadActiveDb();
        await updateStats();
        
        showToast("Base réinitialisée");
      } catch (e) {
        console.error("Erreur reset:", e);
        showToast("Erreur reset", true);
      } finally {
        showLoading(false);
      }
    }

    async function switchToServer() {
      showLoading(true);
      try {
        // Vérifier qu'une base serveur existe
        const serverDb = await idbGet('gestion_db_server');
        if (!serverDb) {
          showToast("⚠️ Aucune base serveur. Téléchargez-la d'abord!", true);
          showLoading(false);
          return;
        }
        
        // Activer la base serveur
        await idbSet('gestion_db', serverDb);
        await idbSet('gestion_db_active', 'serveur');
        
        // Recharger la base en mémoire
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        
        showToast("✅ Base serveur activée");
      } catch (e) {
        console.error("Erreur activation serveur:", e);
        showToast("❌ Erreur activation base serveur", true);
      } finally {
        showLoading(false);
      }
    }

    async function syncFromServer() {
      showLoading(true);
      try {
        const response = await fetch(`${API_BASE_URL}/export`);
        if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
        
        const data = await response.json();
        const base64Db = data.db;
        
        // Sauvegarder la base serveur
        await idbSet('gestion_db_server', base64Db);
        
        // Activer immédiatement la base serveur
        await idbSet('gestion_db', base64Db);
        await idbSet('gestion_db_active', 'serveur');
        
        // Recharger la base en mémoire
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        
        showToast("✅ Base serveur téléchargée et activée");
      } catch (err) {
        console.error("Erreur sync:", err);
        showToast(`❌ Erreur serveur: ${err.message}`, true);
      } finally {
        showLoading(false);
      }
    }

    async function switchToDefault() {
      showLoading(true);
      try {
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        // Basculer vers la base par défaut
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', 'gestion');
        
        // Recharger la base en mémoire
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        
        showToast("✅ Basculé vers base par défaut");
      } catch (e) {
        console.error("Erreur switch:", e);
        showToast("❌ Erreur basculement", true);
      } finally {
        showLoading(false);
      }
    }

    async function updateServerStatus() {
      const activeName = await idbGet('gestion_db_active') || 'gestion';
      const hasServer = await idbGet('gestion_db_server');
      
      const status = document.getElementById('serverStatus');
      if (activeName === 'serveur') {
        status.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-2"></i>Vous utilisez actuellement la base serveur';
      } else if (hasServer) {
        status.innerHTML = '<i class="fas fa-info-circle text-blue-500 mr-2"></i>Base serveur disponible (cliquez pour basculer)';
      } else {
        status.innerHTML = '<i class="fas fa-download text-gray-500 mr-2"></i>Aucune base serveur (cliquez sur "Télécharger")';
      }
    }

    async function updateStats() {
      const activeName = await idbGet('gestion_db_active') || 'Aucune';
      const dbData = await idbGet('gestion_db');
      
      document.getElementById('activeDbName').textContent = activeName;
      
      if (dbData) {
        const sizeKB = (dbData.length / 1024).toFixed(2);
        document.getElementById('dbSize').textContent = `${sizeKB} KB`;
      } else {
        document.getElementById('dbSize').textContent = '0 KB';
      }
    }

    // ========== Initialization ==========
    async function init() {
      showLoading(true);
      try {
        const hasDb = await loadActiveDb();
        
        if (!hasDb) {
          const response = await fetch("gestion.db");
          if (response.ok) {
            const buffer = await response.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            await idbSet('gestion_db', base64);
            await idbSet('gestion_db_active', 'gestion');
            await loadActiveDb();
          }
        }
        
        await updateStats();
        console.log("✅ Application initialisée");
      } catch (e) {
        console.error("❌ Erreur init:", e);
        showToast("Erreur initialisation", true);
      } finally {
        showLoading(false);
      }
    }

    // Démarrage
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
