<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Données - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    @keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
    @keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .collapsible-content.active {
      max-height: 500px;
    }
    
    .rotate-icon {
      transition: transform 0.3s ease;
    }
    
    .rotate-icon.active {
      transform: rotate(180deg);
    }

    .switch-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .switch-btn:hover {
      transform: translateY(-8px);
    }

    .switch-circle {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      transition: all 0.4s ease;
      animation: pulse 2s ease-in-out infinite;
    }

    .switch-btn:hover .switch-circle {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      transform: scale(1.05);
      animation: none;
    }

    .switch-circle i {
      transition: transform 0.3s ease;
    }

    .switch-btn:hover .switch-circle i {
      transform: scale(1.1) rotate(5deg);
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }
      50% {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
    }

    .modal-fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg">
      <i class="fas fa-spinner fa-spin mr-2"></i>
      Chargement...
    </div>
  </div>

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold">
        <i class="fas fa-database mr-2"></i>FirePoz Database
      </h1>
      <div class="flex space-x-2">
        <button onclick="goToParams()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
          <i class="fas fa-cog mr-2"></i>Paramètres
        </button>
        <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
          <i class="fas fa-home mr-2"></i>Accueil
        </button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    
    <!-- Tableau de Bord et Switch -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Stats Cards -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-tachometer-alt mr-2 text-indigo-500"></i>
          Tableau de Bord
        </h2>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
            <p class="text-gray-600 text-sm font-medium mb-1">Base Active</p>
            <p id="activeDbName" class="text-2xl font-bold text-indigo-600">Chargement...</p>
          </div>
          
          <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <p class="text-gray-600 text-sm font-medium mb-1">Taille Base</p>
            <p id="dbSize" class="text-2xl font-bold text-green-600">0 KB</p>
          </div>
        </div>
      </div>

      <!-- Switch Panel -->
      <div class="bg-white rounded-lg shadow-md">
        <div class="px-6 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-t-lg">
          <h2 class="text-xl font-semibold flex items-center">
            <i class="fas fa-exchange-alt mr-3"></i>
            Switch - Basculer entre les Bases
          </h2>
        </div>
        
        <div class="px-6 py-8">
          <div class="flex flex-row gap-8 justify-center">
            <button onclick="switchToServer()" class="switch-btn group relative">
              <div class="switch-circle bg-gradient-to-br from-green-400 to-green-600 group-hover:from-green-500 group-hover:to-green-700">
                <i class="fas fa-cloud text-white text-5xl"></i>
              </div>
              <div class="mt-4 text-center">
                <p class="font-semibold text-gray-800 text-lg">Base Serveur</p>
                <p class="text-sm text-gray-600 mt-1">Utiliser la base téléchargée</p>
              </div>
            </button>
            
            <button onclick="switchToDefault()" class="switch-btn group relative">
              <div class="switch-circle bg-gradient-to-br from-purple-400 to-purple-600 group-hover:from-purple-500 group-hover:to-purple-700">
                <i class="fas fa-mobile-alt text-white text-5xl"></i>
              </div>
              <div class="mt-4 text-center">
                <p class="font-semibold text-gray-800 text-lg">Base Par Défaut</p>
                <p class="text-sm text-gray-600 mt-1">Revenir à la base locale</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- État actuel -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="font-semibold mb-3 flex items-center">
        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
        État actuel
      </h3>
      <div id="serverStatus" class="text-gray-700">Chargement...</div>
    </div>

    <!-- Panneau Gestion Base Locale (Pliable) -->
    <div class="bg-white rounded-lg shadow-md mb-4">
      <button onclick="toggleSection('localPanel')" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition">
        <div class="flex items-center">
          <i class="fas fa-tools mr-3 text-indigo-500"></i>
          <h2 class="text-xl font-semibold">Gestion Base Locale</h2>
        </div>
        <i id="localPanelIcon" class="fas fa-chevron-down rotate-icon"></i>
      </button>
      
      <div id="localPanel" class="collapsible-content">
        <div class="px-6 pb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="downloadDatabase()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition">
              <i class="fas fa-download mr-2"></i>Télécharger Base Active
            </button>
            
            <button onclick="createNewDatabase()" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 transition">
              <i class="fas fa-plus-circle mr-2"></i>Créer Nouvelle Base
            </button>
            
            <button onclick="showDatabaseList()" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition">
              <i class="fas fa-folder-open mr-2"></i>Ouvrir Base Existante
            </button>
            
            <button onclick="resetToDefault()" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition">
              <i class="fas fa-undo mr-2"></i>Réinitialiser (gestion.db)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panneau Synchronisation Serveur (Pliable) -->
    <div class="bg-white rounded-lg shadow-md mb-4">
      <button onclick="toggleSection('syncPanel')" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition">
        <div class="flex items-center">
          <i class="fas fa-cloud-download-alt mr-3 text-yellow-500"></i>
          <h2 class="text-xl font-semibold">Synchronisation Serveur</h2>
        </div>
        <i id="syncPanelIcon" class="fas fa-chevron-down rotate-icon"></i>
      </button>
      
      <div id="syncPanel" class="collapsible-content">
        <div class="px-6 pb-6">
          <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
            <p class="text-sm text-gray-700">
              <i class="fas fa-info-circle mr-2 text-blue-500"></i>
              Téléchargez la base de données depuis le serveur.
            </p>
          </div>
          
          <button onclick="syncFromServer()" class="w-full bg-yellow-600 text-white px-6 py-3 rounded-md hover:bg-yellow-700 transition">
            <i class="fas fa-cloud-download-alt mr-2"></i>Télécharger Base Serveur
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal Liste Bases -->
  <div id="dbListModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col modal-fade-in">
      <div class="px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-t-lg flex justify-between items-center">
        <h3 class="text-xl font-semibold flex items-center">
          <i class="fas fa-database mr-3"></i>
          Bases de Données Disponibles
        </h3>
        <button onclick="closeDbListModal()" class="text-white hover:text-gray-200 text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="p-6 overflow-y-auto flex-1">
        <div id="dbListContent" class="space-y-2">
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
            <p>Chargement des bases de données...</p>
          </div>
        </div>
      </div>
      
      <div class="px-6 py-4 bg-gray-50 rounded-b-lg border-t">
        <label class="w-full bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition cursor-pointer flex items-center justify-center">
          <i class="fas fa-file-upload mr-2"></i>Importer un fichier .db
          <input type="file" id="uploadDbFromModal" accept=".db,.sqlite,.sqlite3" class="hidden" onchange="uploadDatabase(event)">
        </label>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden z-40">
    <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
      <i id="toastIcon" class="mr-2"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <script>
    // ========== IndexedDB Storage Layer ==========
    const DB_NAME = "FirePozDB";
    const STORE_NAME = "databases";
    let API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';
    
    let dbConnection = null;

    function openIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
          }
        };
        
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    async function idbGet(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, value) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(value, key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    async function idbRemove(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).delete(key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    // ========== Modal Functions ==========
    async function showDatabaseList() {
      const modal = document.getElementById('dbListModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      await loadDatabaseList();
    }

    function closeDbListModal() {
      const modal = document.getElementById('dbListModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    async function loadDatabaseList() {
      const content = document.getElementById('dbListContent');
      
      try {
        const db = await openIDB();
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const allKeys = await new Promise((resolve, reject) => {
          const req = store.getAllKeys();
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
        
        const dbKeys = allKeys.filter(key => 
          key === 'gestion_db' || 
          key === 'gestion_db_server' || 
          key.startsWith('gestion_db_backup_')
        );
        
        if (dbKeys.length === 0) {
          content.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-database text-4xl mb-3"></i>
              <p>Aucune base de données trouvée</p>
              <p class="text-sm mt-2">Importez un fichier .db pour commencer</p>
            </div>
          `;
          return;
        }
        
        const activeName = await idbGet('gestion_db_active') || 'gestion';
        
        let html = '';
        
        for (const key of dbKeys) {
          let displayName = '';
          let icon = 'fa-database';
          let color = 'text-gray-600';
          let isActive = false;
          
          if (key === 'gestion_db') {
            displayName = activeName;
            isActive = true;
            color = 'text-green-600';
            icon = 'fa-check-circle';
          } else if (key === 'gestion_db_server') {
            displayName = 'serveur (sauvegardé)';
            color = 'text-blue-600';
            icon = 'fa-cloud';
            if (activeName === 'serveur') {
              isActive = true;
              color = 'text-green-600';
              icon = 'fa-check-circle';
            }
          } else if (key.startsWith('gestion_db_backup_')) {
            displayName = key.replace('gestion_db_backup_', '') + ' (backup)';
            color = 'text-purple-600';
            icon = 'fa-archive';
          }
          
          const dbData = await idbGet(key);
          const sizeKB = dbData ? (dbData.length / 1024).toFixed(2) : '0';
          
          html += `
            <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition ${isActive ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
              <div class="flex items-center flex-1">
                <i class="fas ${icon} ${color} text-2xl mr-4"></i>
                <div class="flex-1">
                  <p class="font-semibold text-gray-800">${displayName}</p>
                  <p class="text-sm text-gray-600">${sizeKB} KB</p>
                </div>
                ${isActive ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full mr-3">Actif</span>' : ''}
              </div>
              <div class="flex space-x-2">
                ${!isActive ? `
                  <button onclick="loadDatabaseFromKey('${key}', '${displayName.replace(' (backup)', '').replace(' (sauvegardé)', '')}')" 
                          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                    <i class="fas fa-upload mr-1"></i>Charger
                  </button>
                ` : ''}
                <button onclick="downloadDatabaseFromKey('${key}', '${displayName.replace(' (backup)', '').replace(' (sauvegardé)', '')}')" 
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
                  <i class="fas fa-download mr-1"></i>
                </button>
              </div>
            </div>
          `;
        }
        
        content.innerHTML = html;
        
      } catch (e) {
        console.error("Erreur chargement liste:", e);
        content.innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
            <p>Erreur lors du chargement des bases de données</p>
          </div>
        `;
      }
    }

    async function loadDatabaseFromKey(key, displayName) {
      if (!confirm(`Charger la base "${displayName}" ?\n\nLa base actuelle sera sauvegardée.`)) return;
      
      showLoading(true);
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        const newDb = await idbGet(key);
        await idbSet('gestion_db', newDb);
        await idbSet('gestion_db_active', displayName);
        
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        
        closeDbListModal();
        showToast(`✅ Base "${displayName}" chargée`);
      } catch (e) {
        console.error("Erreur chargement base:", e);
        showToast("❌ Erreur lors du chargement", true);
      } finally {
        showLoading(false);
      }
    }

    async function downloadDatabaseFromKey(key, displayName) {
      try {
        const dbData = await idbGet(key);
        if (!dbData) {
          showToast("❌ Base non trouvée", true);
          return;
        }
        
        const bytes = Uint8Array.from(atob(dbData), c => c.charCodeAt(0));
        const blob = new Blob([bytes], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
        const folderName = `${displayName}_${dateStr}_${timeStr}`;
        
        a.href = url;
        a.download = `${folderName}_gestion.db`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast(`✅ Base "${displayName}" téléchargée`);
      } catch (e) {
        console.error("Erreur téléchargement:", e);
        showToast("❌ Erreur téléchargement", true);
      }
    }

    // ========== UI Functions ==========
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId);
      const icon = document.getElementById(sectionId + 'Icon');
      
      content.classList.toggle('active');
      icon.classList.toggle('active');
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg toast-in z-40 ${
        isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
      }`;
      
      toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
      toastMessage.textContent = message;
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('toast-out');
        setTimeout(() => toast.classList.add('hidden'), 500);
      }, 3000);
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading');
      loading.style.display = show ? 'flex' : 'none';
    }

    function goHome() {
      window.location.href = "index.html";
    }

    function goToParams() {
      window.location.href = "PARAM.html";
    }

    // ========== Database Functions ==========
    async function loadActiveDb() {
      try {
        const activeData = await idbGet('gestion_db');
        if (activeData) {
          const bytes = Uint8Array.from(atob(activeData), c => c.charCodeAt(0));
          const SQL = await initSqlJs({
            locateFile: () => "https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm"
          });
          dbConnection = new SQL.Database(bytes);
          return true;
        }
        return false;
      } catch (e) {
        console.error("Erreur chargement:", e);
        return false;
      }
    }

    async function saveActiveDb() {
      if (!dbConnection) return;
      
      try {
        const binary = dbConnection.export();
        const base64 = btoa(String.fromCharCode(...binary));
        await idbSet('gestion_db', base64);
        await updateStats();
      } catch (e) {
        console.error("Erreur sauvegarde:", e);
      }
    }

    async function downloadDatabase() {
      const dbData = await idbGet('gestion_db');
      if (!dbData) {
        showToast("Aucune base active", true);
        return;
      }

      try {
        const bytes = Uint8Array.from(atob(dbData), c => c.charCodeAt(0));
        const blob = new Blob([bytes], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const name = await idbGet('gestion_db_active') || 'gestion';
        
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
        const folderName = `${name}_${dateStr}_${timeStr}`;
        
        a.href = url;
        a.download = `${folderName}_gestion.db`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast("Base téléchargée");
      } catch (e) {
        console.error("Erreur téléchargement:", e);
        showToast("Erreur téléchargement", true);
      }
    }

    async function createNewDatabase() {
      const name = prompt("Nom de la nouvelle base:");
      if (!name || !name.trim()) return;
      
      showLoading(true);
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', name.trim());
        
        await loadActiveDb();
        await updateStats();
        
        showToast(`Base "${name}" créée`);
      } catch (e) {
        console.error("Erreur création:", e);
        showToast("Erreur création", true);
      } finally {
        showLoading(false);
      }
    }

     function uploadDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      showLoading(true);
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          const currentName = await idbGet('gestion_db_active') || 'gestion';
          const currentDb = await idbGet('gestion_db');
          if (currentDb) {
            await idbSet(`gestion_db_backup_${currentName}`, currentDb);
            console.log(`💾 Base "${currentName}" sauvegardée`);
          }
          
          const bytes = new Uint8Array(e.target.result);
          const base64 = btoa(String.fromCharCode(...bytes));
          
          const name = file.name.replace(/\.(db|sqlite|sqlite3)$/i, '');
          await idbSet('gestion_db', base64);
          await idbSet('gestion_db_active', name);
          
          await loadActiveDb();
          await updateStats();
          
          showToast(`Base "${name}" chargée`);
        } catch (error) {
          console.error("Erreur import:", error);
          showToast("Erreur import", true);
        } finally {
          showLoading(false);
        }
      };
      
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    async function resetToDefault() {
      if (!confirm("⚠️ Réinitialiser avec gestion.db par défaut ?\n\nCette action est irréversible.")) return;
      
      showLoading(true);
      try {
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', 'gestion');
        await idbRemove('gestion_db_server');
        
        await loadActiveDb();
        await updateStats();
        
        showToast("Base réinitialisée");
      } catch (e) {
        console.error("Erreur reset:", e);
        showToast("Erreur reset", true);
      } finally {
        showLoading(false);
      }
    }

    async function switchToServer() {
      showLoading(true);
      try {
        const serverDb = await idbGet('gestion_db_server');
        if (!serverDb) {
          showToast("⚠️ Aucune base serveur. Téléchargez-la d'abord!", true);
          showLoading(false);
          return;
        }
        
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        await idbSet('gestion_db', serverDb);
        await idbSet('gestion_db_active', 'serveur');
        
        localStorage.setItem('apiBaseUrl', '/api'); 
        
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        
        showToast("✅ Base serveur activée");
      } catch (e) {
        console.error("Erreur activation serveur:", e);
        showToast("❌ Erreur activation base serveur", true);
      } finally {
        showLoading(false);
      }
    }

 async function syncFromServer() {
  showLoading(true);
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) {
      showToast("⚠️ Veuillez vous connecter pour synchroniser la base serveur", true);
      return;
    }

    const response = await fetch(`${API_BASE_URL}/export`, {
      headers: {
        'X-User-ID': userId
      }
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`Erreur HTTP ${response.status}: ${errorData.error || response.statusText}`);
    }
    
    const data = await response.json();
    const base64Db = data.db;
    
    const currentName = await idbGet('gestion_db_active') || 'gestion';
    const currentDb = await idbGet('gestion_db');
    if (currentDb) {
      await idbSet(`gestion_db_backup_${currentName}`, currentDb);
      console.log(`💾 Base "${currentName}" sauvegardée`);
    }
    
    await idbSet('gestion_db_server', base64Db);
    await idbSet('gestion_db', base64Db);
    await idbSet('gestion_db_active', 'serveur');
    
    await idbSet('apiBaseUrl', '/api');
    API_BASE_URL = '/api';
    localStorage.setItem('apiBaseUrl', '/api'); 

    if (dbConnection) {
      try {
        dbConnection.close();
      } catch (e) {}
    }
    dbConnection = null;
    await loadActiveDb();
    await updateStats();
    await updateServerStatus();
    
    if (API_BASE_URL === '/api') {
      showToast("✅ Vous êtes maintenant en MODE LOCAL (/api)");
    } else {
      showToast("✅ Base serveur téléchargée et activée");
    }
  } catch (err) {
    console.error("Erreur sync:", err);
    showToast(`❌ Erreur serveur: ${err.message}`, true);
  } finally {
    showLoading(false);
  }
}
    async function switchToDefault() {
      showLoading(true);
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb && currentName !== 'gestion') {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        let defaultDb = await idbGet('gestion_db_backup_gestion');
        
        if (!defaultDb) {
          console.log("📥 Pas de backup, chargement gestion.db original");
          const response = await fetch("gestion.db");
          if (!response.ok) throw new Error("Impossible de charger gestion.db");
          
          const buffer = await response.arrayBuffer();
          defaultDb = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        } else {
          console.log("📦 Restauration base par défaut depuis backup");
        }
        
        await idbSet('gestion_db', defaultDb);
        await idbSet('gestion_db_active', 'gestion');
        
        localStorage.setItem('apiBaseUrl', '/api'); 
        
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        
        showToast("✅ Basculé vers base par défaut");
      } catch (e) {
        console.error("Erreur switch:", e);
        showToast("❌ Erreur basculement", true);
      } finally {
        showLoading(false);
      }
    }

    async function updateServerStatus() {
      const activeName = await idbGet('gestion_db_active') || 'gestion';
      const hasServer = await idbGet('gestion_db_server');
      
      const status = document.getElementById('serverStatus');
      
      if (activeName === 'serveur') {
        status.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span class="font-semibold text-green-700">Base SERVEUR actuellement active</span>
          </div>
          <p class="text-sm text-gray-600 mt-1">Vous travaillez sur la base téléchargée depuis le serveur.</p>
        `;
      } else if (activeName === 'gestion') {
        status.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-mobile-alt text-purple-500 mr-2"></i>
            <span class="font-semibold text-purple-700">Base PAR DÉFAUT actuellement active</span>
          </div>
          <p class="text-sm text-gray-600 mt-1">Vous travaillez sur la base locale par défaut.</p>
        `;
        
        if (hasServer) {
          status.innerHTML += `
            <p class="text-sm text-blue-600 mt-2">
              <i class="fas fa-info-circle mr-1"></i>
              Une base serveur est disponible.
            </p>
          `;
        }
      } else {
        status.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-database text-indigo-500 mr-2"></i>
            <span class="font-semibold text-indigo-700">Base "${activeName}" active</span>
          </div>
        `;
      }
      
      if (!hasServer && activeName !== 'serveur') {
        status.innerHTML += `
          <p class="text-sm text-orange-600 mt-2">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            Aucune base serveur téléchargée.
          </p>
        `;
      }
    }

     async function updateStats() {
      const activeName = await idbGet('gestion_db_active') || 'Aucune';
      const dbData = await idbGet('gestion_db');
      
      document.getElementById('activeDbName').textContent = activeName;
      
      if (dbData) {
        const sizeKB = (dbData.length / 1024).toFixed(2);
        document.getElementById('dbSize').textContent = `${sizeKB} KB`;
      } else {
        document.getElementById('dbSize').textContent = '0 KB';
      }
    }

    // ========== Initialization ==========
    async function init() {
      showLoading(true);
      try {
        const hasDb = await loadActiveDb();
        
        if (!hasDb) {
          const response = await fetch("gestion.db");
          if (response.ok) {
            const buffer = await response.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            await idbSet('gestion_db', base64);
            await idbSet('gestion_db_active', 'gestion');
            await loadActiveDb();
          }
        }
        
        await updateStats();
        await updateServerStatus();
        console.log("✅ Application initialisée");
      } catch (e) {
        console.error("❌ Erreur init:", e);
        showToast("Erreur initialisation", true);
      } finally {
        showLoading(false);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>

   
