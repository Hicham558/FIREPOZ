<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Données - FirePoz</title>
  <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    @keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
    @keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">
        <i class="fas fa-database mr-2"></i>Gestion Base de Données
      </h1>
      <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
        <i class="fas fa-home mr-2"></i>Accueil
      </button>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    <!-- Outils Base de Données -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">
        <i class="fas fa-database mr-2 text-indigo-500"></i>Outils Base de Données
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button onclick="downloadDatabase()" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 transition">
          <i class="fas fa-file-download mr-2"></i>Télécharger gestion.db
        </button>
        <button onclick="resetDatabaseUI()" class="w-full bg-red-600 text-white px-4 py-3 rounded-md hover:bg-red-700 transition">
          <i class="fas fa-trash mr-2"></i>Réinitialiser la Base
        </button>
        <label class="w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 transition text-center cursor-pointer">
          <i class="fas fa-upload mr-2"></i>Charger depuis fichier
          <input type="file" id="uploadDb" accept=".db,.sqlite,.sqlite3" class="hidden" onchange="uploadDatabase(event)">
        </label>
        <button onclick="createNewDatabase()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 transition">
          <i class="fas fa-plus-circle mr-2"></i>Nouvelle Base (vierge)
        </button>
        <button onclick="updateFromServer()" class="w-full bg-yellow-600 text-white px-4 py-3 rounded-md hover:bg-yellow-700 transition">
          <i class="fas fa-cloud-download-alt mr-2"></i>Mettre à jour depuis serveur
        </button>
      </div>
      <div class="mt-4 text-sm text-gray-600">
        <p><i class="fas fa-info-circle mr-2"></i>La base de production est stockée dans IndexedDB</p>
        <p id="dbSize" class="mt-2">Taille: Calcul en cours...</p>
      </div>
    </div>

    <!-- Liste des bases sauvegardées -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">
        <i class="fas fa-archive mr-2 text-indigo-500"></i>Bases Sauvegardées
      </h2>
      <ul id="dbList" class="space-y-3"></ul>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden">
    <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
      <i id="toastIcon" class="mr-2"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <!-- Script principal -->
  <script type="module">
    import { getDb, saveDbToLocalStorage, resetDatabase, getDbSize } from './db.js';

    const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';

    // ===== Utils =====
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      toast.className = isError
        ? 'fixed bottom-4 right-4 flex items-center bg-red-500 text-white px-6 py-3 rounded-md shadow-lg toast-in'
        : 'fixed bottom-4 right-4 flex items-center bg-green-500 text-white px-6 py-3 rounded-md shadow-lg toast-in';
      toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
      toastMessage.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.remove('toast-in');
        toast.classList.add('toast-out');
        setTimeout(() => toast.classList.add('hidden'), 500);
      }, 3000);
    }

    function goHome() { window.location.href = "index.html"; }

    // ===== Liste bases =====
    function getDbList() { return JSON.parse(localStorage.getItem("gestion_db_list") || "[]"); }
    function saveDbList(list) { localStorage.setItem("gestion_db_list", JSON.stringify(list)); }
    function getActiveIndex() { return parseInt(localStorage.getItem("gestion_db_active") || "-1"); }
    function setActiveIndex(idx) { localStorage.setItem("gestion_db_active", idx); }

    // ===== Télécharger base =====
    async function downloadDatabase() {
      const db = await getDb();
      const dbBinary = db.export();
      const blob = new Blob([dbBinary], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "gestion.db";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("Base téléchargée");
    }

    // ===== Reset UI =====
    async function resetDatabaseUI() {
      if (!confirm("Réinitialiser la base de production ?")) return;
      await resetDatabase();
      renderDbList();
      updateDBSize();
      showToast("Base réinitialisée");
    }

    // ===== Upload fichier =====
    function uploadDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!/\.(db|sqlite|sqlite3)$/i.test(file.name)) { showToast("Format non valide", true); return; }

      const reader = new FileReader();
      reader.onload = async (e) => {
        const array = new Uint8Array(e.target.result);
        const db = await getDb();
        db.close();
        const newDb = new SQL.Database(array);
        await saveDbToLocalStorage(newDb);

        let list = getDbList();
        list.push({id: Date.now(), name:file.name});
        saveDbList(list);
        setActiveIndex(list.length - 1);

        showToast("Nouvelle base importée");
        renderDbList();
        updateDBSize();
      };
      reader.readAsArrayBuffer(file);
    }

    // ===== Nouvelle base =====
    async function createNewDatabase() {
      const response = await fetch("gestion.db");
      const arrayBuffer = await response.arrayBuffer();
      const newDb = new SQL.Database(new Uint8Array(arrayBuffer));
      await saveDbToLocalStorage(newDb);

      let list = getDbList();
      list.push({id: Date.now(), name:`NouvelleBase_${list.length+1}`});
      saveDbList(list);
      renderDbList();
      updateDBSize();
      showToast("Nouvelle base vierge ajoutée");
    }

    // ===== Mettre à jour depuis serveur =====
    async function updateFromServer() {
      try {
        const response = await fetch(`${API_BASE_URL}/export`);
        if (!response.ok) throw new Error("Erreur HTTP " + response.status);
        const data = await response.arrayBuffer();
        const newDb = new SQL.Database(new Uint8Array(data));
        await saveDbToLocalStorage(newDb);

        let list = getDbList();
        list.push({id: Date.now(), name:`BaseServeur_${list.length+1}`});
        saveDbList(list);
        setActiveIndex(list.length - 1);

        renderDbList();
        updateDBSize();
        showToast("Base mise à jour depuis serveur !");
      } catch (err) {
       
