<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Données - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    @keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
    @keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .collapsible-content.active {
      max-height: 500px;
    }
    
    .rotate-icon {
      transition: transform 0.3s ease;
    }
    
    .rotate-icon.active {
      transform: rotate(180deg);
    }

    /* Switch Button Styles */
    .switch-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .switch-btn:hover {
      transform: translateY(-8px);
    }

    .switch-circle {
      width: 100px; /* Réduit de 140px à 100px */
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); /* Ajusté pour la taille */
      transition: all 0.4s ease;
      animation: pulse 2s ease-in-out infinite;
    }

    .switch-btn:hover .switch-circle {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25); /* Ajusté pour la taille */
      transform: scale(1.05);
      animation: none;
    }

    .switch-circle i {
      transition: transform 0.3s ease;
      font-size: 3.5rem; /* Réduit légèrement */
    }

    .switch-btn:hover .switch-circle i {
      transform: scale(1.1) rotate(5deg);
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      }
      50% {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      }
    }

    /* Icon Button Styles (pour les boutons de Base Distante) */
    .icon-button {
      width: 96px;
      height: 96px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      animation: pulseButton 2s ease-in-out infinite;
    }

    .icon-button:hover {
      transform: scale(1.1) translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    @keyframes pulseButton {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      50% {
        transform: scale(1.03);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
    }

    .label-animated {
      opacity: 0;
      transform: translateY(10px);
      animation: slideUpLabel 0.5s ease-out forwards;
      animation-delay: 0.3s;
      text-align: center;
      max-width: 80px;
    }

    @keyframes slideUpLabel {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .switch-circle {
        width: 80px; /* Encore plus petit sur mobile */
        height: 80px;
      }
      .switch-circle i {
        font-size: 2.5rem;
      }
      .icon-button {
        width: 72px;
        height: 72px;
      }
      .icon-button i {
        font-size: 2rem;
      }
      .label-animated {
        font-size: 0.75rem;
        max-width: 60px;
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg">
      <i class="fas fa-spinner fa-spin mr-2" aria-hidden="true"></i>
      Chargement...
    </div>
  </div>

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white shadow-md" role="navigation" aria-label="Navigation principale">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold">
        <i class="fas fa-database mr-2" aria-hidden="true"></i>FirePoz Database
      </h1>
      <div class="flex space-x-2">
        <button onclick="goToParams()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200" aria-label="Accéder aux paramètres">
          <i class="fas fa-cog mr-2" aria-hidden="true"></i>Paramètres
        </button>
        <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200" aria-label="Retour à l'accueil">
          <i class="fas fa-home mr-2" aria-hidden="true"></i>Accueil
        </button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    
    <!-- Tableau de Bord (avec État actuel intégré) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Stats Cards et État actuel -->
      <div class="bg-white rounded-lg shadow-md p-6" role="region" aria-label="Tableau de bord">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-tachometer-alt mr-2 text-indigo-500" aria-hidden="true"></i>
          Tableau de Bord
        </h2>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
            <p class="text-gray-600 text-sm font-medium mb-1">Base Active</p>
            <p id="activeDbName" class="text-2xl font-bold text-indigo-600">Chargement...</p>
          </div>
          
          <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <p class="text-gray-600 text-sm font-medium mb-1">Taille Base</p>
            <p id="dbSize" class="text-2xl font-bold text-green-600">0 KB</p>
          </div>
        </div>

        <!-- État actuel intégré -->
        <hr class="my-4 border-gray-200">
        <h3 class="font-semibold mb-3 flex items-center">
          <i class="fas fa-info-circle mr-2 text-blue-500" aria-hidden="true"></i>
          État actuel
        </h3>
        <div id="serverStatus" class="text-gray-700">Chargement...</div>
      </div>

      <!-- Switch Panel (réduit) -->
      <div class="bg-white rounded-lg shadow-md" role="region" aria-label="Basculer entre les bases">
        <div class="px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-t-lg">
          <h2 class="text-lg font-semibold flex items-center">
            <i class="fas fa-exchange-alt mr-2" aria-hidden="true"></i>
            Switch - Basculer entre les Bases
          </h2>
        </div>
        
        <div class="px-4 py-6"> <!-- Réduit de px-6 py-8 -->
          <div class="flex flex-row gap-6 justify-center"> <!-- Réduit l'écart de gap-8 à gap-6 -->
            <button onclick="switchToServer()" class="switch-btn group relative" aria-label="Basculer vers la base serveur">
              <div class="switch-circle bg-gradient-to-br from-gray-600 to-gray-800 group-hover:from-gray-700 group-hover:to-gray-900">
                <i class="fas fa-cloud text-white text-3.5xl" aria-hidden="true"></i>
              </div>
              <div class="mt-3 text-center"> <!-- Réduit de mt-4 -->
                <p class="font-semibold text-gray-800 text-base">Base Serveur</p> <!-- Réduit de text-lg -->
                <p class="text-xs text-gray-600 mt-1">Utiliser la base téléchargée</p> <!-- Réduit de text-sm -->
              </div>
            </button>
            
            <button onclick="switchToDefault()" class="switch-btn group relative" aria-label="Basculer vers la base par défaut">
              <div class="switch-circle bg-gradient-to-br from-gray-600 to-gray-800 group-hover:from-gray-700 group-hover:to-gray-900">
                <i class="fas fa-mobile-alt text-white text-3.5xl" aria-hidden="true"></i>
              </div>
              <div class="mt-3 text-center">
                <p class="font-semibold text-gray-800 text-base">Base Par Défaut</p>
                <p class="text-xs text-gray-600 mt-1">Revenir à la base locale</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panneau Base Distante (Pliable) -->
    <div class="bg-white rounded-lg shadow-md mb-6" id="remoteBasePanelContainer" role="region" aria-label="Configuration de la base distante">
      <button onclick="toggleSection('remoteBasePanel')" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition" aria-expanded="false" aria-controls="remoteBasePanel">
        <div class="flex items-center">
          <i class="fas fa-server mr-3 text-blue-500" aria-hidden="true"></i>
          <h2 class="text-xl font-semibold">Base Distante</h2>
        </div>
        <i id="remoteBasePanelIcon" class="fas fa-chevron-down rotate-icon" aria-hidden="true"></i>
      </button>
      
      <div id="remoteBasePanel" class="collapsible-content">
        <div class="px-6 pb-6">
          <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded" id="remoteBaseInfo">
            <p class="text-sm text-gray-700">
              <i class="fas fa-info-circle mr-2 text-blue-500" aria-hidden="true"></i>
              Configurez la source API pour basculer entre SupaBase Cloud et Serveur PC.
            </p>
          </div>
          
          <form id="apiSettingsForm" class="space-y-4">
            <div class="flex items-end space-x-2">
              <div class="flex-1">
                <label for="apiBaseUrl" id="apiBaseUrlLabel" class="block text-sm font-medium text-gray-700 mb-2">URL de l'API</label>
                <input id="apiBaseUrl" type="text" name="apiBaseUrl" class="w-full px-4 py-2 text-sm border-2 border-gray-300 bg-white text-gray-800 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-300 placeholder:text-xs" placeholder="ex: https://your-subdomain.loca.lt" aria-labelledby="apiBaseUrlLabel" aria-describedby="remoteBaseInfo">
              </div>
            </div>
            <div class="flex flex-row justify-center items-start gap-6 mt-6">
              <div class="flex flex-col items-center">
                <button type="button" onclick="resetApiUrl()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 w-24 h-24 rounded-full hover:from-blue-700 hover:to-blue-800 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg icon-button" aria-label="Réinitialiser à l'API SupaBase Cloud">
                  <i class="fas fa-cloud text-4xl" aria-hidden="true"></i>
                </button>
                <span class="mt-2 text-sm font-medium text-gray-700 label-animated">SupaBase Cloud</span>
              </div>
              <div class="flex flex-col items-center">
                <button type="button" onclick="resetToSecondaryApiUrl()" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-4 w-24 h-24 rounded-full hover:from-purple-700 hover:to-purple-800 transition-all duration-300 flex items-center justify-center shadow-md hover:shadow-lg icon-button" aria-label="Réinitialiser à l'API Serveur PC">
                  <i class="fas fa-server text-4xl" aria-hidden="true"></i>
                </button>
                <span class="mt-2 text-sm font-medium text-gray-700 label-animated">Serveur PC</span>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Panneau Gestion Base Locale (Pliable) -->
    <div class="bg-white rounded-lg shadow-md mb-4" role="region" aria-label="Gestion de la base locale">
      <button onclick="toggleSection('localPanel')" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition" aria-expanded="false" aria-controls="localPanel">
        <div class="flex items-center">
          <i class="fas fa-tools mr-3 text-indigo-500" aria-hidden="true"></i>
          <h2 class="text-xl font-semibold">Gestion Base Locale</h2>
        </div>
        <i id="localPanelIcon" class="fas fa-chevron-down rotate-icon" aria-hidden="true"></i>
      </button>
      
      <div id="localPanel" class="collapsible-content">
        <div class="px-6 pb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="downloadDatabase()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition" aria-label="Télécharger la base active">
              <i class="fas fa-download mr-2" aria-hidden="true"></i>Télécharger Base Active
            </button>
            
            <button onclick="createNewDatabase()" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 transition" aria-label="Créer une nouvelle base">
              <i class="fas fa-plus-circle mr-2" aria-hidden="true"></i>Créer Nouvelle Base
            </button>
            
            <label class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition text-center cursor-pointer" for="uploadDb" aria-label="Ouvrir une base existante">
              <i class="fas fa-upload mr-2" aria-hidden="true"></i>Ouvrir Base Existante
              <input type="file" id="uploadDb" accept=".db,.sqlite,.sqlite3" class="hidden" onchange="uploadDatabase(event)">
            </label>
            
            <button onclick="resetToDefault()" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition" aria-label="Réinitialiser à la base par défaut">
              <i class="fas fa-undo mr-2" aria-hidden="true"></i>Réinitialiser (gestion.db)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panneau Synchronisation Serveur (Pliable) -->
    <div class="bg-white rounded-lg shadow-md mb-4" id="syncPanelContainer" role="region" aria-label="Synchronisation avec le serveur">
      <button onclick="toggleSection('syncPanel')" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition" aria-expanded="false" aria-controls="syncPanel">
        <div class="flex items-center">
          <i class="fas fa-cloud-download-alt mr-3 text-yellow-500" aria-hidden="true"></i>
          <h2 class="text-xl font-semibold">Synchronisation Serveur</h2>
        </div>
        <i id="syncPanelIcon" class="fas fa-chevron-down rotate-icon" aria-hidden="true"></i>
      </button>
      
      <div id="syncPanel" class="collapsible-content">
        <div class="px-6 pb-6">
          <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded" id="syncInfo">
            <p class="text-sm text-gray-700">
              <i class="fas fa-info-circle mr-2 text-blue-500" aria-hidden="true"></i>
              Téléchargez la base de données depuis le serveur.
            </p>
          </div>
          
          <button onclick="syncFromServer()" class="w-full bg-yellow-600 text-white px-6 py-3 rounded-md hover:bg-yellow-700 transition" aria-label="Télécharger la base depuis le serveur">
            <i class="fas fa-cloud-download-alt mr-2" aria-hidden="true"></i>Télécharger Base Serveur
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden z-40" role="alert" aria-live="assertive">
    <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
      <i id="toastIcon" class="mr-2" aria-hidden="true"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <!-- Modal de confirmation d'import -->
  <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="importModalTitle">
    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
      <h3 id="importModalTitle" class="text-xl font-bold mb-4 text-gray-800 flex items-center">
        <i class="fas fa-question-circle text-yellow-500 mr-2" aria-hidden="true"></i>
        Importer la base de données
      </h3>
      
      <p class="text-gray-700 mb-6">
        Fichier : <strong id="importFileName" class="text-indigo-600"></strong>
      </p>
      
      <p class="text-gray-600 mb-6 text-sm">
        Où souhaitez-vous importer cette base ?
      </p>
      
      <div class="grid grid-cols-1 gap-3 mb-6">
        <button onclick="confirmImport('default')" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition flex items-center justify-center shadow-md" aria-label="Importer comme base par défaut">
          <i class="fas fa-mobile-alt mr-2" aria-hidden="true"></i>
          Base Par Défaut (écrase)
        </button>
        
        <button onclick="confirmImport('server')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center shadow-md" aria-label="Importer comme base serveur">
          <i class="fas fa-cloud mr-2" aria-hidden="true"></i>
          Base Serveur (écrase)
        </button>
      </div>
      
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4" id="importWarning">
        <p class="text-xs text-yellow-800">
          <i class="fas fa-exclamation-triangle mr-1" aria-hidden="true"></i>
          <strong>Attention :</strong> La base actuelle sera sauvegardée automatiquement avant l'écrasement.
        </p>
      </div>
      
      <button onclick="cancelImport()" class="w-full bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition" aria-label="Annuler l'importation">
        Annuler
      </button>
    </div>
  </div>

  <script>
    // ========== IndexedDB Storage Layer ==========
    const DB_NAME = "FirePozDB";
    const STORE_NAME = "databases";
    const DEFAULT_API_URL = 'https://hicham03041979.onrender.com';
    let API_BASE_URL = localStorage.getItem('apiBaseUrl') || DEFAULT_API_URL;
    
    let dbConnection = null;
    let pendingFileData = null;

    function openIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
          }
        };
        
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    async function idbGet(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, value) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(value, key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    async function idbRemove(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).delete(key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    // ========== UI Functions ==========
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId);
      const icon = document.getElementById(sectionId + 'Icon');
      const button = content.previousElementSibling;
      
      content.classList.toggle('active');
      icon.classList.toggle('active');
      const isExpanded = content.classList.contains('active');
      button.setAttribute('aria-expanded', isExpanded);
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg toast-in z-40 ${
        isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
      }`;
      
      toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
      toastMessage.textContent = message;
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('toast-out');
        setTimeout(() => toast.classList.add('hidden'), 500);
      }, 3000);
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading');
      loading.style.display = show ? 'flex' : 'none';
    }

    function goHome() {
      window.location.href = "index.html";
    }

    function goToParams() {
      window.location.href = "PARAM.html";
    }

    // ========== API Button Functions ==========
    function resetApiUrl() {
      if (!checkLoginStatus()) {
        console.log('Réinitialisation annulée: utilisateur non connecté');
        return;
      }
      const apiBaseUrlInput = document.getElementById('apiBaseUrl');
      apiBaseUrlInput.value = DEFAULT_API_URL;
      localStorage.setItem('apiBaseUrl', DEFAULT_API_URL);
      API_BASE_URL = DEFAULT_API_URL;
      showToast(`URL de l'API réinitialisée à: ${DEFAULT_API_URL}`);
      console.log('API_BASE_URL réinitialisée:', DEFAULT_API_URL);
      updateApiButtonsIndicator();
      updateSyncPanelVisibility();
    }

    function resetToSecondaryApiUrl() {
      if (!checkLoginStatus()) {
        console.log('Réinitialisation à la base locale annulée: utilisateur non connecté');
        return;
      }
      const secondaryApiUrl = localStorage.getItem('secondaryApiUrl');
      if (!secondaryApiUrl) {
        showToast('Aucune URL de base locale trouvée', true);
        console.log('Aucune secondaryApiUrl trouvée dans localStorage');
        return;
      }
      const apiBaseUrlInput = document.getElementById('apiBaseUrl');
      apiBaseUrlInput.value = secondaryApiUrl;
      localStorage.setItem('apiBaseUrl', secondaryApiUrl);
      API_BASE_URL = secondaryApiUrl;
      showToast(`URL de l'API rétablie à la base locale: ${secondaryApiUrl}`);
      console.log('API_BASE_URL rétablie à secondaryApiUrl:', secondaryApiUrl);
      updateApiButtonsIndicator();
      updateSyncPanelVisibility();
    }

    function updateApiButtonsIndicator() {
      setTimeout(() => {
        const currentUrl = localStorage.getItem('apiBaseUrl') || DEFAULT_API_URL;
        
        const cloudBtn = document.querySelector('button[onclick="resetApiUrl()"]');
        const pcBtn = document.querySelector('button[onclick="resetToSecondaryApiUrl()"]');
        
        console.log('🔍 Boutons trouvés:', { cloudBtn, pcBtn });
        console.log('🌐 URL actuelle:', currentUrl);
        
        [cloudBtn, pcBtn].forEach(btn => {
          if (btn) {
            btn.style.opacity = '0.5';
            btn.classList.remove('ring-4', 'ring-blue-400', 'ring-purple-400', 'ring-offset-2');
          }
        });
        
        if (currentUrl.includes('hicham03041979')) {
          console.log('✅ Activation bouton CLOUD');
          if (cloudBtn) {
            cloudBtn.style.opacity = '1';
            cloudBtn.classList.add('ring-4', 'ring-blue-400', 'ring-offset-2');
          }
        } else if (currentUrl.endsWith(':5000')) {
          console.log('✅ Activation bouton PC');
          if (pcBtn) {
            pcBtn.style.opacity = '1';
            pcBtn.classList.add('ring-4', 'ring-purple-400', 'ring-offset-2');
          }
        }
      }, 100);
    }

    function checkLoginStatus() {
      const userId = localStorage.getItem('userId');
      const userEmail = localStorage.getItem('userEmail');
      if (!userId || !userEmail) {
        console.log('userId ou userEmail manquant, redirection vers index.html');
        showToast('Veuillez vous connecter', true);
        setTimeout(() => window.location.href = './index.html', 2000);
        return false;
      }
      return true;
    }

    // ========== Database Functions ==========
    async function loadActiveDb() {
      try {
        const activeData = await idbGet('gestion_db');
        if (activeData) {
          const bytes = Uint8Array.from(atob(activeData), c => c.charCodeAt(0));
          const SQL = await initSqlJs({
            locateFile: () => "https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm"
          });
          dbConnection = new SQL.Database(bytes);
          return true;
        }
        return false;
      } catch (e) {
        console.error("Erreur chargement:", e);
        return false;
      }
    }

    async function saveActiveDb() {
      if (!dbConnection) return;
      
      try {
        const binary = dbConnection.export();
        const base64 = btoa(String.fromCharCode(...binary));
        await idbSet('gestion_db', base64);
        await updateStats();
      } catch (e) {
        console.error("Erreur sauvegarde:", e);
      }
    }

    async function downloadDatabase() {
      const dbData = await idbGet('gestion_db');
      if (!dbData) {
        showToast("Aucune base active", true);
        return;
      }

      try {
        const bytes = Uint8Array.from(atob(dbData), c => c.charCodeAt(0));
        const blob = new Blob([bytes], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const name = await idbGet('gestion_db_active') || 'gestion';
        
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
        const folderName = `${name}_${dateStr}_${timeStr}`;
        
        a.href = url;
        a.download = `${folderName}_gestion.db`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast("Base téléchargée");
      } catch (e) {
        console.error("Erreur téléchargement:", e);
        showToast("Erreur téléchargement", true);
      }
    }

    async function createNewDatabase() {
      const name = prompt("Nom de la nouvelle base:");
      if (!name || !name.trim()) return;
      
      showLoading(true);
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', name.trim());
        
        await loadActiveDb();
        await updateStats();
        
        showToast(`Base "${name}" créée`);
      } catch (e) {
        console.error("Erreur création:", e);
        showToast("Erreur création", true);
      } finally {
        showLoading(false);
      }
    }

    async function uploadDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const maxSize = 50 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast("❌ Fichier trop volumineux (max 50 MB)", true);
        event.target.value = '';
        return;
      }
      
      showLoading(true);
      const reader = new FileReader();
      
      reader.onerror = function(e) {
        console.error("Erreur FileReader:", e);
        showToast("❌ Erreur lors de la lecture du fichier", true);
        showLoading(false);
      };
      
      reader.onload = async function(e) {
        try {
          const arrayBuffer = e.target.result;
          
          if (!arrayBuffer || arrayBuffer.byteLength === 0) {
            throw new Error("Fichier vide ou invalide");
          }
          
          const bytes = new Uint8Array(arrayBuffer);
          
          const CHUNK_SIZE = 32768;
          let binary = '';
          
          for (let i = 0; i < bytes.length; i += CHUNK_SIZE) {
            const chunk = bytes.subarray(i, Math.min(i + CHUNK_SIZE, bytes.length));
            binary += String.fromCharCode.apply(null, Array.from(chunk));
          }
          
          const base64 = btoa(binary);
          
          pendingFileData = {
            fileName: file.name.replace(/\.(db|sqlite|sqlite3)$/i, ''),
            base64: base64,
            originalName: file.name,
            size: file.size
          };
          
          document.getElementById('importFileName').textContent = file.name;
          document.getElementById('importModal').classList.remove('hidden');
          
          showLoading(false);
          
        } catch (error) {
          console.error("Erreur détaillée:", error);
          showToast(`❌ Erreur: ${error.message}`, true);
          showLoading(false);
          pendingFileData = null;
        }
      };
      
      reader.readAsArrayBuffer(file);
      event.target.value = '';
    }

    async function confirmImport(type) {
      if (!pendingFileData) {
        showToast("Aucun fichier en attente", true);
        return;
      }
      
      document.getElementById('importModal').classList.add('hidden');
      showLoading(true);
      
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        if (type === 'default') {
          await idbSet('gestion_db', pendingFileData.base64);
          await idbSet('gestion_db_active', 'gestion');
          
          if (dbConnection) {
            try { dbConnection.close(); } catch (e) {}
          }
          dbConnection = null;
          
          await loadActiveDb();
          await updateStats();
          await updateServerStatus();
          await updateSyncPanelVisibility();
          await updateApiButtonsIndicator();
          
          showToast(`✅ Base importée comme base par défaut`);
          
        } else if (type === 'server') {
          await idbSet('gestion_db_server', pendingFileData.base64);
          await idbSet('gestion_db', pendingFileData.base64);
          await idbSet('gestion_db_active', 'serveur');
          
          localStorage.setItem('apiBaseUrl', '/api');
          API_BASE_URL = '/api';
          
          if (dbConnection) {
            try { dbConnection.close(); } catch (e) {}
          }
          dbConnection = null;
          
          await loadActiveDb();
          await updateStats();
          await updateServerStatus();
          await updateSyncPanelVisibility();
          await updateApiButtonsIndicator();
          
          showToast(`✅ Base importée comme base serveur (mode LOCAL activé)`);
        }
        
        pendingFileData = null;
        
      } catch (error) {
        console.error("Erreur import:", error);
        showToast("Erreur lors de l'import", true);
      } finally {
        showLoading(false);
      }
    }

    function cancelImport() {
      document.getElementById('importModal').classList.add('hidden');
      pendingFileData = null;
      showToast("Import annulé");
    }

    async function resetToDefault() {
      if (!confirm("⚠️ Réinitialiser avec gestion.db par défaut ?\n\nCette action est irréversible.")) return;
      
      showLoading(true);
      try {
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', 'gestion');
        await idbRemove('gestion_db_server');
        
        await loadActiveDb();
        await updateStats();
        
        showToast("Base réinitialisée");
      } catch (e) {
        console.error("Erreur reset:", e);
        showToast("Erreur reset", true);
      } finally {
        showLoading(false);
      }
    }

    async function switchToServer() {
      showLoading(true);
      try {
        const serverDb = await idbGet('gestion_db_server');
        if (!serverDb) {
          showToast("⚠️ Aucune base serveur. Téléchargez-la d'abord!", true);
          showLoading(false);
          return;
        }
        
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        await idbSet('gestion_db', serverDb);
        await idbSet('gestion_db_active', 'serveur');
        
        localStorage.setItem('apiBaseUrl', '/api'); 
        API_BASE_URL = '/api';
        
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        await updateSyncPanelVisibility();
        await updateApiButtonsIndicator();
        showToast("✅ Base serveur activée");
      } catch (e) {
        console.error("Erreur activation serveur:", e);
        showToast("❌ Erreur activation base serveur", true);
      } finally {
        showLoading(false);
      }
    }

    async function switchToDefault() {
      showLoading(true);
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb && currentName !== 'gestion') {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        let defaultDb = await idbGet('gestion_db_backup_gestion');
        
        if (!defaultDb) {
          console.log("📥 Pas de backup, chargement gestion.db original");
          const response = await fetch("gestion.db");
          if (!response.ok) throw new Error("Impossible de charger gestion.db");
          
          const buffer = await response.arrayBuffer();
          defaultDb = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        } else {
          console.log("📦 Restauration base par défaut depuis backup");
        }
        
        await idbSet('gestion_db', defaultDb);
        await idbSet('gestion_db_active', 'gestion');
        
        localStorage.setItem('apiBaseUrl', '/api'); 
        API_BASE_URL = '/api';
        
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        await updateSyncPanelVisibility();
        await updateApiButtonsIndicator();
        showToast("✅ Basculé vers base par défaut");
      } catch (e) {
        console.error("Erreur switch:", e);
        showToast("❌ Erreur basculement", true);
      } finally {
        showLoading(false);
      }
    }

    async function syncFromServer() {
      showLoading(true);
      try {
        const userId = localStorage.getItem('userId');
        if (!userId) {
          showToast("⚠️ Veuillez vous connecter pour synchroniser la base serveur", true);
          return;
        }

        const response = await fetch(`${API_BASE_URL}/export`, {
          headers: {
            'X-User-ID': userId
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Erreur HTTP ${response.status}: ${errorData.error || response.statusText}`);
        }
        
        const data = await response.json();
        const base64Db = data.db;
        
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`💾 Base "${currentName}" sauvegardée`);
        }
        
        await idbSet('gestion_db_server', base64Db);
        await idbSet('gestion_db', base64Db);
        await idbSet('gestion_db_active', 'serveur');
        
        localStorage.setItem('apiBaseUrl', '/api');
        API_BASE_URL = '/api';

        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        await updateSyncPanelVisibility();
        await updateApiButtonsIndicator();
        if (API_BASE_URL === '/api') {
          showToast("✅ Vous êtes maintenant en MODE LOCAL (/api)");
        } else {
          showToast("✅ Base serveur téléchargée et activée");
        }
      } catch (err) {
        console.error("Erreur sync:", err);
        showToast(`❌ Erreur serveur: ${err.message}`, true);
      } finally {
        showLoading(false);
      }
    }

    async function updateServerStatus() {
      const activeName = await idbGet('gestion_db_active') || 'gestion';
      const hasServer = await idbGet('gestion_db_server');
      
      const status = document.getElementById('serverStatus');
      
      const serverBtn = document.querySelector('button[onclick="switchToServer()"]');
      const defaultBtn = document.querySelector('button[onclick="switchToDefault()"]');
      
      if (serverBtn) {
        const serverCircle = serverBtn.querySelector('.switch-circle');
        serverCircle.classList.remove('ring-4', 'ring-gray-400', 'ring-offset-2');
        serverBtn.style.opacity = '0.5';
      }
      
      if (defaultBtn) {
        const defaultCircle = defaultBtn.querySelector('.switch-circle');
        defaultCircle.classList.remove('ring-4', 'ring-gray-400', 'ring-offset-2');
        defaultBtn.style.opacity = '0.5';
      }
      
      if (activeName === 'serveur') {
        if (serverBtn) {
          const serverCircle = serverBtn.querySelector('.switch-circle');
          serverCircle.classList.add('ring-4', 'ring-gray-400', 'ring-offset-2');
          serverBtn.style.opacity = '1';
        }
        
        status.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2" aria-hidden="true"></i>
            <span class="font-semibold text-green-700">Base SERVEUR actuellement active</span>
          </div>
          <p class="text-sm text-gray-600 mt-1">Vous travaillez sur la base téléchargée depuis le serveur.</p>
        `;
      } else if (activeName === 'gestion') {
        if (defaultBtn) {
          const defaultCircle = defaultBtn.querySelector('.switch-circle');
          defaultCircle.classList.add('ring-4', 'ring-gray-400', 'ring-offset-2');
          defaultBtn.style.opacity = '1';
        }
        
        status.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-mobile-alt text-purple-500 mr-2" aria-hidden="true"></i>
            <span class="font-semibold text-purple-700">Base PAR DÉFAUT actuellement active</span>
          </div>
          <p class="text-sm text-gray-600 mt-1">Vous travaillez sur la base locale par défaut.</p>
        `;
        
        if (hasServer) {
          status.innerHTML += `
            <p class="text-sm text-blue-600 mt-2">
              <i class="fas fa-info-circle mr-1" aria-hidden="true"></i>
              Une base serveur est disponible.
            </p>
          `;
        }
      } else {
        if (serverBtn) serverBtn.style.opacity = '1';
        if (defaultBtn) defaultBtn.style.opacity = '1';
        
        status.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-database text-indigo-500 mr-2" aria-hidden="true"></i>
            <span class="font-semibold text-indigo-700">Base "${activeName}" active</span>
          </div>
        `;
      }
      
      if (!hasServer && activeName !== 'serveur') {
        status.innerHTML += `
          <p class="text-sm text-orange-600 mt-2">
            <i class="fas fa-exclamation-triangle mr-1" aria-hidden="true"></i>
            Aucune base serveur téléchargée.
          </p>
        `;
      }
    }

    async function updateSyncPanelVisibility() {
      const syncPanelContainer = document.querySelector('#syncPanelContainer');
      const storedApiUrl = localStorage.getItem('apiBaseUrl') || DEFAULT_API_URL;
      
      if (storedApiUrl === '/api') {
        syncPanelContainer.style.opacity = '0.5';
        syncPanelContainer.style.pointerEvents = 'none';
        syncPanelContainer.style.cursor = 'not-allowed';
        syncPanelContainer.setAttribute('aria-disabled', 'true');
        
        let infoMsg = syncPanelContainer.querySelector('.api-local-info');
        if (!infoMsg) {
          infoMsg = document.createElement('div');
          infoMsg.className = 'api-local-info px-6 pb-4';
          infoMsg.innerHTML = `
            <div class="p-3 bg-gray-100 border border-gray-300 rounded text-sm text-gray-600">
              <i class="fas fa-info-circle mr-2" aria-hidden="true"></i>
              <strong>Panneau désactivé</strong> : Vous êtes en mode LOCAL. 
              La synchronisation serveur n'est disponible qu'en mode Cloud.
              <br>
              <span class="text-xs mt-1 block">
                💡 Changez l'URL de base dans les paramètres pour activer cette fonctionnalité.
              </span>
            </div>
          `;
          syncPanelContainer.appendChild(infoMsg);
        }
      } else {
        syncPanelContainer.style.opacity = '1';
        syncPanelContainer.style.pointerEvents = 'auto';
        syncPanelContainer.style.cursor = 'pointer';
        syncPanelContainer.removeAttribute('aria-disabled');
        
        const infoMsg = syncPanelContainer.querySelector('.api-local-info');
        if (infoMsg) {
          infoMsg.remove();
        }
      }
    }

    async function updateStats() {
      const activeName = await idbGet('gestion_db_active') || 'Aucune';
      const dbData = await idbGet('gestion_db');
      
      document.getElementById('activeDbName').textContent = activeName;
      
      if (dbData) {
        const sizeKB = (dbData.length / 1024).toFixed(2);
        document.getElementById('dbSize').textContent = `${sizeKB} KB`;
      } else {
        document.getElementById('dbSize').textContent = '0 KB';
      }
    }

    // ========== Initialization ==========
    async function init() {
      showLoading(true);
      try {
        const hasDb = await loadActiveDb();
        
        if (!hasDb) {
          const response = await fetch("gestion.db");
          if (response.ok) {
            const buffer = await response.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            await idbSet('gestion_db', base64);
            await idbSet('gestion_db_active', 'gestion');
            await loadActiveDb();
          }
        }
        
        await updateStats();
        await updateServerStatus();
        await updateSyncPanelVisibility();
        await updateApiButtonsIndicator();
        console.log("✅ Application initialisée");
      } catch (e) {
        console.error("❌ Erreur init:", e);
        showToast("Erreur initialisation", true);
      } finally {
        showLoading(false);
      }
    }

    // Autosave for apiBaseUrl input
    function setupAutoSave() {
      const apiBaseUrlInput = document.getElementById('apiBaseUrl');
      if (apiBaseUrlInput) {
        apiBaseUrlInput.addEventListener('input', () => {
          const url = apiBaseUrlInput.value.trim();
          localStorage.setItem('apiBaseUrl', url || DEFAULT_API_URL);
          API_BASE_URL = url || DEFAULT_API_URL;
          updateApiButtonsIndicator();
          updateSyncPanelVisibility();
          showToast(`URL de l'API mise à jour: ${API_BASE_URL}`);
        });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        init();
        setupAutoSave();
      });
    } else {
      init();
      setupAutoSave();
    }
  </script>
</body>
</html>