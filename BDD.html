<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Donn√©es - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .toast-in { animation: toastIn 0.5s both; }
    .toast-out { animation: toastOut 0.5s both; }
    @keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
    @keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .collapsible-content.active {
      max-height: 500px;
    }
    
    .rotate-icon {
      transition: transform 0.3s ease;
    }
    
    .rotate-icon.active {
      transform: rotate(180deg);
    }

    /* Switch Button Styles */
    .switch-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .switch-btn:hover {
      transform: translateY(-8px);
    }

    .switch-circle {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      transition: all 0.4s ease;
      animation: pulse 2s ease-in-out infinite;
    }

    .switch-btn:hover .switch-circle {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      transform: scale(1.05);
      animation: none;
    }

    .switch-circle i {
      transition: transform 0.3s ease;
    }

    .switch-btn:hover .switch-circle i {
      transform: scale(1.1) rotate(5deg);
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }
      50% {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Loading -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg">
      <i class="fas fa-spinner fa-spin mr-2"></i>
      Chargement...
    </div>
  </div>

  <!-- Navbar -->
  <nav class="bg-indigo-600 text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold">
        <i class="fas fa-database mr-2"></i>FirePoz Database
      </h1>
      <div class="flex space-x-2">
        <button onclick="goToParams()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
          <i class="fas fa-cog mr-2"></i>Param√®tres
        </button>
        <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200">
          <i class="fas fa-home mr-2"></i>Accueil
        </button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    
    <!-- Tableau de Bord et Switch -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Stats Cards -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-tachometer-alt mr-2 text-indigo-500"></i>
          Tableau de Bord
        </h2>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
            <p class="text-gray-600 text-sm font-medium mb-1">Base Active</p>
            <p id="activeDbName" class="text-2xl font-bold text-indigo-600">Chargement...</p>
          </div>
          
          <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <p class="text-gray-600 text-sm font-medium mb-1">Taille Base</p>
            <p id="dbSize" class="text-2xl font-bold text-green-600">0 KB</p>
          </div>
        </div>
      </div>

      <!-- Switch Panel -->
      <div class="bg-white rounded-lg shadow-md">
        <div class="px-6 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-t-lg">
          <h2 class="text-xl font-semibold flex items-center">
            <i class="fas fa-exchange-alt mr-3"></i>
            Switch - Basculer entre les Bases
          </h2>
        </div>
        
        <div class="px-6 py-8">
          <div class="flex flex-row gap-8 justify-center">
            <button onclick="switchToServer()" class="switch-btn group relative">
              <div class="switch-circle bg-gradient-to-br from-green-400 to-green-600 group-hover:from-green-500 group-hover:to-green-700">
                <i class="fas fa-cloud text-white text-5xl"></i>
              </div>
              <div class="mt-4 text-center">
                <p class="font-semibold text-gray-800 text-lg">Base Serveur</p>
                <p class="text-sm text-gray-600 mt-1">Utiliser la base t√©l√©charg√©e</p>
              </div>
            </button>
            
            <button onclick="switchToDefault()" class="switch-btn group relative">
              <div class="switch-circle bg-gradient-to-br from-purple-400 to-purple-600 group-hover:from-purple-500 group-hover:to-purple-700">
                <i class="fas fa-mobile-alt text-white text-5xl"></i>
              </div>
              <div class="mt-4 text-center">
                <p class="font-semibold text-gray-800 text-lg">Base Par D√©faut</p>
                <p class="text-sm text-gray-600 mt-1">Revenir √† la base locale</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- √âtat actuel -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="font-semibold mb-3 flex items-center">
        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
        √âtat actuel
      </h3>
      <div id="serverStatus" class="text-gray-700">Chargement...</div>
    </div>

    <!-- Panneau Gestion Base Locale (Pliable) -->
    <div class="bg-white rounded-lg shadow-md mb-4">
      <button onclick="toggleSection('localPanel')" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition">
        <div class="flex items-center">
          <i class="fas fa-tools mr-3 text-indigo-500"></i>
          <h2 class="text-xl font-semibold">Gestion Base Locale</h2>
        </div>
        <i id="localPanelIcon" class="fas fa-chevron-down rotate-icon"></i>
      </button>
      
      <div id="localPanel" class="collapsible-content">
        <div class="px-6 pb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="downloadDatabase()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition">
              <i class="fas fa-download mr-2"></i>T√©l√©charger Base Active
            </button>
            
            <button onclick="createNewDatabase()" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 transition">
              <i class="fas fa-plus-circle mr-2"></i>Cr√©er Nouvelle Base
            </button>
            
            <label class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition text-center cursor-pointer">
              <i class="fas fa-upload mr-2"></i>Ouvrir Base Existante
              <input type="file" id="uploadDb" accept=".db,.sqlite,.sqlite3" class="hidden" onchange="uploadDatabase(event)">
            </label>
            
            <button onclick="resetToDefault()" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition">
              <i class="fas fa-undo mr-2"></i>R√©initialiser (gestion.db)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panneau Synchronisation Serveur (Pliable) -->
    <div class="bg-white rounded-lg shadow-md mb-4">
      <button onclick="toggleSection('syncPanel')" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition">
        <div class="flex items-center">
          <i class="fas fa-cloud-download-alt mr-3 text-yellow-500"></i>
          <h2 class="text-xl font-semibold">Synchronisation Serveur</h2>
        </div>
        <i id="syncPanelIcon" class="fas fa-chevron-down rotate-icon"></i>
      </button>
      
      <div id="syncPanel" class="collapsible-content">
        <div class="px-6 pb-6">
          <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
            <p class="text-sm text-gray-700">
              <i class="fas fa-info-circle mr-2 text-blue-500"></i>
              T√©l√©chargez la base de donn√©es depuis le serveur.
            </p>
          </div>
          
          <button onclick="syncFromServer()" class="w-full bg-yellow-600 text-white px-6 py-3 rounded-md hover:bg-yellow-700 transition">
            <i class="fas fa-cloud-download-alt mr-2"></i>T√©l√©charger Base Serveur
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 hidden z-40">
    <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
      <i id="toastIcon" class="mr-2"></i>
      <span id="toastMessage"></span>
    </div>
  </div>

  <script>
      // ========== IndexedDB Storage Layer ==========
    const DB_NAME = "FirePozDB";
    const STORE_NAME = "databases";
    let API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';
    
    let dbConnection = null;

    function openIDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        
        req.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
          }
        };
        
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    async function idbGet(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const req = tx.objectStore(STORE_NAME).get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, value) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).put(value, key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    async function idbRemove(key) {
      const db = await openIDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        tx.objectStore(STORE_NAME).delete(key);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    // ========== UI Functions ==========
    function toggleSection(sectionId) {
      const content = document.getElementById(sectionId);
      const icon = document.getElementById(sectionId + 'Icon');
      
      content.classList.toggle('active');
      icon.classList.toggle('active');
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg toast-in z-40 ${
        isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
      }`;
      
      toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
      toastMessage.textContent = message;
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('toast-out');
        setTimeout(() => toast.classList.add('hidden'), 500);
      }, 3000);
    }

    function showLoading(show = true) {
      const loading = document.getElementById('loading');
      loading.style.display = show ? 'flex' : 'none';
    }

    function goHome() {
      window.location.href = "index.html";
    }

    function goToParams() {
      window.location.href = "PARAM.html";
    }

    // ========== Database Functions ==========
    async function loadActiveDb() {
      try {
        const activeData = await idbGet('gestion_db');
        if (activeData) {
          const bytes = Uint8Array.from(atob(activeData), c => c.charCodeAt(0));
          const SQL = await initSqlJs({
            locateFile: () => "https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm"
          });
          dbConnection = new SQL.Database(bytes);
          return true;
        }
        return false;
      } catch (e) {
        console.error("Erreur chargement:", e);
        return false;
      }
    }

    async function saveActiveDb() {
      if (!dbConnection) return;
      
      try {
        const binary = dbConnection.export();
        const base64 = btoa(String.fromCharCode(...binary));
        await idbSet('gestion_db', base64);
        await updateStats();
      } catch (e) {
        console.error("Erreur sauvegarde:", e);
      }
    }

  async function downloadDatabase() {
  const dbData = await idbGet('gestion_db');
  if (!dbData) {
    showToast("Aucune base active", true);
    return;
  }

  try {
    const bytes = Uint8Array.from(atob(dbData), c => c.charCodeAt(0));
    const blob = new Blob([bytes], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    const name = await idbGet('gestion_db_active') || 'gestion';
    
    // Cr√©er le nom du dossier avec la date
    const now = new Date();
    const dateStr = now.toISOString().slice(0, 10); // Format: YYYY-MM-DD
    const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-'); // Format: HH-MM-SS
    const folderName = `${name}_${dateStr}_${timeStr}`;
    
    a.href = url;
    a.download = `${folderName}/gestion.db`;  // Nom du dossier + fichier gestion.db
    a.click();
    URL.revokeObjectURL(url);
    
    showToast("Base t√©l√©charg√©e");
  } catch (e) {
    console.error("Erreur t√©l√©chargement:", e);
    showToast("Erreur t√©l√©chargement", true);
  }
}

    async function createNewDatabase() {
      const name = prompt("Nom de la nouvelle base:");
      if (!name || !name.trim()) return;
      
      showLoading(true);
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`üíæ Base "${currentName}" sauvegard√©e`);
        }
        
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', name.trim());
        
        await loadActiveDb();
        await updateStats();
        
        showToast(`Base "${name}" cr√©√©e`);
      } catch (e) {
        console.error("Erreur cr√©ation:", e);
        showToast("Erreur cr√©ation", true);
      } finally {
        showLoading(false);
      }
    }

// Variable globale pour stocker les donn√©es du fichier en attente
let pendingFileData = null;

function uploadDatabase(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // V√©rifier la taille du fichier
  const maxSize = 50 * 1024 * 1024; // 50 MB
  if (file.size > maxSize) {
    showToast("‚ùå Fichier trop volumineux (max 50 MB)", true);
    event.target.value = '';
    return;
  }
  
  showLoading(true);
  const reader = new FileReader();
  
  reader.onerror = function(e) {
    console.error("Erreur FileReader:", e);
    showToast("‚ùå Erreur lors de la lecture du fichier", true);
    showLoading(false);
  };
  
  reader.onload = async function(e) {
    try {
      const arrayBuffer = e.target.result;
      
      if (!arrayBuffer || arrayBuffer.byteLength === 0) {
        throw new Error("Fichier vide ou invalide");
      }
      
      const bytes = new Uint8Array(arrayBuffer);
      
      // Conversion optimis√©e pour gros fichiers
      const CHUNK_SIZE = 32768; // 32 KB
      let binary = '';
      
      for (let i = 0; i < bytes.length; i += CHUNK_SIZE) {
        const chunk = bytes.subarray(i, Math.min(i + CHUNK_SIZE, bytes.length));
        binary += String.fromCharCode.apply(null, Array.from(chunk));
      }
      
      const base64 = btoa(binary);
      
      // Stocker les donn√©es
      pendingFileData = {
        fileName: file.name.replace(/\.(db|sqlite|sqlite3)$/i, ''),
        base64: base64,
        originalName: file.name,
        size: file.size
      };
      
      // Afficher le modal
      document.getElementById('importFileName').textContent = file.name;
      document.getElementById('importModal').classList.remove('hidden');
      
      showLoading(false);
      
    } catch (error) {
      console.error("Erreur d√©taill√©e:", error);
      showToast(`‚ùå Erreur: ${error.message}`, true);
      showLoading(false);
      pendingFileData = null;
    }
  };
  
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

async function confirmImport(type) {
  if (!pendingFileData) {
    showToast("Aucun fichier en attente", true);
    return;
  }
  
  // Fermer le modal
  document.getElementById('importModal').classList.add('hidden');
  showLoading(true);
  
  try {
    // Sauvegarder la base actuelle
    const currentName = await idbGet('gestion_db_active') || 'gestion';
    const currentDb = await idbGet('gestion_db');
    if (currentDb) {
      await idbSet(`gestion_db_backup_${currentName}`, currentDb);
      console.log(`üíæ Base "${currentName}" sauvegard√©e`);
    }
    
    if (type === 'default') {
      // Importer comme base par d√©faut
      await idbSet('gestion_db', pendingFileData.base64);
      await idbSet('gestion_db_active', 'gestion');
      
      if (dbConnection) {
        try { dbConnection.close(); } catch (e) {}
      }
      dbConnection = null;
      
      await loadActiveDb();
      await updateStats();
      await updateServerStatus();
      await updateSyncPanelVisibility();
      
      showToast(`‚úÖ Base import√©e comme base par d√©faut`);
      
    } else if (type === 'server') {
      // Importer comme base serveur
      await idbSet('gestion_db_server', pendingFileData.base64);
      await idbSet('gestion_db', pendingFileData.base64);
      await idbSet('gestion_db_active', 'serveur');
      
      // Passer en mode local
      localStorage.setItem('apiBaseUrl', '/api');
      API_BASE_URL = '/api';
      
      if (dbConnection) {
        try { dbConnection.close(); } catch (e) {}
      }
      dbConnection = null;
      
      await loadActiveDb();
      await updateStats();
      await updateServerStatus();
      await updateSyncPanelVisibility();
      
      showToast(`‚úÖ Base import√©e comme base serveur (mode LOCAL activ√©)`);
    }
    
    // Nettoyer
    pendingFileData = null;
    
  } catch (error) {
    console.error("Erreur import:", error);
    showToast("Erreur lors de l'import", true);
  } finally {
    showLoading(false);
  }
}

function cancelImport() {
  document.getElementById('importModal').classList.add('hidden');
  pendingFileData = null;
  showToast("Import annul√©");
}

    async function resetToDefault() {
      if (!confirm("‚ö†Ô∏è R√©initialiser avec gestion.db par d√©faut ?\n\nCette action est irr√©versible.")) return;
      
      showLoading(true);
      try {
        const response = await fetch("gestion.db");
        if (!response.ok) throw new Error("Impossible de charger gestion.db");
        
        const buffer = await response.arrayBuffer();
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        
        await idbSet('gestion_db', base64);
        await idbSet('gestion_db_active', 'gestion');
        await idbRemove('gestion_db_server');
        
        await loadActiveDb();
        await updateStats();
        
        showToast("Base r√©initialis√©e");
      } catch (e) {
        console.error("Erreur reset:", e);
        showToast("Erreur reset", true);
      } finally {
        showLoading(false);
      }
    }

    async function switchToServer() {
      showLoading(true);
      try {
        const serverDb = await idbGet('gestion_db_server');
        if (!serverDb) {
          showToast("‚ö†Ô∏è Aucune base serveur. T√©l√©chargez-la d'abord!", true);
          showLoading(false);
          return;
        }
        
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb) {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`üíæ Base "${currentName}" sauvegard√©e`);
        }
        
        await idbSet('gestion_db', serverDb);
        await idbSet('gestion_db_active', 'serveur');
        
        localStorage.setItem('apiBaseUrl', '/api'); 
        
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        await updateSyncPanelVisibility();
        showToast("‚úÖ Base serveur activ√©e");
      } catch (e) {
        console.error("Erreur activation serveur:", e);
        showToast("‚ùå Erreur activation base serveur", true);
      } finally {
        showLoading(false);
      }
    }

 async function syncFromServer() {
  showLoading(true);
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) {
      showToast("‚ö†Ô∏è Veuillez vous connecter pour synchroniser la base serveur", true);
      return;
    }

    const response = await fetch(`${API_BASE_URL}/export`, {
      headers: {
        'X-User-ID': userId
      }
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`Erreur HTTP ${response.status}: ${errorData.error || response.statusText}`);
    }
    
    const data = await response.json();
    const base64Db = data.db;
    
    const currentName = await idbGet('gestion_db_active') || 'gestion';
    const currentDb = await idbGet('gestion_db');
    if (currentDb) {
      await idbSet(`gestion_db_backup_${currentName}`, currentDb);
      console.log(`üíæ Base "${currentName}" sauvegard√©e`);
    }
    
    await idbSet('gestion_db_server', base64Db);
    await idbSet('gestion_db', base64Db);
    await idbSet('gestion_db_active', 'serveur');
    
    await idbSet('apiBaseUrl', '/api');
    API_BASE_URL = '/api';
    localStorage.setItem('apiBaseUrl', '/api'); 

    if (dbConnection) {
      try {
        dbConnection.close();
      } catch (e) {}
    }
    dbConnection = null;
    await loadActiveDb();
    await updateStats();
    await updateServerStatus();
    await updateSyncPanelVisibility();
    if (API_BASE_URL === '/api') {
      showToast("‚úÖ Vous √™tes maintenant en MODE LOCAL (/api)");
    } else {
      showToast("‚úÖ Base serveur t√©l√©charg√©e et activ√©e");
    }
  } catch (err) {
    console.error("Erreur sync:", err);
    showToast(`‚ùå Erreur serveur: ${err.message}`, true);
  } finally {
    showLoading(false);
  }
}
    async function switchToDefault() {
      showLoading(true);
      try {
        const currentName = await idbGet('gestion_db_active') || 'gestion';
        const currentDb = await idbGet('gestion_db');
        if (currentDb && currentName !== 'gestion') {
          await idbSet(`gestion_db_backup_${currentName}`, currentDb);
          console.log(`üíæ Base "${currentName}" sauvegard√©e`);
        }
        
        let defaultDb = await idbGet('gestion_db_backup_gestion');
        
        if (!defaultDb) {
          console.log("üì• Pas de backup, chargement gestion.db original");
          const response = await fetch("gestion.db");
          if (!response.ok) throw new Error("Impossible de charger gestion.db");
          
          const buffer = await response.arrayBuffer();
          defaultDb = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        } else {
          console.log("üì¶ Restauration base par d√©faut depuis backup");
        }
        
        await idbSet('gestion_db', defaultDb);
        await idbSet('gestion_db_active', 'gestion');
        
        localStorage.setItem('apiBaseUrl', '/api'); 
        
        if (dbConnection) {
          try {
            dbConnection.close();
          } catch (e) {}
        }
        dbConnection = null;
        await loadActiveDb();
        await updateStats();
        await updateServerStatus();
        await updateSyncPanelVisibility();
        showToast("‚úÖ Bascul√© vers base par d√©faut");
      } catch (e) {
        console.error("Erreur switch:", e);
        showToast("‚ùå Erreur basculement", true);
      } finally {
        showLoading(false);
      }
    }

 async function updateServerStatus() {
  const activeName = await idbGet('gestion_db_active') || 'gestion';
  const hasServer = await idbGet('gestion_db_server');
  
  const status = document.getElementById('serverStatus');
  
  // R√©cup√©rer les boutons du switch
  const serverBtn = document.querySelector('button[onclick="switchToServer()"]');
  const defaultBtn = document.querySelector('button[onclick="switchToDefault()"]');
  
  // R√©initialiser les styles des deux boutons
  if (serverBtn) {
    const serverCircle = serverBtn.querySelector('.switch-circle');
    serverCircle.classList.remove('ring-4', 'ring-green-400', 'ring-offset-2');
    serverBtn.style.opacity = '0.5';
  }
  
  if (defaultBtn) {
    const defaultCircle = defaultBtn.querySelector('.switch-circle');
    defaultCircle.classList.remove('ring-4', 'ring-purple-400', 'ring-offset-2');
    defaultBtn.style.opacity = '0.5';
  }
  
  // Appliquer le style au bouton actif
  if (activeName === 'serveur') {
    if (serverBtn) {
      const serverCircle = serverBtn.querySelector('.switch-circle');
      serverCircle.classList.add('ring-4', 'ring-green-400', 'ring-offset-2');
      serverBtn.style.opacity = '1';
    }
    
    status.innerHTML = `
      <div class="flex items-center">
        <i class="fas fa-check-circle text-green-500 mr-2"></i>
        <span class="font-semibold text-green-700">Base SERVEUR actuellement active</span>
      </div>
      <p class="text-sm text-gray-600 mt-1">Vous travaillez sur la base t√©l√©charg√©e depuis le serveur.</p>
    `;
  } else if (activeName === 'gestion') {
    if (defaultBtn) {
      const defaultCircle = defaultBtn.querySelector('.switch-circle');
      defaultCircle.classList.add('ring-4', 'ring-purple-400', 'ring-offset-2');
      defaultBtn.style.opacity = '1';
    }
    
    status.innerHTML = `
      <div class="flex items-center">
        <i class="fas fa-mobile-alt text-purple-500 mr-2"></i>
        <span class="font-semibold text-purple-700">Base PAR D√âFAUT actuellement active</span>
      </div>
      <p class="text-sm text-gray-600 mt-1">Vous travaillez sur la base locale par d√©faut.</p>
    `;
    
    if (hasServer) {
      status.innerHTML += `
        <p class="text-sm text-blue-600 mt-2">
          <i class="fas fa-info-circle mr-1"></i>
          Une base serveur est disponible.
        </p>
      `;
    }
  } else {
    // R√©activer les deux boutons si ni serveur ni gestion
    if (serverBtn) serverBtn.style.opacity = '1';
    if (defaultBtn) defaultBtn.style.opacity = '1';
    
    status.innerHTML = `
      <div class="flex items-center">
        <i class="fas fa-database text-indigo-500 mr-2"></i>
        <span class="font-semibold text-indigo-700">Base "${activeName}" active</span>
      </div>
    `;
  }
  
  if (!hasServer && activeName !== 'serveur') {
    status.innerHTML += `
      <p class="text-sm text-orange-600 mt-2">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        Aucune base serveur t√©l√©charg√©e.
      </p>
    `;
  }
}
async function updateSyncPanelVisibility() {
  const syncPanelContainer = document.querySelector('#syncPanel').parentElement;
  const storedApiUrl = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';
  
  if (storedApiUrl === '/api') {
    // D√©sactiver le panneau
    syncPanelContainer.style.opacity = '0.5';
    syncPanelContainer.style.pointerEvents = 'none';
    syncPanelContainer.style.cursor = 'not-allowed';
    
    // Ajouter un message d'information
    let infoMsg = syncPanelContainer.querySelector('.api-local-info');
    if (!infoMsg) {
      infoMsg = document.createElement('div');
      infoMsg.className = 'api-local-info px-6 pb-4';
      infoMsg.innerHTML = `
        <div class="p-3 bg-gray-100 border border-gray-300 rounded text-sm text-gray-600">
          <i class="fas fa-info-circle mr-2"></i>
          <strong>Panneau d√©sactiv√©</strong> : Vous √™tes en mode LOCAL. 
          La synchronisation serveur n'est disponible qu'en mode Cloud.
          <br>
          <span class="text-xs mt-1 block">
            üí° Changez l'URL de base dans les param√®tres pour activer cette fonctionnalit√©.
          </span>
        </div>
      `;
      syncPanelContainer.appendChild(infoMsg);
    }
  } else {
    // Activer le panneau
    syncPanelContainer.style.opacity = '1';
    syncPanelContainer.style.pointerEvents = 'auto';
    syncPanelContainer.style.cursor = 'pointer';
    
    // Retirer le message si pr√©sent
    const infoMsg = syncPanelContainer.querySelector('.api-local-info');
    if (infoMsg) {
      infoMsg.remove();
    }
  }
}
     async function updateStats() {
      const activeName = await idbGet('gestion_db_active') || 'Aucune';
      const dbData = await idbGet('gestion_db');
      
      document.getElementById('activeDbName').textContent = activeName;
      
      if (dbData) {
        const sizeKB = (dbData.length / 1024).toFixed(2);
        document.getElementById('dbSize').textContent = `${sizeKB} KB`;
      } else {
        document.getElementById('dbSize').textContent = '0 KB';
      }
    }

    // ========== Initialization ==========
    async function init() {
      showLoading(true);
      try {
        const hasDb = await loadActiveDb();
        
        if (!hasDb) {
          const response = await fetch("gestion.db");
          if (response.ok) {
            const buffer = await response.arrayBuffer();
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            await idbSet('gestion_db', base64);
            await idbSet('gestion_db_active', 'gestion');
            await loadActiveDb();
          }
        }
        
        await updateStats();
        await updateServerStatus();
        await updateSyncPanelVisibility();
        console.log("‚úÖ Application initialis√©e");
      } catch (e) {
        console.error("‚ùå Erreur init:", e);
        showToast("Erreur initialisation", true);
      } finally {
        showLoading(false);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <!-- Modal de confirmation d'import -->
<div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
      <i class="fas fa-question-circle text-yellow-500 mr-2"></i>
      Importer la base de donn√©es
    </h3>
    
    <p class="text-gray-700 mb-6">
      Fichier : <strong id="importFileName" class="text-indigo-600"></strong>
    </p>
    
    <p class="text-gray-600 mb-6 text-sm">
      O√π souhaitez-vous importer cette base ?
    </p>
    
    <div class="grid grid-cols-1 gap-3 mb-6">
      <button onclick="confirmImport('default')" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition flex items-center justify-center shadow-md">
        <i class="fas fa-mobile-alt mr-2"></i>
        Base Par D√©faut (√©crase)
      </button>
      
      <button onclick="confirmImport('server')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center shadow-md">
        <i class="fas fa-cloud mr-2"></i>
        Base Serveur (√©crase)
      </button>
    </div>
    
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
      <p class="text-xs text-yellow-800">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        <strong>Attention :</strong> La base actuelle sera sauvegard√©e automatiquement avant l'√©crasement.
      </p>
    </div>
    
    <button onclick="cancelImport()" class="w-full bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition">
      Annuler
    </button>
  </div>
</div> 
</body>
</html>

   
