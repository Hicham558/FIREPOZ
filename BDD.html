<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Base de Données - FirePoz</title>
<script type="module" src="db.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.toast-in { animation: toastIn 0.5s both; }
.toast-out { animation: toastOut 0.5s both; }
@keyframes toastIn { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
@keyframes toastOut { from { opacity:1; transform:translateY(0);} to { opacity:0; transform:translateY(40px);} }
</style>
</head>
<body class="bg-gray-100 min-h-screen">
<nav class="bg-indigo-600 text-white p-4 shadow-md">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-2xl font-bold"><i class="fas fa-database mr-2"></i>Gestion Base de Données</h1>
    <button onclick="goHome()" class="bg-white text-indigo-600 px-4 py-2 rounded-md hover:bg-gray-200"><i class="fas fa-home mr-2"></i>Accueil</button>
  </div>
</nav>

<div class="container mx-auto px-4 py-8">
  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-database mr-2 text-indigo-500"></i>Outils Base de Données</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <button onclick="downloadDatabase()" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 transition"><i class="fas fa-file-download mr-2"></i>Télécharger gestion.db</button>
      <button onclick="resetCurrentDatabase()" class="w-full bg-red-600 text-white px-4 py-3 rounded-md hover:bg-red-700 transition"><i class="fas fa-trash mr-2"></i>Réinitialiser la Base</button>
      <label class="w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 transition text-center cursor-pointer">
        <i class="fas fa-upload mr-2"></i>Charger depuis fichier
        <input type="file" id="uploadDb" accept=".db,.sqlite,.sqlite3" class="hidden" onchange="uploadDatabase(event)">
      </label>
      <button onclick="createNewDatabase()" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 transition"><i class="fas fa-plus-circle mr-2"></i>Nouvelle Base (vierge)</button>
      <button onclick="updateFromServer()" class="w-full bg-yellow-600 text-white px-4 py-3 rounded-md hover:bg-yellow-700 transition"><i class="fas fa-cloud-download-alt mr-2"></i>Mettre à jour depuis serveur</button>
    </div>
    <div class="mt-4 text-sm text-gray-600">
      <p><i class="fas fa-info-circle mr-2"></i>La base de production est stockée dans IndexedDB</p>
      <p id="dbSize" class="mt-2">Taille: Calcul en cours...</p>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-archive mr-2 text-indigo-500"></i>Bases Sauvegardées</h2>
    <ul id="dbList" class="space-y-3"></ul>
  </div>
</div>

<div id="toast" class="fixed bottom-4 right-4 hidden">
  <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
    <i id="toastIcon" class="mr-2"></i>
    <span id="toastMessage"></span>
  </div>
</div>

<script type="module">
import { getDb, saveDbToStorage, resetDatabase, getDbSize } from './db.js';

let activeKey = null;

function showToast(msg, err=false){
  const t = document.getElementById("toast");
  const ti = document.getElementById("toastIcon");
  const tm = document.getElementById("toastMessage");
  t.className = err?"fixed bottom-4 right-4 flex items-center bg-red-500 text-white px-6 py-3 rounded-md shadow-lg toast-in":"fixed bottom-4 right-4 flex items-center bg-green-500 text-white px-6 py-3 rounded-md shadow-lg toast-in";
  ti.className = err?"fas fa-exclamation-circle mr-2":"fas fa-check-circle mr-2";
  tm.textContent = msg;
  t.classList.remove("hidden");
  setTimeout(()=>{t.classList.remove("toast-in");t.classList.add("toast-out"); setTimeout(()=>t.classList.add("hidden"),500)},3000);
}

function getDbList(){ return JSON.parse(localStorage.getItem("gestion_db_list")||"[]"); }
function saveDbList(list){ localStorage.setItem("gestion_db_list", JSON.stringify(list)); }
function getActiveIndex(){ return parseInt(localStorage.getItem("gestion_db_active")||"-1"); }
function setActiveIndex(idx){ localStorage.setItem("gestion_db_active", idx); }

async function setActiveDb(base64, key){
  activeKey = key;
  localStorage.setItem(key, base64);
  await saveDbToStorage(await getDb(), key);
}

async function createNewDatabase(){
  const response = await fetch("gestion.db");
  const buffer = await response.arrayBuffer();
  const bytes = new Uint8Array(buffer);
  let binary="";
  for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]);
  const base64 = btoa(binary);
  let list = getDbList();
  const newId = "db_"+Date.now();
  list.push({id:newId,name:`NouvelleBase_${list.length+1}`,data:base64});
  saveDbList(list);
  await setActiveDb(base64,newId);
  setActiveIndex(list.length-1);
  showToast("Nouvelle base vierge ajoutée et sélectionnée");
  renderDbList();
  updateDBSize();
}

function goHome(){ window.location.href="index.html"; }
async function resetCurrentDatabase(){ if(activeKey){ await resetDatabase(activeKey); updateDBSize(); renderDbList(); } }
async function updateDBSize(){ const size = await getDbSize(activeKey||"db"); document.getElementById("dbSize").textContent=`Taille: ${(size/1024/1024).toFixed(2)} MB`; }
function renderDbList(){
  const list = getDbList(); const active=getActiveIndex();
  const ul=document.getElementById("dbList"); ul.innerHTML="";
  list.forEach((db,idx)=>{
    const li=document.createElement("li");
    li.className="flex items-center justify-between border rounded p-3";
    li.innerHTML=`
      <div class="flex items-center space-x-3">
        <input type="radio" name="activeDb" ${idx===active?"checked":""} onchange="selectDatabase(${idx})">
        <span class="font-medium">${db.name}</span>
      </div>
      <div class="space-x-2">
        <button onclick="renameDatabase(${idx})" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600"><i class="fas fa-edit"></i></button>
        <button onclick="deleteDatabase(${idx})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
      </div>`;
    ul.appendChild(li);
  });
}

// ===== Sélection / Suppression / renommage =====
window.selectDatabase=async function(idx){
  let list=getDbList(); const dbData=list[idx];
  if(!dbData) return;
  activeKey=dbData.id;
  localStorage.setItem(activeKey,dbData.data);
  setActiveIndex(idx);
  showToast(`"${dbData.name}" sélectionnée`);
  updateDBSize();
  renderDbList();
};
window.renameDatabase=function(idx){
  let list=getDbList();
  const newName=prompt("Nouveau nom:",list[idx].name);
  if(newName){ list[idx].name=newName; saveDbList(list); renderDbList(); }
};
window.deleteDatabase=function(idx){
  if(!confirm("Supprimer cette base ?")) return;
  let list=getDbList(); const db=list[idx];
  list.splice(idx,1);
  saveDbList(list);
  if(idx===getActiveIndex()) activeKey=null;
  renderDbList();
  updateDBSize();
};

// ===== Fichier / téléchargement / serveur =====
async function downloadDatabase(){
  if(!activeKey) return showToast("Aucune base active",true);
  const dbData = localStorage.getItem(activeKey); if(!dbData) return showToast("Aucune base trouvée",true);
  const bytes = Uint8Array.from(atob(dbData),c=>c.charCodeAt(0));
  const blob=new Blob([bytes],{type:'application/octet-stream'});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="gestion.db"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  showToast("Base téléchargée");
}

function uploadDatabase(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=async function(ev){
    const bytes=new Uint8Array(ev.target.result); let binary=""; for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]);
    const base64=btoa(binary);
    let list=getDbList(); const newId="db_"+Date.now();
    list.push({id:newId,name:file.name,data:base64});
    saveDbList(list); setActiveIndex(list.length-1);
    await setActiveDb(base64,newId);
    showToast("Nouvelle base importée");
    renderDbList(); updateDBSize();
  };
  reader.readAsArrayBuffer(file);
}

async function updateFromServer(){
  try{
    const API_BASE_URL=localStorage.getItem('apiBaseUrl')||'https://hicham03041979.onrender.com';
    const res=await fetch(`${API_BASE_URL}/export`);
    if(!res.ok) throw new Error("Erreur HTTP "+res.status);
    const data=await res.json(); const base64Db=data.db; let list=getDbList();
    const newId="db_"+Date.now(); list.push({id:newId,name:`BaseServeur_${list.length+1}`,data:base64Db});
    saveDbList(list); setActiveIndex(list.length-1);
    await setActiveDb(base64Db,newId); renderDbList(); updateDBSize();
    showToast("✅ Base mise à jour et sélectionnée");
  }catch(err){ console.error(err); showToast("❌ "+err.message,true); }
}

document.addEventListener("DOMContentLoaded",()=>{
  renderDbList();
  updateDBSize();
});
</script>
</body>
</html>
