<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion Base de Donn√©es - FirePoz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold mb-4">Gestion Base de Donn√©es - FirePoz</h1>

    <div class="space-y-4">
      <button onclick="downloadDatabase()" class="w-full bg-blue-500 text-white p-2 rounded">üì• T√©l√©charger la Base</button>
      <input type="file" id="uploadDb" class="w-full border p-2 rounded" onchange="uploadDatabase(event)">
      <button onclick="resetDatabase()" class="w-full bg-red-500 text-white p-2 rounded">‚ôªÔ∏è R√©initialiser la Base</button>
      <button onclick="createNewDatabase()" class="w-full bg-green-500 text-white p-2 rounded">‚ûï Cr√©er Nouvelle Base</button>
      <button onclick="updateFromServer()" class="w-full bg-purple-500 text-white p-2 rounded">üîÑ Mise √† jour depuis Serveur</button>
    </div>

    <h2 class="text-xl font-semibold mt-6 mb-2">Bases disponibles :</h2>
    <ul id="dbList" class="list-disc pl-5 space-y-1"></ul>
  </div>

  <script type="module">
    import { getDb, saveDbToLocalStorage, importDb, exportDb, resetDatabase as resetDb } from './db.js';

    // T√©l√©charger la base
    async function downloadDatabase() {
      const db = await getDb();
      const binaryArray = await exportDb(db);
      const blob = new Blob([binaryArray], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "database.sqlite";
      a.click();
      URL.revokeObjectURL(url);
    }

    // R√©initialiser la base
    async function resetDatabase() {
      if (!confirm("Voulez-vous vraiment r√©initialiser la base ?")) return;
      await resetDb();
      alert("Base r√©initialis√©e !");
      refreshDbList();
    }

    // Importer une base depuis fichier
    async function uploadDatabase(event) {
      const file = event.target.files[0];
      if (!file) return;
      const buffer = await file.arrayBuffer();
      await importDb(new Uint8Array(buffer));
      alert("Base import√©e !");
      refreshDbList();
    }

    // Cr√©er une nouvelle base vide
    async function createNewDatabase() {
      const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
      const db = new SQL.Database();
      await saveDbToLocalStorage(db);
      alert("Nouvelle base cr√©√©e !");
      refreshDbList();
    }

    // Mise √† jour depuis serveur (exemple)
    async function updateFromServer() {
      try {
        const response = await fetch('/db-update');
        if (!response.ok) throw new Error("Erreur serveur");
        const arrayBuffer = await response.arrayBuffer();
        await importDb(new Uint8Array(arrayBuffer));
        alert("Base mise √† jour depuis serveur !");
        refreshDbList();
      } catch (e) {
        console.error(e);
        alert("√âchec de la mise √† jour !");
      }
    }

    // Afficher la liste des bases (IndexedDB ou LocalStorage fallback)
    async function refreshDbList() {
      const db = await getDb();
      const data = await exportDb(db);
      const sizeKb = (data.byteLength / 1024).toFixed(2);

      const dbList = document.getElementById("dbList");
      dbList.innerHTML = `<li>Base active : ${sizeKb} KB</li>`;
    }

    // Charger la liste au d√©marrage
    refreshDbList();

    // Rendre dispo dans window pour les boutons inline
    window.downloadDatabase = downloadDatabase;
    window.resetDatabase = resetDatabase;
    window.uploadDatabase = uploadDatabase;
    window.createNewDatabase = createNewDatabase;
    window.updateFromServer = updateFromServer;
  </script>
</body>
</html>
