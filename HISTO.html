<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Versements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-center">Gestion des Versements et Réceptions</h1>

        <!-- Filtre Utilisateur -->
        <div class="mb-6">
            <label for="utilisateur" class="block text-lg font-medium">Filtrer par Utilisateur:</label>
            <select id="utilisateur" class="mt-2 p-2 border rounded w-full md:w-1/3">
                <option value="0">Tous les utilisateurs</option>
                <!-- Options remplies via JS -->
            </select>
        </div>

        <!-- Onglets Clients/Fournisseurs -->
        <div class="tabs mb-6">
            <button id="tab-clients" class="px-4 py-2 bg-blue-500 text-white rounded-l-lg">Clients</button>
            <button id="tab-fournisseurs" class="px-4 py-2 bg-gray-300 text-black rounded-r-lg">Fournisseurs</button>
        </div>

        <!-- Section Clients -->
        <div id="section-clients" class="section">
            <h2 class="text-2xl font-semibold mb-4">Versements Clients</h2>

            <!-- Formulaire Versement Client -->
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-medium mb-4">Ajouter un Versement Client</h3>
                <form id="form-versement-client">
                    <div class="mb-4">
                        <label for="client" class="block">Client:</label>
                        <select id="client" name="numero_cf" class="w-full p-2 border rounded" required>
                            <option value="">Sélectionner un client</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="montant-client" class="block">Montant:</label>
                        <input type="number" id="montant-client" name="montant" step="0.01" class="w-full p-2 border rounded" required>
                    </div>
                    <div class="mb-4">
                        <label for="justificatif-client" class="block">Justificatif:</label>
                        <input type="text" id="justificatif-client" name="justificatif" class="w-full p-2 border rounded">
                    </div>
                    <div class="mb-4">
                        <label for="numero-util-client" class="block">Utilisateur:</label>
                        <select id="numero-util-client" name="numero_util" class="w-full p-2 border rounded" required>
                            <option value="">Sélectionner un utilisateur</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Ajouter Versement</button>
                </form>
                <p id="message-client" class="mt-2"></p>
            </div>

            <!-- Historique Clients -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-medium mb-4">Historique des Versements Clients</h3>
                <div class="mb-4">
                    <label for="date-client" class="block">Date:</label>
                    <input type="date" id="date-client" class="p-2 border rounded">
                </div>
                <div id="historique-clients"></div>
                <div id="pagination-clients" class="mt-4"></div>
            </div>
        </div>

        <!-- Section Fournisseurs -->
        <div id="section-fournisseurs" class="section hidden">
            <h2 class="text-2xl font-semibold mb-4">Versements et Réceptions Fournisseurs</h2>

            <!-- Formulaire Versement Fournisseur -->
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-medium mb-4">Ajouter un Versement Fournisseur</h3>
                <form id="form-versement-fournisseur">
                    <div class="mb-4">
                        <label for="fournisseur" class="block">Fournisseur:</label>
                        <select id="fournisseur" name="numero_cf" class="w-full p-2 border rounded" required>
                            <option value="">Sélectionner un fournisseur</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="montant-fournisseur" class="block">Montant:</label>
                        <input type="number" id="montant-fournisseur" name="montant" step="0.01" class="w-full p-2 border rounded" required>
                    </div>
                    <div class="mb-4">
                        <label for="justificatif-fournisseur" class="block">Justificatif:</label>
                        <input type="text" id="justificatif-fournisseur" name="justificatif" class="w-full p-2 border rounded">
                    </div>
                    <div class="mb-4">
                        <label for="numero-util-fournisseur" class="block">Utilisateur:</label>
                        <select id="numero-util-fournisseur" name="numero_util" class="w-full p-2 border rounded" required>
                            <option value="">Sélectionner un utilisateur</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Ajouter Versement</button>
                </form>
                <p id="message-fournisseur" class="mt-2"></p>
            </div>

            <!-- Formulaire Achat Fournisseur -->
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-medium mb-4">Traiter un Achat Fournisseur</h3>
                <form id="form-achat-fournisseur">
                    <div class="mb-4">
                        <label for="fournisseur-achat" class="block">Fournisseur:</label>
                        <select id="fournisseur-achat" name="numero_fou" class="w-full p-2 border rounded" required>
                            <option value="">Sélectionner un fournisseur</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="total-cost" class="block">Coût Total:</label>
                        <input type="number" id="total-cost" name="total_cost" step="0.01" class="w-full p-2 border rounded" required>
                    </div>
                    <div class="mb-4">
                        <label for="justificatif-achat" class="block">Justificatif:</label>
                        <input type="text" id="justificatif-achat" name="justificatif" class="w-full p-2 border rounded">
                    </div>
                    <div class="mb-4">
                        <label for="numero-util-achat" class="block">Utilisateur (optionnel):</label>
                        <select id="numero-util-achat" name="numero_util" class="w-full p-2 border rounded">
                            <option value="">Aucun</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Traiter Achat</button>
                </form>
                <p id="message-achat" class="mt-2"></p>
            </div>

            <!-- Formulaire Réception Fournisseur -->
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-medium mb-4">Valider une Réception Fournisseur</h3>
                <form id="form-reception-fournisseur">
                    <div class="mb-4">
                        <label for="fournisseur-reception" class="block">Fournisseur:</label>
                        <select id="fournisseur-reception" name="numero_four" class="w-full p-2 border rounded" required>
                            <option value="">Sélectionner un fournisseur</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="numero-util-reception" class="block">Utilisateur:</label>
                        <select id="numero-util-reception" name="numero_util" class="w-full p-2 border rounded" required>
                            <option value="">Sélectionner un utilisateur</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="password2" class="block">Mot de passe:</label>
                        <input type="password" id="password2" name="password2" class="w-full p-2 border rounded" required>
                    </div>
                    <div id="lignes-reception" class="mb-4">
                        <h4 class="font-medium mb-2">Articles:</h4>
                        <div class="ligne-reception mb-2">
                            <select name="numero_item" class="p-2 border rounded w-1/3" required>
                                <option value="">Article</option>
                            </select>
                            <input type="number" name="qtea" placeholder="Quantité" step="0.01" class="p-2 border rounded w-1/4 mx-2" required>
                            <input type="number" name="prixbh" placeholder="Prix d'achat" step="0.01" class="p-2 border rounded w-1/4" required>
                            <button type="button" class="remove-ligne bg-red-500 text-white px-2 py-1 rounded">Supprimer</button>
                        </div>
                    </div>
                    <button type="button" id="add-ligne" class="bg-green-500 text-white px-4 py-2 rounded mb-4">Ajouter Article</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Valider Réception</button>
                </form>
                <p id="message-reception" class="mt-2"></p>
            </div>

            <!-- Historique Fournisseurs -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-medium mb-4">Historique des Versements et Réceptions Fournisseurs</h3>
                <div class="mb-4">
                    <label for="date-fournisseur" class="block">Date:</label>
                    <input type="date" id="date-fournisseur" class="p-2 border rounded">
                </div>
                <div id="historique-fournisseurs"></div>
                <div id="pagination-fournisseurs" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://your-api-url.com'; // Remplacer par l'URL de ton API
        const USER_ID = 'your-user-id'; // Remplacer par l'ID utilisateur réel

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page chargée, initialisation...');
            chargerUtilisateurs();
            chargerClients();
            chargerFournisseurs();
            chargerProduits();
            chargerHistorique('C', 1);
            chargerHistorique('F', 1);

            // Gestion des onglets
            document.getElementById('tab-clients').addEventListener('click', () => {
                console.log('Onglet Clients sélectionné');
                document.getElementById('section-clients').classList.remove('hidden');
                document.getElementById('section-fournisseurs').classList.add('hidden');
                document.getElementById('tab-clients').classList.add('bg-blue-500', 'text-white');
                document.getElementById('tab-fournisseurs').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('tab-fournisseurs').classList.add('bg-gray-300', 'text-black');
            });
            document.getElementById('tab-fournisseurs').addEventListener('click', () => {
                console.log('Onglet Fournisseurs sélectionné');
                document.getElementById('section-fournisseurs').classList.remove('hidden');
                document.getElementById('section-clients').classList.add('hidden');
                document.getElementById('tab-fournisseurs').classList.add('bg-blue-500', 'text-white');
                document.getElementById('tab-clients').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('tab-clients').classList.add('bg-gray-300', 'text-black');
            });

            // Gestion des formulaires
            document.getElementById('form-versement-client').addEventListener('submit', (e) => handleVersement(e, 'C'));
            document.getElementById('form-versement-fournisseur').addEventListener('submit', (e) => handleVersement(e, 'F'));
            document.getElementById('form-achat-fournisseur').addEventListener('submit', handleAchat);
            document.getElementById('form-reception-fournisseur').addEventListener('submit', handleReception);

            // Gestion des filtres
            document.getElementById('utilisateur').addEventListener('change', () => {
                console.log('Filtre utilisateur changé:', document.getElementById('utilisateur').value);
                chargerHistorique('C', 1);
                chargerHistorique('F', 1);
            });
            document.getElementById('date-client').addEventListener('change', () => {
                console.log('Date client changée:', document.getElementById('date-client').value);
                chargerHistorique('C', 1);
            });
            document.getElementById('date-fournisseur').addEventListener('change', () => {
                console.log('Date fournisseur changée:', document.getElementById('date-fournisseur').value);
                chargerHistorique('F', 1);
            });

            // Gestion des lignes de réception
            document.getElementById('add-ligne').addEventListener('click', addLigneReception);
            document.querySelectorAll('.remove-ligne').forEach(btn => {
                btn.addEventListener('click', (e) => e.target.closest('.ligne-reception').remove());
            });
        });

        // Charger les utilisateurs
        async function chargerUtilisateurs() {
            try {
                console.log('Chargement des utilisateurs...');
                const response = await fetch(`${API_URL}/liste_utilisateurs`, {
                    headers: { 'X-User-ID': USER_ID }
                });
                if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
                const utilisateurs = await response.json();
                console.log('Utilisateurs chargés:', utilisateurs);
                const selects = [
                    document.getElementById('numero-util-client'),
                    document.getElementById('numero-util-fournisseur'),
                    document.getElementById('numero-util-achat'),
                    document.getElementById('numero-util-reception'),
                    document.getElementById('utilisateur')
                ];
                selects.forEach(select => {
                    utilisateurs.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.numero_util;
                        option.textContent = u.nom;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
            }
        }

        // Charger les clients
        async function chargerClients() {
            try {
                console.log('Chargement des clients...');
                const response = await fetch(`${API_URL}/liste_clients`, {
                    headers: { 'X-User-ID': USER_ID }
                });
                if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
                const clients = await response.json();
                console.log('Clients chargés:', clients);
                const select = document.getElementById('client');
                clients.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.numero_clt;
                    option.textContent = c.nom;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement clients:', error);
            }
        }

        // Charger les fournisseurs
        async function chargerFournisseurs() {
            try {
                console.log('Chargement des fournisseurs...');
                const response = await fetch(`${API_URL}/liste_fournisseurs`, {
                    headers: { 'X-User-ID': USER_ID }
                });
                if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
                const fournisseurs = await response.json();
                console.log('Fournisseurs chargés:', fournisseurs);
                const selects = [
                    document.getElementById('fournisseur'),
                    document.getElementById('fournisseur-achat'),
                    document.getElementById('fournisseur-reception')
                ];
                selects.forEach(select => {
                    fournisseurs.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.numero_fou;
                        option.textContent = f.nom;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Erreur chargement fournisseurs:', error);
            }
        }

        // Charger les produits pour réception
        async function chargerProduits() {
            try {
                console.log('Chargement des produits...');
                const response = await fetch(`${API_URL}/liste_produits`, {
                    headers: { 'X-User-ID': USER_ID }
                });
                if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
                const produits = await response.json();
                console.log('Produits chargés:', produits);
                const select = document.querySelector('.ligne-reception select[name="numero_item"]');
                produits.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.NUMERO_ITEM;
                    option.textContent = p.DESIGNATION;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement produits:', error);
            }
        }

        // Ajouter une ligne de réception
        function addLigneReception() {
            console.log('Ajout d\'une ligne de réception');
            const container = document.getElementById('lignes-reception');
            const ligne = document.createElement('div');
            ligne.className = 'ligne-reception mb-2';
            ligne.innerHTML = `
                <select name="numero_item" class="p-2 border rounded w-1/3" required>
                    <option value="">Article</option>
                    ${document.querySelector('.ligne-reception select[name="numero_item"]').innerHTML}
                </select>
                <input type="number" name="qtea" placeholder="Quantité" step="0.01" class="p-2 border rounded w-1/4 mx-2" required>
                <input type="number" name="prixbh" placeholder="Prix d'achat" step="0.01" class="p-2 border rounded w-1/4" required>
                <button type="button" class="remove-ligne bg-red-500 text-white px-2 py-1 rounded">Supprimer</button>
            `;
            container.appendChild(ligne);
            ligne.querySelector('.remove-ligne').addEventListener('click', () => {
                console.log('Suppression d\'une ligne de réception');
                ligne.remove();
            });
        }

        // Gérer les versements
        async function handleVersement(e, type) {
            e.preventDefault();
            console.log(`Soumission versement type ${type}`);
            const form = e.target;
            const message = document.getElementById(`message-${type === 'C' ? 'client' : 'fournisseur'}`);
            const data = {
                type,
                numero_cf: form.numero_cf.value,
                montant: form.montant.value,
                justificatif: form.justificatif.value,
                numero_util: form.numero_util.value
            };
            console.log('Données versement:', data);

            try {
                const response = await fetch(`${API_URL}/ajouter_versement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': USER_ID
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                console.log('Réponse /ajouter_versement:', result);
                if (response.ok) {
                    message.className = 'success';
                    message.textContent = `Versement ajouté (ID: ${result.numero_mc})`;
                    form.reset();
                    chargerHistorique(type, 1);
                } else {
                    message.className = 'error';
                    message.textContent = result.erreur || 'Erreur lors de l\'ajout';
                }
            } catch (error) {
                console.error('Erreur réseau versement:', error);
                message.className = 'error';
                message.textContent = 'Erreur réseau';
            }
        }

        // Gérer les achats
        async function handleAchat(e) {
            e.preventDefault();
            console.log('Soumission achat');
            const form = e.target;
            const message = document.getElementById('message-achat');
            const data = {
                numero_fou: form.numero_fou.value,
                total_cost: form.total_cost.value,
                justificatif: form.justificatif.value,
                numero_util: form.numero_util.value || null
            };
            console.log('Données achat:', data);

            try {
                const response = await fetch(`${API_URL}/process_purchase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': USER_ID
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                console.log('Réponse /process_purchase:', result);
                if (response.ok) {
                    message.className = 'success';
                    message.textContent = `Achat traité (Nouveau solde: ${result.nouveau_solde})`;
                    form.reset();
                    chargerHistorique('F', 1);
                } else {
                    message.className = 'error';
                    message.textContent = result.erreur || 'Erreur lors du traitement';
                }
            } catch (error) {
                console.error('Erreur réseau achat:', error);
                message.className = 'error';
                message.textContent = 'Erreur réseau';
            }
        }

        // Gérer les réceptions
        async function handleReception(e) {
            e.preventDefault();
            console.log('Soumission réception');
            const form = e.target;
            const message = document.getElementById('message-reception');
            const lignes = Array.from(document.querySelectorAll('.ligne-reception')).map(ligne => ({
                numero_item: ligne.querySelector('[name="numero_item"]').value,
                qtea: ligne.querySelector('[name="qtea"]').value,
                prixbh: ligne.querySelector('[name="prixbh"]').value
            }));
            const data = {
                numero_four: form.numero_four.value,
                numero_util: form.numero_util.value,
                password2: form.password2.value,
                lignes
            };
            console.log('Données réception:', data);

            try {
                const response = await fetch(`${API_URL}/valider_reception`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': USER_ID
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                console.log('Réponse /valider_reception:', result);
                if (response.ok) {
                    message.className = 'success';
                    message.textContent = `Réception validée (ID: ${result.numero_mouvement})`;
                    form.reset();
                    document.getElementById('lignes-reception').innerHTML = `
                        <h4 class="font-medium mb-2">Articles:</h4>
                        <div class="ligne-reception mb-2">
                            <select name="numero_item" class="p-2 border rounded w-1/3" required>
                                <option value="">Article</option>
                            </select>
                            <input type="number" name="qtea" placeholder="Quantité" step="0.01" class="p-2 border rounded w-1/4 mx-2" required>
                            <input type="number" name="prixbh" placeholder="Prix d'achat" step="0.01" class="p-2 border rounded w-1/4" required>
                            <button type="button" class="remove-ligne bg-red-500 text-white px-2 py-1 rounded">Supprimer</button>
                        </div>
                    `;
                    chargerProduits();
                    chargerHistorique('F', 1);
                } else {
                    message.className = 'error';
                    message.textContent = result.error || 'Erreur lors de la validation';
                }
            } catch (error) {
                console.error('Erreur réseau réception:', error);
                message.className = 'error';
                message.textContent = 'Erreur réseau';
            }
        }

        // Charger l'historique
        async function chargerHistorique(type, page) {
            console.log(`Chargement historique type ${type}, page ${page}`);
            const date = document.getElementById(`date-${type === 'C' ? 'client' : 'fournisseur'}`).value;
            const utilisateur = document.getElementById('utilisateur').value;
            const container = document.getElementById(`historique-${type === 'C' ? 'clients' : 'fournisseurs'}`);
            const pagination = document.getElementById(`pagination-${type === 'C' ? 'clients' : 'fournisseurs'}`);
            let url = `${API_URL}/historique_versements?page=${page}&per_page=10&type=${type}`;
            if (date) url += `&date=${date}`;
            if (utilisateur !== '0') url += `&numero_util=${utilisateur}`;
            console.log('URL historique:', url);

            try {
                const response = await fetch(url, {
                    headers: { 'X-User-ID': USER_ID }
                });
                if (!response.ok) throw new Error(`Erreur ${response.status}: ${await response.text()}`);
                const data = await response.json();
                console.log('Données historique:', data);
                container.innerHTML = `
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border p-2">Date</th>
                                <th class="border p-2">Nom</th>
                                <th class="border p-2">Montant</th>
                                <th class="border p-2">Justificatif</th>
                                <th class="border p-2">Utilisateur</th>
                                <th class="border p-2">Origine</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.versements.map(v => `
                                <tr>
                                    <td class="border p-2">${new Date(v.date_mc).toLocaleDateString()}</td>
                                    <td class="border p-2">${v.nom}</td>
                                    <td class="border p-2">${v.montant}</td>
                                    <td class="border p-2">${v.justificatif}</td>
                                    <td class="border p-2">${v.utilisateur_nom}</td>
                                    <td class="border p-2">${v.origine}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                pagination.innerHTML = `
                    <div class="flex justify-between">
                        <button class="px-4 py-2 bg-blue-500 text-white rounded ${page === 1 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                ${page === 1 ? 'disabled' : ''} 
                                onclick="chargerHistorique('${type}', ${page - 1})">Précédent</button>
                        <span>Page ${data.page} / ${data.total_pages}</span>
                        <button class="px-4 py-2 bg-blue-500 text-white rounded ${page >= data.total_pages ? 'opacity-50 cursor-not-allowed' : ''}" 
                                ${page >= data.total_pages ? 'disabled' : ''} 
                                onclick="chargerHistorique('${type}', ${page + 1})">Suivant</button>
                    </div>
                `;
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                container.innerHTML = `<p class="error">Erreur lors du chargement de l'historique: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
