<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Versements</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Gestion des Versements</h1>

        <!-- Message d'erreur global -->
        <p id="global-error" class="text-red-600 hidden mb-4"></p>

        <!-- Onglets -->
        <div class="mb-4">
            <ul class="flex border-b">
                <li class="mr-1">
                    <button id="tab-clients" class="bg-white inline-block py-2 px-4 text-blue-600 font-semibold border-b-2 border-blue-600">Clients</button>
                </li>
                <li class="mr-1">
                    <button id="tab-fournisseurs" class="bg-white inline-block py-2 px-4 text-gray-600 font-semibold">Fournisseurs</button>
                </li>
            </ul>
        </div>

        <!-- Formulaire Versement -->
        <div class="bg-white p-4 rounded shadow mb-4">
            <h2 id="form-title" class="text-xl font-semibold mb-4">Ajouter un Versement (Client)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium">Client/Fournisseur</label>
                    <select id="numero_cf" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">Chargement...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Montant (positif/négatif)</label>
                    <input type="number" id="montant" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ex: 100.00 ou -100.00">
                </div>
                <div>
                    <label class="block text-sm font-medium">Justificatif</label>
                    <input type="text" id="justificatif" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ex: Paiement facture">
                </div>
                <div>
                    <label class="block text-sm font-medium">Utilisateur</label>
                    <select id="numero_util" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">Chargement...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium">Mot de passe</label>
                    <input type="password" id="password2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
            <button id="submit-versement" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Ajouter Versement</button>
            <p id="form-message" class="mt-2 text-red-600 hidden"></p>
        </div>

        <!-- Historique -->
        <div class="bg-white p-4 rounded shadow">
            <h2 class="text-xl font-semibold mb-4">Historique des Versements</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium">Filtrer par date</label>
                <input type="date" id="filter-date" class="mt-1 block w-full md:w-1/4 border-gray-300 rounded-md shadow-sm">
            </div>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2">Date</th>
                        <th class="p-2">Type</th>
                        <th class="p-2">Nom</th>
                        <th class="p-2">Montant</th>
                        <th class="p-2">Justificatif</th>
                        <th class="p-2">Fait par</th>
                    </tr>
                </thead>
                <tbody id="versements-table"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://your-api-url.com'; // Remplacer par l'URL de ton API (ex: https://your-railway-app.up.railway.app)
        const USER_ID = 'your-user-id'; // Remplacer par ton user_id réel

        // Afficher les erreurs globales
        function showGlobalError(message) {
            const error = document.getElementById('global-error');
            error.textContent = message;
            error.classList.remove('hidden');
        }

        // Charger les clients, fournisseurs et utilisateurs
        async function loadData() {
            try {
                const [clientsRes, fournisseursRes, utilisateursRes] = await Promise.all([
                    fetch(`${API_URL}/liste_clients`, {
                        headers: { 'X-User-ID': USER_ID }
                    }).then(res => {
                        console.log('Réponse /liste_clients:', res.status, res.statusText);
                        return res;
                    }),
                    fetch(`${API_URL}/liste_fournisseurs`, {
                        headers: { 'X-User-ID': USER_ID }
                    }).then(res => {
                        console.log('Réponse /liste_fournisseurs:', res.status, res.statusText);
                        return res;
                    }),
                    fetch(`${API_URL}/liste_utilisateurs`).then(res => {
                        console.log('Réponse /liste_utilisateurs:', res.status, res.statusText);
                        return res;
                    })
                ]);

                if (!clientsRes.ok) throw new Error(`Erreur clients: ${clientsRes.statusText}`);
                if (!fournisseursRes.ok) throw new Error(`Erreur fournisseurs: ${fournisseursRes.statusText}`);
                if (!utilisateursRes.ok) throw new Error(`Erreur utilisateurs: ${utilisateursRes.statusText}`);

                const clients = await clientsRes.json();
                const fournisseurs = await fournisseursRes.json();
                const utilisateurs = await utilisateursRes.json();

                const clientSelect = document.getElementById('numero_cf');
                clientSelect.innerHTML = '<option value="">Sélectionner...</option>';
                clients.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.numero_clt;
                    option.textContent = `${c.nom} (Solde: ${c.solde})`;
                    clientSelect.appendChild(option);
                });

                const utilisateurSelect = document.getElementById('numero_util');
                utilisateurSelect.innerHTML = '<option value="">Sélectionner...</option>';
                utilisateurs.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.numero_util;
                    option.textContent = u.nom;
                    utilisateurSelect.appendChild(option);
                });

                window.fournisseurs = fournisseurs;
                console.log('Données chargées:', clients.length, 'clients,', fournisseurs.length, 'fournisseurs,', utilisateurs.length, 'utilisateurs');
            } catch (error) {
                console.error('Erreur chargement données:', error);
                showGlobalError(`Erreur de chargement des données: ${error.message}. Vérifiez l'URL de l'API et l'ID utilisateur.`);
            }
        }

        // Charger l'historique des versements
        async function loadHistorique(date = '', type = 'C') {
            try {
                let url = `${API_URL}/historique_versements?type=${type}`;
                if (date) url += `&date=${date}`;
                const res = await fetch(url, {
                    headers: { 'X-User-ID': USER_ID }
                }).then(res => {
                    console.log('Réponse /historique_versements:', res.status, res.statusText);
                    return res;
                });
                if (!res.ok) throw new Error(`Erreur historique: ${res.statusText}`);
                const versements = await res.json();
                const tableBody = document.getElementById('versements-table');
                tableBody.innerHTML = '';
                versements.forEach(v => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${v.date_mc}</td>
                        <td class="p-2">${v.type}</td>
                        <td class="p-2">${v.nom_cf}</td>
                        <td class="p-2 ${parseFloat(v.montant) < 0 ? 'text-red-600' : 'text-green-600'}">${v.montant}</td>
                        <td class="p-2">${v.justificatif}</td>
                        <td class="p-2">${v.utilisateur_nom}</td>
                    `;
                    tableBody.appendChild(row);
                });
                console.log('Historique chargé:', versements.length, 'versements');
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                showGlobalError(`Erreur chargement historique: ${error.message}`);
            }
        }

        // Soumettre un versement
        async function submitVersement() {
            const type = document.getElementById('tab-clients').classList.contains('border-blue-600') ? 'C' : 'F';
            const numero_cf = document.getElementById('numero_cf').value;
            const montant = document.getElementById('montant').value;
            const justificatif = document.getElementById('justificatif').value;
            const numero_util = document.getElementById('numero_util').value;
            const password2 = document.getElementById('password2').value;
            const message = document.getElementById('form-message');

            if (!numero_cf || !montant || !numero_util || !password2) {
                message.textContent = 'Tous les champs obligatoires doivent être remplis';
                message.classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/ajouter_versement`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': USER_ID
                    },
                    body: JSON.stringify({ type, numero_cf, montant, justificatif, numero_util, password2 })
                }).then(res => {
                    console.log('Réponse /ajouter_versement:', res.status, res.statusText);
                    return res;
                });
                const data = await res.json();
                if (res.ok) {
                    message.textContent = 'Versement ajouté avec succès';
                    message.classList.remove('text-red-600', 'hidden');
                    message.classList.add('text-green-600');
                    document.getElementById('numero_cf').value = '';
                    document.getElementById('montant').value = '';
                    document.getElementById('justificatif').value = '';
                    document.getElementById('numero_util').value = '';
                    document.getElementById('password2').value = '';
                    loadHistorique(document.getElementById('filter-date').value, type);
                } else {
                    message.textContent = data.error || 'Erreur lors de l\'ajout';
                    message.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erreur ajout versement:', error);
                message.textContent = `Erreur réseau: ${error.message}`;
                message.classList.remove('hidden');
            }
        }

        // Gestion des onglets
        function switchTab(tab) {
            const clientTab = document.getElementById('tab-clients');
            const fournisseurTab = document.getElementById('tab-fournisseurs');
            const clientSelect = document.getElementById('numero_cf');
            const formTitle = document.getElementById('form-title');

            clientSelect.innerHTML = '<option value="">Sélectionner...</option>';
            if (tab === 'clients') {
                clientTab.classList.add('text-blue-600', 'border-blue-600');
                clientTab.classList.remove('text-gray-600');
                fournisseurTab.classList.remove('text-blue-600', 'border-blue-600');
                fournisseurTab.classList.add('text-gray-600');
                formTitle.textContent = 'Ajouter un Versement (Client)';
                fetch(`${API_URL}/liste_clients`, {
                    headers: { 'X-User: 'YOUR_USER_ID' }
                    }).then(res => res.json())
                    .then(clients => {
                        clients.forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.numero_clt;
                            option.textContent = `${c.nom} (Solde: ${c.solde})`;
                            clientSelect.appendChild(option);
                        });
                    }).catch(error => {
                        console.error('Erreur chargement clients:', error);
                        showGlobalError('Erreur chargement clients');
                    });
                loadHistorique(document.getElementById('filter-date').value, 'C');
            } else {
                fournisseurTab.classList.add('text-blue-600', 'border-blue-600');
                fournisseurTab.classList.remove('text-gray-600');
                clientTab.classList.remove('text-blue-600', 'border-blue-600');
                clientTab.classList.add('text-gray-600');
                formTitle.textContent = 'Ajouter un Versement (Fournisseur)';
                window.fournisseurs.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f.numero_fou;
                    option.textContent = `${f.nom} (Solde: ${f.solde})`;
                    clientSelect.appendChild(option);
                });
                loadHistorique(document.getElementById('filter-date').value, 'F');
            }
        }

        // Événements
        document.getElementById('tab-clients').addEventListener('click', () => switchTab('clients'));
        document.getElementById('tab-fournisseurs').addEventListener('click', () => switchTab('fournisseurs'));
        document.getElementById('submit-versement').addEventListener('click', submitVersement);
        document.getElementById('filter-date').addEventListener('change', (e) => {
            const type = document.getElementById('tab-clients').classList.contains('border-blue-600') ? 'C' : 'F';
            loadHistorique(e.target.value, type);
        });

        // Initialisation
        loadData();
        switchTab('clients');
    </script>
</body>
</html>
