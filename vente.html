<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vente - FIREPOZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Point de Vente</h1>

        <!-- Sélection du client ou comptoir -->
        <div class="mb-4">
            <label for="client" class="block text-sm font-medium text-gray-700">Client ou Comptoir</label>
            <select id="client" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                <option value="0">Comptoir</option>
                <!-- Les clients seront chargés via /liste_clients -->
            </select>
        </div>

        <!-- Sélection des articles -->
        <div class="mb-4">
            <label for="article" class="block text-sm font-medium text-gray-700">Article</label>
            <select id="article" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                <!-- Les articles seront chargés via /liste_produits -->
            </select>
        </div>

        <!-- Quantité -->
        <div class="mb-4">
            <label for="quantite" class="block text-sm font-medium text-gray-700">Quantité</label>
            <input type="number" id="quantite" min="1" value="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
        </div>

        <!-- Bouton Ajouter -->
        <button onclick="ajouterArticle()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Ajouter Article</button>

        <!-- Liste des articles ajoutés -->
        <div class="mt-4">
            <h2 class="text-lg font-medium">Articles Sélectionnés</h2>
            <table id="tableauArticles" class="min-w-full bg-white mt-2">
                <thead>
                    <tr>
                        <th class="px-4 py-2">Numéro Item</th>
                        <th class="px-4 py-2">Désignation</th>
                        <th class="px-4 py-2">Quantité</th>
                        <th class="px-4 py-2">Prix Total</th>
                        <th class="px-4 py-2">Remarque</th>
                        <th class="px-4 py-2">Prix BH</th>
                        <th class="px-4 py-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="listeArticles"></tbody>
            </table>
        </div>

        <!-- Bouton Valider -->
        <button onclick="validerVente()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mt-4">Valider Vente</button>
    </div>

    <script>
        let listeArticles = [];

        // Charger les clients
        async function chargerClients() {
            try {
                const response = await axios.get('https://web-production-3b9e.up.railway.app/liste_clients', {
                    headers: { 'X-User-ID': localStorage.getItem('userId') }
                });
                const clients = response.data;
                const clientSelect = document.getElementById('client');
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id_client; // Supposons que l'API renvoie id_client
                    option.textContent = client.nom_client;
                    clientSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement clients:', error);
            }
        }

        // Charger les articles
        async function chargerArticles() {
            try {
                const response = await axios.get('https://web-production-3b9e.up.railway.app/liste_produits', {
                    headers: { 'X-User-ID': localStorage.getItem('userId') }
                });
                const articles = response.data;
                const articleSelect = document.getElementById('article');
                articles.forEach(article => {
                    const option = document.createElement('option');
                    option.value = article.BAR; // Supposons que l'API renvoie BAR
                    option.textContent = `${article.DESIGNATION} (${article.PRIX} CFA)`;
                    option.dataset.article = JSON.stringify(article);
                    articleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement articles:', error);
            }
        }

        // Ajouter un article à la liste temporaire
        function ajouterArticle() {
            const articleSelect = document.getElementById('article');
            const quantiteInput = document.getElementById('quantite');
            const articleData = JSON.parse(articleSelect.selectedOptions[0].dataset.article);
            const quantite = parseInt(quantiteInput.value);

            const article = {
                numero_item: articleData.BAR, // Utiliser BAR comme numero_item
                designation: articleData.DESIGNATION,
                quantite: quantite,
                prixt: articleData.PRIX * quantite,
                remarque: (articleData.PRIX * quantite).toFixed(2),
                prixbh: articleData.PRIXBA * quantite
            };

            listeArticles.push(article);
            afficherArticles();
        }

        // Afficher la liste des articles
        function afficherArticles() {
            const tbody = document.getElementById('listeArticles');
            tbody.innerHTML = '';
            listeArticles.forEach((article, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="border px-4 py-2">${article.numero_item}</td>
                    <td class="border px-4 py-2">${article.designation}</td>
                    <td class="border px-4 py-2">${article.quantite}</td>
                    <td class="border px-4 py-2">${article.prixt.toFixed(2)}</td>
                    <td class="border px-4 py-2">${article.remarque}</td>
                    <td class="border px-4 py-2">${article.prixbh.toFixed(2)}</td>
                    <td class="border px-4 py-2">
                        <button onclick="supprimerArticle(${index})" class="text-red-500 hover:text-red-700">Supprimer</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Supprimer un article
        function supprimerArticle(index) {
            listeArticles.splice(index, 1);
            afficherArticles();
        }

        // Valider la vente
        async function validerVente() {
            const clientSelect = document.getElementById('client');
            const numero_table = parseInt(clientSelect.value);

            const vente = {
                numero_table: numero_table,
                date_comande: new Date().toISOString(),
                nature: "vente",
                lignes: listeArticles
            };

            try {
                const response = await axios.post('https://web-production-3b9e.up.railway.app/valider_vente', vente, {
                    headers: { 'X-User-ID': localStorage.getItem('userId') }
                });
                Toastify({
                    text: `Vente #${response.data.numero_comande} validée`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "green"
                }).showToast();
                listeArticles = [];
                afficherArticles();
            } catch (error) {
                console.error('Erreur validation vente:', error);
                Toastify({
                    text: `Erreur: ${error.response?.data?.error || 'Validation échouée'}`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "red"
                }).showToast();
            }
        }

        // Initialisation
        window.onload = () => {
            if (!localStorage.getItem('userId')) {
                window.location.href = '/login.html'; // Rediriger si non connecté
            }
            chargerClients();
            chargerArticles();
        };
    </script>
</body>
</html>
