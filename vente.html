// Fonction pour envoyer des données à l'imprimante
async function sendToPrinter(data) {
    if (!bluetoothCharacteristic) {
        throw new Error('Imprimante non connectée');
    }
    
    const encoded = encodeESCPOS(data);
    const chunkSize = 512; // Taille des morceaux pour l'envoi
    
    for (let i = 0; i < encoded.length; i += chunkSize) {
        const chunk = encoded.slice(i, i + chunkSize);
        await bluetoothCharacteristic.writeValue(chunk);
        await new Promise(resolve => setTimeout(resolve, 50)); // Délai entre envois
    }
}

// Fonction principale d'impression Bluetooth 80mm
async function imprimerVente80mm() {
    if (tempSaleLines.length === 0) {
        showToast('Aucune ligne à imprimer', true);
        return;
    }

    // Vérifier si Bluetooth est supporté
    if (!navigator.bluetooth) {
        showToast('Bluetooth non supporté sur ce navigateur. Utilisez Chrome sur Android.', true);
        return;
    }

    try {
        // Se connecter si pas déjà connecté
        if (!bluetoothCharacteristic) {
            const connected = await connectBluetoothPrinter();
            if (!connected) return;
        }

        showToast('Impression en cours...');

        // Récupérer les paramètres
        const settings = JSON.parse(localStorage.getItem('settings')) || {};
        const companyName = settings.companyName || 'FirePoz';
        const companyAddress = settings.companyAddress || '';
        const companyPhone = settings.companyPhone || '';

        const clientSelect = document.getElementById('saleClientId');
        const clientValue = clientSelect.value;
        const clientText = clientValue === '0' ? 'Vente Comptoir' : 
            clientSelect.options[clientSelect.selectedIndex].text.replace(/<span.*<\/span>/, '');

        const paymentMode = document.getElementById('paymentMode').value;
        const amountPaid = paymentMode === 'a_terme' ? parseFloat(document.getElementById('amountPaid').value) || 0 : 0;
        const total = tempSaleLines.reduce((sum, ligne) => sum + parseFloat(ligne.prixt || 0), 0).toFixed(2);

        const storedSeller = localStorage.getItem('selectedSeller');
        const sellerName = storedSeller ? JSON.parse(storedSeller).nom : 'Non spécifié';

        // Construire le ticket ESC/POS
        let ticket = ESCPOS.INIT;

        // En-tête centré
        ticket += ESCPOS.ALIGN_CENTER;
        ticket += ESCPOS.SIZE_LARGE + ESCPOS.BOLD_ON;
        ticket += companyName + ESCPOS.LINE_FEED;
        ticket += ESCPOS.SIZE_NORMAL + ESCPOS.BOLD_OFF;
        
        if (companyAddress) {
            ticket += companyAddress + ESCPOS.LINE_FEED;
        }
        if (companyPhone) {
            ticket += 'Tel: ' + companyPhone + ESCPOS.LINE_FEED;
        }

        ticket += '================================' + ESCPOS.LINE_FEED;
        ticket += ESCPOS.ALIGN_LEFT;

        // Informations de la vente
        ticket += 'Date: ' + new Date().toLocaleString('fr-FR') + ESCPOS.LINE_FEED;
        ticket += 'Vendeur: ' + sellerName + ESCPOS.LINE_FEED;
        ticket += 'Client: ' + clientText + ESCPOS.LINE_FEED;
        ticket += 'Mode: ' + (paymentMode === 'espece' ? 'Espece' : 'A terme') + ESCPOS.LINE_FEED;
        
        if (paymentMode === 'a_terme') {
            ticket += 'Verse: ' + amountPaid.toFixed(2) + ' DA' + ESCPOS.LINE_FEED;
        }

        // Solde si applicable
        if (paymentMode === 'a_terme' && clientValue !== '0') {
            const client = clientsCache.find(c => c.numero_clt === parseInt(clientValue));
            if (client) {
                const soldeAvant = parseFloat(client.solde) || 0;
                const soldeApres = soldeAvant + (amountPaid - parseFloat(total));
                ticket += 'Solde avant: ' + soldeAvant.toFixed(2) + ' DA' + ESCPOS.LINE_FEED;
                ticket += 'Solde apres: ' + soldeApres.toFixed(2) + ' DA' + ESCPOS.LINE_FEED;
            }
        }

        ticket += '================================' + ESCPOS.LINE_FEED;

        // En-tête du tableau des articles
        ticket += ESCPOS.BOLD_ON;
        ticket += 'Articles:' + ESCPOS.LINE_FEED;
        ticket += ESCPOS.BOLD_OFF;
        ticket += '--------------------------------' + ESCPOS.LINE_FEED;

        // Vérifier si tempSaleLines existe et contient des données
        console.log('Lignes de vente:', tempSaleLines);
        
        if (tempSaleLines && tempSaleLines.length > 0) {
            // Lignes de vente avec format tableau
            for (let i = 0; i < tempSaleLines.length; i++) {
                const ligne = tempSaleLines[i];
                
                // ID et Désignation
                const id = ligne.numero_item || 'N/A';
                const designation = ligne.designation || 'Produit';
                ticket += ESCPOS.BOLD_ON + 'ID: ' + id + ESCPOS.BOLD_OFF + ' - ' + designation + ESCPOS.LINE_FEED;
                
                // Quantité, Prix unitaire et Total
                const qte = parseFloat(ligne.quantite || 0).toFixed(2);
                const prixU = parseFloat(ligne.remarque || 0).toFixed(2);
                const prixT = parseFloat(ligne.prixt || 0).toFixed(2);
                
                ticket += '  Qte: ' + qte + ' x ' + prixU + ' DA' + ESCPOS.LINE_FEED;
                ticket += '  Total: ' + prixT + ' DA' + ESCPOS.LINE_FEED;
                ticket += '- - - - - - - - - - - - - - - -' + ESCPOS.LINE_FEED;
            }
        } else {
            ticket += 'Aucun article' + ESCPOS.LINE_FEED;
        }

        ticket += '================================' + ESCPOS.LINE_FEED;

        // Total en gras et grande taille
        ticket += ESCPOS.SIZE_DOUBLE + ESCPOS.BOLD_ON;
        ticket += ESCPOS.ALIGN_CENTER;
        ticket += 'TOTAL: ' + total + ' DA' + ESCPOS.LINE_FEED;
        ticket += ESCPOS.SIZE_NORMAL + ESCPOS.BOLD_OFF;

        ticket += '================================' + ESCPOS.LINE_FEED;
        ticket += ESCPOS.LINE_FEED;
        ticket += 'Merci de votre achat !' + ESCPOS.LINE_FEED;
        ticket += ESCPOS.LINE_FEED;
        ticket += ESCPOS.LINE_FEED;
        ticket += ESCPOS.LINE_FEED;

        // Couper le papier (optionnel selon l'imprimante)
        ticket += ESCPOS.CUT_PAPER;

        // Envoyer à l'imprimante
        await sendToPrinter(ticket);

        showToast('Impression réussie !');

    } catch (error) {
        console.error('Erreur impression Bluetooth:', error);
        showToast('Erreur impression : ' + error.message, true);
        
        // Réinitialiser la connexion en cas d'erreur
        bluetoothDevice = null;
        bluetoothCharacteristic = null;
    }
}