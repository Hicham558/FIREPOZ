<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script type="module" src="sw1.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Application de scan de codes-barres EAN-13 avec thème clair">
    <title>Scanner EAN-13 - Thème Clair</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#4b5563',
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        /* Style principal */
        body {
            background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
            color: #1f2937;
        }

        /* Scanner vidéo */
        #scanner-video, #linked-scanner-video, #photo-video {
            transform: scale(1.2);
            transform-origin: center center;
            border-radius: 8px;
        }

        /* Indicateur de scan */
        .scan-indicator, .photo-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 50%;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: border-color 0.3s;
            pointer-events: none;
            z-index: 10;
        }

        .scan-indicator.scanning, .photo-indicator.active {
            border-color: rgba(0, 255, 0, 0.5);
        }

        .scan-indicator.detected {
            border-color: rgba(0, 255, 0, 1);
        }

        /* Éléments de l'interface */
        .toast {
            backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, 0.9);
            color: #1f2937;
        }

        .form-input {
            background: #ffffff;
            border: 1px solid #1e40af;
            color: #1f2937;
        }

        .form-input:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }

        /* Tableau */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #e5e7eb;
            font-weight: 600;
        }

        /* Boutons */
        .btn-primary {
            background: #1e40af;
            color: #ffffff;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #60a5fa;
            color: #1f2937;
        }

        .btn-secondary {
            background: #4b5563;
            color: #ffffff;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #60a5fa;
            color: #1f2937;
        }

        /* Impression de vignettes */
        @media print {
            @page {
                size: 80mm 20mm;
                margin: 0;
            }
            
            body * {
                visibility: hidden;
            }
            
            .print-label, .print-label * {
                visibility: visible;
            }
            
            .print-label {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                height: 20mm;
                display: flex;
                align-items: center;
                justify-content: center;
                background: white;
                color: black;
                font-size: 8px;
            }
        }

        .barcode-preview {
            width: 80mm;
            height: 20mm;
            background: white;
            color: black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #d1d5db;
            margin: 10px auto;
        }

        /* Style pour les miniatures */
        .product-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- En-tête -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-[#1e40af] mb-2 drop-shadow-lg">Scanner EAN-13</h1>
            <p class="text-[#1f2937] mb-4">Pointez la caméra vers un code-barres EAN-13</p>
            <div class="flex justify-center gap-4 flex-wrap">
                <a href="index.html" class="inline-flex items-center btn-primary px-4 py-2 rounded-md">
                    <i class="fas fa-home mr-2"></i>Accueil
                </a>
                <button onclick="toggleAddProductForm()" class="inline-flex items-center btn-secondary px-4 py-2 rounded-md">
                    <i class="fas fa-plus mr-2"></i>Ajouter un produit
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Section Scanner -->
            <div class="bg-white/80 rounded-xl shadow-lg p-6 backdrop-blur-sm">
                <h2 class="text-xl font-semibold text-[#1e40af] mb-4">Scanner</h2>
                
                <div id="scanner-container" class="relative w-full aspect-[4/3] bg-[#e5e7eb] rounded-lg overflow-hidden mb-4">
                    <video id="scanner-video" class="absolute inset-0 w-full h-full object-cover" autoplay muted playsinline></video>
                    <div id="camera-loading" class="absolute inset-0 flex items-center justify-center text-[#1e40af]">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement de la caméra...
                    </div>
                    <div id="scan-indicator" class="scan-indicator"></div>
                </div>

                <div class="flex justify-center space-x-2 mb-4">
                    <button onclick="startScanner()" class="flex items-center bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                        <i class="fas fa-play mr-1"></i>Démarrer
                    </button>
                    <button onclick="stopScanner()" class="flex items-center bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">
                        <i class="fas fa-stop mr-1"></i>Arrêter
                    </button>
                    <button onclick="toggleTorch()" class="flex items-center bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition">
                        <i class="fas fa-lightbulb mr-1"></i>Flash
                    </button>
                </div>

                <div id="result" class="p-4 bg-[#e5e7eb]/50 rounded-lg text-[#1f2937] text-center">
                    <p class="text-lg">En attente de scan...</p>
                </div>

                <!-- Formulaire d'ajout de produit -->
                <div id="addProductForm" class="hidden mt-4 p-4 bg-[#e5e7eb]/50 rounded-lg">
                    <h3 class="text-lg font-semibold text-[#1e40af] mb-4">Ajouter un nouveau produit</h3>
                    <form id="productForm" class="space-y-3">
                        <div>
                            <label for="designation" class="block text-sm font-medium text-[#1e40af] mb-1">Désignation</label>
                            <input type="text" id="designation" name="designation" class="form-input w-full p-2 rounded" required>
                        </div>
                        <div>
                            <label for="bar" class="block text-sm font-medium text-[#1e40af] mb-1">Code-barres</label>
                            <input type="text" id="bar" name="bar" class="form-input w-full p-2 rounded">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="prix" class="block text-sm font-medium text-[#1e40af] mb-1">Prix (DA)</label>
                                <input type="number" id="prix" name="prix" class="form-input w-full p-2 rounded" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label for="qte" class="block text-sm font-medium text-[#1e40af] mb-1">Quantité</label>
                                <input type="number" id="qte" name="qte" class="form-input w-full p-2 rounded" min="0" required>
                            </div>
                        </div>
                        <div>
                            <label for="prixba" class="block text-sm font-medium text-[#1e40af] mb-1">Prix BA (DA)</label>
                            <input type="number" id="prixba" name="prixba" class="form-input w-full p-2 rounded" step="0.01" min="0">
                        </div>
                        <button type="submit" class="w-full btn-primary py-2 rounded">Ajouter le produit</button>
                    </form>
                </div>
            </div>

            <!-- Section Liste des produits -->
            <div class="bg-white/80 rounded-xl shadow-lg p-6 backdrop-blur-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-[#1e40af]">Liste des produits</h2>
                    <button onclick="loadProducts(localStorage.getItem('userId'))" class="btn-primary px-3 py-1 rounded text-sm">
                        <i class="fas fa-sync mr-1"></i>Recharger
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="searchProduct" placeholder="Rechercher..." class="form-input w-full p-2 rounded">
                </div>
                
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-left text-[#1f2937] text-sm">
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Désignation</th>
                                <th>Code-barres</th>
                                <th>Prix</th>
                                <th>Qté</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-4">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal Code-barres lié -->
        <div id="linkedBarcodeModal" class="fixed inset-0 hidden modal flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold text-[#1e40af] mb-4">Ajouter un code-barres lié</h3>
                
                <div id="linked-scanner-container" class="relative w-full aspect-[4/3] bg-[#e5e7eb] rounded-lg overflow-hidden mb-4">
                    <video id="linked-scanner-video" class="absolute inset-0 w-full h-full object-cover" autoplay muted playsinline></video>
                    <div id="linked-camera-loading" class="absolute inset-0 flex items-center justify-center text-[#1e40af]">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement...
                    </div>
                    <div id="linked-scan-indicator" class="scan-indicator"></div>
                </div>
                
                <form id="linkedBarcodeForm">
                    <input type="hidden" id="linkedItemId" name="numero_item">
                    <div class="mb-4">
                        <label for="linkedBarcode" class="block text-sm font-medium text-[#1e40af] mb-1">Code-barres lié</label>
                        <input type="text" id="linkedBarcode" name="linkedBarcode" class="form-input w-full p-2 rounded">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeLinkedBarcodeModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">Annuler</button>
                        <button type="button" onclick="startLinkedBarcodeScan()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">Scanner</button>
                        <button type="submit" class="btn-primary px-4 py-2 rounded">Ajouter</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Affichage codes-barres liés -->
        <div id="viewLinkedBarcodesModal" class="fixed inset-0 hidden modal flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold text-[#1e40af] mb-4">Codes-barres liés</h3>
                <div id="linkedBarcodesList" class="mb-4 text-[#1f2937] max-h-48 overflow-y-auto">
                    <p>Chargement...</p>
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="closeViewLinkedBarcodesModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Modal Impression de vignettes -->
        <div id="printLabelModal" class="fixed inset-0 hidden modal flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold text-[#1e40af] mb-4">Imprimer une vignette</h3>
                
                <div class="mb-4">
                    <label for="printDesignation" class="block text-sm font-medium text-[#1e40af] mb-1">Désignation</label>
                    <input type="text" id="printDesignation" class="form-input w-full p-2 rounded" readonly>
                </div>
                
                <div class="mb-4">
                    <label for="printBarcode" class="block text-sm font-medium text-[#1e40af] mb-1">Code-barres</label>
                    <input type="text" id="printBarcode" class="form-input w-full p-2 rounded" readonly>
                </div>
                
                <div class="mb-4">
                    <label for="printPrice" class="block text-sm font-medium text-[#1e40af] mb-1">Prix (DA)</label>
                    <input type="text" id="printPrice" class="form-input w-full p-2 rounded" readonly>
                </div>

                <!-- Aperçu de la vignette -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-[#1e40af] mb-2">Aperçu de la vignette (80mm x 20mm)</label>
                    <div id="labelPreview" class="barcode-preview">
                        <div class="text-xs font-bold mb-1"></div>
                        <svg id="barcodePreview" class="mb-1"></svg>
                        <div class="text-xs"></div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closePrintLabelModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">Annuler</button>
                    <button type="button" onclick="printLabel()" class="btn-primary px-4 py-2 rounded">
                        <i class="fas fa-print mr-1"></i>Imprimer
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Prise de photo -->
        <div id="photoModal" class="fixed inset-0 hidden modal flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold text-[#1e40af] mb-4">Prendre une photo</h3>
                
                <div id="photo-container" class="relative w-full aspect-[4/3] bg-[#e5e7eb] rounded-lg overflow-hidden mb-4">
                    <video id="photo-video" class="absolute inset-0 w-full h-full object-cover" autoplay muted playsinline></video>
                    <div id="photo-loading" class="absolute inset-0 flex items-center justify-center text-[#1e40af]">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement...
                    </div>
                    <div id="photo-indicator" class="photo-indicator"></div>
                </div>
                
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closePhotoModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">Annuler</button>
                    <button type="button" onclick="capturePhoto()" class="btn-primary px-4 py-2 rounded">
                        <i class="fas fa-camera mr-1"></i>Capturer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast" class="fixed bottom-4 right-4 hidden toast rounded-md shadow-lg">
        <div class="flex items-center px-6 py-3">
            <i id="toastIcon" class="mr-2"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <!-- Zone d'impression cachée -->
    <div id="printArea" class="print-label hidden">
        <div class="text-xs font-bold mb-1"></div>
        <svg id="barcodePrint"></svg>
        <div class="text-xs"></div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';
        
        // Variables globales
        let produitsCache = [];
        let scannerRunning = false;
        let torchOn = false;
        let lastScanTime = 0;
        const SCAN_COOLDOWN = 2000;
        let isLinkedBarcodeScan = false;
        let currentItemId = null;
        let photoStream = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Connexion requise pour utiliser le scanner', true);
                setTimeout(() => window.location.href = 'index.html', 3000);
                return;
            }
            
            loadProducts(userId);
            document.getElementById('searchProduct').addEventListener('input', filterProducts);
        });

        // Fonctions utilitaires
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = `fixed bottom-4 right-4 flex items-center toast px-6 py-3 rounded-md shadow-lg ${
                isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`;
            toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function formatPrice(price) {
            return parseFloat(price).toFixed(2);
        }

        // Fonctions de filtrage et affichage
        function filterProducts() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const filteredProduits = produitsCache.filter(produit =>
                produit.DESIGNATION.toLowerCase().includes(searchTerm) ||
                produit.BAR.toLowerCase().includes(searchTerm)
            );
            renderProductTable(filteredProduits);
        }

        function renderProductTable(produits) {
            const productTableBody = document.getElementById('productTableBody');
            
            if (produits.length === 0) {
                productTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">Aucun produit trouvé.</td>
                    </tr>`;
                return;
            }

            productTableBody.innerHTML = produits.map(produit => `
                <tr class="border-b border-[#e5e7eb] hover:bg-[#e5e7eb]/30 transition-colors">
                    <td class="py-2">
                        <img src="/images/${produit.NUMERO_ITEM}.jpg" 
                             class="product-thumbnail" 
                             alt="Photo de ${produit.DESIGNATION}" 
                             onerror="this.src='https://via.placeholder.com/40?text=No+Image';">
                    </td>
                    <td class="py-2">${produit.DESIGNATION}</td>
                    <td class="py-2">${produit.BAR}</td>
                    <td class="py-2">${produit.PRIX} DA</td>
                    <td class="py-2">${produit.QTE}</td>
                    <td class="py-2">
                        <div class="flex space-x-1">
                            <button onclick="openViewLinkedBarcodesModal('${produit.NUMERO_ITEM}')" 
                                    class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition"
                                    title="Afficher les codes-barres liés">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="openLinkedBarcodeModal('${produit.NUMERO_ITEM}')" 
                                    class="btn-primary px-2 py-1 rounded text-xs"
                                    title="Ajouter un code-barres lié">
                                <i class="fas fa-barcode"></i>
                            </button>
                            <button onclick="openPrintLabelModal('${produit.NUMERO_ITEM}', '${produit.DESIGNATION.replace(/'/g, "\\'")}', '${produit.BAR}', '${produit.PRIX}')" 
                                    class="bg-purple-500 text-white px-2 py-1 rounded text-xs hover:bg-purple-600 transition"
                                    title="Imprimer une vignette">
                                <i class="fas fa-print"></i>
                            </button>
                            <button onclick="openPhotoModal('${produit.NUMERO_ITEM}')" 
                                    class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600 transition"
                                    title="Prendre une photo">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Chargement des produits
        async function loadProducts(userId) {
            const resultElement = document.getElementById('result');
            
            try {
                resultElement.innerHTML = `<p class="text-[#1e40af]">Chargement des produits...</p>`;
                
                const response = await fetch(`${API_BASE_URL}/liste_produits`, {
                    headers: { 'X-User-ID': userId }
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const produits = await response.json();
                
                if (!Array.isArray(produits)) {
                    throw new Error('Réponse inattendue : les produits ne sont pas un tableau');
                }

                produitsCache = produits.map(produit => ({
                    NUMERO_ITEM: produit.NUMERO_ITEM || 0,
                    DESIGNATION: produit.DESIGNATION || 'N/A',
                    BAR: produit.BAR || 'N/A',
                    PRIX: formatPrice(produit.PRIX || 0),
                    QTE: produit.QTE || 0
                }));

                renderProductTable(produitsCache);
                resultElement.innerHTML = `<p class="text-[#1f2937]">
                    ${produitsCache.length} produit(s) chargé(s). En attente de scan...
                </p>`;
                
            } catch (error) {
                console.error('Erreur lors du chargement des produits:', error);
                showToast(`Erreur de chargement : ${error.message}`, true);
                document.getElementById('productTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-red-400">Erreur lors du chargement des produits.</td>
                    </tr>`;
                resultElement.innerHTML = `<p class="text-red-500">Erreur : ${error.message}</p>`;
            }
        }

        // Fonctions du scanner
        async function startScanner(isModal = false) {
            if (scannerRunning) return;
            
            scannerRunning = true;
            const userId = localStorage.getItem('userId');
            
            if (!userId) {
                showToast('Connexion requise', true);
                stopScanner();
                return;
            }

            const videoElement = isModal ? 
                document.getElementById('linked-scanner-video') : 
                document.getElementById('scanner-video');
            const loadingElement = isModal ? 
                document.getElementById('linked-camera-loading') : 
                document.getElementById('camera-loading');
            const scanIndicator = isModal ? 
                document.getElementById('linked-scan-indicator') : 
                document.getElementById('scan-indicator');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment', 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 } 
                    }
                });
                
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    loadingElement.style.display = 'none';
                    scanIndicator.classList.add('scanning');
                };

                if (!('BarcodeDetector' in window)) {
                    throw new Error('API BarcodeDetector non supportée. Utilisez Chrome ou Edge.');
                }

                const barcodeDetector = new BarcodeDetector({ formats: ['ean_13'] });
                
                const scan = async () => {
                    if (!scannerRunning) return;
                    
                    try {
                        const barcodes = await barcodeDetector.detect(videoElement);
                        if (barcodes.length > 0) {
                            const currentTime = Date.now();
                            if (currentTime - lastScanTime < SCAN_COOLDOWN) return;
                            lastScanTime = currentTime;

                            const code = barcodes[0].rawValue;
                            scanIndicator.classList.remove('scanning');
                            scanIndicator.classList.add('detected');
                            setTimeout(() => scanIndicator.classList.remove('detected'), 500);

                            if (isLinkedBarcodeScan) {
                                document.getElementById('linkedBarcode').value = code;
                                await addLinkedBarcode(currentItemId, code, userId);
                                closeLinkedBarcodeModal();
                            } else {
                                await handleScannedCode(code, userId);
                            }
                        }
                    } catch (err) {
                        console.error('Erreur de détection:', err);
                    }
                    
                    requestAnimationFrame(scan);
                };

                scan();
                
            } catch (err) {
                console.error('Erreur démarrage scanner:', err);
                showToast(`Erreur : ${err.message}`, true);
                scannerRunning = false;
            }
        }

        function stopScanner() {
            if (!scannerRunning) return;

            ['scanner-video', 'linked-scanner-video', 'photo-video'].forEach(id => {
                const video = document.getElementById(id);
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
            });

            ['scan-indicator', 'linked-scan-indicator', 'photo-indicator'].forEach(id => {
                const indicator = document.getElementById(id);
                if (indicator) indicator.classList.remove('scanning', 'detected', 'active');
            });

            ['camera-loading', 'linked-camera-loading', 'photo-loading'].forEach(id => {
                const loading = document.getElementById(id);
                if (loading) loading.style.display = 'flex';
            });

            scannerRunning = false;
            torchOn = false;
            isLinkedBarcodeScan = false;
            photoStream = null;
            
            document.getElementById('result').innerHTML = `<p class="text-[#1f2937]">Scanner arrêté.</p>`;
            document.getElementById('addProductForm').classList.add('hidden');
        }

        function toggleTorch() {
            if (!scannerRunning) return;
            
            const videoElement = document.getElementById('scanner-video');
            if (!videoElement.srcObject) return;

            const track = videoElement.srcObject.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            if (!capabilities.torch) {
                showToast('Flash non disponible sur cet appareil.', true);
                return;
            }

            torchOn = !torchOn;
            track.applyConstraints({ advanced: [{ torch: torchOn }] })
                .then(() => showToast(`Flash ${torchOn ? 'activé' : 'désactivé'}`))
                .catch(err => showToast(`Erreur du flash : ${err.message}`, true));
        }

        async function handleScannedCode(code, userId) {
            const resultElement = document.getElementById('result');
            
            try {
                resultElement.innerHTML = `<p class="text-green-500">Code détecté : ${code}</p><p>Recherche en cours...</p>`;
                
                const response = await fetch(`${API_BASE_URL}/liste_produits`, {
                    headers: { 'X-User-ID': userId }
                });
                
                if (!response.ok) throw new Error(`Erreur ${response.status}`);
                
                const produits = await response.json();
                const produit = produits.find(p => p.BAR === code);
                
                if (produit) {
                    resultElement.innerHTML = `
                        <div class="bg-[#e5e7eb]/80 p-4 rounded-lg">
                            <p class="text-green-500 font-semibold mb-2">✓ Produit trouvé</p>
                            <div class="space-y-1 text-sm">
                                <p><strong>Désignation :</strong> ${produit.DESIGNATION}</p>
                                <p><strong>Quantité :</strong> ${produit.QTE}</p>
                                <p><strong>Prix :</strong> ${formatPrice(produit.PRIX)} DA</p>
                                <p><strong>Code-barres :</strong> ${produit.BAR}</p>
                            </div>
                        </div>`;
                    document.getElementById('addProductForm').classList.add('hidden');
                    showToast('Produit trouvé !');
                } else {
                    const linkedResponse = await fetch(`${API_BASE_URL}/liste_codebar_lies?numero_item=0`, {
                        headers: { 'X-User-ID': userId }
                    });
                    
                    if (linkedResponse.ok) {
                        const linkedResult = await linkedResponse.json();
                        const linked_barcodes = linkedResult.linked_barcodes || [];
                        
                        if (linked_barcodes.includes(code)) {
                            resultElement.innerHTML = `
                                <div class="bg-[#e5e7eb]/80 p-4 rounded-lg">
                                    <p class="text-green-500 font-semibold">✓ Code-barres lié trouvé</p>
                                    <p class="text-sm mt-1">Code : ${code}</p>
                                </div>`;
                            showToast('Code-barres lié trouvé !');
                            return;
                        }
                    }
                    
                    resultElement.innerHTML = `
                        <div class="bg-yellow-500/20 p-4 rounded-lg border border-yellow-500/50">
                            <p class="text-yellow-400 font-semibold">⚠ Produit inconnu</p>
                            <p class="text-sm mt-1">Code : ${code}</p>
                            <p class="text-xs mt-2">Utilisez le formulaire ci-dessous pour l'ajouter.</p>
                        </div>`;
                    document.getElementById('bar').value = code;
                    document.getElementById('addProductForm').classList.remove('hidden');
                    showToast('Produit non trouvé. Ajoutez-le.', true);
                }
                
                await loadProducts(userId);
                
            } catch (error) {
                console.error('Erreur handleScannedCode:', error);
                showToast(`Erreur : ${error.message}`, true);
                resultElement.innerHTML = `<p class="text-red-500">Erreur : ${error.message}</p>`;
            }
        }

        function openLinkedBarcodeModal(numero_item) {
            currentItemId = numero_item;
            document.getElementById('linkedItemId').value = numero_item;
            document.getElementById('linkedBarcode').value = '';
            document.getElementById('linkedBarcodeModal').classList.remove('hidden');
        }

        function closeLinkedBarcodeModal() {
            document.getElementById('linkedBarcodeModal').classList.add('hidden');
            isLinkedBarcodeScan = false;
            stopScanner();
        }

        function startLinkedBarcodeScan() {
            isLinkedBarcodeScan = true;
            startScanner(true);
        }

        async function addLinkedBarcode(numero_item, barcode, userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/ajouter_codebar_lie`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({ numero_item, barcode })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Code-barres lié ajouté !');
                    await loadProducts(userId);
                } else {
                    showToast(`Erreur : ${result.erreur}`, true);
                }
            } catch (error) {
                console.error('Erreur addLinkedBarcode:', error);
                showToast(`Erreur réseau : ${error.message}`, true);
            }
        }

        async function openViewLinkedBarcodesModal(numero_item) {
            const userId = localStorage.getItem('userId');
            const linkedBarcodesList = document.getElementById('linkedBarcodesList');
            
            linkedBarcodesList.innerHTML = '<p>Chargement...</p>';
            document.getElementById('viewLinkedBarcodesModal').classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/liste_codebar_lies?numero_item=${numero_item}`, {
                    headers: { 'X-User-ID': userId }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const linked_barcodes = result.linked_barcodes || [];
                    
                    if (linked_barcodes.length > 0) {
                        linkedBarcodesList.innerHTML = `
                            <div class="space-y-2">
                                ${linked_barcodes.map(bc => `
                                    <div class="flex justify-between items-center p-2 bg-[#e5e7eb]/50 rounded">
                                        <span class="font-mono text-sm">${bc}</span>
                                        <button onclick="deleteLinkedBarcode('${numero_item}', '${bc.replace(/'/g, "\\'")}', '${userId.replace(/'/g, "\\'")}')" 
                                                class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition"
                                                title="Supprimer ce code-barres lié">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>`;
                    } else {
                        linkedBarcodesList.innerHTML = '<p class="text-center text-gray-400">Aucun code-barres lié trouvé.</p>';
                    }
                } else {
                    linkedBarcodesList.innerHTML = '<p class="text-red-400">Erreur lors du chargement.</p>';
                    showToast(`Erreur : ${result.erreur}`, true);
                }
            } catch (error) {
                console.error('Erreur openViewLinkedBarcodesModal:', error);
                linkedBarcodesList.innerHTML = '<p class="text-red-400">Erreur de connexion.</p>';
                showToast(`Erreur réseau : ${error.message}`, true);
            }
        }

        function closeViewLinkedBarcodesModal() {
            document.getElementById('viewLinkedBarcodesModal').classList.add('hidden');
        }

        async function deleteLinkedBarcode(numero_item, bar2, userId) {
            if (!confirm(`Voulez-vous vraiment supprimer le code-barres lié "${bar2}" ?`)) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/supprimer_codebar_lie`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({ numero_item, bar2 })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Code-barres lié supprimé !');
                    await openViewLinkedBarcodesModal(numero_item);
                } else {
                    showToast(`Erreur : ${result.erreur}`, true);
                }
            } catch (error) {
                console.error('Erreur deleteLinkedBarcode:', error);
                showToast(`Erreur réseau : ${error.message}`, true);
            }
        }

        document.getElementById('productForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Connexion requise', true);
                return;
            }

            const formData = {
                designation: document.getElementById('designation').value.trim(),
                bar: document.getElementById('bar').value.trim(),
                prix: parseFloat(document.getElementById('prix').value),
                qte: parseInt(document.getElementById('qte').value),
                prixba: parseFloat(document.getElementById('prixba').value) || 0
            };

            if (!formData.designation || isNaN(formData.prix) || isNaN(formData.qte)) {
                showToast('Veuillez remplir tous les champs obligatoires', true);
                return;
            }

            try {
                if (formData.bar) {
                    const checkResponse = await fetch(`${API_BASE_URL}/liste_produits`, {
                        headers: { 'X-User-ID': userId }
                    });
                    
                    if (checkResponse.ok) {
                        const produits = await checkResponse.json();
                        if (produits.some(p => p.BAR === formData.bar)) {
                            showToast('Ce code-barres existe déjà.', true);
                            return;
                        }
                    }
                }

                const response = await fetch(`${API_BASE_URL}/ajouter_item`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('result').innerHTML = `<p class="text-green-500">✓ Produit ajouté avec succès !</p>`;
                    document.getElementById('addProductForm').classList.add('hidden');
                    document.getElementById('productForm').reset();
                    showToast('Produit ajouté !');
                    await loadProducts(userId);
                } else {
                    showToast(`Erreur : ${result.erreur || 'Échec de l\'ajout'}`, true);
                }
            } catch (error) {
                console.error('Erreur ajout produit:', error);
                showToast(`Erreur réseau : ${error.message}`, true);
            }
        });

        document.getElementById('linkedBarcodeForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const userId = localStorage.getItem('userId');
            const numero_item = document.getElementById('linkedItemId').value;
            const barcode = document.getElementById('linkedBarcode').value.trim();

            if (!barcode) {
                showToast('Veuillez saisir un code-barres', true);
                return;
            }

            try {
                await addLinkedBarcode(numero_item, barcode, userId);
                closeLinkedBarcodeModal();
            } catch (error) {
                console.error('Erreur submit linkedBarcodeForm:', error);
                showToast(`Erreur : ${error.message}`, true);
            }
        });

        function openPrintLabelModal(numeroItem, designation, barcode, prix) {
            document.getElementById('printDesignation').value = designation;
            document.getElementById('printBarcode').value = barcode;
            document.getElementById('printPrice').value = `${prix} DA`;
            
            generateBarcodePreview(designation, barcode, prix);
            document.getElementById('printLabelModal').classList.remove('hidden');
        }

        function closePrintLabelModal() {
            document.getElementById('printLabelModal').classList.add('hidden');
        }

        function generateBarcodePreview(designation, barcode, prix) {
            const preview = document.getElementById('labelPreview');
            const barcodePreview = document.getElementById('barcodePreview');
            
            const designationEl = preview.querySelector('.text-xs.font-bold');
            const priceEl = preview.querySelector('.text-xs:not(.font-bold)');
            
            designationEl.textContent = designation.length > 20 ? designation.substring(0, 20) + '...' : designation;
            priceEl.textContent = `Prix: ${prix} DA`;
            
            try {
                JsBarcode(barcodePreview, barcode, {
                    format: "EAN13",
                    width: 1.5,
                    height: 30,
                    displayValue: true,
                    fontSize: 8,
                    textMargin: 2
                });
            } catch (error) {
                console.error('Erreur génération code-barres:', error);
                barcodePreview.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="red" font-size="8">Erreur: Code-barres invalide</text>`;
            }
        }

        function printLabel() {
            const designation = document.getElementById('printDesignation').value;
            const barcode = document.getElementById('printBarcode').value;
            const prix = document.getElementById('printPrice').value.replace(' DA', '');
            
            const printArea = document.getElementById('printArea');
            const barcodePrint = document.getElementById('barcodePrint');
            
            const designationEl = printArea.querySelector('.text-xs.font-bold');
            const priceEl = printArea.querySelector('.text-xs:not(.font-bold)');
            
            designationEl.textContent = designation.length > 25 ? designation.substring(0, 25) + '...' : designation;
            priceEl.textContent = `Prix: ${prix} DA`;
            
            try {
                JsBarcode(barcodePrint, barcode, {
                    format: "EAN13",
                    width: 1.2,
                    height: 25,
                    displayValue: true,
                    fontSize: 6,
                    textMargin: 1
                });
                
                printArea.classList.remove('hidden');
                
                setTimeout(() => {
                    window.print();
                    printArea.classList.add('hidden');
                    closePrintLabelModal();
                }, 100);
                
            } catch (error) {
                console.error('Erreur impression:', error);
                showToast('Erreur lors de la génération du code-barres pour l\'impression', true);
            }
        }

        function toggleAddProductForm() {
            const form = document.getElementById('addProductForm');
            form.classList.toggle('hidden');
            
            if (!form.classList.contains('hidden')) {
                document.getElementById('result').innerHTML = `<p class="text-[#1e40af]">Formulaire d'ajout de produit ouvert.</p>`;
            }
        }

        // Fonctions pour la prise de photo
        async function openPhotoModal(numero_item) {
            currentItemId = numero_item;
            const photoModal = document.getElementById('photoModal');
            const videoElement = document.getElementById('photo-video');
            const loadingElement = document.getElementById('photo-loading');
            const photoIndicator = document.getElementById('photo-indicator');

            try {
                photoStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment', 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 } 
                    }
                });
                
                videoElement.srcObject = photoStream;
                videoElement.onloadedmetadata = () => {
                    loadingElement.style.display = 'none';
                    photoIndicator.classList.add('active');
                };
                
                photoModal.classList.remove('hidden');
            } catch (err) {
                console.error('Erreur ouverture caméra photo:', err);
                showToast(`Erreur : ${err.message}`, true);
                closePhotoModal();
            }
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
            stopScanner();
        }

        async function capturePhoto() {
            const video = document.getElementById('photo-video');
            const canvas = document.createElement('canvas');
            canvas.width = 320; // Taille réduite pour miniature
            canvas.height = 240;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                // Convertir l'image en blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.7));
                
                // Créer un fichier
                const file = new File([blob], `${currentItemId}.jpg`, { type: 'image/jpeg' });

                // Simuler l'enregistrement dans un dossier /images/ (nécessite un serveur)
                // Pour cet exemple, on utilise l'API FileSystem ou un stockage local
                if ('showDirectoryPicker' in window) {
                    const dirHandle = await window.showDirectoryPicker();
                    const fileHandle = await dirHandle.getFileHandle(`${currentItemId}.jpg`, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(file);
                    await writable.close();
                } else {
                    // Fallback : stocker dans localStorage (non optimal pour les images)
                    const reader = new FileReader();
                    reader.onload = () => {
                        localStorage.setItem(`image_${currentItemId}`, reader.result);
                    };
                    reader.readAsDataURL(file);
                }

                showToast('Photo enregistrée avec succès !');
                await loadProducts(localStorage.getItem('userId'));
                closePhotoModal();
            } catch (err) {
                console.error('Erreur capture photo:', err);
                showToast(`Erreur lors de l'enregistrement de la photo : ${err.message}`, true);
            }
        }

        window.addEventListener('unhandledrejection', event => {
            console.error('Unhandled rejection:', event.reason);
            if (event.reason.message?.includes('Failed to fetch')) {
                showToast('Erreur de connexion au serveur.', true);
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('Service Worker enregistré'))
                .catch(error => console.error('Erreur Service Worker:', error));
        }
    </script>
</body>
</html>