<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script type="module" src="sw1.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Application de scan de codes-barres EAN-13 avec thème Twilight">
    <title>Scanner EAN-13 - Thème Twilight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#800020',
                        secondary: '#2e1a47',
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            background: linear-gradient(to bottom, #1a2a44, #2e1a47) !important;
            color: #d9d9d9;
        }
        #scanner-video {
            transform: scale(1.5);
            transform-origin: center center;
            border-radius: 8px;
        }
        #scan-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 50%;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: border-color 0.3s;
            pointer-events: none;
            z-index: 10;
        }
        .scanning {
            border-color: rgba(0, 255, 0, 0.5);
        }
        .detected {
            border-color: rgba(0, 255, 0, 1);
        }
        #linked-scan-indicator.scanning {
            border-color: rgba(0, 255, 0, 0.5);
        }
        #linked-scan-indicator.detected {
            border-color: rgba(0, 255, 0, 1);
        }
        .toast {
            backdrop-filter: blur(5px);
            background: rgba(26, 42, 68, 0.8);
        }
        .form-input {
            background: #1a2a44;
            border: 1px solid #800020;
            color: #d9d9d9;
        }
        .modal {
            background: rgba(26, 42, 68, 0.95);
            backdrop-filter: blur(5px);
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #2e1a47;
        }
        /* Force light mode pour la page si besoin */
        .light-mode body {
            background: linear-gradient(to bottom, #f0f0f0, #ffffff) !important;
            color: #000000 !important;
        }
        .light-mode .form-input {
            background: #ffffff !important;
            border: 1px solid #000000 !important;
            color: #000000 !important;
        }
        @media print {
            color-scheme: light !important;
            print-color-adjust: exact !important;
            -webkit-print-color-adjust: exact !important;
            body * {
                visibility: hidden !important;
                background: transparent !important;
                color: transparent !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
            #label-print, #label-print * {
                visibility: visible !important;
                background: white !important;
                color: black !important;
            }
            #label-print {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 40mm !important;
                height: 20mm !important;
                display: block !important;
                border: 1px solid #000 !important;
                font-family: Arial, sans-serif !important;
                font-size: 8px !important;
                overflow: hidden !important;
                z-index: 9999 !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            #barcode-canvas {
                background: white !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center light">
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-[#b3cde0] mb-2 drop-shadow-lg">Scanner EAN-13</h1>
            <p class="text-[#d9d9d9] mb-4">Pointez la caméra vers un code-barres EAN-13</p>
            <div class="flex justify-center gap-4">
                <a href="index.html" class="inline-flex items-center bg-[#800020] text-[#e6e6e6] px-4 py-2 rounded-md hover:bg-[#b3cde0] hover:text-[#1a2a44] transition">
                    <i class="fas fa-home mr-2"></i>Accueil
                </a>
                <button onclick="toggleAddProductForm()" class="inline-flex items-center bg-[#2e1a47] text-[#e6e6e6] px-4 py-2 rounded-md hover:bg-[#b3cde0] hover:text-[#1a2a44] transition" aria-label="Ouvrir le formulaire d'ajout de produit">
                    <i class="fas fa-plus mr-2"></i>Ajouter un produit
                </button>
                <button onclick="toggleTheme()" class="inline-flex items-center bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition" aria-label="Toggle thème clair/sombre">
                    <i class="fas fa-sun mr-2"></i>Thème Clair
                </button>
            </div>
        </header>

        <div class="bg-[#1a2a44]/80 rounded-xl shadow-lg p-6 backdrop-blur-sm">
            <div class="mb-6">
                <div id="scanner-container" class="relative w-full aspect-[4/3] bg-[#2e1a47] rounded-lg overflow-hidden">
                    <video id="scanner-video" class="absolute inset-0 w-full h-full object-cover" autoplay muted playsinline aria-label="Flux vidéo pour scanner les codes-barres"></video>
                    <div id="camera-loading" class="absolute inset-0 flex items-center justify-center text-[#b3cde0]">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement de la caméra...
                    </div>
                    <div id="scan-indicator" role="region" aria-live="polite"></div>
                    <div class="absolute bottom-4 left-0 right-0 flex justify-center space-x-2 z-20">
                        <button onclick="startScanner()" class="flex items-center bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition" aria-label="Démarrer le scanner">
                            <i class="fas fa-play mr-1"></i>Démarrer
                        </button>
                        <button onclick="stopScanner()" class="flex items-center bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition" aria-label="Arrêter le scanner">
                            <i class="fas fa-stop mr-1"></i>Arrêter
                        </button>
                        <button onclick="toggleTorch()" class="flex items-center bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition" aria-label="Activer/désactiver le flash">
                            <i class="fas fa-lightbulb mr-1"></i>Flash
                        </button>
                    </div>
                </div>
            </div>

            <div id="result" class="p-4 bg-[#2e1a47]/50 rounded-lg text-[#d9d9d9] text-center" role="alert" aria-live="assertive">
                <p class="text-lg">En attente de scan...</p>
            </div>

            <div id="addProductForm" class="hidden mt-4 p-4 bg-[#2e1a47]/50 rounded-lg">
                <h3 class="text-lg font-semibold text-[#b3cde0] mb-2">Ajouter un nouveau produit</h3>
                <form id="productForm">
                    <div class="mb-2">
                        <label for="designation" class="block text-sm font-medium text-[#b3cde0]">Désignation</label>
                        <input type="text" id="designation" name="designation" class="form-input w-full p-2 rounded" required aria-required="true">
                    </div>
                    <div class="mb-2">
                        <label for="bar" class="block text-sm font-medium text-[#b3cde0]">Code-barres</label>
                        <input type="text" id="bar" name="bar" class="form-input w-full p-2 rounded" aria-required="false">
                    </div>
                    <div class="mb-2">
                        <label for="prix" class="block text-sm font-medium text-[#b3cde0]">Prix (€)</label>
                        <input type="number" id="prix" name="prix" class="form-input w-full p-2 rounded" step="0.01" min="0" required aria-required="true">
                    </div>
                    <div class="mb-2">
                        <label for="qte" class="block text-sm font-medium text-[#b3cde0]">Quantité</label>
                        <input type="number" id="qte" name="qte" class="form-input w-full p-2 rounded" min="0" required aria-required="true">
                    </div>
                    <div class="mb-2">
                        <label for="prixba" class="block text-sm font-medium text-[#b3cde0]">Prix BA (€)</label>
                        <input type="number" id="prixba" name="prixba" class="form-input w-full p-2 rounded" step="0.01" min="0">
                    </div>
                    <button type="submit" class="w-full bg-[#800020] text-[#e6e6e6] py-2 rounded hover:bg-[#b3cde0] hover:text-[#1a2a44] transition" aria-label="Ajouter le produit">Ajouter le produit</button>
                </form>
            </div>

            <div id="productList" class="mt-6">
                <h3 class="text-lg font-semibold text-[#b3cde0] mb-2">Liste des produits</h3>
                <button onclick="loadProducts(localStorage.getItem('userId'))" class="bg-[#800020] text-[#e6e6e6] px-4 py-2 rounded mb-4 hover:bg-[#b3cde0] hover:text-[#1a2a44] transition">Recharger la grille</button>
                <div class="mb-4">
                    <input type="text" id="searchProduct" placeholder="Rechercher par désignation ou code-barres..." class="form-input w-full p-2 rounded" aria-label="Rechercher un produit">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[#d9d9d9]">
                        <thead>
                            <tr class="bg-[#2e1a47]">
                                <th class="p-2">Désignation</th>
                                <th class="p-2">Code-barres</th>
                                <th class="p-2">Prix (€)</th>
                                <th class="p-2">Quantité</th>
                                <th class="p-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <tr id="noProductsRow">
                                <td colspan="5" class="p-2 text-center">Aucun produit trouvé. Ajoutez un produit pour commencer.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="linkedBarcodeModal" class="fixed inset-0 hidden modal flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg max-w-md w-full">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Ajouter un code-barres lié</h3>
                    <div id="linked-scanner-container" class="relative w-full aspect-[4/3] bg-gray-200 rounded-lg overflow-hidden mb-4">
                        <video id="linked-scanner-video" class="absolute inset-0 w-full h-full object-cover" autoplay muted playsinline aria-label="Flux vidéo pour scanner les codes-barres liés"></video>
                        <div id="linked-camera-loading" class="absolute inset-0 flex items-center justify-center text-gray-500">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Chargement de la caméra...
                        </div>
                        <div id="linked-scan-indicator" role="region" aria-live="polite" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[70%] h-[50%] border-2 border-transparent rounded-lg transition-border-color duration-300 pointer-events-none z-10"></div>
                    </div>
                    <form id="linkedBarcodeForm">
                        <input type="hidden" id="linkedItemId" name="numero_item">
                        <div class="mb-4">
                            <label for="linkedBarcode" class="block text-sm font-medium text-gray-700">Code-barres lié</label>
                            <input type="text" id="linkedBarcode" name="linkedBarcode" class="form-input w-full p-2 rounded border-gray-300 text-gray-900" aria-required="false">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="closeLinkedBarcodeModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">Annuler</button>
                            <button type="button" onclick="startLinkedBarcodeScan()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">Scanner</button>
                            <button type="submit" class="bg-primary text-gray-100 px-4 py-2 rounded hover:bg-gray-200 hover:text-gray-900 transition">Ajouter</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="viewLinkedBarcodesModal" class="fixed inset-0 hidden modal flex items-center justify-center z-50">
                <div class="bg-[#1a2a44] p-6 rounded-lg max-w-md w-full">
                    <h3 class="text-lg font-semibold text-[#b3cde0] mb-4">Codes-barres liés</h3>
                    <div id="linkedBarcodesList" class="mb-4 text-[#d9d9d9]">
                        <p>Aucun code-barres lié trouvé.</p>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" onclick="closeViewLinkedBarcodesModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">Fermer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 hidden toast">
        <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
            <i id="toastIcon" class="mr-2"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <!-- Vignette d'impression cachée -->
    <div id="label-print" style="display: none; width: 40mm; height: 20mm; border: 1px solid #000; background: white !important; padding: 0; margin: 0; font-family: Arial, sans-serif; font-size: 8px; position: relative; overflow: hidden; color: black !important; print-color-adjust: exact;">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 60%; display: flex; align-items: center; justify-content: center; background: white !important;">
            <canvas id="barcode-canvas" width="120" height="40" style="margin: 0 auto; background: white !important; visibility: visible;"></canvas>
        </div>
        <div style="position: absolute; top: 60%; left: 0; width: 100%; height: 20%; text-align: center; background: white !important; font-weight: bold; color: black !important;">
            <span id="label-price"></span>
        </div>
        <div style="position: absolute; top: -5%; left: 0; width: 100%; height: 65%; text-align: center; background: white !important; display: flex; flex-direction: column; justify-content: flex-start; padding-top: 1mm; color: black !important;">
            <span id="label-designation" style="font-size: 6px; line-height: 1.1; word-wrap: break-word; max-height: 4mm; overflow: hidden;"></span>
        </div>
    </div>

    <script>
        const API_BASE_URL = localStorage.getItem('apiBaseUrl') || 'https://hicham03041979.onrender.com';
        let produitsCache = [];
        let scannerRunning = false;
        let torchOn = false;
        let lastScanTime = 0;
        const SCAN_COOLDOWN = 2000;
        let isLinkedBarcodeScan = false;
        let currentItemId = null;

        // Fonction pour charger JsBarcode asynchrone
        async function loadJsBarcode() {
            if (typeof JsBarcode !== 'undefined') return true;
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js';
                script.onload = () => {
                    console.log('JsBarcode chargé');
                    resolve(true);
                };
                script.onerror = () => {
                    console.error('Erreur chargement JsBarcode');
                    reject(new Error('Échec chargement JsBarcode'));
                };
                document.head.appendChild(script);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadJsBarcode(); // Charge JsBarcode au démarrage
            const userId = localStorage.getItem('userId');
            console.log('DOMContentLoaded, userId:', userId);
            const resultElement = document.getElementById('result');
            if (!userId) {
                showToast('Connexion requise pour utiliser le scanner', true);
                resultElement.innerHTML = `<p class="text-red-500">Erreur : Aucun utilisateur connecté. Redirection vers la page d'accueil...</p>`;
                setTimeout(() => window.location.href = 'index.html', 3000);
            } else {
                resultElement.innerHTML = `<p class="text-[#b3cde0]">Chargement des produits...</p>`;
                loadProducts(userId);
                document.getElementById('searchProduct').addEventListener('input', filterProducts);
            }
            // Listener pour reset après impression
            window.addEventListener('afterprint', () => {
                document.getElementById('label-print').style.display = 'none';
                console.log('Impression terminée, reset vignette');
            });
        });

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.querySelector('button[onclick="toggleTheme()"]').innerHTML = `<i class="fas fa-${isLight ? 'moon' : 'sun'} mr-2"></i>Thème ${isLight ? 'Sombre' : 'Clair'}`;
            showToast(`Thème passé en mode ${isLight ? 'clair' : 'sombre'}`, false);
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = `fixed bottom-4 right-4 flex items-center toast px-6 py-3 rounded-md shadow-lg ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            toastIcon.className = isError ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const productTableBody = document.getElementById('productTableBody');
            const filteredProduits = produitsCache.filter(produit =>
                produit.DESIGNATION.toLowerCase().includes(searchTerm) ||
                produit.BAR.toLowerCase().includes(searchTerm)
            );

            productTableBody.innerHTML = '';
            if (filteredProduits.length === 0) {
                productTableBody.innerHTML = `
                    <tr id="noProductsRow">
                        <td colspan="5" class="p-2 text-center">Aucun produit trouvé.</td>
                    </tr>`;
            } else {
                productTableBody.innerHTML = filteredProduits.map(produit => `
                    <tr class="border-b border-[#2e1a47]">
                        <td class="p-2">${produit.DESIGNATION}</td>
                        <td class="p-2">${produit.BAR}</td>
                        <td class="p-2">${produit.PRIX}</td>
                        <td class="p-2">${produit.QTE}</td>
                        <td class="p-2 flex space-x-2">
                            <button onclick="printLabel('${produit.DESIGNATION.replace(/'/g, "\\'")}', '${produit.BAR}', '${produit.PRIX}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 transition" aria-label="Imprimer vignette">
                                <i class="fas fa-print mr-1"></i>Imprimer
                            </button>
                            <button onclick="openViewLinkedBarcodesModal('${produit.NUMERO_ITEM}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition" aria-label="Afficher les codes-barres liés">
                                <i class="fas fa-eye mr-1"></i>Afficher
                            </button>
                            <button onclick="openLinkedBarcodeModal('${produit.NUMERO_ITEM}')" class="bg-[#800020] text-[#e6e6e6] px-2 py-1 rounded hover:bg-[#b3cde0] hover:text-[#1a2a44] transition" aria-label="Ajouter un code-barres lié">
                                <i class="fas fa-barcode mr-1"></i>Ajouter
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function loadProducts(userId) {
            const productTableBody = document.getElementById('productTableBody');
            const resultElement = document.getElementById('result');
            console.log('loadProducts called with userId:', userId);

            try {
                resultElement.innerHTML = `<p class="text-[#b3cde0]">Chargement des produits...</p>`;
                const response = await fetch(`${API_BASE_URL}/liste_produits`, {
                    headers: { 'X-User-ID': userId }
                });
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                const produits = await response.json();
                console.log('Produits reçus:', produits);

                if (!Array.isArray(produits)) {
                    throw new Error('Réponse inattendue : les produits ne sont pas un tableau');
                }

                produitsCache = produits.map(produit => ({
                    NUMERO_ITEM: produit.NUMERO_ITEM || 0,
                    DESIGNATION: produit.DESIGNATION || 'N/A',
                    BAR: (produit.BAR || '').toString().trim(), // Force string et trim
                    PRIX: produit.PRIX ? parseFloat(produit.PRIX).toFixed(2) : '0.00',
                    QTE: produit.QTE || 0
                }));

                productTableBody.innerHTML = '';

                if (produitsCache.length === 0) {
                    console.log('Aucun produit trouvé');
                    productTableBody.innerHTML = `
                        <tr id="noProductsRow">
                            <td colspan="5" class="p-2 text-center">Aucun produit trouvé. Ajoutez un produit pour commencer.</td>
                        </tr>`;
                    resultElement.innerHTML = `<p class="text-[#d9d9d9]">Aucun produit disponible. Utilisez le formulaire pour en ajouter.</p>`;
                } else {
                    console.log('Rendu des produits:', produitsCache);
                    productTableBody.innerHTML = produitsCache.map(produit => `
                        <tr class="border-b border-[#2e1a47]">
                            <td class="p-2">${produit.DESIGNATION}</td>
                            <td class="p-2">${produit.BAR}</td>
                            <td class="p-2">${produit.PRIX}</td>
                            <td class="p-2">${produit.QTE}</td>
                            <td class="p-2 flex space-x-2">
                                <button onclick="printLabel('${produit.DESIGNATION.replace(/'/g, "\\'")}', '${produit.BAR}', '${produit.PRIX}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 transition" aria-label="Imprimer vignette">
                                    <i class="fas fa-print mr-1"></i>Imprimer
                                </button>
                                <button onclick="openViewLinkedBarcodesModal('${produit.NUMERO_ITEM}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition" aria-label="Afficher les codes-barres liés">
                                    <i class="fas fa-eye mr-1"></i>Afficher
                                </button>
                                <button onclick="openLinkedBarcodeModal('${produit.NUMERO_ITEM}')" class="bg-[#800020] text-[#e6e6e6] px-2 py-1 rounded hover:bg-[#b3cde0] hover:text-[#1a2a44] transition" aria-label="Ajouter un code-barres lié">
                                    <i class="fas fa-barcode mr-1"></i>Ajouter
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    resultElement.innerHTML = `<p class="text-[#d9d9d9]">Produits chargés avec succès.</p>`;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des produits:', error);
                showToast(`Erreur de chargement des produits : ${error.message}`, true);
                productTableBody.innerHTML = `
                    <tr id="noProductsRow">
                        <td colspan="5" class="p-2 text-center">Erreur lors du chargement des produits.</td>
                    </tr>`;
                resultElement.innerHTML = `<p class="text-red-500">Erreur : ${error.message}</p>`;
            }
        }

        // Fonction printLabel corrigée avec chargement async et validation stricte
        async function printLabel(designation, bar, prix) {
            console.log('printLabel appelée avec:', { designation, bar, prix });
            bar = (bar || '').toString().trim(); // Force string et trim
            if (!bar || bar.length !== 13 || !/^\d{13}$/.test(bar)) {
                showToast('Code-barres invalide pour EAN-13 (doit être exactement 13 chiffres)', true);
                console.error('Code invalide:', bar);
                return;
            }
            try {
                await loadJsBarcode();
                if (typeof JsBarcode === 'undefined') {
                    throw new Error('JsBarcode non chargé');
                }
                const canvas = document.getElementById('barcode-canvas');
                const ctx = canvas.getContext('2d');
                if (!canvas || !ctx) {
                    throw new Error('Canvas non trouvé');
                }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                JsBarcode(canvas, bar, {
                    format: "EAN13",
                    lineColor: "#000",
                    width: 1.2,
                    height: 30,
                    displayValue: false,
                    margin: 2,
                    fontSize: undefined
                });
                console.log('Barcode généré avec succès pour:', bar);
                document.getElementById('label-designation').textContent = designation;
                document.getElementById('label-price').textContent = `${prix} DA`;
                document.getElementById('label-print').style.display = 'block';
                setTimeout(() => {
                    window.focus();
                    window.print();
                    console.log('Print déclenché');
                }, 500);
            } catch (err) {
                console.error('Erreur JsBarcode:', err);
                showToast(`Erreur génération barcode: ${err.message}`, true);
            }
        }

        // Reste du script inchangé (startScanner, etc.) - je l'omets pour brevité, copiez du précédent
        // [Insérez ici tout le code JS restant de la version précédente : startScanner, stopScanner, etc.]
        async function startScanner(isModal = false) {
            // ... (code identique à la version précédente)
        }
        // [Et ainsi de suite pour toutes les autres fonctions : stopScanner, toggleTorch, fetchProduit, etc.]
        // Pour éviter la longueur, copiez le script complet de la réponse précédente et remplacez seulement printLabel et loadProducts par les versions ci-dessus.
    </script>
</body>
</html>