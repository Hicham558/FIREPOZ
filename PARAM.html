<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - Firepoz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a103d, #2a1a5e);
            font-family: 'Inter', sans-serif;
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .glow {
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .input-field {
            background-color: #2d3748;
            border: none;
            color: #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            ring: 2px;
            ring-color: #7c3aed;
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen text-gray-200">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 hidden">
        <form id="loginForm" class="bg-gray-800 rounded-lg p-6 w-full max-w-md glow">
            <h2 class="text-xl font-semibold text-gray-100 mb-4">Connexion</h2>
            <p class="text-sm text-red-400 mb-4">⚠️ Le mot de passe ne doit pas être celui de votre email.</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Adresse Email*</label>
                <input type="email" id="userEmail" class="input-field" placeholder="Entrez votre email" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Mot de passe*</label>
                <input type="password" id="userPassword" class="input-field" placeholder="Entrez votre mot de passe" required>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition transform hover:scale-105">
                    <i class="fas fa-sign-in-alt mr-2"></i>Se connecter
                </button>
            </div>
        </form>
    </div>

    <!-- Navigation -->
    <nav class="bg-gray-900 p-4 shadow-lg animate-fade-in">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold text-purple-400">
                <i class="fas fa-fire mr-2"></i> Firepoz
            </div>
            <div class="space-x-4">
                <a href="index.html" class="text-gray-300 hover:text-purple-400 transition">Tableau de bord</a>
                <a href="vente.html" class="text-gray-300 hover:text-purple-400 transition">Ventes</a>
                <a href="achat.html" class="text-gray-300 hover:text-purple-400 transition">Achats</a>
                <a href="HISTO.html" class="text-gray-300 hover:text-purple-400 transition">Versements</a>
                <a href="HELP.html" class="text-gray-300 hover:text-purple-400 transition">Aide</a>
                <a href="parametres.html" class="text-purple-400 font-semibold">Paramètres</a>
                <button id="logoutButton" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition hidden">
                    <i class="fas fa-sign-out-alt mr-1"></i>Déconnexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto py-12 px-4 animate-fade-in">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-purple-300">Paramètres de Firepoz</h1>
            <p class="text-lg text-gray-400 mt-2">
                Configurez votre application pour une expérience optimale.<br>
                Développé par <span class="text-purple-400 font-semibold">Khelladi Hicham</span>
            </p>
        </div>

        <!-- User Validation Panel -->
        <div class="card bg-gray-800 p-6 rounded-lg glow mb-8">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                <i class="fas fa-user-check mr-2 text-purple-400"></i> Validation de l'utilisateur
            </h2>
            <select id="userSelect" class="input-field mb-4">
                <option value="">Choisir un utilisateur</option>
            </select>
            <input id="userPassword" type="password" placeholder="Mot de passe" class="input-field mb-4">
            <button id="validateUser" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full transform hover:scale-105">
                Valider
            </button>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- General Settings -->
            <div class="card bg-gray-800 p-6 rounded-lg glow">
                <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                    <i class="fas fa-cog mr-2 text-purple-400"></i> Paramètres Généraux
                </h2>
                <form id="generalSettingsForm">
                    <div class="mb-4">
                        <label for="theme" class="block text-gray-300 mb-1">Thème</label>
                        <select id="theme" class="input-field">
                            <option value="twilight">Twilight (Défaut)</option>
                            <option value="light">Clair</option>
                            <option value="dark">Sombre</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="currency" class="block text-gray-300 mb-1">Devise</label>
                        <select id="currency" class="input-field">
                            <option value="DZD">DZD (Dinar Algérien)</option>
                            <option value="EUR">EUR (Euro)</option>
                            <option value="USD">USD (Dollar)</option>
                        </select>
                    </div>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full transform hover:scale-105">
                        Enregistrer
                    </button>
                </form>
            </div>

            <!-- Notifications -->
            <div class="card bg-gray-800 p-6 rounded-lg glow">
                <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                    <i class="fas fa-bell mr-2 text-purple-400"></i> Notifications
                </h2>
                <form id="notificationSettingsForm">
                    <div class="mb-4">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="emailNotifications" class="mr-2">
                            Notifications par email
                        </label>
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="appNotifications" class="mr-2">
                            Notifications dans l'application
                        </label>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-gray-300 mb-1">Email pour notifications</label>
                        <input type="email" id="email" class="input-field" placeholder="exemple@firepoz.com">
                    </div>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full transform hover:scale-105">
                        Enregistrer
                    </button>
                </form>
            </div>

            <!-- User Settings -->
            <div class="card bg-gray-800 p-6 rounded-lg glow">
                <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                    <i class="fas fa-user mr-2 text-purple-400"></i> Paramètres Utilisateur
                </h2>
                <form id="userSettingsForm">
                    <div class="mb-4">
                        <label for="userName" class="block text-gray-300 mb-1">Nom</label>
                        <input type="text" id="userName" class="input-field" placeholder="Nom complet">
                    </div>
                    <div class="mb-4">
                        <label for="userEmail" class="block text-gray-300 mb-1">Email</label>
                        <input type="email" id="userEmail" class="input-field" placeholder="email@firepoz.com">
                    </div>
                    <div class="mb-4">
                        <label for="userPassword" class="block text-gray-300 mb-1">Nouveau mot de passe</label>
                        <input type="password" id="userPassword" class="input-field" placeholder="Laissez vide pour ne pas changer">
                    </div>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full transform hover:scale-105">
                        Enregistrer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 hidden toast">
        <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
            <i id="toastIcon" class="mr-2"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 py-6 mt-12 animate-fade-in">
        <div class="container mx-auto text-center text-gray-400">
            <p>Firepoz © 2025 - Développé par <span class="text-purple-400">Khelladi Hicham</span></p>
            <p class="mt-2">Tous droits réservés.</p>
        </div>
    </footer>

    <script>
        const API_BASE_URL = 'https://web-production-3b9e.up.railway.app';

        // Generate unique user ID
        function generateUniqueUserId(email, password) {
            const combined = `${email.toLowerCase()}:${password}`;
            return btoa(combined);
        }

        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg toast ${
                isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`;
            toastIcon.className = `fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2`;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Apply theme from localStorage
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'twilight';
            if (theme === 'light') {
                document.body.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                document.querySelectorAll('.card').forEach(card => card.style.background = '#ffffff');
            } else if (theme === 'dark') {
                document.body.style.background = 'linear-gradient(135deg, #111827, #1f2937)';
                document.querySelectorAll('.card').forEach(card => card.style.background = '#1f2937');
            }
            document.getElementById('theme').value = theme;
        }

        // Load users
        async function loadUsers() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Veuillez vous connecter pour voir les utilisateurs', true);
                document.getElementById('loginModal').classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/liste_utilisateurs`, {
                    headers: { 'X-User-ID': userId }
                });
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                const users = await response.json();
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '<option value="">Choisir un utilisateur</option>';

                if (users.length === 0) {
                    showToast('Aucun utilisateur trouvé', true);
                    return;
                }

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.numero_util;
                    option.textContent = user.nom;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                showToast(`Erreur de chargement des utilisateurs: ${error.message}`, true);
                console.error('Erreur utilisateurs:', error);
            }
        }

        // Handle login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            if (!email || !password) {
                showToast('Veuillez entrer un email et un mot de passe valides', true);
                return;
            }

            const userId = generateUniqueUserId(email, password);
            localStorage.setItem('userId', userId);
            localStorage.setItem('userEmail', email.toLowerCase());
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('logoutButton').classList.remove('hidden');
            showToast('Connexion réussie');
            loadUsers();
        });

        // Handle logout
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            document.getElementById('logoutButton').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('userSelect').innerHTML = '<option value="">Choisir un utilisateur</option>';
            showToast('Déconnexion réussie');
        });

        // Validate user
        document.getElementById('validateUser').addEventListener('click', async () => {
            const userId = localStorage.getItem('userId');
            const selectedUser = document.getElementById('userSelect').value;
            const password = document.getElementById('userPassword').value.trim();
            if (!userId || !selectedUser || !password) {
                showToast('Veuillez sélectionner un utilisateur et entrer un mot de passe', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/valider_utilisateur`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify({ numero_util: selectedUser, password })
                });
                if (!response.ok) {
                    throw new Error('Échec de la validation');
                }
                document.getElementById('settingsSection').classList.remove('hidden');
                loadSettings();
                showToast('Utilisateur validé');
            } catch (error) {
                showToast(`Erreur de validation: ${error.message}`, true);
                console.error('Erreur validation:', error);
            }
        });

        // Load settings
        async function loadSettings() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/parametres`, {
                    headers: { 'X-User-ID': userId }
                });
                if (!response.ok) {
                    throw new Error('Erreur de chargement des paramètres');
                }
                const settings = await response.json();
                document.getElementById('currency').value = settings.currency || 'DZD';
                document.getElementById('emailNotifications').checked = settings.emailNotifications || false;
                document.getElementById('appNotifications').checked = settings.appNotifications || false;
                document.getElementById('email').value = settings.email || '';
                document.getElementById('userName').value = settings.userName || '';
                document.getElementById('userEmail').value = settings.userEmail || '';
            } catch (error) {
                showToast(`Erreur de chargement des paramètres: ${error.message}`, true);
                console.error('Erreur paramètres:', error);
            }
        }

        // Handle general settings form
        document.getElementById('generalSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Veuillez vous connecter', true);
                return;
            }

            const settings = {
                theme: document.getElementById('theme').value,
                currency: document.getElementById('currency').value
            };
            localStorage.setItem('theme', settings.theme);
            applyTheme();

            try {
                const response = await fetch(`${API_BASE_URL}/parametres`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(settings)
                });
                if (!response.ok) {
                    throw new Error('Échec de la sauvegarde');
                }
                showToast('Paramètres généraux sauvegardés');
            } catch (error) {
                showToast(`Erreur de sauvegarde: ${error.message}`, true);
                console.error('Erreur sauvegarde:', error);
            }
        });

        // Handle notification settings form
        document.getElementById('notificationSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Veuillez vous connecter', true);
                return;
            }

            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                appNotifications: document.getElementById('appNotifications').checked,
                email: document.getElementById('email').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/parametres`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(settings)
                });
                if (!response.ok) {
                    throw new Error('Échec de la sauvegarde');
                }
                showToast('Notifications sauvegardées');
            } catch (error) {
                showToast(`Erreur de sauvegarde: ${error.message}`, true);
                console.error('Erreur sauvegarde:', error);
            }
        });

        // Handle user settings form
        document.getElementById('userSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Veuillez vous connecter', true);
                return;
            }

            const settings = {
                userName: document.getElementById('userName').value,
                userEmail: document.getElementById('userEmail').value,
                userPassword: document.getElementById('userPassword').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/parametres`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(settings)
                });
                if (!response.ok) {
                    throw new Error('Échec de la sauvegarde');
                }
                showToast('Paramètres utilisateur sauvegardés');
            } catch (error) {
                showToast(`Erreur de sauvegarde: ${error.message}`, true);
                console.error('Erreur sauvegarde:', error);
            }
        });

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            const userId = localStorage.getItem('userId');
            if (userId) {
                document.getElementById('logoutButton').classList.remove('hidden');
                loadUsers();
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>