<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - Firepoz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a103d, #2a1a5e);
            font-family: 'Inter', sans-serif;
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .section-title {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .glow {
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .input-field {
            background-color: #2d3748;
            border: none;
            color: #e2e8f0;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            ring: 2px;
            ring-color: #7c3aed;
        }
    </style>
</head>
<body class="min-h-screen text-gray-200">
    <!-- Barre de navigation -->
    <nav class="bg-gray-900 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold text-purple-400">
                <i class="fas fa-fire mr-2"></i> Firepoz
            </div>
            <div class="space-x-4">
                <a href="index.html" class="text-gray-300 hover:text-purple-400 transition">Tableau de bord</a>
                <a href="ventes.html" class="text-gray-300 hover:text-purple-400 transition">Ventes</a>
                <a href="achats.html" class="text-gray-300 hover:text-purple-400 transition">Achats</a>
                <a href="versements.html" class="text-gray-300 hover:text-purple-400 transition">Versements</a>
                <a href="help.html" class="text-gray-300 hover:text-purple-400 transition">Aide</a>
                <a href="parametres.html" class="text-purple-400 font-semibold">Paramètres</a>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="container mx-auto py-12 px-4">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-purple-300 section-title">Paramètres de Firepoz</h1>
            <p class="text-lg text-gray-400 mt-2">
                Configurez votre application pour une expérience optimale.<br>
                Développé par <span class="text-purple-400 font-semibold">Khelladi Hicham</span>
            </p>
        </div>

        <!-- Panneau utilisateur -->
        <div class="card bg-gray-800 p-6 rounded-lg glow mb-8">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                <i class="fas fa-user-check mr-2 text-purple-400"></i> Validation de l'utilisateur
            </h2>
            <select id="userSelect" class="input-field mb-4">
                <option value="">Choisir un utilisateur</option>
            </select>
            <input id="userPassword" type="password" placeholder="Mot de passe" class="input-field mb-4">
            <button id="validateUser" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full">
                Valider
            </button>
        </div>

        <!-- Section paramètres (visible après validation) -->
        <div id="settingsSection" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Paramètres généraux -->
                <div class="card bg-gray-800 p-6 rounded-lg glow">
                    <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                        <i class="fas fa-cog mr-2 text-purple-400"></i> Paramètres Généraux
                    </h2>
                    <form id="generalSettingsForm">
                        <div class="mb-4">
                            <label for="theme" class="block text-gray-300 mb-1">Thème</label>
                            <select id="theme" class="input-field">
                                <option value="twilight">Twilight (Défaut)</option>
                                <option value="light">Clair</option>
                                <option value="dark">Sombre</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="currency" class="block text-gray-300 mb-1">Devise</label>
                            <select id="currency" class="input-field">
                                <option value="DZD">DZD (Dinar Algérien)</option>
                                <option value="EUR">EUR (Euro)</option>
                                <option value="USD">USD (Dollar)</option>
                            </select>
                        </div>
                        <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full">
                            Enregistrer
                        </button>
                    </form>
                </div>

                <!-- Notifications -->
                <div class="card bg-gray-800 p-6 rounded-lg glow">
                    <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                        <i class="fas fa-bell mr-2 text-purple-400"></i> Notifications
                    </h2>
                    <form id="notificationSettingsForm">
                        <div class="mb-4">
                            <label class="flex items-center text-gray-300">
                                <input type="checkbox" id="emailNotifications" class="mr-2">
                                Notifications par email
                            </label>
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center text-gray-300">
                                <input type="checkbox" id="appNotifications" class="mr-2">
                                Notifications dans l'application
                            </label>
                        </div>
                        <div class="mb-4">
                            <label for="email" class="block text-gray-300 mb-1">Email pour notifications</label>
                            <input type="email" id="email" class="input-field" placeholder="exemple@firepoz.com">
                        </div>
                        <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full">
                            Enregistrer
                        </button>
                    </form>
                </div>

                <!-- Paramètres utilisateur -->
                <div class="card bg-gray-800 p-6 rounded-lg glow">
                    <h2 class="text-2xl font-semibold text-gray-100 mb-4">
                        <i class="fas fa-user mr-2 text-purple-400"></i> Paramètres Utilisateur
                    </h2>
                    <form id="userSettingsForm">
                        <div class="mb-4">
                            <label for="userName" class="block text-gray-300 mb-1">Nom</label>
                            <input type="text" id="userName" class="input-field" placeholder="Nom complet">
                        </div>
                        <div class="mb-4">
                            <label for="userEmail" class="block text-gray-300 mb-1">Email</label>
                            <input type="email" id="userEmail" class="input-field" placeholder="email@firepoz.com">
                        </div>
                        <div class="mb-4">
                            <label for="userPassword" class="block text-gray-300 mb-1">Nouveau mot de passe</label>
                            <input type="password" id="userPassword" class="input-field" placeholder="Laissez vide pour ne pas changer">
                        </div>
                        <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition w-full">
                            Enregistrer
                        </button>
                    </form>
                </div>
            </div>

            <!-- Bouton de réinitialisation -->
            <div class="mt-8 text-center">
                <button id="resetSettings" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-md transition">
                    Réinitialiser tous les paramètres
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de confirmation -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal">
        <div class="bg-gray-800 p-6 rounded-lg glow w-full max-w-md">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Confirmation</h2>
            <p id="modalMessage" class="text-gray-300 mb-4">Êtes-vous sûr de vouloir sauvegarder les modifications ?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelModal" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition">Annuler</button>
                <button id="confirmModal" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Pied de page -->
    <footer class="bg-gray-900 py-6 mt-12">
        <div class="container mx-auto text-center text-gray-400">
            <p>Firepoz © 2025 - Développé par <span class="text-purple-400">Khelladi Hicham</span></p>
            <p class="mt-2">Tous droits réservés.</p>
        </div>
    </footer>

    <script>
        // Appliquer le thème depuis localStorage
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'twilight';
            if (theme === 'light') {
                document.body.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                document.querySelectorAll('.card').forEach(card => card.style.background = '#ffffff');
            } else if (theme === 'dark') {
                document.body.style.background = 'linear-gradient(135deg, #111827, #1f2937)';
                document.querySelectorAll('.card').forEach(card => card.style.background = '#1f2937');
            }
            document.getElementById('theme').value = theme;
        }

        // Charger les utilisateurs
        async function loadUsers() {
            try {
                const response = await fetch('/liste_utilisateurs');
                const users = await response.json();
                const userSelect = document.getElementById('userSelect');
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.numero_util;
                    option.textContent = user.nom;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                showModal('Erreur lors du chargement des utilisateurs.');
            }
        }

        // Valider l'utilisateur
        document.getElementById('validateUser').addEventListener('click', async () => {
            const userId = document.getElementById('userSelect').value;
            const password = document.getElementById('userPassword').value;
            try {
                const response = await fetch('/valider_utilisateur', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, password })
                });
                if (response.ok) {
                    localStorage.setItem('selectedUser', userId);
                    localStorage.setItem('userPassword', password);
                    document.getElementById('settingsSection').classList.remove('hidden');
                    loadSettings();
                } else {
                    showModal('Échec de la validation.');
                }
            } catch (error) {
                console.error('Erreur de validation:', error);
                showModal('Erreur lors de la validation.');
            }
        });

        // Charger les paramètres
        async function loadSettings() {
            try {
                const response = await fetch('/parametres');
                const settings = await response.json();
                document.getElementById('currency').value = settings.currency || 'DZD';
                document.getElementById('emailNotifications').checked = settings.emailNotifications || false;
                document.getElementById('appNotifications').checked = settings.appNotifications || false;
                document.getElementById('email').value = settings.email || '';
                document.getElementById('userName').value = settings.userName || '';
                document.getElementById('userEmail').value = settings.userEmail || '';
            } catch (error) {
                console.error('Erreur lors du chargement des paramètres:', error);
                showModal('Erreur lors du chargement des paramètres.');
            }
        }

        // Afficher la modale
        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        // Gérer les formulaires
        document.getElementById('generalSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                theme: document.getElementById('theme').value,
                currency: document.getElementById('currency').value
            };
            localStorage.setItem('theme', settings.theme);
            applyTheme();
            showModal('Voulez-vous sauvegarder les paramètres généraux ?');
            document.getElementById('confirmModal').onclick = async () => {
                try {
                    const response = await fetch('/parametres', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    if (response.ok) {
                        showModal('Paramètres sauvegardés !');
                        document.getElementById('confirmModal').onclick = () => {
                            document.getElementById('confirmModal').classList.add('hidden');
                        };
                    } else {
                        showModal('Échec de la sauvegarde.');
                    }
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    showModal('Erreur lors de la sauvegarde.');
                }
            };
        });

        document.getElementById('notificationSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                appNotifications: document.getElementById('appNotifications').checked,
                email: document.getElementById('email').value
            };
            showModal('Voulez-vous sauvegarder les paramètres de notification ?');
            document.getElementById('confirmModal').onclick = async () => {
                try {
                    const response = await fetch('/parametres', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    if (response.ok) {
                        showModal('Notifications sauvegardées !');
                        document.getElementById('confirmModal').onclick = () => {
                            document.getElementById('confirmModal').classList.add('hidden');
                        };
                    } else {
                        showModal('Échec de la sauvegarde.');
                    }
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    showModal('Erreur lors de la sauvegarde.');
                }
            };
        });

        document.getElementById('userSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                userName: document.getElementById('userName').value,
                userEmail: document.getElementById('userEmail').value,
                userPassword: document.getElementById('userPassword').value
            };
            showModal('Voulez-vous sauvegarder les paramètres utilisateur ?');
            document.getElementById('confirmModal').onclick = async () => {
                try {
                    const response = await fetch('/parametres', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    if (response.ok) {
                        showModal('Paramètres utilisateur sauvegardés !');
                        document.getElementById('confirmModal').onclick = () => {
                            document.getElementById('confirmModal').classList.add('hidden');
                        };
                    } else {
                        showModal('Échec de la sauvegarde.');
                    }
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    showModal('Erreur lors de la sauvegarde.');
                }
            };
        });

        // Réinitialiser les paramètres
        document.getElementById('resetSettings').addEventListener('click', () => {
            showModal('Voulez-vous réinitialiser tous les paramètres ? Cette action est irréversible.');
            document.getElementById('confirmModal').onclick = async () => {
                try {
                    const response = await fetch('/parametres/reset', { method: 'DELETE' });
                    if (response.ok) {
                        localStorage.removeItem('theme');
                        applyTheme();
                        showModal('Paramètres réinitialisés !');
                        document.getElementById('confirmModal').onclick = () => {
                            document.getElementById('confirmModal').classList.add('hidden');
                            loadSettings();
                        };
                    } else {
                        showModal('Échec de la réinitialisation.');
                    }
                } catch (error) {
                    console.error('Erreur lors de la réinitialisation:', error);
                    showModal('Erreur lors de la réinitialisation.');
                }
            };
        });

        // Fermer la modale
        document.getElementById('cancelModal').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.add('hidden');
        });

        // Initialisation
        applyTheme();
        loadUsers();
        if (localStorage.getItem('selectedUser')) {
            document.getElementById('settingsSection').classList.remove('hidden');
            loadSettings();
        }
    </script>
</body>
</html>