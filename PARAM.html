<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - Firepoz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        .toast { transition: opacity 0.5s; }
        .hidden { opacity: 0; display: none; }
        .kpi-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .kpi-card:hover { transform: scale(1.03); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        body { font-family: 'Inter', sans-serif; }
        .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
        .small-email { font-size: 0.75rem; line-height: 1rem; }
        .user-anim { animation: userPulse 1.5s infinite ease-in-out; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes userPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Barre de navigation -->
    <nav class="bg-indigo-600 text-white p-4 fixed w-full top-0 z-10 shadow-md animate-slide-in">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-fire mr-2 text-amber-400 animate-pulse"></i> Firepoz Param
                </h1>
                <span id="userDisplay" class="small-email user-anim hidden"></span>
            </div>
            <div class="space-x-4 flex items-center">
                <a href="./index.html" class="hover:text-indigo-200 transition flex items-center">
                    <i class="fas fa-home mr-1"></i> Accueil
                </a>
                <a href="https://github.com/Hicham558/FIREPOZ/releases/download/untagged-2711f45614d596a3f23c/_firepoz_18969177.apk" class="hover:text-indigo-200 transition flex items-center" download>
                    <i class="fas fa-download mr-1"></i> DownloadAPK
                </a>
                <button id="logoutButton" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition flex items-center">
                    <i class="fas fa-sign-out-alt mr-1"></i> Déconnexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="container mx-auto px-4 py-16 mt-16">
        <h2 class="text-3xl font-semibold mb-6 text-indigo-700 text-center">Paramètres Avancés</h2>

        <!-- Paramètres de l'API -->
        <div class="kpi-card bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Paramètres de l'API</h3>
            <form id="apiSettingsForm" class="space-y-4">
                <div class="flex items-center space-x-2">
                    <div class="flex-1">
                        <label for="apiBaseUrl" class="block text-sm font-medium text-gray-700">URL de l'API</label>
                        <input id="apiBaseUrl" type="text" name="apiBaseUrl" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="ex: https://your-subdomain.loca.lt">
                    </div>
                    <button type="button" onclick="scanQrCode()" class="mt-6 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700 transition flex items-center justify-center" aria-label="Scanner un QR code pour l'URL de l'API">
                        <i class="fas fa-qrcode"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="flex space-x-4">
                        <button type="button" onclick="setOfflineMode()" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition flex items-center justify-center">
                            <i class="fas fa-wifi mr-2"></i> Base Locale
                        </button>
                        <button type="button" onclick="resetApiUrl()" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition flex items-center justify-center">
                            <i class="fas fa-undo mr-2"></i> Revenir à l'API par défaut
                        </button>
                        <button type="button" onclick="resetToSecondaryApiUrl()" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition flex items-center justify-center">
                            <i class="fas fa-server mr-2"></i> Revenir à la base locale
                        </button>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="saveApiSettings()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> Sauvegarder URL
                        </button>
                        <button type="button" onclick="testDbConnection()" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition flex items-center justify-center">
                            <i class="fas fa-plug mr-2"></i> Tester Connexion
                        </button>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="window.location.href='./BDD.html'" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition flex items-center justify-center">
                            <i class="fas fa-database mr-2"></i> Gestion de Base Hors Ligne
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Autres sections inchangées -->
        <div class="kpi-card bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Paramètres Généraux</h3>
            <form id="generalSettingsForm" class="space-y-4">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700">Nom de l'Entreprise</label>
                    <input id="companyName" type="text" name="companyName" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nom de l'entreprise">
                </div>
                <div>
                    <label for="companyAddress" class="block text-sm font-medium text-gray-700">Adresse</label>
                    <input id="companyAddress" type="text" name="companyAddress" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Adresse de l'entreprise">
                </div>
                <div>
                    <label for="companyPhone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                    <input id="companyPhone" type="tel" name="companyPhone" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="+213...">
                </div>
                <div>
                    <label for="companyLogo" class="block text-sm font-medium text-gray-700">Logo de l'Entreprise</label>
                    <input id="companyLogo" type="file" accept="image/*" name="companyLogo" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <img id="logoPreview" class="mt-2 max-w-[150px] hidden" alt="Prévisualisation du logo">
                </div>
                <div>
                    <label for="theme" class="block text-sm font-medium text-gray-700">Thème</label>
                    <select id="theme" name="theme" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="light">Clair</option>
                        <option value="dark">Sombre</option>
                        <option value="twilight">Twilight</option>
                    </select>
                </div>
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700">Devise</label>
                    <select id="currency" name="currency" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="DZD">DZD</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <div>
                    <label for="language" class="block text-sm font-medium text-gray-700">Langue</label>
                    <select id="language" name="language" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="kpi-card bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Paramètres Caméra</h3>
            <form id="cameraSettingsForm" class="space-y-4">
                <div>
                    <label for="cameraResolution" class="block text-sm font-medium text-gray-700">Résolution Caméra</label>
                    <select id="cameraResolution" name="cameraResolution" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="low">Basse (480p)</option>
                        <option value="medium">Moyenne (720p)</option>
                        <option value="high">Haute (1080p)</option>
                    </select>
                </div>
                <div>
                    <label for="cameraFacing" class="block text-sm font-medium text-gray-700">Orientation Caméra</label>
                    <select id="cameraFacing" name="cameraFacing" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="environment">Arrière</option>
                        <option value="user">Avant</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        <input id="autoScan" type="checkbox" class="mr-2 text-indigo-500 focus:ring-indigo-500"> Scan Automatique
                    </label>
                </div>
                <button type="button" id="testCamera" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition mt-2">Tester Caméra</button>
            </form>
            <div id="cameraPreview" class="hidden mt-4 w-full max-w-[300px] h-[200px] border-2 border-gray-200 bg-black"></div>
        </div>
        <div class="kpi-card bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Notifications</h3>
            <form id="notificationSettingsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        <input id="emailNotifications" type="checkbox" class="mr-2 text-indigo-500 focus:ring-indigo-500"> Notifications par Email
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        <input id="appNotifications" type="checkbox" class="mr-2 text-indigo-500 focus:ring-indigo-500"> Notifications In-App
                    </label>
                </div>
                <div>
                    <label for="notificationEmail" class="block text-sm font-medium text-gray-700">Email pour Notifications</label>
                    <input id="notificationEmail" type="email" name="notificationEmail" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="exemple@domaine.com">
                </div>
            </form>
        </div>
        <div class="kpi-card bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Gestion du Stock</h3>
            <form id="stockSettingsForm" class="space-y-4">
                <div>
                    <label for="lowStockThreshold" class="block text-sm font-medium text-gray-700">Seuil de Stock Faible</label>
                    <input id="lowStockThreshold" type="number" name="lowStockThreshold" min="0" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="10">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        <input id="autoReorder" type="checkbox" class="mr-2 text-indigo-500 focus:ring-indigo-500"> Réapprovisionnement Automatique
                    </label>
                </div>
                <div>
                    <label for="reorderQuantity" class="block text-sm font-medium text-gray-700">Quantité de Réapprovisionnement</label>
                    <input id="reorderQuantity" type="number" name="reorderQuantity" min="0" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="50">
                </div>
            </form>
        </div>
        <div class="kpi-card bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Rapports</h3>
            <form id="reportSettingsForm" class="space-y-4">
                <div>
                    <label for="reportFormat" class="block text-sm font-medium text-gray-700">Format des Rapports</label>
                    <select id="reportFormat" name="reportFormat" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <div>
                    <label for="reportFrequency" class="block text-sm font-medium text-gray-700">Fréquence des Rapports</label>
                    <select id="reportFrequency" name="reportFrequency" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="daily">Quotidien</option>
                        <option value="weekly">Hebdomadaire</option>
                        <option value="monthly">Mensuel</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="kpi-card bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Performance</h3>
            <form id="performanceSettingsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        <input id="enableCache" type="checkbox" class="mr-2 text-indigo-500 focus:ring-indigo-500"> Activer le Cache
                    </label>
                </div>
                <div>
                    <label for="syncInterval" class="block text-sm font-medium text-gray-700">Intervalle de Synchronisation (minutes)</label>
                    <input id="syncInterval" type="number" name="syncInterval" min="1" class="mt-1 block w-full border-gray-300 bg-white text-gray-800 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        <input id="offlineMode" type="checkbox" class="mr-2 text-indigo-500 focus:ring-indigo-500"> Mode Hors-Ligne
                    </label>
                </div>
            </form>
        </div>
    </main>

    <!-- Toast notification -->
    <div id="toast" class=" बड़े bottom-4 right-4 hidden">
        <div class="flex items-center px-6 py-3 rounded-md shadow-lg">
            <i id="toastIcon" class="mr-2"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        let stream = null;
        const DEFAULT_API_URL = 'https://hicham03041979.onrender.com';
        let API_BASE_URL = localStorage.getItem('apiBaseUrl') || DEFAULT_API_URL;

        // Afficher une notification toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            if (!toast || !toastMessage || !toastIcon) {
                console.error('Éléments toast non trouvés');
                return;
            }

            toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg ${
                isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`;
            toastIcon.className = `fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2`;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Définir le mode hors ligne
        function setOfflineMode() {
            if (!checkLoginStatus()) {
                console.log('Mode hors ligne annulé: utilisateur non connecté');
                return;
            }
            const apiBaseUrlInput = document.getElementById('apiBaseUrl');
            apiBaseUrlInput.value = '/api';
            
            showToast('Mode hors ligne activé: URL définie sur /api');
            console.log('Mode hors ligne activé: URL définie sur /api');
        }

        // Scanner un QR code pour l'URL de l'API
        async function scanQrCode() {
            if (!checkLoginStatus()) {
                console.log('Scan annulé: utilisateur non connecté');
                return;
            }
            if (!('BarcodeDetector' in window)) {
                showToast('Le scan de QR code n\'est pas pris en charge par ce navigateur', true);
                return;
            }
            try {
                const resolution = document.getElementById('cameraResolution').value;
                const facingMode = document.getElementById('cameraFacing').value;
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: resolution === 'high' ? 1920 : resolution === 'medium' ? 1280 : 640 },
                        height: { ideal: resolution === 'high' ? 1080 : resolution === 'medium' ? 720 : 480 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute('playsinline', '');
                video.play();

                const cameraPreview = document.getElementById('cameraPreview');
                cameraPreview.innerHTML = '';
                cameraPreview.appendChild(video);
                cameraPreview.style.display = 'block';

                const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
                const detectQrCode = async () => {
                    const barcodes = await barcodeDetector.detect(video);
                    if (barcodes.length > 0) {
                        const qrCodeValue = barcodes[0].rawValue;
                        const apiBaseUrlInput = document.getElementById('apiBaseUrl');
                        apiBaseUrlInput.value = qrCodeValue;
                        saveApiSettings();
                        showToast(`QR code scanné: ${qrCodeValue}`);
                        stopCamera();
                        clearInterval(interval);
                    }
                };
                const interval = setInterval(detectQrCode, 1000);
                setTimeout(() => {
                    if (stream) {
                        stopCamera();
                        clearInterval(interval);
                        showToast('Aucun QR code détecté après 10 secondes', true);
                    }
                }, 10000);
            } catch (error) {
                showToast(`Erreur lors du scan: ${error.message}`, true);
                console.error('Erreur scan QR:', error);
                stopCamera();
            }
        }

        // Appliquer le thème depuis localStorage
        function applyTheme(themeValue) {
            const theme = themeValue || localStorage.getItem('theme') || 'light';
            console.log('Application du thème:', theme);
            if (theme === 'dark') {
                document.body.classList.remove('bg-gray-100');
                document.body.classList.add('bg-gray-800');
                document.querySelectorAll('.kpi-card').forEach(card => {
                    card.classList.remove('bg-white');
                    card.classList.add('bg-gray-900');
                    card.querySelectorAll('label').forEach(label => {
                        label.classList.remove('text-gray-700');
                        label.classList.add('text-gray-200');
                    });
                    card.querySelectorAll('select, input').forEach(input => {
                        input.classList.remove('bg-white', 'text-gray-800', 'border-gray-300');
                        input.classList.add('bg-gray-800', 'text-gray-200', 'border-gray-700');
                    });
                });
            } else if (theme === 'twilight') {
                document.body.classList.remove('bg-gray-100');
                document.body.classList.add('bg-gradient-to-br', 'from-gray-800', 'to-gray-900');
                document.querySelectorAll('.kpi-card').forEach(card => {
                    card.classList.remove('bg-white');
                    card.classList.add('bg-gray-800');
                    card.querySelectorAll('label').forEach(label => {
                        label.classList.remove('text-gray-700');
                        label.classList.add('text-gray-300');
                    });
                    card.querySelectorAll('select, input').forEach(input => {
                        input.classList.remove('bg-white', 'text-gray-800', 'border-gray-300');
                        input.classList.add('bg-gray-700', 'text-gray-200', 'border-gray-600');
                    });
                });
            } else {
                document.body.classList.add('bg-gray-100');
                document.querySelectorAll('.kpi-card').forEach(card => {
                    card.classList.add('bg-white');
                    card.querySelectorAll('label').forEach(label => {
                        label.classList.add('text-gray-700');
                    });
                    card.querySelectorAll('select, input').forEach(input => {
                        input.classList.add('bg-white', 'text-gray-800', 'border-gray-300');
                    });
                });
            }
            const themeElement = document.getElementById('theme');
            if (themeElement) themeElement.value = theme;
        }

        // Vérifier l'état de connexion
        function checkLoginStatus() {
            const userId = localStorage.getItem('userId');
            const userEmail = localStorage.getItem('userEmail');
            if (!userId || !userEmail) {
                console.log('userId ou userEmail manquant, redirection vers index.html');
                showToast('Veuillez vous connecter', true);
                setTimeout(() => window.location.href = './index.html', 2000);
                return false;
            }
            const userDisplay = document.getElementById('userDisplay');
            if (userDisplay) {
                userDisplay.textContent = userEmail.toLowerCase();
                userDisplay.classList.remove('hidden');
            }
            console.log('Connexion OK:', { userId, userEmail });
            return true;
        }

        // Sauvegarder les paramètres de l'API
        function saveApiSettings() {
            if (!checkLoginStatus()) {
                console.log('Sauvegarde annulée: utilisateur non connecté');
                return;
            }
            const apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            const urlToSave = apiBaseUrl || DEFAULT_API_URL;
            localStorage.setItem('apiBaseUrl', urlToSave);
            localStorage.setItem('secondaryApiUrl', urlToSave); // Enregistrer dans secondaryApiUrl
            API_BASE_URL = urlToSave;
            showToast(`URL de l'API sauvegardée: ${urlToSave}`);
            console.log('API_BASE_URL et secondaryApiUrl sauvegardées:', urlToSave);
        }

        // Réinitialiser l'URL de l'API à la valeur par défaut
        function resetApiUrl() {
            if (!checkLoginStatus()) {
                console.log('Réinitialisation annulée: utilisateur non connecté');
                return;
            }
            const apiBaseUrlInput = document.getElementById('apiBaseUrl');
            apiBaseUrlInput.value = DEFAULT_API_URL;
            localStorage.setItem('apiBaseUrl', DEFAULT_API_URL);
            API_BASE_URL = DEFAULT_API_URL;
            showToast(`URL de l'API réinitialisée à: ${DEFAULT_API_URL}`);
            console.log('API_BASE_URL réinitialisée:', DEFAULT_API_URL);
        }

        // Revenir à l'URL de la base locale
        function resetToSecondaryApiUrl() {
            if (!checkLoginStatus()) {
                console.log('Réinitialisation à la base locale annulée: utilisateur non connecté');
                return;
            }
            const secondaryApiUrl = localStorage.getItem('secondaryApiUrl');
            if (!secondaryApiUrl) {
                showToast('Aucune URL de base locale trouvée', true);
                console.log('Aucune secondaryApiUrl trouvée dans localStorage');
                return;
            }
            const apiBaseUrlInput = document.getElementById('apiBaseUrl');
            apiBaseUrlInput.value = secondaryApiUrl;
            localStorage.setItem('apiBaseUrl', secondaryApiUrl);
            API_BASE_URL = secondaryApiUrl;
            showToast(`URL de l'API rétablie à la base locale: ${secondaryApiUrl}`);
            console.log('API_BASE_URL rétablie à secondaryApiUrl:', secondaryApiUrl);
        }

        // Collecter tous les paramètres
        function collectAllSettings() {
            const settings = {
                companyName: (document.getElementById('companyName')?.value || ''),
                companyAddress: (document.getElementById('companyAddress')?.value || ''),
                companyPhone: (document.getElementById('companyPhone')?.value || ''),
                companyLogo: (document.getElementById('logoPreview')?.src || ''),
                theme: (document.getElementById('theme')?.value || 'light'),
                currency: (document.getElementById('currency')?.value || 'DZD'),
                language: (document.getElementById('language')?.value || 'fr'),
                cameraResolution: (document.getElementById('cameraResolution')?.value || 'medium'),
                cameraFacing: (document.getElementById('cameraFacing')?.value || 'environment'),
                autoScan: document.getElementById('autoScan')?.checked || false,
                emailNotifications: document.getElementById('emailNotifications')?.checked || false,
                appNotifications: document.getElementById('appNotifications')?.checked || false,
                notificationEmail: (document.getElementById('notificationEmail')?.value || ''),
                lowStockThreshold: parseInt(document.getElementById('lowStockThreshold')?.value) || 10,
                autoReorder: document.getElementById('autoReorder')?.checked || false,
                reorderQuantity: parseInt(document.getElementById('reorderQuantity')?.value) || 50,
                reportFormat: (document.getElementById('reportFormat')?.value || 'pdf'),
                reportFrequency: (document.getElementById('reportFrequency')?.value || 'weekly'),
                enableCache: document.getElementById('enableCache')?.checked || false,
                syncInterval: parseInt(document.getElementById('syncInterval')?.value) || 30,
                offlineMode: document.getElementById('offlineMode')?.checked || false,
                apiBaseUrl: (document.getElementById('apiBaseUrl')?.value || DEFAULT_API_URL)
            };
            console.log('Paramètres collectés:', settings);
            return settings;
        }

        // Charger les paramètres depuis localStorage
        function loadSettings() {
            if (!checkLoginStatus()) return;
            console.log('Chargement des paramètres');

            // Charger les paramètres depuis localStorage
            const settings = JSON.parse(localStorage.getItem('settings')) || {};

            // Ajouter la configuration de l'API
            settings.apiBaseUrl = localStorage.getItem('apiBaseUrl') || DEFAULT_API_URL;

            const fields = [
                { id: 'companyName', default: '' },
                { id: 'companyAddress', default: '' },
                { id: 'companyPhone', default: '' },
                { id: 'theme', default: 'light' },
                { id: 'currency', default: 'DZD' },
                { id: 'language', default: 'fr' },
                { id: 'cameraResolution', default: 'medium' },
                { id: 'cameraFacing', default: 'environment' },
                { id: 'autoScan', default: false, type: 'checked' },
                { id: 'emailNotifications', default: false, type: 'checked' },
                { id: 'appNotifications', default: false, type: 'checked' },
                { id: 'notificationEmail', default: '' },
                { id: 'lowStockThreshold', default: 10 },
                { id: 'autoReorder', default: false, type: 'checked' },
                { id: 'reorderQuantity', default: 50 },
                { id: 'reportFormat', default: 'pdf' },
                { id: 'reportFrequency', default: 'weekly' },
                { id: 'enableCache', default: false, type: 'checked' },
                { id: 'syncInterval', default: 30 },
                { id: 'offlineMode', default: false, type: 'checked' },
                { id: 'apiBaseUrl', default: DEFAULT_API_URL }
            ];

            fields.forEach(({ id, default: defaultValue, type }) => {
                const element = document.getElementById(id);
                if (element) {
                    if (type === 'checked') {
                        element.checked = settings[id] !== undefined ? settings[id] : defaultValue;
                    } else {
                        element.value = settings[id] !== undefined ? settings[id] : defaultValue;
                    }
                } else {
                    console.warn(`Élément ${id} non trouvé lors du chargement`);
                }
            });

            // Afficher le logo si disponible
            if (settings.companyLogo) {
                const logoPreview = document.getElementById('logoPreview');
                if (logoPreview) {
                    logoPreview.src = settings.companyLogo;
                    logoPreview.classList.remove('hidden');
                }
            }

            applyTheme(settings.theme);
        }

        // Enregistrer les paramètres dans localStorage
        function saveSettings(formId) {
            if (!checkLoginStatus()) {
                console.log('Sauvegarde annulée: utilisateur non connecté');
                return;
            }
            const settings = collectAllSettings();
            console.log(`Sauvegarde des paramètres pour ${formId}:`, settings);
            localStorage.setItem('settings', JSON.stringify(settings));
            if (formId === 'apiSettingsForm') {
                localStorage.setItem('apiBaseUrl', settings.apiBaseUrl);
                localStorage.setItem('secondaryApiUrl', settings.apiBaseUrl); // Enregistrer dans secondaryApiUrl
            }
            showToast(`Paramètres ${formId.replace('SettingsForm', '').toLowerCase()} sauvegardés`);
        }

        // Gérer le téléchargement du logo
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = () => {
                    const logoPreview = document.getElementById('logoPreview');
                    logoPreview.src = reader.result;
                    logoPreview.classList.remove('hidden');
                    saveSettings('generalSettingsForm');
                };
                reader.readAsDataURL(file);
                } else {
                showToast('Veuillez sélectionner une image valide', true);
            }
        }

        // Tester la caméra
        async function testCamera() {
            if (!('BarcodeDetector' in window)) {
                showToast('Le détecteur de codes-barres n\'est pas pris en charge', true);
                return;
            }
            try {
                const resolution = document.getElementById('cameraResolution').value;
                const facingMode = document.getElementById('cameraFacing').value;
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: resolution === 'high' ? 1920 : resolution === 'medium' ? 1280 : 640 },
                        height: { ideal: resolution === 'high' ? 1080 : resolution === 'medium' ? 720 : 480 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute('playsinline', '');
                video.play();
                const cameraPreview = document.getElementById('cameraPreview');
                cameraPreview.innerHTML = '';
                cameraPreview.appendChild(video);
                cameraPreview.style.display = 'block';
                setTimeout(() => stopCamera(), 5000);
                showToast('Caméra testée avec succès');
            } catch (error) {
                showToast(`Erreur d'accès à la caméra: ${error.message}`, true);
                console.error('Erreur caméra:', error);
            }
        }

        // Arrêter la caméra
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            const cameraPreview = document.getElementById('cameraPreview');
            cameraPreview.innerHTML = '';
            cameraPreview.style.display = 'none';
        }

        // Déconnexion
        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            showToast('Déconnexion réussie');
            setTimeout(() => window.location.href = './index.html', 1000);
        }

        // Tester la connexion à la base de données
        async function testDbConnection() {
            if (!checkLoginStatus()) return;
            try {
                const response = await fetchWithHeaders(`${API_BASE_URL}/`, {
                    method: 'GET'
                });
                if (response.ok) {
                    const text = await response.text();
                    showToast(text || 'Connexion à la base de données réussie');
                } else {
                    const data = await response.json();
                    showToast(data.erreur || 'Erreur lors du test de connexion', true);
                }
            } catch (error) {
                showToast(`Erreur: ${error.message}`, true);
                console.error('Erreur lors du test de connexion:', error);
            }
        }

        // Fonction fetch avec en-têtes personnalisés
        async function fetchWithHeaders(url, options = {}) {
            const userId = localStorage.getItem('userId');
            const headers = {
                ...options.headers,
                'X-User-ID': userId || ''
            };
            return fetch(url, { ...options, headers });
        }

        // Gestion des changements automatiques
        function setupAutoSave() {
            const settingsFields = [
                { id: 'companyName', form: 'generalSettingsForm', type: 'input' },
                { id: 'companyAddress', form: 'generalSettingsForm', type: 'input' },
                { id: 'companyPhone', form: 'generalSettingsForm', type: 'input' },
                { id: 'companyLogo', form: 'generalSettingsForm', type: 'change' },
                { id: 'theme', form: 'generalSettingsForm', type: 'change' },
                { id: 'currency', form: 'generalSettingsForm', type: 'change' },
                { id: 'language', form: 'generalSettingsForm', type: 'change' },
                { id: 'cameraResolution', form: 'cameraSettingsForm', type: 'change' },
                { id: 'cameraFacing', form: 'cameraSettingsForm', type: 'change' },
                { id: 'autoScan', form: 'cameraSettingsForm', type: 'change' },
                { id: 'emailNotifications', form: 'notificationSettingsForm', type: 'change' },
                { id: 'appNotifications', form: 'notificationSettingsForm', type: 'change' },
                { id: 'notificationEmail', form: 'notificationSettingsForm', type: 'input' },
                { id: 'lowStockThreshold', form: 'stockSettingsForm', type: 'input' },
                { id: 'autoReorder', form: 'stockSettingsForm', type: 'change' },
                { id: 'reorderQuantity', form: 'stockSettingsForm', type: 'input' },
                { id: 'reportFormat', form: 'reportSettingsForm', type: 'change' },
                { id: 'reportFrequency', form: 'reportSettingsForm', type: 'change' },
                { id: 'enableCache', form: 'performanceSettingsForm', type: 'change' },
                { id: 'syncInterval', form: 'performanceSettingsForm', type: 'input' },
                { id: 'offlineMode', form: 'performanceSettingsForm', type: 'change' },
                { id: 'apiBaseUrl', form: 'apiSettingsForm', type: 'input' }
            ];

            settingsFields.forEach(({ id, form, type }) => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Élément ${id} non trouvé`);
                    return;
                }
                element.addEventListener(type, () => {
                    console.log(`Changement détecté pour ${id} (form: ${form})`);
                    if (id === 'theme') {
                        localStorage.setItem('theme', element.value);
                        applyTheme(element.value);
                    }
                    saveSettings(form);
                });
            });
            console.log('Écouteurs auto-save configurés pour', settingsFields.length, 'champs');

            // Écouteur spécifique pour le logo
            const logoInput = document.getElementById('companyLogo');
            if (logoInput) logoInput.addEventListener('change', handleLogoUpload);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initialisation de la page');
            applyTheme();
            loadSettings();
            setupAutoSave();
            const testCameraButton = document.getElementById('testCamera');
            const logoutButton = document.getElementById('logoutButton');
            if (testCameraButton) testCameraButton.addEventListener('click', testCamera);
            if (logoutButton) logoutButton.addEventListener('click', logout);
        });
    </script>
</body>
</html>
