<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - Firepoz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .toast { transition: opacity 0.5s; }
        .hidden { opacity: 0; display: none; }
        .card { transition: background 0.3s; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-800 to-gray-900 text-gray-200">
    <!-- Barre de navigation -->
    <nav class="bg-blue-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Firepoz - Paramètres</h1>
            <div class="space-x-4">
                <a href="/index.html" class="hover:text-blue-200 transition">Accueil</a>
                <a href="/vente.html" class="hover:text-blue-200 transition">Vente</a>
                <a href="/HISTO.html" class="hover:text-blue-200 transition">Historique</a>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="container mx-auto mt-8 px-4">
        <h2 class="text-3xl font-semibold mb-6 text-center">Paramètres Avancés</h2>

        <!-- Paramètres généraux -->
        <div class="card bg-gray-800 shadow-xl rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-blue-300">Paramètres Généraux</h3>
            <form id="generalSettingsForm" class="space-y-4">
                <div>
                    <label for="theme" class="block text-sm font-medium text-gray-300">Thème</label>
                    <select id="theme" name="theme" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="twilight">Twilight</option>
                        <option value="light">Clair</option>
                        <option value="dark">Sombre</option>
                    </select>
                </div>
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-300">Devise</label>
                    <select id="currency" name="currency" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="DZD">DZD</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
                <div>
                    <label for="language" class="block text-sm font-medium text-gray-300">Langue</label>
                    <select id="language" name="language" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Enregistrer</button>
            </form>
        </div>

        <!-- Paramètres caméra -->
        <div class="card bg-gray-800 shadow-xl rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-blue-300">Paramètres Caméra</h3>
            <form id="cameraSettingsForm" class="space-y-4">
                <div>
                    <label for="cameraResolution" class="block text-sm font-medium text-gray-300">Résolution Caméra</label>
                    <select id="cameraResolution" name="cameraResolution" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="low">Basse (480p)</option>
                        <option value="medium">Moyenne (720p)</option>
                        <option value="high">Haute (1080p)</option>
                    </select>
                </div>
                <div>
                    <label for="cameraFacing" class="block text-sm font-medium text-gray-300">Orientation Caméra</label>
                    <select id="cameraFacing" name="cameraFacing" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="environment">Arrière</option>
                        <option value="user">Avant</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">
                        <input id="autoScan" type="checkbox" class="mr-2 text-blue-500"> Scan Automatique
                    </label>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Enregistrer</button>
                <button type="button" id="testCamera" class="w-full bg-gray-600 text-white py-2 rounded-md hover:bg-gray-700 transition mt-2">Tester Caméra</button>
            </form>
            <div id="cameraPreview" class="hidden mt-4"></div>
        </div>

        <!-- Paramètres notifications -->
        <div class="card bg-gray-800 shadow-xl rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-blue-300">Notifications</h3>
            <form id="notificationSettingsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300">
                        <input id="emailNotifications" type="checkbox" class="mr-2 text-blue-500"> Notifications par Email
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">
                        <input id="appNotifications" type="checkbox" class="mr-2 text-blue-500"> Notifications In-App
                    </label>
                </div>
                <div>
                    <label for="notificationEmail" class="block text-sm font-medium text-gray-300">Email pour Notifications</label>
                    <input id="notificationEmail" type="email" name="notificationEmail" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="exemple@domaine.com">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Enregistrer</button>
            </form>
        </div>

        <!-- Paramètres stock -->
        <div class="card bg-gray-800 shadow-xl rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-blue-300">Gestion du Stock</h3>
            <form id="stockSettingsForm" class="space-y-4">
                <div>
                    <label for="lowStockThreshold" class="block text-sm font-medium text-gray-300">Seuil de Stock Faible</label>
                    <input id="lowStockThreshold" type="number" name="lowStockThreshold" min="0" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="10">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">
                        <input id="autoReorder" type="checkbox" class="mr-2 text-blue-500"> Réapprovisionnement Automatique
                    </label>
                </div>
                <div>
                    <label for="reorderQuantity" class="block text-sm font-medium text-gray-300">Quantité de Réapprovisionnement</label>
                    <input id="reorderQuantity" type="number" name="reorderQuantity" min="0" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="50">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Enregistrer</button>
            </form>
        </div>

        <!-- Paramètres rapports -->
        <div class="card bg-gray-800 shadow-xl rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-blue-300">Rapports</h3>
            <form id="reportSettingsForm" class="space-y-4">
                <div>
                    <label for="reportFormat" class="block text-sm font-medium text-gray-300">Format des Rapports</label>
                    <select id="reportFormat" name="reportFormat" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <div>
                    <label for="reportFrequency" class="block text-sm font-medium text-gray-300">Fréquence des Rapports</label>
                    <select id="reportFrequency" name="reportFrequency" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="daily">Quotidien</option>
                        <option value="weekly">Hebdomadaire</option>
                        <option value="monthly">Mensuel</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Enregistrer</button>
            </form>
        </div>

        <!-- Paramètres performance -->
        <div class="card bg-gray-800 shadow-xl rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4 text-blue-300">Performance</h3>
            <form id="performanceSettingsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300">
                        <input id="enableCache" type="checkbox" class="mr-2 text-blue-500"> Activer le Cache
                    </label>
                </div>
                <div>
                    <label for="syncInterval" class="block text-sm font-medium text-gray-300">Intervalle de Synchronisation (minutes)</label>
                    <input id="syncInterval" type="number" name="syncInterval" min="1" class="mt-1 block w-full border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="30">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">
                        <input id="offlineMode" type="checkbox" class="mr-2 text-blue-500"> Mode Hors-Ligne
                    </label>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">Enregistrer</button>
            </form>
        </div>
    </main>

    <!-- Toast notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg bg-green-500 text-white">
        <i id="toastIcon" class="fas fa-check-circle mr-2"></i>
        <span id="toastMessage">Opération réussie</span>
    </div>

    <script>
        const API_BASE_URL = 'https://web-production-3b9e.up.railway.app';
        let stream = null;

        // Afficher une notification toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = `fixed bottom-4 right-4 flex items-center px-6 py-3 rounded-md shadow-lg toast ${
                isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`;
            toastIcon.className = `fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2`;
            toastMessage.textContent = message;
            toast.classList.remove('hidden');

            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Appliquer le thème depuis localStorage
        function applyTheme() {
            const theme = localStorage.getItem('theme') || 'twilight';
            if (theme === 'light') {
                document.body.classList.remove('bg-gradient-to-br', 'from-gray-800', 'to-gray-900');
                document.body.classList.add('bg-gradient-to-br', 'from-gray-100', 'to-gray-200');
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.remove('bg-gray-800');
                    card.classList.add('bg-white');
                    card.querySelectorAll('label').forEach(label => {
                        label.classList.remove('text-gray-300');
                        label.classList.add('text-gray-700');
                    });
                    card.querySelectorAll('select, input').forEach(input => {
                        input.classList.remove('bg-gray-700', 'text-gray-200', 'border-gray-600');
                        input.classList.add('bg-white', 'text-gray-800', 'border-gray-300');
                    });
                });
            } else if (theme === 'dark') {
                document.body.classList.remove('bg-gradient-to-br', 'from-gray-800', 'to-gray-900');
                document.body.classList.add('bg-gradient-to-br', 'from-gray-900', 'to-gray-950');
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.remove('bg-gray-800');
                    card.classList.add('bg-gray-900');
                    card.querySelectorAll('label').forEach(label => {
                        label.classList.remove('text-gray-300');
                        label.classList.add('text-gray-200');
                    });
                    card.querySelectorAll('select, input').forEach(input => {
                        input.classList.remove('bg-gray-700', 'text-gray-200', 'border-gray-600');
                        input.classList.add('bg-gray-800', 'text-gray-200', 'border-gray-700');
                    });
                });
            } else {
                document.body.classList.add('bg-gradient-to-br', 'from-gray-800', 'to-gray-900');
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.add('bg-gray-800');
                    card.querySelectorAll('label').forEach(label => {
                        label.classList.add('text-gray-300');
                    });
                    card.querySelectorAll('select, input').forEach(input => {
                        input.classList.add('bg-gray-700', 'text-gray-200', 'border-gray-600');
                    });
                });
            }
            document.getElementById('theme').value = theme;
        }

        // Charger les paramètres
        async function loadSettings() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Veuillez vous connecter', true);
                setTimeout(() => window.location.href = '/index.html', 2000);
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/parametres`, {
                    headers: { 'X-User-ID': userId }
                });
                const data = await response.json();
                if (!response.ok) {
                    console.error('Erreur API:', data, 'Statut:', response.status);
                    throw new Error(data.erreur || `Erreur serveur (${response.status})`);
                }
                const settings = data;
                document.getElementById('theme').value = settings.theme || 'twilight';
                document.getElementById('currency').value = settings.currency || 'DZD';
                document.getElementById('language').value = settings.language || 'fr';
                document.getElementById('cameraResolution').value = settings.cameraResolution || 'medium';
                document.getElementById('cameraFacing').value = settings.cameraFacing || 'environment';
                document.getElementById('autoScan').checked = settings.autoScan || false;
                document.getElementById('emailNotifications').checked = settings.emailNotifications || false;
                document.getElementById('appNotifications').checked = settings.appNotifications || false;
                document.getElementById('notificationEmail').value = settings.notificationEmail || '';
                document.getElementById('lowStockThreshold').value = settings.lowStockThreshold || 10;
                document.getElementById('autoReorder').checked = settings.autoReorder || false;
                document.getElementById('reorderQuantity').value = settings.reorderQuantity || 50;
                document.getElementById('reportFormat').value = settings.reportFormat || 'pdf';
                document.getElementById('reportFrequency').value = settings.reportFrequency || 'weekly';
                document.getElementById('enableCache').checked = settings.enableCache || false;
                document.getElementById('syncInterval').value = settings.syncInterval || 30;
                document.getElementById('offlineMode').checked = settings.offlineMode || false;
                applyTheme();
            } catch (error) {
                console.error('Erreur fetch:', error);
                showToast(`Erreur de chargement des paramètres: ${error.message}`, true);
            }
        }

        // Enregistrer les paramètres
        async function saveSettings(formId, settings) {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showToast('Veuillez vous connecter', true);
                setTimeout(() => window.location.href = '/index.html', 2000);
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/parametres`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': userId
                    },
                    body: JSON.stringify(settings)
                });
                const data = await response.json();
                if (!response.ok) {
                    console.error('Erreur API:', data, 'Statut:', response.status);
                    throw new Error(data.erreur || `Erreur serveur (${response.status})`);
                }
                showToast(`Paramètres ${formId.replace('SettingsForm', '').toLowerCase()} sauvegardés`);
            } catch (error) {
                console.error('Erreur fetch:', error);
                showToast(`Erreur de sauvegarde: ${error.message}`, true);
            }
        }

        // Tester la caméra
        async function testCamera() {
            if (!('BarcodeDetector' in window)) {
                showToast('Le détecteur de codes-barres n\'est pas pris en charge', true);
                return;
            }
            try {
                const resolution = document.getElementById('cameraResolution').value;
                const facingMode = document.getElementById('cameraFacing').value;
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: resolution === 'high' ? 1920 : resolution === 'medium' ? 1280 : 640 },
                        height: { ideal: resolution === 'high' ? 1080 : resolution === 'medium' ? 720 : 480 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.createElement('video');
                video.srcObject = stream;
                video.setAttribute('playsinline', '');
                video.play();
                const cameraPreview = document.getElementById('cameraPreview');
                cameraPreview.innerHTML = '';
                cameraPreview.appendChild(video);
                cameraPreview.style.display = 'block';
                setTimeout(() => stopCamera(), 5000);
                showToast('Caméra testée avec succès');
            } catch (error) {
                showToast(`Erreur d'accès à la caméra: ${error.message}`, true);
                console.error('Erreur caméra:', error);
            }
        }

        // Arrêter la caméra
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            const cameraPreview = document.getElementById('cameraPreview');
            cameraPreview.innerHTML = '';
            cameraPreview.style.display = 'none';
        }

        // Gestion des formulaires
        document.getElementById('generalSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                theme: document.getElementById('theme').value,
                currency: document.getElementById('currency').value,
                language: document.getElementById('language').value
            };
            localStorage.setItem('theme', settings.theme);
            applyTheme();
            await saveSettings('generalSettingsForm', settings);
        });

        document.getElementById('cameraSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                cameraResolution: document.getElementById('cameraResolution').value,
                cameraFacing: document.getElementById('cameraFacing').value,
                autoScan: document.getElementById('autoScan').checked
            };
            await saveSettings('cameraSettingsForm', settings);
        });

        document.getElementById('notificationSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                appNotifications: document.getElementById('appNotifications').checked,
                notificationEmail: document.getElementById('notificationEmail').value
            };
            await saveSettings('notificationSettingsForm', settings);
        });

        document.getElementById('stockSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value) || 10,
                autoReorder: document.getElementById('autoReorder').checked,
                reorderQuantity: parseInt(document.getElementById('reorderQuantity').value) || 50
            };
            await saveSettings('stockSettingsForm', settings);
        });

        document.getElementById('reportSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                reportFormat: document.getElementById('reportFormat').value,
                reportFrequency: document.getElementById('reportFrequency').value
            };
            await saveSettings('reportSettingsForm', settings);
        });

        document.getElementById('performanceSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settings = {
                enableCache: document.getElementById('enableCache').checked,
                syncInterval: parseInt(document.getElementById('syncInterval').value) || 30,
                offlineMode: document.getElementById('offlineMode').checked
            };
            await saveSettings('performanceSettingsForm', settings);
        });

        document.getElementById('testCamera').addEventListener('click', testCamera);

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme();
            loadSettings();
        });
    </script>
</body>
</html>